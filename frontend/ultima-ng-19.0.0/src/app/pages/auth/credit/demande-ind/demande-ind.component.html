<!-- demande-ind.component.html -->
<div class="container-fluid p-4">
    <p-toast></p-toast>

    <!-- Header -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">
                <i class="pi pi-file-edit mr-2"></i>
                DEMANDE DE CRÉDIT - GROS DOSSIER
            </h2>
            @if(state().clientData) {
            <p class="mt-2 mb-0">Client: <strong>{{ state().clientData?.nom_CLIENTE }}</strong></p>
            }
        </div>

        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label>Date de la demande:</label>
                    <strong>{{ today | date:'dd/MM/yyyy' }}</strong>
                </div>
                <div class="col-md-4">
                    <label>Agence de:</label>
                    <strong>{{ selectedAgence?.libele || '-' }}</strong>
                </div>
                <div class="col-md-4">
                    <label>Agent de crédit:</label>
                    <strong>{{ currentUser?.name || '-' }}</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    @if(state().submitting || state().loading) {
    <div class="d-flex justify-content-center my-4">
        <p-progressSpinner [style]="{ width: '50px', height: '50px' }"></p-progressSpinner>
    </div>
    }

    <!-- Main Form -->
    <form #demandeForm="ngForm" (ngSubmit)="createDemande(demandeForm)">

        <!-- SECTION 1: INFORMATIONS SUR LE MEMBRE/CLIENT -->
        <p-panel header="1. INFORMATIONS SUR LE MEMBRE/CLIENT" [toggleable]="true" class="mb-3">
            <div class="grid">

                <!-- Row 1 -->
                <div class="col-12 md:col-6 lg:col-3">
                    <label for="nom" class="block mb-2">Nom et Prénoms *</label>
                    <div class="p-inputgroup">
                        <input pInputText [(ngModel)]="formData.nom" name="nom" id="nom" required
                            [disabled]="state().submitting" class="w-full" placeholder="Nom">
                    </div>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label class="block mb-2">&nbsp;</label>
                    <input pInputText [(ngModel)]="formData.prenom" name="prenom" required
                        [disabled]="state().submitting" class="w-full" placeholder="Prénom(s)">
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label for="numeroMembre" class="block mb-2">Numéro/membre *</label>
                    <input pInputText [(ngModel)]="formData.numeroMembre"
                        [value]="state().clientData?.clientesPKId?.codCliente" name="numeroMembre" id="numeroMembre"
                        required [disabled]="state().submitting" class="w-full">
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label for="telephone" class="block mb-2">Téléphone *</label>
                    <input pInputText [(ngModel)]="formData.telephone" name="telephone" id="telephone" required
                        [disabled]="state().submitting" class="w-full" placeholder="Ex: 620000000">
                </div>

                <!-- Row 2: Type de pièce et informations -->
                <div class="col-12 md:col-6 lg:col-3">
                    <label for="typePiece" class="block mb-2">Type de pièce d'identité *</label>
                    <p-dropdown [(ngModel)]="formData.typePiece" name="typePiece" [options]="typePieceOptions"
                        optionLabel="label" optionValue="value" placeholder="Sélectionner" [showClear]="true" required
                        [disabled]="state().submitting" styleClass="w-full">
                    </p-dropdown>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label for="numId" class="block mb-2">Référence/N° *</label>
                    <input pInputText [(ngModel)]="formData.numId" name="numId" id="numId" required
                        [disabled]="state().submitting" class="w-full" placeholder="Numéro de la pièce">
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label for="dateNaissance" class="block mb-2">Date et lieu de naissance *</label>
                    <p-calendar [(ngModel)]="formData.dateNaissance" name="dateNaissance" dateFormat="dd/mm/yy"
                        [showIcon]="true" required [disabled]="state().submitting" styleClass="w-full">
                    </p-calendar>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label class="block mb-2">&nbsp;</label>
                    <input pInputText [(ngModel)]="formData.lieuxNaissance" name="lieuxNaissance" required
                        [disabled]="state().submitting" class="w-full" placeholder="Lieu de naissance">
                </div>

                <!-- Row 3: Genre et situation -->
                <div class="col-12 md:col-6 lg:col-2">
                    <label class="block mb-2">Genre *</label>
                    <div class="flex gap-3">
                        <div class="field-radiobutton">
                            <p-radioButton [(ngModel)]="formData.genre" name="genre" value="Masculin" inputId="masculin"
                                [disabled]="state().submitting">
                            </p-radioButton>
                            <label for="masculin" class="ml-2">M</label>
                        </div>
                        <div class="field-radiobutton">
                            <p-radioButton [(ngModel)]="formData.genre" name="genre" value="Feminin" inputId="feminin"
                                [disabled]="state().submitting">
                            </p-radioButton>
                            <label for="feminin" class="ml-2">F</label>
                        </div>
                    </div>
                </div>

                <div class="col-12 md:col-6 lg:col-4">
                    <label for="situationMatrimoniale" class="block mb-2">Situation matrimoniale *</label>
                    <p-dropdown [(ngModel)]="formData.situationMatrimoniale" name="situationMatrimoniale"
                        [options]="situationMatrimonialeOptions" optionLabel="label" optionValue="value"
                        placeholder="Sélectionner" required [disabled]="state().submitting" styleClass="w-full">
                    </p-dropdown>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label for="nombrePersonneEnCharge" class="block mb-2">Nombre de personnes à charge *</label>
                    <p-inputNumber [(ngModel)]="formData.nombrePersonneEnCharge" name="nombrePersonneEnCharge" [min]="0"
                        required [disabled]="state().submitting" styleClass="w-full">
                    </p-inputNumber>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label for="nombrePersonneScolarise" class="block mb-2">Nombre d'enfants scolarisés</label>
                    <p-inputNumber [(ngModel)]="formData.nombrePersonneScolarise" name="nombrePersonneScolarise"
                        [min]="0" [disabled]="state().submitting" styleClass="w-full">
                    </p-inputNumber>
                </div>

                <!-- Row 4: Adresse et domicile -->
                <div class="col-12 md:col-6">
                    <label for="addresseDomicileContact" class="block mb-2">Adresse de domicile et Contact *</label>
                    <textarea pTextarea [(ngModel)]="formData.addresseDomicileContact" name="addresseDomicileContact"
                        rows="2" required [disabled]="state().submitting" class="w-full" placeholder="Adresse complète">
          </textarea>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label for="typePropriete" class="block mb-2">Type de propriété *</label>
                    <p-dropdown [(ngModel)]="formData.typePropriete" name="typePropriete"
                        [options]="typeProprieteOptions" optionLabel="label" optionValue="value"
                        placeholder="Sélectionner" required [disabled]="state().submitting" styleClass="w-full">
                    </p-dropdown>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label for="nombreAnneeHabitation" class="block mb-2">Nombre d'années à l'adresse *</label>
                    <p-inputNumber [(ngModel)]="formData.nombreAnneeHabitation" name="nombreAnneeHabitation" [min]="0"
                        required [disabled]="state().submitting" styleClass="w-full">
                    </p-inputNumber>
                </div>
                <div class="col-12">
                    <p-divider align="left">
                        <div class="px-2">Nature du Client</div>
                    </p-divider>
                </div>
                <div class="col-12 md:col-6 lg:col-4">
                    <label for="natureClient" class="block mb-2">Nature du client *</label>
                    <p-dropdown [(ngModel)]="formData.natureClient" name="natureClient" [options]="natureClientOptions"
                        optionLabel="label" optionValue="value" placeholder="Sélectionner la nature du client" required
                        [disabled]="state().submitting" styleClass="w-full" (onChange)="onNatureClientChange($event)">
                        <ng-template pTemplate="selectedItem" let-option>
                            <div class="flex align-items-center" *ngIf="option">
                                <i [class]="option.icon + ' mr-2'"></i>
                                <span>{{ option.label }}</span>
                            </div>
                        </ng-template>
                        <ng-template pTemplate="item" let-option>
                            <div class="flex align-items-center">
                                <i [class]="option.icon + ' mr-2'"></i>
                                <span>{{ option.label }}</span>
                            </div>
                        </ng-template>
                    </p-dropdown>
                </div>
                <div class="col-12 md:col-6 lg:col-8">
                    <!-- Message d'information selon la nature sélectionnée -->
                    @if(formData.natureClient === 'PME') {
                    <p-message severity="info"
                        text="Pour une PME, veuillez renseigner les informations du représentant légal de l'entreprise.">
                    </p-message>
                    }
                    @if(formData.natureClient === 'Groupe Solidaire') {
                    <p-message severity="info"
                        text="Pour un groupe solidaire, veuillez renseigner les informations du chef de groupe.">
                    </p-message>
                    }
                    @if(formData.natureClient === 'Autre') {
                    <p-message severity="warn" text="Veuillez préciser la nature dans la description de l'activité.">
                    </p-message>
                    }
                </div>

                <!-- Row 5: Localisation administrative -->
                <div class="col-12">
                    <p-divider align="left">
                        <div class="px-2">Localisation Administrative</div>
                    </p-divider>
                </div>

                <div class="col-12 md:col-6 lg:col-4">
                    <label for="delegation" class="block mb-2">Délégation *</label>
                    <p-dropdown [(ngModel)]="formData.delegation" name="delegation"
                        [options]="state().allDelegations || []" optionLabel="libele" dataKey="id" [filter]="true"
                        filterBy="libele" [showClear]="true" placeholder="Sélectionner une délégation" required
                        [disabled]="state().submitting || state().loading" styleClass="w-full"
                        (onChange)="onDelegationChange($event)">
                    </p-dropdown>
                </div>

                <div class="col-12 md:col-6 lg:col-4">
                    <label for="agence" class="block mb-2">Agence *</label>
                    <p-dropdown [(ngModel)]="formData.agence" name="agence" [options]="state().filteredAgences || []"
                        optionLabel="libele" dataKey="id" [filter]="true" filterBy="libele" [showClear]="true"
                        placeholder="Sélectionner une agence" required
                        [disabled]="state().submitting || !state().filteredAgences?.length" styleClass="w-full"
                        (onChange)="onAgenceChange($event)">
                    </p-dropdown>
                </div>

                <div class="col-12 md:col-6 lg:col-4">
                    <label for="pos" class="block mb-2">Point de Vente *</label>
                    <p-dropdown [(ngModel)]="formData.pos" name="pos" [options]="state().filteredPointsVente || []"
                        optionLabel="libele" dataKey="id" [filter]="true" filterBy="libele" [showClear]="true"
                        placeholder="Sélectionner un point de vente" required
                        [disabled]="state().submitting || !state().filteredPointsVente?.length" styleClass="w-full">
                    </p-dropdown>
                </div>

            </div>
        </p-panel>

        <!-- SECTION 2: ACTIVITÉS -->
        <p-panel header="2. ACTIVITÉS" [toggleable]="true" class="mb-3">
            <div class="grid">

                <!-- Type d'activité principal avec dropdown -->
                <div class="col-12 md:col-6 lg:col-4">
                    <label for="typeActivite" class="block mb-2">Type d'activité *</label>
                    <p-dropdown [(ngModel)]="formData.typeActivite" name="typeActivite" [options]="activiteOptions"
                        optionLabel="label" optionValue="value" placeholder="Sélectionner une activité" [filter]="true"
                        filterBy="label" [showClear]="true" required [disabled]="state().submitting" styleClass="w-full"
                        (onChange)="onActiviteChange($event)">
                        <ng-template pTemplate="selectedItem" let-option>
                            <div class="flex align-items-center">
                                <span>{{ option?.label }}</span>
                            </div>
                        </ng-template>
                        <ng-template pTemplate="item" let-option>
                            <div class="flex align-items-center">
                                <span class="font-bold mr-2">{{ option.value }}</span>
                                <span>{{ option.label }}</span>
                            </div>
                        </ng-template>
                    </p-dropdown>
                </div>

                <!-- Sous-activité avec dropdown -->
                <div class="col-12 md:col-6 lg:col-4">
                    <label for="sousActivite" class="block mb-2">Sous-activité *</label>
                    <p-dropdown [(ngModel)]="formData.sousActivite" name="sousActivite" [options]="sousActiviteOptions"
                        optionLabel="label" optionValue="value" placeholder="Sélectionner une sous-activité"
                        [filter]="true" filterBy="label" [showClear]="true" required
                        [disabled]="state().submitting || !selectedActivite" styleClass="w-full"
                        (onChange)="onSousActiviteChange($event)">
                        <ng-template pTemplate="selectedItem" let-option>
                            <div class="flex align-items-center">
                                <span>{{ option?.label }}</span>
                            </div>
                        </ng-template>
                        <ng-template pTemplate="item" let-option>
                            <div class="flex align-items-center">
                                <span class="font-bold mr-2">{{ option.value }}</span>
                                <span>{{ option.label }}</span>
                            </div>
                        </ng-template>
                    </p-dropdown>
                </div>

                <!-- Sous-sous-activité avec dropdown -->
                <div class="col-12 md:col-6 lg:col-4">
                    <label for="sousSousActivite" class="block mb-2">Sous-sous-activité</label>
                    <p-dropdown [(ngModel)]="formData.sousSousActivite" name="sousSousActivite"
                        [options]="sousSousActiviteOptions" optionLabel="label" optionValue="value"
                        placeholder="Sélectionner (optionnel)" [filter]="true" filterBy="label" [showClear]="true"
                        [disabled]="state().submitting || !selectedSousActivite" styleClass="w-full"
                        (onChange)="onSousSousActiviteChange($event)">
                        <ng-template pTemplate="selectedItem" let-option>
                            <div class="flex align-items-center">
                                <span>{{ option?.label }}</span>
                            </div>
                        </ng-template>
                        <ng-template pTemplate="item" let-option>
                            <div class="flex align-items-center">
                                <span class="font-bold mr-2">{{ option.value }}</span>
                                <span>{{ option.label }}</span>
                            </div>
                        </ng-template>
                    </p-dropdown>
                </div>

                <!-- Affichage de la sélection actuelle -->
                @if(selectedActivite || selectedSousActivite || selectedSousSousActivite) {
                <div class="col-12">
                    <p-message severity="info">
                        <div class="flex flex-column gap-2">
                            <span class="font-bold">Activité sélectionnée:</span>
                            <span>
                                {{ selectedActivite?.libelle }}
                                @if(selectedSousActivite) {
                                → {{ selectedSousActivite.libelle }}
                                }
                                @if(selectedSousSousActivite) {
                                → {{ selectedSousSousActivite.libelle }}
                                }
                            </span>
                        </div>
                    </p-message>
                </div>
                }

                <div class="col-12">
                    <label for="descriptionActivite" class="block mb-2">Description de l'activité *</label>
                    <textarea pTextarea [(ngModel)]="formData.descriptionActivite" name="descriptionActivite" rows="3"
                        required [disabled]="state().submitting" class="w-full"
                        placeholder="Décrivez en détail votre activité actuelle">
            </textarea>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label for="nombreAnneeActivite" class="block mb-2">Nombre d'années dans l'activité *</label>
                    <p-inputNumber [(ngModel)]="formData.nombreAnneeActivite" name="nombreAnneeActivite" [min]="0"
                        required [disabled]="state().submitting" styleClass="w-full">
                    </p-inputNumber>
                </div>

                <div class="col-12 md:col-6 lg:col-9">
                    <label for="adresseLieuActivite" class="block mb-2">Adresse du lieu d'activité *</label>
                    <input pInputText [(ngModel)]="formData.adresseLieuActivite" name="adresseLieuActivite" required
                        [disabled]="state().submitting" class="w-full"
                        placeholder="Adresse complète du lieu d'exercice de l'activité">
                </div>

                <div class="col-12 md:col-6">
                    <label for="autreActivite" class="block mb-2">Autres activités (optionnel)</label>
                    <input pInputText [(ngModel)]="formData.autreActivite" name="autreActivite"
                        [disabled]="state().submitting" class="w-full" placeholder="Activités secondaires éventuelles">
                </div>

                <div class="col-12 md:col-6">
                    <label for="lieuActivite" class="block mb-2">Lieu de l'activité (optionnel)</label>
                    <input pInputText [(ngModel)]="formData.lieuActivite" name="lieuActivite"
                        [disabled]="state().submitting" class="w-full" placeholder="Précisions sur le lieu">
                </div>

            </div>
        </p-panel>

        <!-- SECTION 3: MODALITÉS DE LA DEMANDE -->
        <p-panel header="3. MODALITÉS DE LA DEMANDE" [toggleable]="true" class="mb-3">
            <div class="grid">

                <div class="col-12 md:col-6 lg:col-3">
                    <label for="montantDemande" class="block mb-2">Montant demandé (GNF) *</label>
                    <p-inputNumber [(ngModel)]="formData.montantDemande" name="montantDemande" mode="currency"
                        currency="GNF" locale="fr-FR" [min]="1" required [disabled]="state().submitting"
                        styleClass="w-full">
                    </p-inputNumber>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label for="dureeDemande" class="block mb-2">Durée demandée (mois) *</label>
                    <p-inputNumber [(ngModel)]="formData.dureeDemande" name="dureeDemande" [min]="1" suffix=" mois"
                        required [disabled]="state().submitting" styleClass="w-full">
                    </p-inputNumber>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label for="periodiciteRemboursement" class="block mb-2">Périodicité de remboursement *</label>
                    <p-dropdown [(ngModel)]="formData.periodiciteRemboursement" name="periodiciteRemboursement"
                        [options]="periodiciteOptions" optionLabel="label" optionValue="value"
                        placeholder="Sélectionner" required [disabled]="state().submitting" styleClass="w-full">
                    </p-dropdown>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label for="tauxInteret" class="block mb-2">Taux d'intérêt (%) *</label>
                    <p-inputNumber [(ngModel)]="formData.tauxInteret" name="tauxInteret" [min]="0" [max]="100"
                        suffix="%" [minFractionDigits]="2" [maxFractionDigits]="2" required
                        [disabled]="state().submitting" styleClass="w-full">
                    </p-inputNumber>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label for="periodeDiffere" class="block mb-2">Période de différé (mois)</label>
                    <p-inputNumber [(ngModel)]="formData.periodeDiffere" name="periodeDiffere" [min]="0" suffix=" mois"
                        [disabled]="state().submitting" styleClass="w-full">
                    </p-inputNumber>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label for="nombreEcheance" class="block mb-2">Nombre d'échéances *</label>
                    <p-inputNumber [(ngModel)]="formData.nombreEcheance" name="nombreEcheance" [min]="1" required
                        [disabled]="state().submitting" styleClass="w-full">
                    </p-inputNumber>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label for="echeance" class="block mb-2">Échéance calculée (GNF)</label>
                    <p-inputNumber [(ngModel)]="formData.echeance" name="echeance" mode="currency" currency="GNF"
                        locale="fr-FR" [disabled]="state().submitting" styleClass="w-full">
                    </p-inputNumber>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label for="tipCredito" class="block mb-2">Type de Crédit *</label>
                    <p-dropdown [(ngModel)]="formData.tipCredito" name="tipCredito" [options]="typeCreditOptions"
                        optionLabel="label" optionValue="value" [filter]="true" filterBy="label" [showClear]="true"
                        required placeholder="Sélectionner un type de crédit" [disabled]="state().submitting"
                        styleClass="w-full" (onChange)="onTypeCreditChange($event)">
                        <ng-template pTemplate="selectedItem" let-option>
                            <div class="flex align-items-center">
                                <span>{{ option?.label }}</span>
                            </div>
                        </ng-template>
                        <ng-template pTemplate="item" let-option>
                            <div class="flex align-items-center justify-content-between w-full">
                                <span>{{ option.label }}</span>
                                <span class="text-xs text-gray-500 ml-2">({{ option.value }})</span>
                            </div>
                        </ng-template>
                    </p-dropdown>
                </div>

                <div class="col-12">
                    <p-divider align="left">
                        <div class="px-2">Objet du crédit</div>
                    </p-divider>
                </div>

                <div class="col-12 md:col-6 lg:col-4">
                    <label for="objectCredit" class="block mb-2">Objet du crédit sollicité *</label>
                    <p-dropdown [(ngModel)]="formData.objectCredit" name="objectCredit" [options]="objectCreditOptions"
                        optionLabel="label" optionValue="value" placeholder="Sélectionner" required
                        [disabled]="state().submitting" styleClass="w-full">
                    </p-dropdown>
                </div>

                <div class="col-12 md:col-6 lg:col-8">
                    <label for="detailObjectCredit" class="block mb-2">Détail de l'objet de crédit *</label>
                    <textarea pTextarea [(ngModel)]="formData.detailObjectCredit" name="detailObjectCredit" rows="2"
                        required [disabled]="state().submitting" class="w-full"
                        placeholder="Précisez l'utilisation prévue du crédit">
          </textarea>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label class="block mb-2">Statut du crédit *</label>
                    <div class="flex gap-3">
                        @for(option of statutCreditOptions; track option.value) {
                        <div class="field-radiobutton">
                            <p-radioButton [(ngModel)]="formData.statutCredit" name="statutCredit"
                                [value]="option.value" [inputId]="option.value" [disabled]="state().submitting">
                            </p-radioButton>
                            <label [for]="option.value" class="ml-2">{{ option.label }}</label>
                        </div>
                        }
                    </div>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <label for="rangCredit" class="block mb-2">Rang de crédit</label>
                    <p-inputNumber [(ngModel)]="formData.rangCredit" name="rangCredit" [min]="1"
                        [disabled]="state().submitting" styleClass="w-full">
                    </p-inputNumber>
                </div>

            </div>
        </p-panel>

        <!-- SECTION 4: GARANTIES PROPOSÉES -->
        <p-panel header="4. GARANTIES PROPOSÉES" [toggleable]="true" class="mb-3">

            <div class="mb-3 flex justify-content-between align-items-center">
                <button type="button" pButton icon="pi pi-plus" label="Ajouter une garantie" class="p-button-success"
                    (click)="showAddGarantieDialog()" [disabled]="state().submitting">
                </button>

                <!-- Badge informatif pour les nouveaux types -->
                <div class="flex gap-2">
                    <p-chip label="Financière" icon="pi pi-dollar"
                        [style]="{'background-color': '#10b981', 'color': 'white'}"></p-chip>
                    <p-chip label="Matérielle" icon="pi pi-box"
                        [style]="{'background-color': '#3b82f6', 'color': 'white'}"></p-chip>
                    <p-chip label="Caution" icon="pi pi-users"
                        [style]="{'background-color': '#f59e0b', 'color': 'white'}"></p-chip>
                </div>
            </div>

            <p-table [value]="state().garanties" [responsive]="true" styleClass="p-datatable-sm">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Type de Garantie</th>
                        <th>Nature / Description des garanties</th>
                        <th>Valeur de la garantie</th>
                        <th>Valeur d'emprunt (75%)</th>
                        <th style="width: 100px;">Actions</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-garantie let-i="rowIndex">
                    <tr>
                        <td>
                            <div class="flex align-items-center gap-2">
                                <!-- Icône selon le type de garantie -->
                                @switch(garantie.typeGarantie) {
                                @case('Garantie Financiere') {
                                <i class="pi pi-dollar text-green-500"></i>
                                }
                                @case('Garantie Materielle') {
                                <i class="pi pi-box text-blue-500"></i>
                                }
                                @case('Caution Solidaire') {
                                <i class="pi pi-users text-orange-500"></i>
                                }
                                @default {
                                <i class="pi pi-question-circle text-gray-500"></i>
                                }
                                }
                                <span>{{ garantie.typeGarantie }}</span>
                            </div>
                        </td>
                        <td>{{ garantie.descriptionGarantie }}</td>
                        <td>{{ garantie.valeurGarantie | currency:'GNF':'symbol':'1.0-0' }}</td>
                        <td>{{ garantie.valeurEmprunte | currency:'GNF':'symbol':'1.0-0' }}</td>
                        <td>
                            <button type="button" pButton icon="pi pi-pencil" class="p-button-text p-button-sm"
                                (click)="editGarantie(garantie, i)" [disabled]="state().submitting">
                            </button>
                            <button type="button" pButton icon="pi pi-trash"
                                class="p-button-text p-button-danger p-button-sm" (click)="deleteGarantie(i)"
                                [disabled]="state().submitting">
                            </button>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="footer">
                    <tr>
                        <td colspan="2"><strong>Total</strong></td>
                        <td><strong>{{ calculateTotalGaranties() | currency:'GNF':'symbol':'1.0-0' }}</strong></td>
                        <td><strong>{{ calculateTotalEmpruntable() | currency:'GNF':'symbol':'1.0-0' }}</strong></td>
                        <td></td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="5" class="text-center">
                            <i class="pi pi-exclamation-triangle mr-2"></i>
                            Aucune garantie ajoutée. Veuillez ajouter au moins une garantie.
                        </td>
                    </tr>
                </ng-template>
            </p-table>
            <div class="mt-3">
                <p-message severity="info">
                    <div class="flex flex-column gap-1">
                        <span><strong>Types de garanties disponibles:</strong></span>
                        <span>• <strong>Garantie Financière:</strong> Dépôt à terme, compte bloqué, etc.</span>
                        <span>• <strong>Garantie Matérielle:</strong> Biens immobiliers, véhicules, équipements,
                            etc.</span>
                        <span>• <strong>Caution Solidaire:</strong> Engagement d'un tiers garant</span>
                        <span>• <strong>Autre Garantie:</strong> Toute autre forme de garantie acceptée</span>
                    </div>
                </p-message>
            </div>

            <div class="mt-3">
                <p-message severity="info"
                    text="Note: La valeur d'emprunt est automatiquement calculée à 75% de la valeur de la garantie">
                </p-message>
            </div>

        </p-panel>

        <!-- Actions Buttons -->
        <div class="flex justify-content-between align-items-center mt-4">
            <div>
                <button type="button" pButton icon="pi pi-arrow-left" label="Retour" class="p-button-secondary"
                    (click)="router.navigate(['/demandes'])" [disabled]="state().submitting">
                </button>
            </div>
            <div class="flex gap-2">
                <button type="button" pButton icon="pi pi-times" label="Annuler" class="p-button-danger"
                    (click)="demandeForm.resetForm()" [disabled]="state().submitting">
                </button>
                <button type="submit" pButton icon="pi pi-save" label="Soumettre la demande"
                    [loading]="state().submitting"
                    [disabled]="demandeForm.invalid || state().submitting || state().garanties.length === 0">
                </button>
            </div>
        </div>

    </form>

    <!-- Dialog for Adding/Editing Garantie -->
    <p-dialog [(visible)]="state().showGarantieDialog"
        [header]="state().editingGarantieIndex !== undefined ? 'Modifier la garantie' : 'Ajouter une garantie'"
        [modal]="true" [style]="{ width: '500px' }" [draggable]="false" [resizable]="false">

        <div class="grid">
            <div class="col-12">
                <label for="typeGarantie" class="block mb-2">Type de garantie *</label>
                <p-dropdown [(ngModel)]="state().currentGarantie.typeGarantie" [options]="typeGarantieOptions"
                    optionLabel="label" optionValue="value" placeholder="Sélectionner" styleClass="w-full">
                    <ng-template pTemplate="selectedItem" let-option>
                        <div class="flex align-items-center" *ngIf="option">
                            @switch(option.value) {
                            @case('Garantie Financiere') {
                            <i class="pi pi-dollar mr-2 text-green-500"></i>
                            }
                            @case('Garantie Materielle') {
                            <i class="pi pi-box mr-2 text-blue-500"></i>
                            }
                            @case('Caution Solidaire') {
                            <i class="pi pi-users mr-2 text-orange-500"></i>
                            }
                            @default {
                            <i class="pi pi-question-circle mr-2 text-gray-500"></i>
                            }
                            }
                            <span>{{ option.label }}</span>
                        </div>
                    </ng-template>
                    <ng-template pTemplate="item" let-option>
                        <div class="flex align-items-center">
                            @switch(option.value) {
                            @case('Garantie Financiere') {
                            <i class="pi pi-dollar mr-2 text-green-500"></i>
                            }
                            @case('Garantie Materielle') {
                            <i class="pi pi-box mr-2 text-blue-500"></i>
                            }
                            @case('Caution Solidaire') {
                            <i class="pi pi-users mr-2 text-orange-500"></i>
                            }
                            @default {
                            <i class="pi pi-question-circle mr-2 text-gray-500"></i>
                            }
                            }
                            <span>{{ option.label }}</span>
                        </div>
                    </ng-template>
                </p-dropdown>
            </div>

            <!-- Exemples de description selon le type sélectionné -->
            <div class="col-12">
                @if(state().currentGarantie.typeGarantie === 'Garantie Financiere') {
                <p-message severity="info" [closable]="false"
                    text="Ex: Compte DAT n°12345 à la Banque XYZ, montant 50.000.000 GNF">
                </p-message>
                }
                @if(state().currentGarantie.typeGarantie === 'Garantie Materielle') {
                <p-message severity="info" [closable]="false"
                    text="Ex: Terrain avec titre foncier n°TF-2024-001, superficie 500m²">
                </p-message>
                }
                @if(state().currentGarantie.typeGarantie === 'Caution Solidaire') {
                <p-message severity="info" [closable]="false"
                    text="Ex: M. Jean DUPONT, fonctionnaire, matricule n°12345">
                </p-message>
                }
            </div>

            <div class="col-12">
                <label for="descriptionGarantie" class="block mb-2">Description de la garantie *</label>
                <textarea pTextarea [(ngModel)]="state().currentGarantie.descriptionGarantie" rows="3" class="w-full"
                    placeholder="Décrivez précisément la garantie proposée">
            </textarea>
            </div>

            <div class="col-12">
                <label for="valeurGarantie" class="block mb-2">Valeur de la garantie (GNF) *</label>
                <p-inputNumber [(ngModel)]="state().currentGarantie.valeurGarantie" mode="currency" currency="GNF"
                    locale="fr-FR" [min]="1" styleClass="w-full">
                </p-inputNumber>
            </div>

            <div class="col-12">
                <p-message severity="success" [closable]="false">
                    <div class="flex justify-content-between align-items-center w-full">
                        <span>Valeur empruntable (75%):</span>
                        <strong>{{ (state().currentGarantie.valeurGarantie * 0.75) | currency:'GNF':'symbol':'1.0-0'
                            }}</strong>
                    </div>
                </p-message>
            </div>
        </div>

        <ng-template pTemplate="footer">
            <button type="button" pButton icon="pi pi-times" label="Annuler" class="p-button-text"
                (click)="cancelGarantie()">
            </button>
            <button type="button" pButton icon="pi pi-check" label="Valider" (click)="saveGarantie()" [disabled]="!state().currentGarantie.typeGarantie || 
                       !state().currentGarantie.descriptionGarantie || 
                       state().currentGarantie.valeurGarantie <= 0">
            </button>
        </ng-template>

    </p-dialog>

</div>