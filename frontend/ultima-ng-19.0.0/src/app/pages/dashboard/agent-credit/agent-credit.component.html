<div class="card h-full">
    <p-toast></p-toast>

    <div class="p-2 h-full flex flex-col justify-between">
        <div class="flex items-center justify-between mb-4">
            <div class="flex gap-4 flex-col justify-between w-full md:flex-row md:items-center">
                <div class="flex gap-4 items-center">
                    <div class="text-4xl">ðŸ‘‹</div>
                    <div class="flex flex-col gap-1 text-surface-600 dark:text-surface-200">
                        <span class="text-2xl font-semibold">
                            Bonjour,
                            <span class="text-color">
                                {{ state().user?.firstName }} {{ state().user?.lastName }}!
                            </span>
                        </span>
                        <span>
                            Point de Service
                            <span class="font-bold text-primary">
                                &#64; {{ state().pointVente?.libele }} : {{ state().pointVente?.code }}
                            </span>
                        </span>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    @if(state().user?.role === 'AGENT_CREDIT' && state().nombreDemandeInd! > 0) {
                    <p-message severity="info">
                        Nouvelle demande Pour la Selection, Voir plus de dÃ©tails.
                        <a [routerLink]="['/dashboards/agent-credit/list-selection-ind']"
                            class="px-2 py-1 ml-2 font-bold bg-blue-100 text-blue-700 rounded-md border border-blue-300 hover:bg-blue-200">
                            Voir la liste â†’
                        </a>
                    </p-message>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Status Check -->
    @if(state().checkingStatus) {
    <div class="flex justify-center items-center py-8">
        <div class="flex flex-col items-center gap-3">
            <i class="pi pi-spin pi-spinner text-4xl text-blue-500"></i>
            <p class="text-gray-600">VÃ©rification de votre statut d'activation...</p>
        </div>
    </div>
    }

    <!-- Agent Inactive Warning -->
    @if(!state().checkingStatus && state().isAgentActive === false) {
    <div class="card bg-red-50 border-2 border-red-200 p-6 mx-4 my-6">
        <div class="flex items-start gap-4">
            <div class="flex-shrink-0">
                <i class="pi pi-exclamation-triangle text-5xl text-red-600"></i>
            </div>
            <div class="flex-1">
                <h3 class="text-2xl font-bold text-red-800 mb-3">
                    ðŸš« AccÃ¨s Restreint - Agent Non ActivÃ©
                </h3>
                <div class="space-y-3 text-red-700">
                    <p class="text-lg font-semibold">
                        Vous n'Ãªtes pas activÃ© dans ce point de service.
                    </p>
                    <p class="text-base">
                        Pour accÃ©der aux fonctionnalitÃ©s de gestion des crÃ©dits, votre compte doit Ãªtre activÃ©
                        par le Responsable d'Agence (RA) pour ce point de service.
                    </p>
                    <div class="bg-white rounded-lg p-4 border border-red-300 mt-4">
                        <h4 class="font-semibold text-red-800 mb-2">ðŸ“‹ Que faire ?</h4>
                        <ul class="list-disc list-inside space-y-2 text-red-700">
                            <li>Contactez votre Responsable d'Agence (RA)</li>
                            <li>Demandez l'activation de votre compte pour ce point de service</li>
                            <li>Une fois activÃ©, rafraÃ®chissez cette page</li>
                        </ul>
                    </div>
                    @if(state().user) {
                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-300 rounded-lg">
                        <p class="text-yellow-800 text-sm">
                            <i class="pi pi-info-circle mr-2"></i>
                            <strong>Note:</strong> Votre point de service actuel est
                            <strong>{{ state().pointVente?.libele }} ({{ state().pointVente?.code }})</strong>
                        </p>
                    </div>
                    }
                </div>
                <div class="mt-6 flex gap-3">
                    <button pButton pRipple label="VÃ©rifier mon statut" icon="pi pi-refresh" (click)="refresh()"
                        [loading]="state().checkingStatus" class="p-button-outlined p-button-danger">
                    </button>
                    <button pButton pRipple label="Recharger la page" icon="pi pi-replay" (click)="reloadPage()"
                        class="p-button-outlined">
                    </button>
                </div>
            </div>
        </div>
    </div>
    }

    <!-- Content - Only show if agent is active -->
    @if(state().isAgentActive === true && !state().checkingStatus) {

    <!-- CrÃ©dits Table -->
    @if(state().creditDtos?.length! > 0) {
    <div class="card mt-5">
        <h3 class="text-xl font-medium mb-3">
            Liste des CrÃ©dits NotÃ©s par le Directeur D'agence
        </h3>
        <p-table #dtCredits [value]="state().creditDtos!" [paginator]="true" paginatorDropdownAppendTo="body"
            [rows]="10" [showCurrentPageReport]="true" responsiveLayout="scroll"
            currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
            [rowsPerPageOptions]="[10, 25, 50]">

            <ng-template pTemplate="caption">
                <div class="flex flex-wrap gap-2 items-center justify-between">
                    <p-icon-field class="w-full sm:w-80 order-1 sm:order-none">
                        <p-inputicon class="pi pi-search" />
                        <input pInputText type="text" (input)="onGlobalFilter(dtCredits, $event)"
                            placeholder="Recherche globale" class="w-full" />
                    </p-icon-field>
                </div>
            </ng-template>

            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="dateCreation" class="white-space-nowrap" style="width:15%">
                        Date <p-sortIcon field="dateCreation"></p-sortIcon>
                    </th>
                    <th pSortableColumn="codeMembre" class="white-space-nowrap" style="width:15%">
                        NÂ° Membre <p-sortIcon field="codeMembre"></p-sortIcon>
                    </th>
                    <th pSortableColumn="status" class="white-space-nowrap" style="width:15%">
                        Statut CrÃ©dit <p-sortIcon field="status"></p-sortIcon>
                    </th>
                    <th class="white-space-nowrap" style="width:15%">Action</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-credit>
                <tr>
                    <td>{{ credit.createAt | date: 'dd/MM/yyyy' }}</td>
                    <td>{{ credit.codeMembre }}</td>
                    <td>
                        <p-tag [value]="credit.status" [severity]="getStatusSeverity(credit.status, '')">
                        </p-tag>
                    </td>
                    <td>
                        <button pButton pRipple label="DÃ©tails"
                            (click)="viewCreditDetails(credit.referenceCredit, credit.codeMembre)" class="ml-auto" text>
                        </button>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="6" class="text-center p-4">Aucun crÃ©dit trouvÃ©.</td>
                </tr>
            </ng-template>
        </p-table>
    </div>
    }

    <!-- Section: Demandes a Corriger (rejetees par DA) -->
    @if(hasWorkflowEnCorrection()) {
    <div class="card mt-5 border-l-4 border-red-500">
        <div class="flex flex-wrap gap-3 items-center justify-between mb-4">
            <h3 class="text-xl font-semibold m-0">
                <i class="pi pi-exclamation-triangle mr-2 text-red-600"></i>
                Demandes a Corriger (rejetees par DA)
                <p-badge [value]="state().workflowEnCorrection.length.toString()" severity="danger"
                    class="ml-2"></p-badge>
            </h3>
            <p-button icon="pi pi-refresh" (click)="refresh()" severity="secondary" size="small"></p-button>
        </div>

        <p-table #dtCorrection [value]="state().workflowEnCorrection" [paginator]="true" [rows]="10"
            [showCurrentPageReport]="true" responsiveLayout="scroll"
            currentPageReportTemplate="Affichage de {first} a {last} sur {totalRecords}"
            [rowsPerPageOptions]="[10, 25, 50]" [globalFilterFields]="['nom', 'prenom', 'numeroMembre', 'motifRejetDa']"
            styleClass="p-datatable-striped">

            <ng-template pTemplate="caption">
                <div class="flex flex-wrap gap-3 items-center justify-between">
                    <p-icon-field class="w-full sm:w-80">
                        <p-inputicon class="pi pi-search" />
                        <input pInputText type="text" (input)="onGlobalFilter(dtCorrection, $event)"
                            placeholder="Rechercher..." class="w-full" />
                    </p-icon-field>
                </div>
            </ng-template>

            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="createdAt" style="width:12%">Date <p-sortIcon field="createdAt"></p-sortIcon>
                    </th>
                    <th pSortableColumn="nom" style="width:18%">Client <p-sortIcon field="nom"></p-sortIcon></th>
                    <th class="text-right" style="width:15%">Montant</th>
                    <th style="width:25%">Motif de rejet</th>
                    <th style="width:15%">Sections a revoir</th>
                    <th class="text-center" style="width:15%">Actions</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-demande>
                <tr class="hover:bg-surface-50">
                    <td>{{ demande.createdAt | date:'dd/MM/yyyy' }}</td>
                    <td>
                        <div class="flex flex-col gap-1">
                            <span class="font-semibold">{{ demande.prenom }} {{ demande.nom }}</span>
                            <small class="text-500">{{ demande.numeroMembre }}</small>
                        </div>
                    </td>
                    <td class="text-right font-bold text-red-600">{{ formatMontantGNF(demande.montantDemande) }}</td>
                    <td>
                        <span>{{ demande.motifRejetDa }}</span>
                        <br *ngIf="demande.instructionsAc">
                        <small *ngIf="demande.instructionsAc" class="text-blue-600"><i
                                class="pi pi-info-circle mr-1"></i>{{ demande.instructionsAc }}</small>
                    </td>
                    <td><small>{{ demande.sectionsARevoirDa }}</small></td>
                    <td class="text-center">
                        <div class="flex gap-2 justify-center">
                            @if(hasDemandeCorrectionSection(demande)) {
                            <p-button icon="pi pi-pencil" label="Modifier la demande"
                                (click)="navigateCorrectionDemande(demande.demandeIndividuelId)" size="small"
                                severity="danger"></p-button>
                            }
                            <p-button icon="pi pi-eye" label="Corriger"
                                (click)="viewDemandeDetail(demande.demandeIndividuelId)" size="small"
                                severity="warn"></p-button>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="6" class="text-center p-6">
                        <i class="pi pi-check-circle text-4xl text-green-500 mb-3"></i>
                        <p class="text-600">Aucune demande a corriger</p>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
    }

    <!-- Section: Demandes Rejetees par DR - A Corriger par AC -->
    @if(hasWorkflowCorrectionDR()) {
    <div class="card mt-5 border-l-4 border-orange-500">
        <div class="flex flex-wrap gap-3 items-center justify-between mb-4">
            <h3 class="text-xl font-semibold m-0">
                <i class="pi pi-exclamation-circle mr-2 text-orange-600"></i>
                Demandes Rejetees par le DR - A Corriger
                <p-badge [value]="state().workflowCorrectionDR.length.toString()" severity="danger"
                    class="ml-2"></p-badge>
            </h3>
            <p-button icon="pi pi-refresh" (click)="refresh()" severity="secondary" size="small"></p-button>
        </div>

        <p-table #dtCorrectionDR [value]="state().workflowCorrectionDR" [paginator]="true" [rows]="10"
            [showCurrentPageReport]="true" responsiveLayout="scroll"
            currentPageReportTemplate="Affichage de {first} a {last} sur {totalRecords}"
            [rowsPerPageOptions]="[10, 25, 50]"
            [globalFilterFields]="['nom', 'prenom', 'numeroMembre', 'motifRejetDr']"
            styleClass="p-datatable-striped">

            <ng-template pTemplate="caption">
                <div class="flex flex-wrap gap-3 items-center justify-between">
                    <p-icon-field class="w-full sm:w-80">
                        <p-inputicon class="pi pi-search" />
                        <input pInputText type="text" (input)="onGlobalFilter(dtCorrectionDR, $event)"
                            placeholder="Rechercher..." class="w-full" />
                    </p-icon-field>
                </div>
            </ng-template>

            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="createdAt" style="width:12%">Date <p-sortIcon field="createdAt"></p-sortIcon></th>
                    <th pSortableColumn="nom" style="width:18%">Client <p-sortIcon field="nom"></p-sortIcon></th>
                    <th class="text-right" style="width:15%">Montant</th>
                    <th style="width:25%">Motif de rejet DR</th>
                    <th style="width:15%">Sections a revoir</th>
                    <th class="text-center" style="width:15%">Actions</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-demande>
                <tr class="hover:bg-surface-50">
                    <td>{{ demande.createdAt | date:'dd/MM/yyyy' }}</td>
                    <td>
                        <div class="flex flex-col gap-1">
                            <span class="font-semibold">{{ demande.prenom }} {{ demande.nom }}</span>
                            <small class="text-500">{{ demande.numeroMembre }}</small>
                        </div>
                    </td>
                    <td class="text-right font-bold text-orange-600">{{ formatMontantGNF(demande.montantDemande) }}</td>
                    <td>
                        <span>{{ demande.motifRejetDr }}</span>
                        <br *ngIf="demande.instructionsDa">
                        <small *ngIf="demande.instructionsDa" class="text-blue-600"><i
                                class="pi pi-info-circle mr-1"></i>{{ demande.instructionsDa }}</small>
                    </td>
                    <td><small>{{ demande.sectionsARevoirDr }}</small></td>
                    <td class="text-center">
                        <p-button icon="pi pi-eye" label="Corriger"
                            (click)="viewDemandeDetail(demande.demandeIndividuelId)" size="small"
                            severity="warn"></p-button>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="6" class="text-center p-6">
                        <i class="pi pi-check-circle text-4xl text-green-500 mb-3"></i>
                        <p class="text-600">Aucune demande rejetee par DR</p>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
    }

    <!-- Section: Suivi des demandes en validation -->
    @if(hasSuiviValidation()) {
    <div class="card mt-5 border-l-4 border-indigo-500">
        <div class="flex flex-wrap gap-3 items-center justify-between mb-4">
            <h3 class="text-xl font-semibold m-0">
                <i class="pi pi-sync mr-2 text-indigo-600"></i>
                Suivi des demandes en cours de validation
                <p-badge [value]="state().workflowSuiviValidation.length.toString()" severity="info"
                    class="ml-2"></p-badge>
            </h3>
            <p-button icon="pi pi-refresh" (click)="refresh()" severity="secondary" size="small"></p-button>
        </div>

        <p-table #dtSuivi [value]="state().workflowSuiviValidation" [paginator]="true" [rows]="10"
            [showCurrentPageReport]="true" responsiveLayout="scroll"
            currentPageReportTemplate="Affichage de {first} a {last} sur {totalRecords}"
            [rowsPerPageOptions]="[10, 25, 50]"
            [globalFilterFields]="['nom', 'prenom', 'numeroMembre', 'objectCredit', 'validationState']"
            styleClass="p-datatable-striped">

            <ng-template pTemplate="caption">
                <div class="flex flex-wrap gap-3 items-center justify-between">
                    <p-icon-field class="w-full sm:w-80">
                        <p-inputicon class="pi pi-search" />
                        <input pInputText type="text" (input)="onGlobalFilter(dtSuivi, $event)"
                            placeholder="Rechercher..." class="w-full" />
                    </p-icon-field>
                </div>
            </ng-template>

            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="createdAt" style="width:12%">Date <p-sortIcon field="createdAt"></p-sortIcon>
                    </th>
                    <th pSortableColumn="nom" style="width:22%">Client <p-sortIcon field="nom"></p-sortIcon></th>
                    <th class="text-right" style="width:16%">Montant</th>
                    <th style="width:18%">Objet</th>
                    <th pSortableColumn="validationState" class="text-center" style="width:18%">Etape <p-sortIcon
                            field="validationState"></p-sortIcon></th>
                    <th class="text-center" style="width:14%">Actions</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-demande>
                <tr class="hover:bg-surface-50">
                    <td>{{ demande.createdAt | date:'dd/MM/yyyy' }}</td>
                    <td>
                        <div class="flex flex-col gap-1">
                            <span class="font-semibold">{{ demande.prenom }} {{ demande.nom }}</span>
                            <small class="text-500">{{ demande.numeroMembre }}</small>
                        </div>
                    </td>
                    <td class="text-right font-bold">{{ formatMontantGNF(demande.montantDemande) }}</td>
                    <td>{{ demande.objectCredit }}</td>
                    <td class="text-center">
                        <p-tag [value]="getValidationStateLabel(demande.validationState)"
                            [severity]="getValidationStateSeverity(demande.validationState)"></p-tag>
                    </td>
                    <td class="text-center">
                        <p-button icon="pi pi-eye" label="Voir" (click)="viewDemandeDetail(demande.demandeIndividuelId)"
                            size="small" severity="info"></p-button>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="6" class="text-center p-6">
                        <i class="pi pi-check-circle text-4xl text-green-500 mb-3"></i>
                        <p class="text-600">Aucune demande en cours de validation</p>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
    }
    }
</div>