<div class="logistique-container">
    <!-- Toast pour les notifications -->
    <p-toast position="top-right"></p-toast>

    <!-- Header -->
    <p-card styleClass="header-card mb-4">
        <div class="flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h2 class="text-2xl font-bold text-primary m-0 mb-2">
                    <i class="pi pi-box mr-2"></i>
                    Gestion Logistique - Bons Acceptés
                </h2>
                <p class="text-600 m-0">
                    Bons de commande validés par le DE, prêts pour traitement
                </p>
            </div>
            <div class="flex gap-2">
                <p-button icon="pi pi-refresh" label="Actualiser" [outlined]="true" (onClick)="loadStockAcceptes()"
                    [loading]="loading()">
                </p-button>
                <p-button icon="pi pi-print" label="Imprimer" severity="secondary"
                    [disabled]="filteredStocks().length === 0" (onClick)="printRapportSynthese()"
                    pTooltip="Imprimer le rapport synthétique">
                </p-button>
            </div>
        </div>
    </p-card>

    <!-- Statistiques -->
    @if (!loading()) {
    <div class="grid mb-4">
        <div class="col-12 md:col-4">
            <div class="stat-card stat-total">
                <div class="stat-icon">
                    <i class="pi pi-list"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">{{ totalCommandes() }}</div>
                    <div class="stat-label">Commandes à traiter</div>
                </div>
            </div>
        </div>
        <div class="col-12 md:col-4">
            <div class="stat-card stat-quantity">
                <div class="stat-icon">
                    <i class="pi pi-box"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">{{ totalQuantite() }}</div>
                    <div class="stat-label">Quantité totale</div>
                </div>
            </div>
        </div>
        <div class="col-12 md:col-4">
            <div class="stat-card stat-delegations">
                <div class="stat-icon">
                    <i class="pi pi-map-marker"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">{{ getCommandesParDelegation().length }}</div>
                    <div class="stat-label">Délégations</div>
                </div>
            </div>
        </div>
    </div>
    }

    <!-- Loading Spinner -->
    @if (loading()) {
    <div class="flex justify-content-center align-items-center" style="min-height: 300px;">
        <div class="text-center">
            <p-progressSpinner></p-progressSpinner>
            <p class="mt-3 text-600">Chargement des bons acceptés...</p>
        </div>
    </div>
    }

    <!-- Filtres et Table -->
    @if (!loading()) {
    <p-card>
        <ng-template pTemplate="header">
            <div class="p-4 border-bottom-1 surface-border">
                <div class="flex justify-content-between align-items-center flex-wrap gap-3">
                    <h3 class="m-0 text-xl font-semibold">
                        <i class="pi pi-check-circle mr-2 text-green-500"></i>
                        Bons de Commande Acceptés par le DE
                    </h3>

                    <!-- Filtres et Actions -->
                    <div class="flex gap-2 flex-wrap align-items-center">
                        <span class="p-input-icon-left">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" placeholder="Rechercher..." [ngModel]="searchTerm()"
                                (ngModelChange)="searchTerm.set($event)" />
                        </span>
                        <p-dropdown [options]="delegations()" [ngModel]="selectedDelegation()"
                            (ngModelChange)="selectedDelegation.set($event)" optionLabel="label" optionValue="value"
                            placeholder="Filtrer par délégation" [style]="{'min-width': '200px'}">
                        </p-dropdown>

                        <!-- Boutons d'impression -->
                        <div class="flex gap-1 ml-2">
                            <p-button icon="pi pi-file" severity="info" [outlined]="true" size="small"
                                [disabled]="filteredStocks().length === 0" (onClick)="printRapportSynthese()"
                                pTooltip="Rapport synthétique">
                            </p-button>
                            <p-button icon="pi pi-file-pdf" severity="danger" [outlined]="true" size="small"
                                [disabled]="filteredStocks().length === 0" (onClick)="printRapportComplet()"
                                pTooltip="Rapport complet avec détails">
                            </p-button>
                        </div>
                    </div>
                </div>
            </div>
        </ng-template>

        @if (filteredStocks().length > 0) {
        <p-table [value]="filteredStocks()" [tableStyle]="{ 'min-width': '80rem' }"
            styleClass="p-datatable-striped p-datatable-gridlines" [paginator]="true" [rows]="10"
            [rowsPerPageOptions]="[5, 10, 25, 50]" [showCurrentPageReport]="true"
            currentPageReportTemplate="Affichage {first} à {last} sur {totalRecords} commandes">

            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 3%"></th>
                    <th style="width: 12%">N° Commande</th>
                    <th>Service</th>
                    <th>Délégation</th>
                    <th>Demandeur</th>
                    <th style="width: 8%" class="text-center">Qté</th>
                    <th style="width: 10%" class="text-center">État</th>
                    <th style="width: 12%">Date Acceptation</th>
                    <th style="width: 8%" class="text-center">Actions</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-stock>
                <tr [class.row-expanded]="isExpanded(stock)">
                    <td>
                        <button pButton type="button"
                            [icon]="isExpanded(stock) ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                            class="p-button-text p-button-rounded p-button-sm" (click)="toggleRow(stock)">
                        </button>
                    </td>
                    <td>
                        <span class="font-bold text-primary">{{ stock.numeroCommande }}</span>
                    </td>
                    <td>
                        <span class="service-badge">{{ stock.service }}</span>
                    </td>
                    <td>
                        <span class="delegation-badge">
                            <i class="pi pi-map-marker mr-1"></i>
                            {{ stock.delegationLibele || '-' }}
                        </span>
                    </td>
                    <td>
                        <div class="flex flex-column">
                            <span class="font-semibold">{{ stock.userFullName || stock.username }}</span>
                            <small class="text-500">{{ stock.agenceLibele }}</small>
                        </div>
                    </td>
                    <td class="text-center">
                        <div class="quantity-display">
                            @if (stock.qteSuggeree && stock.qteSuggeree !== stock.qte) {
                            <span class="quantity-original">{{ stock.qte }}</span>
                            <i class="pi pi-arrow-right mx-1 text-orange-500"></i>
                            <span class="quantity-suggested">{{ stock.qteSuggeree }}</span>
                            } @else {
                            <span class="quantity-normal">{{ stock.qteSuggeree || stock.qte }}</span>
                            }
                        </div>
                    </td>
                    <td class="text-center">
                        <p-tag [value]="getValidationLabel(stock.stateValidation)"
                            [severity]="getValidationSeverity(stock.stateValidation)">
                        </p-tag>
                    </td>
                    <td>
                        <span class="text-sm">{{ formatDate(stock.dateTraitement) }}</span>
                    </td>
                    <td class="text-center">
                        <div class="flex gap-1 justify-content-center">
                            <button pButton type="button" icon="pi pi-eye"
                                class="p-button-info p-button-rounded p-button-sm" (click)="openDetailDialog(stock)"
                                pTooltip="Voir les détails">
                            </button>
                            <button pButton type="button" icon="pi pi-print"
                                class="p-button-secondary p-button-rounded p-button-sm" (click)="printCommande(stock)"
                                pTooltip="Imprimer cette commande">
                            </button>
                            <button pButton type="button" icon="pi pi-check"
                                class="p-button-success p-button-rounded p-button-sm" (click)="quickValidate(stock)"
                                [disabled]="processingAction()" pTooltip="Valider - Marquer comme traité">
                            </button>
                        </div>
                    </td>
                </tr>

                <!-- Ligne expansible avec détails -->
                @if (isExpanded(stock)) {
                <tr [@rowExpand]="'expanded'">
                    <td colspan="9">
                        <div class="detail-container">
                            <div class="grid">
                                <!-- Informations de la commande -->
                                <div class="col-12 md:col-4">
                                    <div class="detail-section">
                                        <h5 class="detail-title">
                                            <i class="pi pi-info-circle"></i>
                                            Informations
                                        </h5>
                                        <div class="detail-item">
                                            <span class="label">Service:</span>
                                            <span class="value">{{ stock.service }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="label">Catégorie:</span>
                                            <span class="value">{{ stock.categorieLibele || '-' }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="label">Détails:</span>
                                            <span class="value">{{ parseDetails(stock.detailBonCommande)?.detailStandard
                                                || '-' }}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Localisation -->
                                <div class="col-12 md:col-4">
                                    <div class="detail-section">
                                        <h5 class="detail-title">
                                            <i class="pi pi-map-marker"></i>
                                            Localisation
                                        </h5>
                                        <div class="detail-item">
                                            <span class="label">Délégation:</span>
                                            <span class="value">{{ stock.delegationLibele || '-' }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="label">Agence:</span>
                                            <span class="value">{{ stock.agenceLibele || '-' }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="label">Point de vente:</span>
                                            <span class="value">{{ stock.pointventeLibele || '-' }}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quantités et motif -->
                                <div class="col-12 md:col-4">
                                    <div class="detail-section">
                                        <h5 class="detail-title">
                                            <i class="pi pi-box"></i>
                                            Quantités
                                        </h5>
                                        <div class="detail-item">
                                            <span class="label">Qté demandée:</span>
                                            <span class="value">{{ stock.qte }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="label">Qté actuelle:</span>
                                            <span class="value">{{ stock.qteActuelle || stock.qte }}</span>
                                        </div>
                                        @if (stock.qteSuggeree) {
                                        <div class="detail-item">
                                            <span class="label">Qté validée:</span>
                                            <span class="value text-green-600 font-bold">{{ stock.qteSuggeree }}</span>
                                        </div>
                                        }
                                        @if (stock.motifQte) {
                                        <div class="detail-item">
                                            <span class="label">Motif:</span>
                                            <span class="value text-orange-600">{{ stock.motifQte }}</span>
                                        </div>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Observations -->
                            @if (stock.observations) {
                            <div class="observations-section mt-3">
                                <h5 class="detail-title">
                                    <i class="pi pi-comment"></i>
                                    Observations
                                </h5>
                                <p class="observations-text">{{ stock.observations }}</p>
                            </div>
                            }
                        </div>
                    </td>
                </tr>
                }
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="9" class="text-center p-5">
                        <div class="empty-state">
                            <i class="pi pi-inbox text-5xl text-400 mb-3"></i>
                            <p class="text-600 m-0">Aucun bon de commande accepté trouvé</p>
                            <small class="text-400">Les bons validés par le DE apparaîtront ici</small>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="summary">
                <div class="flex justify-content-between align-items-center">
                    <span>
                        <strong>{{ filteredStocks().length }}</strong> commande(s) -
                        <strong>{{ totalQuantite() }}</strong> unité(s) au total
                    </span>
                </div>
            </ng-template>
        </p-table>
        } @else {
        <div class="empty-state-large">
            <i class="pi pi-check-circle text-6xl text-green-300 mb-4"></i>
            <h3 class="text-600 mb-2">Aucun bon de commande en attente</h3>
            <p class="text-400">
                Les bons de commande acceptés par le Directeur d'Exploitation apparaîtront ici.
            </p>
            <p-button icon="pi pi-refresh" label="Actualiser" [outlined]="true" (onClick)="loadStockAcceptes()"
                class="mt-3">
            </p-button>
        </div>
        }
    </p-card>

    <!-- Résumé par délégation -->
    @if (getCommandesParDelegation().length > 1) {
    <p-card styleClass="mt-4">
        <ng-template pTemplate="header">
            <div class="p-4 border-bottom-1 surface-border">
                <h3 class="m-0 text-xl font-semibold">
                    <i class="pi pi-chart-bar mr-2 text-primary"></i>
                    Synthèse par Délégation
                </h3>
            </div>
        </ng-template>

        <div class="grid">
            @for (item of getCommandesParDelegation(); track item.delegation) {
            <div class="col-12 md:col-6 lg:col-4 xl:col-3">
                <div class="delegation-summary-card" (click)="selectedDelegation.set(item.delegation)">
                    <div class="delegation-name">
                        <i class="pi pi-map-marker mr-2"></i>
                        {{ item.delegation }}
                    </div>
                    <div class="delegation-stats">
                        <span class="stat">
                            <strong>{{ item.count }}</strong> cmd
                        </span>
                        <span class="stat">
                            <strong>{{ item.quantite }}</strong> unités
                        </span>
                    </div>
                </div>
            </div>
            }
        </div>
    </p-card>
    }
    }
</div>

<!-- Dialogue de détail -->
<p-dialog [(visible)]="showDetailDialog" [modal]="true" [draggable]="false" [resizable]="false"
    [style]="{width: '700px'}" header="Détails de la commande" [closable]="true">

    @if (selectedStock()) {
    <div class="detail-dialog-content">
        <!-- En-tête -->
        <div class="dialog-header-section mb-4">
            <div class="flex justify-content-between align-items-center">
                <div>
                    <h4 class="m-0 text-primary">{{ selectedStock()!.numeroCommande }}</h4>
                    <span class="text-600">{{ selectedStock()!.service }}</span>
                </div>
                <p-tag [value]="getValidationLabel(selectedStock()!.stateValidation!)"
                    [severity]="getValidationSeverity(selectedStock()!.stateValidation!)" styleClass="text-lg px-3">
                </p-tag>
            </div>
        </div>

        <p-divider></p-divider>

        <!-- Informations -->
        <div class="grid">
            <div class="col-12 md:col-6">
                <div class="info-group">
                    <h5 class="text-primary mb-3">
                        <i class="pi pi-user mr-2"></i>Demandeur
                    </h5>
                    <p class="mb-2"><strong>Nom:</strong> {{ selectedStock()!.userFullName }}</p>
                    <p class="mb-2"><strong>Agence:</strong> {{ selectedStock()!.agenceLibele }}</p>
                    <p class="mb-2"><strong>Point de vente:</strong> {{ selectedStock()!.pointventeLibele || '-' }}</p>
                </div>
            </div>
            <div class="col-12 md:col-6">
                <div class="info-group">
                    <h5 class="text-primary mb-3">
                        <i class="pi pi-box mr-2"></i>Quantités
                    </h5>
                    <p class="mb-2"><strong>Demandée:</strong> {{ selectedStock()!.qte }}</p>
                    <p class="mb-2"><strong>Validée:</strong>
                        <span class="text-green-600 font-bold">{{ selectedStock()!.qteSuggeree || selectedStock()!.qte
                            }}</span>
                    </p>
                    @if (selectedStock()!.motifQte) {
                    <p class="mb-2"><strong>Motif:</strong>
                        <span class="text-orange-600">{{ selectedStock()!.motifQte }}</span>
                    </p>
                    }
                </div>
            </div>
        </div>

        <p-divider></p-divider>

        <!-- Dates -->
        <div class="grid">
            <div class="col-12 md:col-6">
                <p class="mb-2">
                    <i class="pi pi-calendar-plus text-blue-500 mr-2"></i>
                    <strong>Création:</strong> {{ formatDate(selectedStock()!.dateCreation) }}
                </p>
            </div>
            <div class="col-12 md:col-6">
                <p class="mb-2">
                    <i class="pi pi-calendar-check text-green-500 mr-2"></i>
                    <strong>Acceptation:</strong> {{ formatDate(selectedStock()!.dateTraitement) }}
                </p>
            </div>
        </div>

        <!-- Détails -->
        @if (selectedStock()!.detailBonCommande) {
        <div class="detail-box mt-3">
            <h5 class="text-primary mb-2">
                <i class="pi pi-file-edit mr-2"></i>Détails de la commande
            </h5>
            <p class="m-0">{{ parseDetails(selectedStock()!.detailBonCommande)?.detailStandard }}</p>
        </div>
        }

        <!-- Observations -->
        @if (selectedStock()!.observations) {
        <div class="observations-box mt-3">
            <h5 class="text-primary mb-2">
                <i class="pi pi-comment mr-2"></i>Observations
            </h5>
            <p class="m-0">{{ selectedStock()!.observations }}</p>
        </div>
        }
    </div>
    }

    <ng-template pTemplate="footer">
        <p-button label="Fermer" icon="pi pi-times" severity="secondary" (onClick)="closeDetailDialog()">
        </p-button>
    </ng-template>
</p-dialog>

<!-- Dialogue de confirmation -->
<p-confirmDialog></p-confirmDialog>

<!-- Dialogue de validation avec observations -->
<p-dialog [(visible)]="showValidationDialog" [modal]="true" [draggable]="false" [resizable]="false"
    [style]="{width: '500px'}" header="Validation de la commande" [closable]="!processingAction()">

    @if (selectedStock()) {
    <div class="validation-dialog-content">
        <div class="info-section mb-3">
            <p class="mb-2"><strong>Commande :</strong> {{ selectedStock()!.numeroCommande }}</p>
            <p class="mb-2"><strong>Service :</strong> {{ selectedStock()!.service }}</p>
            <p class="mb-2"><strong>Délégation :</strong> {{ selectedStock()!.delegationLibele }}</p>
            <p class="mb-2"><strong>Quantité :</strong> {{ selectedStock()!.qteSuggeree || selectedStock()!.qte }}</p>
        </div>

        <div class="alert-info mb-3">
            <i class="pi pi-info-circle mr-2"></i>
            <span>En validant, cette commande sera marquée comme <strong>traitée</strong> et disparaîtra de votre
                liste.</span>
        </div>

        <div class="field">
            <label for="validation-obs">Observations (optionnel)</label>
            <textarea pTextarea id="validation-obs" [(ngModel)]="validationObservations" rows="3" class="w-full"
                [disabled]="processingAction()" placeholder="Ajoutez des observations sur le traitement...">
            </textarea>
        </div>
    </div>
    }

    <ng-template pTemplate="footer">
        <p-button label="Annuler" icon="pi pi-times" severity="secondary" [text]="true"
            (onClick)="closeValidationDialog()" [disabled]="processingAction()">
        </p-button>
        <p-button label="Valider la commande" icon="pi pi-check" severity="success" (onClick)="confirmValidation()"
            [disabled]="processingAction()" [loading]="processingAction()">
        </p-button>
    </ng-template>
</p-dialog>