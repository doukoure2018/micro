<p-card class="societariat-card chart-card">
    <div class="header">
        <div>
            <h3>Évolution des corrections</h3>
            <p class="subtitle">Tendance sur les dernières {{ selectedPeriod === 'day' ? '30 jours' : '12 semaines' }}
            </p>
        </div>
        <div class="header-actions">
            <p-selectButton [options]="chartPeriodOptions" [(ngModel)]="selectedPeriod" (onChange)="onPeriodChange()"
                optionLabel="label" optionValue="value"></p-selectButton>

            <button pButton type="button" [icon]="showComparison ? 'pi pi-eye-slash' : 'pi pi-eye'"
                [label]="showComparison ? 'Masquer comparaison' : 'Comparer'" (click)="toggleComparison()"
                class="p-button-outlined p-button-secondary"></button>

            <p-selectButton [options]="viewModeOptions" [(ngModel)]="selectedViewMode" (onChange)="onViewModeChange()"
                optionLabel="label" optionValue="value"></p-selectButton>
        </div>
    </div>

    <!-- Summary Cards -->
    @if (summaryStats()) {
    <div class="summary-cards">
        <div class="summary-card summary-attente">
            <div class="summary-label">En attente</div>
            <div class="summary-value">{{ summaryStats()!.current.enAttente }}</div>
            @if (summaryStats()!.variations.enAttente !== null) {
            <div class="summary-variation" [ngClass]="getVariationClass(summaryStats()!.variations.enAttente)">
                <i [class]="getVariationIcon(summaryStats()!.variations.enAttente)"></i>
                {{ formatVariation(summaryStats()!.variations.enAttente) }}
            </div>
            }
            <div class="summary-prev">vs {{ summaryStats()!.previous.enAttente }} période préc.</div>
        </div>

        <div class="summary-card summary-rejete">
            <div class="summary-label">Rejetées</div>
            <div class="summary-value">{{ summaryStats()!.current.rejete }}</div>
            @if (summaryStats()!.variations.rejete !== null) {
            <div class="summary-variation" [ngClass]="getVariationClass(summaryStats()!.variations.rejete)">
                <i [class]="getVariationIcon(summaryStats()!.variations.rejete)"></i>
                {{ formatVariation(summaryStats()!.variations.rejete) }}
            </div>
            }
            <div class="summary-prev">vs {{ summaryStats()!.previous.rejete }} période préc.</div>
        </div>

        <div class="summary-card summary-valide">
            <div class="summary-label">Validées</div>
            <div class="summary-value">{{ summaryStats()!.current.valide }}</div>
            @if (summaryStats()!.variations.valide !== null) {
            <div class="summary-variation" [ngClass]="getVariationClass(summaryStats()!.variations.valide)">
                <i [class]="getVariationIcon(summaryStats()!.variations.valide)"></i>
                {{ formatVariation(summaryStats()!.variations.valide) }}
            </div>
            }
            <div class="summary-prev">vs {{ summaryStats()!.previous.valide }} période préc.</div>
        </div>

        <div class="summary-card summary-total">
            <div class="summary-label">Total</div>
            <div class="summary-value">{{ summaryStats()!.current.total }}</div>
            @if (summaryStats()!.variations.total !== null) {
            <div class="summary-variation" [ngClass]="getVariationClass(summaryStats()!.variations.total)">
                <i [class]="getVariationIcon(summaryStats()!.variations.total)"></i>
                {{ formatVariation(summaryStats()!.variations.total) }}
            </div>
            }
            <div class="summary-prev">vs {{ summaryStats()!.previous.total }} période préc.</div>
        </div>
    </div>
    }

    @if (chartError()) {
    <div class="error">{{ chartError() }}</div>
    }

    @if (loadingChart()) {
    <div class="loading">
        <p-progressSpinner></p-progressSpinner>
    </div>
    } @else if (selectedViewMode === 'chart' && chartData()) {
    <div class="chart-container">
        <p-chart type="line" [data]="chartData()" [options]="chartOptions" height="350px"></p-chart>
    </div>
    } @else if (selectedViewMode === 'table' && evolutionData().length > 0) {
    <div class="table-container">
        <p-table [value]="evolutionData()" [tableStyle]="{'min-width': '100%'}" [scrollable]="true"
            scrollHeight="400px">
            <ng-template pTemplate="header">
                <tr>
                    <th>Période</th>
                    <th class="text-right">En attente</th>
                    <th class="text-right">Rejetées</th>
                    <th class="text-right">Validées</th>
                    <th class="text-right">Total</th>
                    @if (showComparison) {
                    <th class="text-right">Var. Total</th>
                    }
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-row>
                <tr>
                    <td>{{ row.periode }}</td>
                    <td class="text-right en-attente">
                        {{ row.enAttente }}
                        @if (showComparison && row.enAttentePrev !== null) {
                        <span class="prev-value">({{ row.enAttentePrev }})</span>
                        }
                    </td>
                    <td class="text-right rejete">
                        {{ row.rejete }}
                        @if (showComparison && row.rejetePrev !== null) {
                        <span class="prev-value">({{ row.rejetePrev }})</span>
                        }
                    </td>
                    <td class="text-right valide">
                        {{ row.valide }}
                        @if (showComparison && row.validePrev !== null) {
                        <span class="prev-value">({{ row.validePrev }})</span>
                        }
                    </td>
                    <td class="text-right total">
                        {{ row.total }}
                        @if (showComparison && row.totalPrev !== null) {
                        <span class="prev-value">({{ row.totalPrev }})</span>
                        }
                    </td>
                    @if (showComparison) {
                    <td class="text-right">
                        <span [ngClass]="getVariationClass(row.totalVariation)">
                            <i [class]="getVariationIcon(row.totalVariation)"></i>
                            {{ formatVariation(row.totalVariation) }}
                        </span>
                    </td>
                    }
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td [attr.colspan]="showComparison ? 6 : 5" class="empty">
                        Aucune donnée disponible
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
    } @else if (selectedViewMode === 'comparison' && evolutionData().length > 0) {
    <div class="comparison-container">
        <div class="comparison-grid">
            @for (row of evolutionData(); track row.periode) {
            <div class="comparison-card">
                <div class="comparison-header">{{ row.periode }}</div>
                <div class="comparison-body">
                    <div class="comparison-row">
                        <span class="label">En attente</span>
                        <span class="current en-attente">{{ row.enAttente }}</span>
                        <span class="vs">vs</span>
                        <span class="previous">{{ row.enAttentePrev ?? '-' }}</span>
                        <span class="variation" [ngClass]="getVariationClass(row.enAttenteVariation)">
                            {{ formatVariation(row.enAttenteVariation) }}
                        </span>
                    </div>
                    <div class="comparison-row">
                        <span class="label">Rejetées</span>
                        <span class="current rejete">{{ row.rejete }}</span>
                        <span class="vs">vs</span>
                        <span class="previous">{{ row.rejetePrev ?? '-' }}</span>
                        <span class="variation" [ngClass]="getVariationClass(row.rejeteVariation)">
                            {{ formatVariation(row.rejeteVariation) }}
                        </span>
                    </div>
                    <div class="comparison-row">
                        <span class="label">Validées</span>
                        <span class="current valide">{{ row.valide }}</span>
                        <span class="vs">vs</span>
                        <span class="previous">{{ row.validePrev ?? '-' }}</span>
                        <span class="variation" [ngClass]="getVariationClass(row.valideVariation)">
                            {{ formatVariation(row.valideVariation) }}
                        </span>
                    </div>
                    <div class="comparison-row total-row">
                        <span class="label">Total</span>
                        <span class="current total">{{ row.total }}</span>
                        <span class="vs">vs</span>
                        <span class="previous">{{ row.totalPrev ?? '-' }}</span>
                        <span class="variation" [ngClass]="getVariationClass(row.totalVariation)">
                            {{ formatVariation(row.totalVariation) }}
                        </span>
                    </div>
                </div>
            </div>
            }
        </div>
    </div>
    } @else {
    <div class="empty-chart">
        <i class="pi pi-chart-line"></i>
        <p>Aucune donnée d'évolution disponible</p>
    </div>
    }
</p-card>

<!-- Stats Table Section -->
<p-card class="societariat-card">
    <div class="header">
        <div>
            <h3>Statistiques des corrections</h3>
            <p class="subtitle">Répartition par délégation (EN_ATTENTE / REJETE / VALIDE)</p>
        </div>
        <button pButton type="button" icon="pi pi-refresh" label="Rafraîchir" (click)="loadStats(); loadChartData()"
            [disabled]="isLoading()" class="p-button-outlined"></button>
    </div>

    @if (error()) {
    <div class="error">
        {{ error() }}
    </div>
    }

    @if (isLoading()) {
    <div class="loading">
        <p-progressSpinner></p-progressSpinner>
    </div>
    } @else {
    <p-table [value]="stats()" [tableStyle]="{'min-width': '100%'}">
        <ng-template pTemplate="header">
            <tr>
                <th>Délégation</th>
                <th>En attente</th>
                <th>Rejeté</th>
                <th>Validé</th>
                <th>Total</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-row>
            <tr (click)="onSelectDelegation(row)" class="clickable">
                <td>{{ row.delegationLibele || 'Non renseignée' }}</td>
                <td class="number en-attente">{{ row.enAttente }}</td>
                <td class="number rejete">{{ row.rejete }}</td>
                <td class="number valide">{{ row.valide }}</td>
                <td class="number total">{{ row.total }}</td>
            </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="5" class="empty">Aucune donnée disponible</td>
            </tr>
        </ng-template>
    </p-table>
    }
</p-card>

@if (selectedDelegation()) {
<div class="grid">
    <div class="col-12 md:col-6">
        <app-societariat-by-agence [delegationLibele]="selectedDelegation()?.delegationLibele" [stats]="agences()"
            [loading]="loadingAgences()" [error]="agenceError()"
            (agenceSelected)="onSelectAgence($event)"></app-societariat-by-agence>
    </div>
    <div class="col-12 md:col-6">
        <app-societariat-by-ps [agenceLibele]="selectedAgence()?.agenceLibele" [stats]="points()"
            [loading]="loadingPoints()" [error]="pointError()"></app-societariat-by-ps>
    </div>
</div>
}