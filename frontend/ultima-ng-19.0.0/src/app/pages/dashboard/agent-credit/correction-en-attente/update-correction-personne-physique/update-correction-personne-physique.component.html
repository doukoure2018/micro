<div class="correction-detail-container">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>

    <!-- Header Card -->
    <!-- Complete updated header section -->
    <p-card styleClass="header-card">
        <div class="header-content">
            <div class="title-section">
                <button pButton icon="pi pi-arrow-left" class="p-button-text p-button-secondary" (click)="goBack()"
                    pTooltip="Retour à la liste">
                </button>
                <h2>
                    <i class="pi pi-user-edit"></i>
                    Détails Correction - {{ state().codCliente }}
                    <!-- Status badge -->
                    <p-tag *ngIf="state().correctionApres?.correctionStatut" [value]="getCorrectionStatusLabel()"
                        [severity]="getCorrectionStatusSeverity()" class="ml-2">
                    </p-tag>
                </h2>
            </div>
            <div class="action-buttons">
                <button pButton icon="pi pi-refresh" label="Actualiser" class="p-button-outlined" (click)="refresh()"
                    [loading]="isLoading()">
                </button>

                <!-- Conditionally show action buttons based on status -->
                <ng-container *ngIf="canPerformActions()">
                    &nbsp;
                    <button pButton icon="pi pi-ban" label="Rejeter la Correction" class="p-button-danger"
                        (click)="rejetCorrection()" [disabled]="isLoading() || !state().correctionApres">
                    </button>
                    &nbsp;
                    <button pButton icon="pi pi-check" label="Valider" class="p-button-success"
                        (click)="validateCorrection()" [disabled]="isLoading() || !state().correctionApres">
                    </button>
                </ng-container>
            </div>
        </div>
    </p-card>

    <!-- Status messages for rejected or validated corrections -->
    <div *ngIf="isRejected()" class="status-message rejection-status-message">
        <p-messages severity="warn" [closable]="false">
            <ng-template pTemplate>
                <div class="flex align-items-center">
                    <i class="pi pi-ban mr-2"></i>
                    <div>
                        <strong>Correction Rejetée</strong>
                        <p class="mt-1 mb-0">Cette correction a été rejetée et ne peut plus être modifiée.</p>
                        <p class="mt-1 mb-0 text-sm" *ngIf="state().correctionApres?.updatedAt">
                            Date de rejet: {{ state().correctionApres.updatedAt }}
                        </p>
                    </div>
                </div>
            </ng-template>
        </p-messages>
    </div>

    <div *ngIf="isValidated()" class="status-message validation-status-message">
        <p-messages severity="success" [closable]="false">
            <ng-template pTemplate>
                <div class="flex align-items-center">
                    <i class="pi pi-check-circle mr-2"></i>
                    <div>
                        <strong>Correction Validée</strong>
                        <p class="mt-1 mb-0">Cette correction a été validée et appliquée dans le système SAF.</p>
                        <p class="mt-1 mb-0 text-sm" *ngIf="state().correctionApres?.updatedAt">
                            Date de validation: {{ state().correctionApres.updatedAt }}
                        </p>
                    </div>
                </div>
            </ng-template>
        </p-messages>
    </div>

    <!-- Messages -->
    <p-messages [(value)]="messages" [enableService]="false" [closable]="true"></p-messages>

    <!-- Main Content -->
    <div class="content-grid">
        <!-- Left Panel - Correction AVANT (SAF) -->
        <p-panel header="CORRECTION AVANT (SAF SQL Server)" [toggleable]="true">
            <ng-template pTemplate="icons">
                <p-chip label="Source: SAF" styleClass="custom-chip-info">
                </p-chip>
            </ng-template>

            <div class="panel-content">
                <!-- Loading State -->
                <div *ngIf="state().loadingAvant" class="loading-state">
                    <p-progressSpinner styleClass="w-4rem h-4rem" strokeWidth="3">
                    </p-progressSpinner>
                    <p>Chargement des données SAF...</p>
                </div>

                <!-- Error State -->
                <div *ngIf="state().errorAvant && !state().loadingAvant" class="error-state">
                    <i class="pi pi-exclamation-triangle"></i>
                    <p>{{ state().errorAvant }}</p>
                    <button pButton label="Réessayer" icon="pi pi-refresh" class="p-button-sm"
                        (click)="loadCorrectionAvant(state().codCliente)">
                    </button>
                </div>

                <!-- Data Display -->
                <div *ngIf="state().correctionAvant && !state().loadingAvant" class="data-display">
                    <div class="info-grid">
                        <div class="info-item" *ngFor="let item of state().comparisons">
                            <label>{{ item.label }}</label>
                            <span class="value">{{ getFormattedDisplayValue(item.avant, item.field, 'avant') }}</span>
                        </div>
                    </div>
                </div>

                <!-- No Data -->
                <div *ngIf="!state().correctionAvant && !state().loadingAvant && !state().errorAvant" class="no-data">
                    <i class="pi pi-inbox"></i>
                    <p>Aucune donnée disponible</p>
                </div>
            </div>
        </p-panel>

        <!-- Right Panel - Correction APRES (PostgreSQL) -->
        <p-panel header="CORRECTION APRES (PostgreSQL)" [toggleable]="true">
            <ng-template pTemplate="icons">
                <p-chip label="Source: PostgreSQL" styleClass="custom-chip-success">
                </p-chip>
            </ng-template>

            <div class="panel-content">
                <!-- Loading State -->
                <div *ngIf="state().loadingApres" class="loading-state">
                    <p-progressSpinner styleClass="w-4rem h-4rem" strokeWidth="3">
                    </p-progressSpinner>
                    <p>Chargement des données PostgreSQL...</p>
                </div>

                <!-- Error State -->
                <div *ngIf="state().errorApres && !state().loadingApres" class="error-state">
                    <i class="pi pi-exclamation-triangle"></i>
                    <p>{{ state().errorApres }}</p>
                    <button pButton label="Réessayer" icon="pi pi-refresh" class="p-button-sm"
                        (click)="loadCorrectionApres(state().codCliente)">
                    </button>
                </div>

                <!-- Data Display -->
                <div *ngIf="state().correctionApres && !state().loadingApres" class="data-display">
                    <div class="info-grid">
                        <div class="info-item" *ngFor="let item of state().comparisons">
                            <label>{{ item.label }}</label>
                            <span class="value" [class.highlight-difference]="item.isDifferent">
                                {{ getFormattedDisplayValue(item.apres, item.field, 'apres') }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- No Data -->
                <div *ngIf="!state().correctionApres && !state().loadingApres && !state().errorApres" class="no-data">
                    <i class="pi pi-inbox"></i>
                    <p>Pas encore corrigé</p>
                </div>
            </div>
        </p-panel>
    </div>

    <!-- Comparison Table (shown when both data are available) -->
    <p-card *ngIf="hasBothData()" styleClass="comparison-card">
        <ng-template pTemplate="header">
            <div class="comparison-header">
                <h3>
                    <i class="pi pi-chart-line"></i>
                    Tableau de Comparaison
                </h3>
                <p-chip [label]="differenceCount() + ' différence(s) trouvée(s)'"
                    [styleClass]="differenceCount() > 0 ? 'custom-chip-warning' : 'custom-chip-success'">
                </p-chip>
            </div>
        </ng-template>

        <p-table [value]="state().comparisons" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10, 25, 50]"
            styleClass="p-datatable-striped">

            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 25%">Champ</th>
                    <th style="width: 30%">Avant (SAF)</th>
                    <th style="width: 30%">Après (PostgreSQL)</th>
                    <th style="width: 15%">État</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-comparison>
                <tr [class.row-different]="comparison.isDifferent">
                    <td>
                        <strong>{{ comparison.label }}</strong>
                    </td>
                    <td>
                        <span class="value-display">
                            {{ getFormattedDisplayValue(comparison.avant, comparison.field, 'avant') }}
                        </span>
                    </td>
                    <td>
                        <span class="value-display" [class.text-warning]="comparison.isDifferent">
                            {{ getFormattedDisplayValue(comparison.apres, comparison.field, 'apres') }}
                        </span>
                    </td>
                    <td>
                        <p-tag [value]="comparison.isDifferent ? 'Différent' : 'Identique'"
                            [severity]="getDifferenceSeverity(comparison.isDifferent)">
                        </p-tag>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="4" class="text-center">
                        Aucune donnée à comparer
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="summary">
                <div class="comparison-summary">
                    <span class="summary-item">
                        <i class="pi pi-check-circle text-success"></i>
                        Identiques: <strong>{{ getIdentiquesCount() }}</strong>
                    </span>
                    <span class="summary-item">
                        <i class="pi pi-exclamation-circle text-warning"></i>
                        Différents: <strong>{{ differenceCount() }}</strong>
                    </span>
                </div>
            </ng-template>
        </p-table>
    </p-card>

    <!-- Rejection Dialog -->
    <p-dialog [(visible)]="state().showRejectionDialog" header="Rejeter la Correction" [modal]="true"
        [style]="{width: '500px'}" [closable]="!state().submittingRejection"
        [closeOnEscape]="!state().submittingRejection">

        <div class="rejection-dialog-content">
            <div class="field">
                <label for="motif" class="required">
                    Motif de rejet <span class="text-danger">*</span>
                </label>
                <small class="text-muted d-block mb-2">
                    Veuillez expliquer la raison du rejet de cette correction (minimum 10 caractères)
                </small>
                <textarea id="motif" pTextarea [(ngModel)]="state().rejectionMotif" rows="5" class="w-full"
                    [disabled]="state().submittingRejection" placeholder="Entrez le motif de rejet..."
                    [style]="{'width': '100%'}">
                </textarea>

                <small *ngIf="state().rejectionMotif" class="text-muted">
                    {{ state().rejectionMotif.length }} caractère(s)
                </small>
            </div>

            <div class="mt-3 p-2 bg-warning-light border-round">
                <i class="pi pi-exclamation-triangle text-warning mr-2"></i>
                <span class="text-warning font-semibold">Attention:</span>
                <span class="text-sm"> Cette action est irréversible. La correction sera marquée comme rejetée.</span>
            </div>
        </div>

        <ng-template pTemplate="footer">
            <button pButton type="button" label="Annuler" icon="pi pi-times" class="p-button-text"
                (click)="closeRejectionDialog()" [disabled]="state().submittingRejection">
            </button>
            <button pButton type="button" label="Confirmer le Rejet" icon="pi pi-ban" class="p-button-danger"
                (click)="submitRejection()" [loading]="state().submittingRejection"
                [disabled]="!state().rejectionMotif || state().rejectionMotif.length < 10">
            </button>
        </ng-template>
    </p-dialog>
</div>