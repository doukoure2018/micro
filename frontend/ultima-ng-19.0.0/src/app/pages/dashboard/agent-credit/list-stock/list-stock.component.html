<div class="grid">
    <div class="col-12">
        <p-toast></p-toast>
        <p-confirmDialog></p-confirmDialog>

        <p-card header="Bons de Commande - Espace DR">
            <div class="mb-3" *ngIf="user">
                <span class="ml-3 text-500">Délégation : </span>
                <span class="font-bold">{{ delegation()?.libele | uppercase}}</span>
                <span class="ml-4 text-500">Rôle : </span>
                <span class="font-bold badge"
                    [ngClass]="{'badge-dr': user.role === 'DR', 'badge-user': user.role !== 'DR'}">
                    {{ user.role }}
                </span>
            </div>

            <div *ngIf="loading()" class="flex justify-content-center p-4">
                <p-progressSpinner></p-progressSpinner>
            </div>

            <p-table *ngIf="!loading()" [value]="stocks()" [paginator]="true" [rows]="10" [showCurrentPageReport]="true"
                currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} entrées"
                responsiveLayout="scroll" dataKey="idCmd">
                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 3rem"></th>
                        <th>N° Commande</th>
                        <th>Service</th>
                        <th>Catégorie</th>
                        <th>Statut</th>
                        <th>Validation</th>
                        <th>Date Création</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-stock let-expanded="expanded">
                    <tr [ngClass]="{'row-urgent': isUrgent(stock)}">
                        <td>
                            <button type="button" pButton
                                [pTooltip]="isExpanded(stock) ? 'Masquer les détails' : 'Afficher les détails'"
                                (click)="toggleRow(stock)" class="p-button-text p-button-rounded p-button-plain"
                                [icon]="isExpanded(stock) ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
                        </td>
                        <td class="font-bold">{{ stock.numeroCommande }}</td>
                        <td>{{ stock.service }}</td>
                        <td>
                            <span class="badge badge-info">{{ stock.categorieLibele || '-' }}</span>
                        </td>
                        <td>
                            <p-tag [value]="stock.status" [severity]="getStatusSeverity(stock.status)"></p-tag>
                        </td>
                        <td>
                            <p-tag [value]="getStateValidationLabel(stock.stateValidation || 'EN_ATTENTE')"
                                [severity]="getValidationSeverity(stock.stateValidation || 'EN_ATTENTE')"></p-tag>
                        </td>
                        <td>{{ formatDate(stock.dateCreation) }}</td>
                    </tr>
                    <tr *ngIf="isExpanded(stock)" [@rowExpand]="isExpanded(stock) ? 'expanded' : 'collapsed'">
                        <td colspan="8">
                            <div class="detail-container">
                                <div class="grid">
                                    <!-- Section Informations Complètes de la Commande -->
                                    <div class="col-12">
                                        <div class="detail-card">
                                            <div class="detail-header">
                                                <i class="pi pi-info-circle"></i>
                                                <span>Informations Complètes de la Commande</span>
                                            </div>
                                            <table class="detail-table">
                                                <tbody>
                                                    <tr>
                                                        <td class="label-cell">
                                                            <i class="pi pi-user mini-icon"></i>
                                                            Demandeur
                                                        </td>
                                                        <td class="value-cell">{{ stock.userFullName || stock.username }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="label-cell">
                                                            <i class="pi pi-map-marker mini-icon"></i>
                                                            Délégation
                                                        </td>
                                                        <td class="value-cell">{{ stock.delegationLibele || '-' }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="label-cell">
                                                            <i class="pi pi-home mini-icon"></i>
                                                            Agence
                                                        </td>
                                                        <td class="value-cell">{{ stock.agenceLibele || '-' }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="label-cell">
                                                            <i class="pi pi-shopping-cart mini-icon"></i>
                                                            Point de vente
                                                        </td>
                                                        <td class="value-cell">{{ stock.pointventeLibele || '-' }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="label-cell">
                                                            <i class="pi pi-file-text mini-icon"></i>
                                                            Description
                                                        </td>
                                                        <td class="value-cell">
                                                            <div *ngIf="parseDetails(stock.detailBonCommande) as details">
                                                                <p *ngIf="details.detailStandard">{{ details.detailStandard }}</p>
                                                                <div *ngIf="!details.detailStandard">
                                                                    <div *ngFor="let key of Object.keys(details)" class="mb-1">
                                                                        <strong>{{ key }}:</strong> {{ details[key] }}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="label-cell">
                                                            <i class="pi pi-sort-numeric-up mini-icon"></i>
                                                            Quantité commandée
                                                        </td>
                                                        <td class="value-cell">{{ stock.qte || 0 }}</td>
                                                    </tr>
                                                    <tr *ngIf="stock.dateTraitement">
                                                        <td class="label-cell">
                                                            <i class="pi pi-calendar mini-icon"></i>
                                                            Date de traitement
                                                        </td>
                                                        <td class="value-cell">{{ formatDate(stock.dateTraitement) }}</td>
                                                    </tr>
                                                    <tr *ngIf="stock.traitePar">
                                                        <td class="label-cell">
                                                            <i class="pi pi-user-edit mini-icon"></i>
                                                            Traité par
                                                        </td>
                                                        <td class="value-cell">ID: {{ stock.traitePar }}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Section Observations et Motifs -->
                                    <div class="col-12" *ngIf="stock.observations || stock.motif">
                                        <div class="detail-card">
                                            <div class="detail-header">
                                                <i class="pi pi-comments"></i>
                                                <span>Observations & Motifs</span>
                                            </div>
                                            <div class="observations-content">
                                                <div class="observation-box" *ngIf="stock.observations">
                                                    <div class="observation-label">
                                                        <i class="pi pi-eye mini-icon"></i>
                                                        Observations
                                                    </div>
                                                    <div class="observation-text">{{ stock.observations }}</div>
                                                </div>
                                                <div class="motif-box" *ngIf="stock.motif">
                                                    <div class="motif-label">
                                                        <i class="pi pi-exclamation-triangle"></i>
                                                        Motif de refus/rejet
                                                    </div>
                                                    <div class="motif-text">{{ stock.motif }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Section Boutons d'action DR -->
                                    <div class="col-12">
                                        <div class="action-buttons-container">
                                            <div class="action-status-info" *ngIf="stock.dateTraitement">
                                                <i class="pi pi-info-circle"></i>
                                                <span>Traité le {{ formatDate(stock.dateTraitement) }}
                                                    <span *ngIf="stock.traitePar">par l'utilisateur #{{ stock.traitePar }}</span>
                                                </span>
                                            </div>
                                            
                                            <div class="action-buttons">
                                                <button pButton type="button" label="Rejeter" icon="pi pi-times"
                                                    class="p-button-danger p-button-raised"
                                                    [disabled]="isRejectDisabled(stock) || processingAction()"
                                                    (click)="openRejectDialog(stock)"
                                                    [pTooltip]="getRejectTooltip(stock)">
                                                </button>
                                                <button pButton type="button" label="Valider" icon="pi pi-check"
                                                    class="p-button-success p-button-raised"
                                                    [disabled]="isValidateDisabled(stock) || processingAction()"
                                                    (click)="openValidateDialog(stock)"
                                                    [pTooltip]="getValidateTooltip(stock)">
                                                </button>
                                            </div>
                                            
                                            <div class="action-info">
                                                <i class="pi pi-info-circle"></i>
                                                <span *ngIf="stock.status === 'ENCOURS' && (!stock.stateValidation || stock.stateValidation === 'EN_ATTENTE')">
                                                    Actions disponibles pour cette commande en cours
                                                </span>
                                                <span *ngIf="stock.stateValidation === 'VALIDE'">
                                                    Cette commande a été validée par un DR
                                                </span>
                                                <span *ngIf="stock.stateValidation === 'ACCEPTE'">
                                                    Cette commande a été acceptée
                                                </span>
                                                <span *ngIf="stock.stateValidation === 'REFUSE'">
                                                    Cette commande a été refusée
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="8" class="text-center p-4">
                            <i class="pi pi-inbox text-4xl text-300"></i>
                            <p class="mt-3">Aucun bon de commande trouvé</p>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </p-card>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════ -->
<!-- WORKFLOW CREDIT - Demandes a Valider par le DR                        -->
<!-- ═══════════════════════════════════════════════════════════════════════ -->
<div class="col-12" *ngIf="hasWorkflowAValiderDR()">
    <p-card styleClass="border-l-4 border-green-500">
        <div class="flex flex-wrap gap-3 items-center justify-between mb-4">
            <h3 class="text-xl font-semibold m-0">
                <i class="pi pi-check-square mr-2 text-green-600"></i>
                Demandes de Credit en attente de Validation DR
                <p-badge [value]="workflowAValiderDR().length.toString()" severity="success" class="ml-2"></p-badge>
            </h3>
            <button pButton type="button" icon="pi pi-refresh" (click)="refreshWorkflow()"
                class="p-button-secondary p-button-sm" pTooltip="Actualiser"></button>
        </div>

        <p-table #dtWorkflowDR [value]="workflowAValiderDR()" [paginator]="true" [rows]="10"
            [showCurrentPageReport]="true" responsiveLayout="scroll"
            currentPageReportTemplate="Affichage de {first} a {last} sur {totalRecords}"
            [rowsPerPageOptions]="[10, 25, 50]"
            [globalFilterFields]="['nom', 'prenom', 'numeroMembre', 'objectCredit', 'avisAgentCredit', 'avisDa']"
            styleClass="p-datatable-striped">

            <ng-template pTemplate="caption">
                <div class="flex flex-wrap gap-3 items-center justify-between">
                    <p-icon-field class="w-full sm:w-80">
                        <p-inputicon class="pi pi-search" />
                        <input pInputText type="text" (input)="onGlobalFilter(dtWorkflowDR, $event)"
                            placeholder="Rechercher..." class="w-full" />
                    </p-icon-field>
                    <div class="text-sm text-500">
                        {{ workflowAValiderDR().length }} demande(s) en attente
                    </div>
                </div>
            </ng-template>

            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="createdAt" style="width:10%">Date <p-sortIcon field="createdAt"></p-sortIcon></th>
                    <th pSortableColumn="nom" style="width:18%">Client <p-sortIcon field="nom"></p-sortIcon></th>
                    <th class="text-right" style="width:14%">Montant</th>
                    <th style="width:14%">Objet</th>
                    <th style="width:16%">Avis AC</th>
                    <th style="width:16%">Avis DA</th>
                    <th class="text-center" style="width:12%">Actions</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-demande>
                <tr class="hover:bg-surface-50">
                    <td>{{ demande.createdAt | date:'dd/MM/yyyy' }}</td>
                    <td>
                        <div class="flex flex-column gap-1">
                            <span class="font-semibold">{{ demande.prenom }} {{ demande.nom }}</span>
                            <small class="text-500">{{ demande.numeroMembre }}</small>
                        </div>
                    </td>
                    <td class="text-right font-bold text-green-600">{{ formatMontantGNF(demande.montantDemande) }}</td>
                    <td>{{ demande.objectCredit }}</td>
                    <td>
                        <small *ngIf="demande.avisAgentCredit" class="text-600">{{ demande.avisAgentCredit | slice:0:50 }}...</small>
                        <small *ngIf="!demande.avisAgentCredit" class="text-400">-</small>
                    </td>
                    <td>
                        <small *ngIf="demande.avisDa" class="text-600">{{ demande.avisDa | slice:0:50 }}...</small>
                        <small *ngIf="!demande.avisDa" class="text-400">-</small>
                    </td>
                    <td class="text-center">
                        <p-button icon="pi pi-eye" label="Voir detail"
                            (click)="viewDemandeDetail(demande.demandeIndividuelId)" size="small"
                            severity="info"></p-button>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="7" class="text-center p-6">
                        <i class="pi pi-check-circle text-4xl text-green-500 mb-3"></i>
                        <p class="text-600">Aucune demande de credit a valider</p>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </p-card>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════ -->
<!-- WORKFLOW CREDIT - Demandes Rejetees par la DE                         -->
<!-- ═══════════════════════════════════════════════════════════════════════ -->
<div class="col-12" *ngIf="hasWorkflowCorrectionDE()">
    <p-card styleClass="border-l-4 border-orange-500">
        <div class="flex flex-wrap gap-3 items-center justify-between mb-4">
            <h3 class="text-xl font-semibold m-0">
                <i class="pi pi-exclamation-circle mr-2 text-orange-600"></i>
                Demandes Rejetees par la Direction d'Exploitation
                <p-badge [value]="workflowCorrectionDE().length.toString()" severity="danger" class="ml-2"></p-badge>
            </h3>
        </div>

        <p-table #dtCorrectionDE [value]="workflowCorrectionDE()" [paginator]="true" [rows]="10"
            [showCurrentPageReport]="true" responsiveLayout="scroll"
            currentPageReportTemplate="Affichage de {first} a {last} sur {totalRecords}"
            [rowsPerPageOptions]="[10, 25, 50]"
            [globalFilterFields]="['nom', 'prenom', 'numeroMembre', 'motifRejetDe']"
            styleClass="p-datatable-striped">

            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="createdAt" style="width:12%">Date <p-sortIcon field="createdAt"></p-sortIcon></th>
                    <th pSortableColumn="nom" style="width:20%">Client <p-sortIcon field="nom"></p-sortIcon></th>
                    <th class="text-right" style="width:15%">Montant</th>
                    <th style="width:25%">Motif de rejet DE</th>
                    <th style="width:15%">Sections a revoir</th>
                    <th class="text-center" style="width:13%">Actions</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-demande>
                <tr class="hover:bg-surface-50">
                    <td>{{ demande.createdAt | date:'dd/MM/yyyy' }}</td>
                    <td>
                        <div class="flex flex-column gap-1">
                            <span class="font-semibold">{{ demande.prenom }} {{ demande.nom }}</span>
                            <small class="text-500">{{ demande.numeroMembre }}</small>
                        </div>
                    </td>
                    <td class="text-right font-bold text-orange-600">{{ formatMontantGNF(demande.montantDemande) }}</td>
                    <td>{{ demande.motifRejetDe }}</td>
                    <td><small>{{ demande.sectionsARevoirDe }}</small></td>
                    <td class="text-center">
                        <p-button icon="pi pi-eye" label="Voir"
                            (click)="viewDemandeDetail(demande.demandeIndividuelId)" size="small"
                            severity="warn"></p-button>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="6" class="text-center p-6">
                        <i class="pi pi-check-circle text-4xl text-green-500 mb-3"></i>
                        <p class="text-600">Aucune demande rejetee par la DE</p>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </p-card>
</div>

<!-- Dialogue de validation -->
<p-dialog [(visible)]="showValidateDialog" [modal]="true" [draggable]="false" [resizable]="false"
    [style]="{width: '450px'}" header="Validation de la commande" [closable]="!processingAction()">

    <div class="dialog-content" *ngIf="selectedStock()">
        <div class="info-section mb-3">
            <p class="mb-2">
                <strong>Commande :</strong> {{ selectedStock().numeroCommande }}
            </p>
            <p class="mb-2">
                <strong>Service :</strong> {{ selectedStock().service }}
            </p>
            <p class="mb-2">
                <strong>Demandeur :</strong> {{ selectedStock().userFullName || selectedStock().username }}
            </p>
        </div>

        <div class="alert alert-info mb-3">
            <i class="pi pi-info-circle mr-2"></i>
            <span *ngIf="user?.role === 'DR'">
                En tant que DR, cette commande sera marquée comme <strong>VALIDÉE</strong>.
            </span>
            <span *ngIf="user?.role !== 'DR'">
                Cette commande sera marquée comme <strong>ACCEPTÉE</strong>.
            </span>
        </div>

        <div class="field">
            <label for="validate-observations">Observations (optionnel)</label>
            <textarea pTextarea id="validate-observations" [(ngModel)]="validateObservations" rows="3"
                class="w-full" [disabled]="processingAction()" placeholder="Ajoutez des observations si nécessaire...">
            </textarea>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <button pButton label="Annuler" icon="pi pi-times" class="p-button-text" (click)="closeDialogs()"
            [disabled]="processingAction()">
        </button>
        <button pButton label="Confirmer la validation" icon="pi pi-check" class="p-button-success"
            (click)="validateCommand()" [disabled]="processingAction()" [loading]="processingAction()">
        </button>
    </ng-template>
</p-dialog>

<!-- Dialogue de rejet -->
<p-dialog [(visible)]="showRejectDialog" [modal]="true" [draggable]="false" [resizable]="false"
    [style]="{width: '450px'}" header="Rejet de la commande" [closable]="!processingAction()">

    <div class="dialog-content" *ngIf="selectedStock()">
        <div class="info-section mb-3">
            <p class="mb-2">
                <strong>Commande :</strong> {{ selectedStock().numeroCommande }}
            </p>
            <p class="mb-2">
                <strong>Service :</strong> {{ selectedStock().service }}
            </p>
            <p class="mb-2">
                <strong>Demandeur :</strong> {{ selectedStock().userFullName || selectedStock().username }}
            </p>
        </div>

        <div class="alert alert-warning mb-3">
            <i class="pi pi-exclamation-triangle mr-2"></i>
            Cette action est irréversible. La commande sera marquée comme <strong>REFUSÉE</strong>.
        </div>

        <div class="field mb-3">
            <label for="reject-motif" class="required">Motif de rejet *</label>
            <textarea pTextarea id="reject-motif" [(ngModel)]="rejectMotif" rows="3" class="w-full"
                [disabled]="processingAction()" placeholder="Indiquez le motif de rejet (obligatoire)..."
                [ngClass]="{'ng-invalid': !rejectMotif() && showRejectDialog()}">
            </textarea>
            <small class="p-error" *ngIf="!rejectMotif() && showRejectDialog()">
                Le motif de rejet est obligatoire
            </small>
        </div>

        <div class="field">
            <label for="reject-observations">Observations complémentaires (optionnel)</label>
            <textarea id="reject-observations" pTextarea [(ngModel)]="rejectObservations" rows="2" class="w-full"
                [disabled]="processingAction()" placeholder="Observations supplémentaires...">
            </textarea>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <button pButton label="Annuler" icon="pi pi-times" class="p-button-text" (click)="closeDialogs()"
            [disabled]="processingAction()">
        </button>
        <button pButton label="Confirmer le rejet" icon="pi pi-ban" class="p-button-danger" (click)="rejectCommand()"
            [disabled]="processingAction() || !rejectMotif()" [loading]="processingAction()">
        </button>
    </ng-template>
</p-dialog>
