<div class="agent-caisse-container">
    <p-toast></p-toast>

    <!-- Header Section -->
    <p-card styleClass="mb-3">
        <div class="flex justify-content-between align-items-center">
            <div>
                <h2 class="m-0">Gestion Personne Physique</h2>
                @if (state().user) {
                <p class="text-500 mt-2">
                    Agent: {{ state().user?.firstName }} {{ state().user?.lastName }}
                </p>
                }
            </div>
            <p-button label="Corriger la fiche Signalétique" icon="pi pi-plus" (click)="openAddDialog()"
                [loading]="isLoading()" [disabled]="!ficheData()">
            </p-button>
        </div>
    </p-card>

    <!-- Search Section -->
    <p-card styleClass="mb-3">
        <h3>Rechercher un Client</h3>
        <form [formGroup]="searchForm" (ngSubmit)="searchFicheSignaletique()">
            <div class="grid">
                <div class="col-12 md:col-8">
                    <div class="p-inputgroup">
                        <span class="p-inputgroup-addon">
                            <i class="pi pi-search"></i>
                        </span>
                        <input pInputText formControlName="codCliente"
                            placeholder="Entrez le code client (9-11 chiffres)" class="w-full">
                    </div>
                    @if (codClienteControl?.invalid && codClienteControl?.touched) {
                    <small class="p-error block mt-1">
                        Le code client doit contenir entre 9 et 11 chiffres
                    </small>
                    }
                </div>
                <div class="col-12 md:col-4">
                    <div class="flex gap-2">
                        <p-button label="Rechercher" icon="pi pi-search" type="submit" [loading]="isSearching()"
                            [disabled]="searchForm.invalid">
                        </p-button>
                        <p-button label="Effacer" icon="pi pi-times" severity="secondary" (click)="clearSearch()"
                            type="button">
                        </p-button>
                    </div>
                </div>
            </div>
        </form>
    </p-card>

    <!-- Loading Spinner -->
    @if (isSearching()) {
    <div class="flex justify-content-center my-4">
        <p-progressSpinner></p-progressSpinner>
    </div>
    }

    <!-- Fiche Signalétique Display -->
    @if (ficheData(); as fiche) {
    <p-card styleClass="fiche-signaletique">
        <h3 class="mb-3">Fiche Signalétique</h3>

        <!-- Client Status Badge -->
        <div class="mb-3">
            <span class="p-badge" [ngClass]="{'p-badge-success': fiche.indEstado === 'A', 
                                  'p-badge-warning': fiche.indEstado !== 'A'}">
                {{ fiche.statutClientLibelle || 'Statut inconnu' }}
            </span>
        </div>

        <p-divider></p-divider>

        <!-- Informations Personnelles -->
        <div class="section mb-3">
            <h4 class="text-primary">Informations Personnelles</h4>
            <table class="info-table">
                <tbody>
                    <tr>
                        <th>Code Client</th>
                        <td>{{ fiche.codCliente }}</td>
                    </tr>
                    <tr>
                        <th>Nom Complet</th>
                        <td>{{ fiche.nombreComplet }}</td>
                    </tr>
                    <tr>
                        <th>Prénom</th>
                        <td>{{ fiche.primerNombre }}</td>
                    </tr>
                    <tr>
                        <th>Nom</th>
                        <td>{{ fiche.primerApellido }}</td>
                    </tr>
                    <tr>
                        <th>Date de Naissance</th>
                        <td>{{ fiche.fechNacimiento }}</td>
                    </tr>
                    <tr>
                        <th>Lieu de Naissance</th>
                        <td>{{ fiche.lugarNacimiento }}</td>
                    </tr>
                    <tr>
                        <th>Nationalité</th>
                        <td>{{ fiche.nacionalidad }}</td>
                    </tr>
                    <tr>
                        <th>Sexe</th>
                        <td>{{ fiche.sexeLibelle }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <p-divider></p-divider>

        <!-- Informations de Contact -->
        <div class="section mb-3">
            <h4 class="text-primary">Informations de Contact</h4>
            <table class="info-table">
                <tbody>
                    <tr>
                        <th>Téléphone Principal</th>
                        <td>{{ fiche.telPrincipal || 'Non renseigné' }}</td>
                    </tr>
                    <tr>
                        <th>Téléphone Secondaire</th>
                        <td>{{ fiche.telSecundario || 'Non renseigné' }}</td>
                    </tr>
                    <tr>
                        <th>Autre Téléphone</th>
                        <td>{{ fiche.telOtro || 'Non renseigné' }}</td>
                    </tr>
                    <tr>
                        <th>Adresse</th>
                        <td>{{ fiche.detDireccion || 'Non renseignée' }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <p-divider></p-divider>

        <!-- Informations Familiales -->
        <div class="section mb-3">
            <h4 class="text-primary">Informations Familiales</h4>
            <table class="info-table">
                <tbody>
                    <tr>
                        <th>État Civil</th>
                        <td>{{ fiche.estatCivilLibelle || 'Non renseigné' }}</td>
                    </tr>
                    <tr>
                        <th>Conjoint(e)</th>
                        <td>{{ fiche.nomConyugue || fiche.codCteConyugue || 'Non renseigné' }}</td>
                    </tr>
                    <tr>
                        <th>Nombre d'Enfants</th>
                        <td>{{ fiche.numHijos || 0 }}</td>
                    </tr>
                    <tr>
                        <th>Bénéficiaire</th>
                        <td>{{ fiche.nomBeneficiario || 'Non renseigné' }}</td>
                    </tr>
                    <tr>
                        <th>Relation Bénéficiaire</th>
                        <td>{{ fiche.relacBeneficiario || 'Non renseignée' }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <p-divider></p-divider>

        <!-- Informations Professionnelles -->
        <div class="section mb-3">
            <h4 class="text-primary">Informations Professionnelles</h4>
            <table class="info-table">
                <tbody>
                    <tr>
                        <th>Profession</th>
                        <td>{{ getProfessionLabel(fiche.codProfesion!) }}</td>
                    </tr>
                    <tr>
                        <th>Secteur d'Activité</th>
                        <td>{{ getSectorLabel(fiche.codSector!) }}</td>
                    </tr>
                    <tr>
                        <th>Type de Travail</th>
                        <td>{{ fiche.typeTravailLibelle || 'Non renseigné' }}</td>
                    </tr>
                    <tr>
                        <th>Ancienneté Poste</th>
                        <td>{{ fiche.antiguedadPuesto ? fiche.antiguedadPuesto + ' ans' : 'Non renseigné' }}</td>
                    </tr>
                    <tr>
                        <th>Lieu de Travail</th>
                        <td>{{ fiche.lugarTrabajo || 'Non renseigné' }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <p-divider></p-divider>

        <!-- Informations Logement -->
        <div class="section mb-3">
            <h4 class="text-primary">Informations Logement</h4>
            <table class="info-table">
                <tbody>
                    <tr>
                        <th>Type d'Habitation</th>
                        <td>{{ fiche.typeHabitationLibelle || 'Non renseigné' }}</td>
                    </tr>
                    <tr>
                        <th>Ancienneté Résidence</th>
                        <td>{{ fiche.antiguedadResidencia ? fiche.antiguedadResidencia + ' ans' : 'Non renseigné' }}
                        </td>
                    </tr>
                    <tr>
                        <th>Province</th>
                        <td>{{ getProvinceLabel(fiche.codProvincia!) }}</td>
                    </tr>
                    <tr>
                        <th>District</th>
                        <td>{{ getDistrictLabel(fiche.codDistrito!, fiche.codProvincia!, fiche.codCanton!) }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <p-divider></p-divider>

        <!-- Informations Administratives -->
        <div class="section">
            <h4 class="text-primary">Informations Administratives</h4>
            <table class="info-table">
                <tbody>
                    <tr>
                        <th>Type de Pièce</th>
                        <td>{{ getIdTypeLabel(fiche.codTipoId!) }}</td>
                    </tr>
                    <tr>
                        <th>Numéro de Pièce</th>
                        <td>{{ fiche.numId || 'Non renseigné' }}</td>
                    </tr>
                    <tr>
                        <th>Date d'Expiration</th>
                        <td>{{ fiche.fecVencim || 'Non renseignée' }}</td>
                    </tr>
                    <tr>
                        <th>Agence</th>
                        <td>{{ fiche.codAgencia || 'Non renseignée' }}</td>
                    </tr>
                    <tr>
                        <th>Date d'Inscription</th>
                        <td>{{ fiche.fecIngreso || 'Non renseignée' }}</td>
                    </tr>
                    <tr>
                        <th>Type de Personne</th>
                        <td>{{ fiche.indPersona === 'F' ? 'Physique' : 'Morale' }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </p-card>
    }

    <!-- Add Personne Physique Dialog -->
    <p-dialog [(visible)]="state().showAddDialog" [modal]="true" [style]="{width: '90vw', maxWidth: '1000px'}"
        [draggable]="false" [resizable]="false" header="Corriger la personne Physique">

        <app-add-personne-physique [userId]="state().user?.userId" [ficheData]="state().ficheSignaletique"
            (onSave)="onPersonnePhysiqueAdded($event)" (onCancel)="closeAddDialog()">
        </app-add-personne-physique>
    </p-dialog>
</div>