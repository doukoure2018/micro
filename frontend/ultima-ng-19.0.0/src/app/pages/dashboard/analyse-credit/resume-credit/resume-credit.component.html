<!-- resume-credit.component.html -->
<div class="container-fluid">
    <!-- Header Section -->
    <div class="grid">
        <div class="col-12">
            <div class="flex flex-wrap gap-2 items-center justify-between mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-900 m-0">R√©sum√© d'Analyse de Cr√©dit</h2>
                    <p class="text-600 m-0 mt-1">Analyse compl√®te de la demande de cr√©dit</p>
                </div>
                <div class="flex gap-2">
                    <p-button label="Retour" icon="pi pi-arrow-left" outlined (onClick)="retourListe()">
                    </p-button>

                </div>
            </div>
        </div>
    </div>

    <div class="grid mb-4">
        <div class="col-12">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="flex align-items-center gap-2 p-3">
                        <i class="pi pi-lightbulb text-yellow-600"></i>
                        <h4 class="m-0">Recommandations et Analyse</h4>
                    </div>
                </ng-template>

                <div class="grid">
                    <div class="col-12 md:col-6">
                        <h6 class="text-blue-700 mb-3">üí° Recommandations</h6>
                        <div class="recommendation-list">
                            @for (recommandation of getRecommandations(); track recommandation) {
                            <div class="flex align-items-start mb-2">
                                <div class="text-sm text-700">{{ recommandation }}</div>
                            </div>
                            }
                        </div>
                    </div>

                    <!-- Analyse de risque -->
                    <div class="col-12 md:col-6">
                        <h6 class="text-orange-700 mb-3">‚ö†Ô∏è Analyse de Risque</h6>
                        <div class="risk-analysis">
                            <div class="mb-3">
                                <div class="flex justify-content-between align-items-center mb-2">
                                    <span class="text-sm font-semibold">Score de risque :</span>
                                    <span class="text-lg font-bold" [class]="getCouleurEvaluationGlobale()">
                                        {{ getScoreRisque() }}/100
                                    </span>
                                </div>
                                <p-progressBar [value]="getScoreRisque()" [style]="{'height': '8px'}"
                                    [class]="'progress-' + getEvaluationGlobale().toLowerCase()">
                                </p-progressBar>
                            </div>

                            <div class="facteurs-risque">
                                <small class="text-600 font-semibold mb-1 block">Facteurs identifi√©s :</small>
                                @for (facteur of getAnalyseRisque().facteurs; track facteur) {
                                <div class="text-xs text-700 mb-1">‚Ä¢ {{ facteur }}</div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conseils d'am√©lioration -->
                <p-divider></p-divider>
                <div class="mt-3">
                    <h6 class="text-green-700 mb-3">üéØ Conseils d'Am√©lioration</h6>
                    <div class="grid">
                        @for (conseil of getConseilsAmelioration(); track conseil) {
                        <div class="col-12 md:col-6">
                            <div class="conseil-item p-2 bg-green-50 border-round mb-2">
                                <small class="text-green-800">{{ conseil }}</small>
                            </div>
                        </div>
                        }
                    </div>
                </div>

                <!-- Recommandation de d√©cision (pour usage interne) -->
                <p-divider></p-divider>
                <div class="mt-3">
                    <h6 class="text-purple-700 mb-3">‚öñÔ∏è Recommandation de D√©cision</h6>
                    <div class="decision-recommendation p-3 border-round"
                        [ngClass]="'bg-' + getRecommandationDecision().decision.toLowerCase().replace('_', '-') + '-50'">

                        <div class="flex justify-content-between align-items-center mb-2">
                            <span class="font-bold text-purple-800">D√©cision recommand√©e :</span>
                            <p-tag [value]="getRecommandationDecision().decision.replace('_', ' ')"
                                [severity]="getDecisionSeverity()" class="font-semibold"></p-tag>
                        </div>

                        <div class="text-sm text-700 mb-3">
                            <strong>Justification :</strong> {{ getRecommandationDecision().justification }}
                        </div>

                        @if (getRecommandationDecision().conditions) {
                        <div class="conditions">
                            <small class="font-semibold text-purple-700 block mb-1">Conditions recommand√©es :</small>
                            @for (condition of getRecommandationDecision().conditions; track condition) {
                            <div class="text-xs text-600 mb-1">‚Ä¢ {{ condition }}</div>
                            }
                        </div>
                        }
                    </div>
                </div>
            </p-card>
        </div>
    </div>

    <!-- Section Indicateurs Cl√©s avec Formules et S√©parateurs -->
    @if(state().user?.role === 'MANAGER'){
    <div class="grid mb-4">
        <div class="col-12">
            <h3 class="text-xl font-semibold text-900 mb-3">
                <i class="pi pi-chart-bar mr-2 text-blue-600"></i>
                Indicateurs Cl√©s avec Formules de Calcul
            </h3>
        </div>

        <!-- R1 - Capacit√© de remboursement -->
        <div class="col-12 md:col-6 lg:col-4">
            <div class="indicator-card-simple">
                <div class="indicator-header">
                    <div class="flex align-items-center mb-2">
                        <i class="pi pi-credit-card text-blue-600 text-2xl mr-3"></i>
                        <div>
                            <h5 class="m-0 text-blue-800">R1 - Capacit√© de remboursement</h5>
                            <small class="text-blue-600">(Cash Flow + Autres revenus) / (Traite revenus)</small>
                        </div>
                    </div>
                </div>
                <div class="indicator-value text-3xl font-bold text-900 mb-2">
                    {{ calculerR1Capacite() }}%
                </div>
                <div class="indicator-details">
                    <div class="text-sm text-600 mb-1">
                        <strong>Calcul :</strong> ({{ formatCurrency(getCashFlow() + getAutresRevenus()) }} + {{
                        formatCurrency(getAutresRevenus()) }}) / {{ formatCurrency(getTraiteRevenus()) }}
                    </div>
                    <p-tag [value]="getStatutR1()" [severity]="getSeveriteR1()" class="font-semibold"></p-tag>
                </div>
            </div>
        </div>

        <!-- S√©parateur vertical pour desktop -->
        <div class="col-12 lg:col-12 separator-container">
            <div class="indicator-separator"></div>
        </div>

        <!-- R2 - Ratio de solvabilit√© -->
        <div class="col-12 md:col-6 lg:col-4">
            <div class="indicator-card-simple">
                <div class="indicator-header">
                    <div class="flex align-items-center mb-2">
                        <i class="pi pi-shield text-green-600 text-2xl mr-3"></i>
                        <div>
                            <h5 class="m-0 text-green-800">R2 - Ratio de solvabilit√©</h5>
                            <small class="text-green-600">Capitaux propres / Total Actif</small>
                        </div>
                    </div>
                </div>
                <div class="indicator-value text-3xl font-bold text-900 mb-2">
                    {{ calculerR2Solvabilite() }}%
                </div>
                <div class="indicator-details">
                    <div class="text-sm text-600 mb-1">
                        <strong>Calcul :</strong> {{ formatCurrency(getCapitauxPropres()) }} / {{
                        formatCurrency(getTotalActif()) }}
                    </div>
                    <p-tag [value]="getStatutR2()" [severity]="getSeveriteR2()" class="font-semibold"></p-tag>
                </div>
            </div>
        </div>

        <!-- S√©parateur -->
        <div class="col-12 lg:col-12 separator-container">
            <div class="indicator-separator"></div>
        </div>

        <!-- R3 - Ratio de liquidit√© -->
        <div class="col-12 md:col-6 lg:col-4">
            <div class="indicator-card-simple">
                <div class="indicator-header">
                    <div class="flex align-items-center mb-2">
                        <i class="pi pi-chart-line text-orange-600 text-2xl mr-3"></i>
                        <div>
                            <h5 class="m-0 text-orange-800">R3 - Ratio de liquidit√©</h5>
                            <small class="text-orange-600">Cr√©ances + Tr√©sorerie / Dettes court terme</small>
                        </div>
                    </div>
                </div>
                <div class="indicator-value text-3xl font-bold text-900 mb-2">
                    {{ calculerR3Liquidite() }}%
                </div>
                <div class="indicator-details">
                    <div class="text-sm text-600 mb-1">
                        <strong>Calcul :</strong> {{ formatCurrency(getCreancesEtTresorerie()) }} / {{
                        formatCurrency(getDettesCourtTerme()) }}
                    </div>
                    <p-tag [value]="getStatutR3()" [severity]="getSeveriteR3()" class="font-semibold"></p-tag>
                </div>
            </div>
        </div>

        <!-- S√©parateur -->
        <div class="col-12 lg:col-12 separator-container">
            <div class="indicator-separator"></div>
        </div>

        <!-- R4 - Ratio d'endettement -->
        <div class="col-12 md:col-6 lg:col-4">
            <div class="indicator-card-simple">
                <div class="indicator-header">
                    <div class="flex align-items-center mb-2">
                        <i class="pi pi-exclamation-triangle text-red-600 text-2xl mr-3"></i>
                        <div>
                            <h5 class="m-0 text-red-800">R4 - Ratio d'endettement</h5>
                            <small class="text-red-600">(Dettes totales + Cr√©dit) / (Total Actif + Cr√©dit)</small>
                        </div>
                    </div>
                </div>
                <div class="indicator-value text-3xl font-bold text-900 mb-2">
                    {{ calculerR4Endettement() }}%
                </div>
                <div class="indicator-details">
                    <div class="text-sm text-600 mb-1">
                        <strong>Calcul :</strong> {{ formatCurrency(getDettesTotalesAvecCredit()) }} / {{
                        formatCurrency(getTotalActifAvecCredit()) }}
                    </div>
                    <p-tag [value]="getStatutR4()" [severity]="getSeveriteR4()" class="font-semibold"></p-tag>
                </div>
            </div>
        </div>

        <!-- S√©parateur -->
        <div class="col-12 lg:col-12 separator-container">
            <div class="indicator-separator"></div>
        </div>

        <!-- R5 - Ratio de d√©pendance -->
        <div class="col-12 md:col-6 lg:col-4">
            <div class="indicator-card-simple">
                <div class="indicator-header">
                    <div class="flex align-items-center mb-2">
                        <i class="pi pi-chart-pie text-purple-600 text-2xl mr-3"></i>
                        <div>
                            <h5 class="m-0 text-purple-800">R5 - Ratio de d√©pendance</h5>
                            <small class="text-purple-600">Autres revenus / Revenus totaux</small>
                        </div>
                    </div>
                </div>
                <div class="indicator-value text-3xl font-bold text-900 mb-2">
                    {{ calculerR5Dependance() }}%
                </div>
                <div class="indicator-details">
                    <div class="text-sm text-600 mb-1">
                        <strong>Calcul :</strong> {{ formatCurrency(getAutresRevenus()) }} / {{
                        formatCurrency(getRevenusTorauxPrevisionnel()) }}
                    </div>
                    <p-tag [value]="getStatutR5()" [severity]="getSeveriteR5()" class="font-semibold"></p-tag>
                </div>
            </div>
        </div>

        <!-- S√©parateur -->
        <div class="col-12 lg:col-12 separator-container">
            <div class="indicator-separator"></div>
        </div>

        <!-- R6 - Ratio de couverture -->
        <div class="col-12 md:col-6 lg:col-4">
            <div class="indicator-card-simple">
                <div class="indicator-header">
                    <div class="flex align-items-center mb-2">
                        <i class="pi pi-wallet text-indigo-600 text-2xl mr-3"></i>
                        <div>
                            <h5 class="m-0 text-indigo-800">R6 - Ratio de couverture de la Garantie</h5>
                            <small class="text-indigo-600">Valeur de la garantie / Cr√©dit</small>
                        </div>
                    </div>
                </div>
                <div class="indicator-value text-3xl font-bold text-900 mb-2">
                    {{ calculerR6Couverture() }}%
                </div>
                <div class="indicator-details">
                    <div class="text-sm text-600 mb-1">
                        <strong>Calcul :</strong> {{ formatCurrency(getValeurGarantie()) }} / {{
                        formatCurrency(getMontantCredit()) }}
                    </div>
                    <p-tag [value]="getStatutR6()" [severity]="getSeveriteR6()" class="font-semibold"></p-tag>
                </div>
            </div>
        </div>
    </div>
    <!-- R√©sum√© des seuils - Version agrandie et centr√©e -->
    <div class="grid mb-4">
        <div class="col-12">
            <p-card class="seuils-card-large">
                <ng-template pTemplate="header">
                    <div class="flex align-items-center justify-content-center gap-3 p-4">
                        <i class="pi pi-info-circle text-blue-600 text-3xl"></i>
                        <h4 class="m-0 text-2xl font-bold text-center">Seuils d'√âvaluation des Ratios</h4>
                    </div>
                </ng-template>

                <div class="seuils-content p-4">
                    <div class="grid">
                        <!-- Section Seuils Acceptables -->
                        <div class="col-12 lg:col-6">
                            <div class="seuils-section text-center">
                                <h6 class="text-green-700 mb-4 text-xl font-bold">‚úÖ Seuils Acceptables</h6>
                                <div class="seuils-list bg-green-50 p-4 border-round">
                                    <ul class="text-base text-700 list-none p-0 m-0">
                                        <li class="mb-3 p-2 bg-white border-round shadow-1">
                                            <strong class="text-green-800">R1 Capacit√© :</strong>
                                            <span class="text-green-700 font-semibold ml-2">‚â• 150%</span>
                                        </li>
                                        <li class="mb-3 p-2 bg-white border-round shadow-1">
                                            <strong class="text-green-800">R2 Solvabilit√© :</strong>
                                            <span class="text-green-700 font-semibold ml-2">‚â• 25%</span>
                                        </li>
                                        <li class="mb-3 p-2 bg-white border-round shadow-1">
                                            <strong class="text-green-800">R3 Liquidit√© :</strong>
                                            <span class="text-green-700 font-semibold ml-2">‚â• 100%</span>
                                        </li>
                                        <li class="mb-3 p-2 bg-white border-round shadow-1">
                                            <strong class="text-green-800">R4 Endettement :</strong>
                                            <span class="text-green-700 font-semibold ml-2">‚â§ 70%</span>
                                        </li>
                                        <li class="mb-3 p-2 bg-white border-round shadow-1">
                                            <strong class="text-green-800">R5 D√©pendance :</strong>
                                            <span class="text-green-700 font-semibold ml-2">‚â§ 50%</span>
                                            <!-- MODIFI√â: de 30% √† 50% -->
                                        </li>
                                        <li class="mb-3 p-2 bg-white border-round shadow-1">
                                            <strong class="text-green-800">R6 Couverture :</strong>
                                            <span class="text-green-700 font-semibold ml-2">‚â• 120%</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Section √âvaluation Globale -->
                        <div class="col-12 lg:col-6">
                            <div class="evaluation-section text-center">
                                <h6 class="text-blue-700 mb-4 text-xl font-bold">üìä √âvaluation Globale</h6>
                                <div class="evaluation-box p-5 bg-blue-50 border-round border-2 border-blue-200">
                                    <!-- Score principal -->
                                    <div class="evaluation-main mb-4">
                                        <div class="text-5xl font-bold mb-2" [class]="getCouleurEvaluationGlobale()">
                                            {{ getEvaluationGlobale() }}
                                        </div>
                                        <div class="text-lg text-600 font-medium">
                                            {{ getNbSeuilsRespetes() }}/6 seuils respect√©s
                                        </div>
                                    </div>

                                    <!-- Barre de progression -->
                                    <div class="progress-section mb-4">
                                        <div class="text-sm text-600 mb-2 font-medium">Taux de conformit√©</div>
                                        <p-progressBar [value]="(getNbSeuilsRespetes() / 6) * 100"
                                            [style]="{'height': '12px'}"
                                            [class]="'progress-' + getEvaluationGlobale().toLowerCase()">
                                        </p-progressBar>
                                        <div class="text-sm text-600 mt-1 font-medium">
                                            {{ ((getNbSeuilsRespetes() / 6) * 100).toFixed(0) }}% des seuils respect√©s
                                        </div>
                                    </div>

                                    <!-- Indicateur visuel -->
                                    <div class="status-indicator">
                                        <i [class]="getIconeEvaluation()" [ngClass]="getCouleurEvaluationGlobale()"
                                            class="text-4xl"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section r√©capitulatif centr√©e -->
                    <div class="col-12 mt-4">
                        <div class="recapitulatif-centre text-center p-4 bg-gray-50 border-round">
                            <h6 class="text-gray-700 mb-3 text-lg font-bold">üéØ R√©sum√© de l'Analyse</h6>
                            <div class="flex justify-content-center align-items-center gap-4 flex-wrap">
                                <div class="metric-item">
                                    <div class="text-2xl font-bold text-blue-600">{{ getNbSeuilsRespetes() }}</div>
                                    <small class="text-600">Seuils OK</small>
                                </div>
                                <div class="metric-separator">‚Ä¢</div>
                                <div class="metric-item">
                                    <div class="text-2xl font-bold text-orange-600">{{ 6 - getNbSeuilsRespetes() }}
                                    </div>
                                    <small class="text-600">√Ä am√©liorer</small>
                                </div>
                                <div class="metric-separator">‚Ä¢</div>
                                <div class="metric-item">
                                    <div class="text-2xl font-bold" [class]="getCouleurEvaluationGlobale()">
                                        {{ ((getNbSeuilsRespetes() / 6) * 100).toFixed(0) }}%
                                    </div>
                                    <small class="text-600">Score global</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </p-card>
        </div>
    </div>
    }@else{

    }





    <!-- Loading State -->
    @if (state().loading) {
    <div class="grid">
        <div class="col-12">
            <div class="flex justify-center items-center p-8">
                <p-progressSpinner></p-progressSpinner>
            </div>
        </div>
    </div>
    }

    <!-- Error State -->
    @if (state().error && !state().loading) {
    <div class="grid">
        <div class="col-12">
            <p-card>
                <div class="text-center p-4">
                    <i class="pi pi-exclamation-triangle text-6xl text-red-500 mb-3"></i>
                    <h3 class="text-red-600">Erreur lors du chargement</h3>
                    <p class="text-600">{{ state().error?.message || 'Une erreur est survenue' }}</p>
                    <p-button label="R√©essayer" icon="pi pi-refresh" (onClick)="chargerResumeCredit()"></p-button>
                </div>
            </p-card>
        </div>
    </div>
    }

    <!-- Main Content -->
    @if (state().resumeCredit && !state().loading) {
    <!-- Indicateurs Cl√©s -->
    @if(state().user?.role === 'MANAGER'){
    <div class="grid mb-4">
        <div class="col-12">
            <h3 class="text-xl font-semibold text-900 mb-3">Indicateurs Cl√©s</h3>
        </div>
        @for (indicateur of getIndicateursCles(); track indicateur.label) {
        <div class="col-12 md:col-6 lg:col-3">
            <p-card class="h-full">
                <div class="flex items-center gap-3">
                    <div class="p-3 rounded-full" [ngClass]="'bg-' + indicateur.color + '-100'">
                        <i [class]="indicateur.icon" [ngClass]="'text-' + indicateur.color + '-600 text-xl'"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-600 text-sm m-0">{{ indicateur.label }}</p>
                        <p class="text-900 text-xl font-semibold m-0">
                            <p-tag [value]="indicateur.value" [severity]="indicateur.severity"></p-tag>
                        </p>
                    </div>
                </div>
            </p-card>
        </div>
        }
    </div>
    }@else{

    }


    <!-- Informations G√©n√©rales -->
    <div class="grid mb-4">
        <!-- Promoteur -->
        <div class="col-12 lg:col-6">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="flex items-center gap-2 p-3">
                        <i class="pi pi-user text-blue-600"></i>
                        <h4 class="m-0">Informations du Promoteur</h4>
                    </div>
                </ng-template>
                <p-table [value]="getPromoteurData()" [tableStyle]="{'min-width': '100%'}" styleClass="p-datatable-sm">
                    <ng-template pTemplate="body" let-item>
                        <tr>
                            <td class="font-semibold text-600">{{ item.label }}</td>
                            <td>{{ item.value }}</td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-card>
        </div>

        <!-- Entreprise -->
        <div class="col-12 lg:col-6">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="flex items-center gap-2 p-3">
                        <i class="pi pi-building text-green-600"></i>
                        <h4 class="m-0">Informations de l'Entreprise</h4>
                    </div>
                </ng-template>
                <p-table [value]="getEntrepriseData()" [tableStyle]="{'min-width': '100%'}" styleClass="p-datatable-sm">
                    <ng-template pTemplate="body" let-item>
                        <tr>
                            <td class="font-semibold text-600">{{ item.label }}</td>
                            <td>{{ item.value }}</td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-card>
        </div>
    </div>
    <!-- Personnes Caution - NOUVELLE SECTION -->
    <div class="grid mb-4">
        <div class="col-12">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="flex items-center gap-2 p-3">
                        <i class="pi pi-users text-teal-600"></i>
                        <h4 class="m-0">Personnes Caution</h4>
                        <p-badge [value]="getNombrePersonnesCaution().toString()"
                            [severity]="getNombrePersonnesCaution() > 0 ? 'success' : 'warn'">
                        </p-badge>
                    </div>
                </ng-template>

                <!-- Si aucune personne caution -->
                @if (!hasPersonnesCaution()) {
                <div class="text-center p-4">
                    <i class="pi pi-exclamation-triangle text-4xl text-orange-500 mb-3"></i>
                    <h5 class="text-orange-600 mb-2">Aucune personne caution</h5>
                    <p class="text-600 mb-3">
                        Aucune garantie personnelle n'a √©t√© renseign√©e pour cette demande de cr√©dit.
                    </p>
                    <p-tag value="ATTENTION : Risque de garantie insuffisant" severity="warn"></p-tag>
                </div>
                }

                <!-- Si des personnes caution existent -->
                @if (hasPersonnesCaution()) {
                <div class="grid">
                    <!-- Liste d√©taill√©e des personnes caution -->
                    <div class="col-12 lg:col-8">
                        <h5 class="text-teal-700 mb-3">
                            <i class="pi pi-list mr-2"></i>
                            D√©tails des Personnes Caution ({{ getNombrePersonnesCaution() }})
                        </h5>
                        <p-table [value]="getPersonnesCautionData()" [tableStyle]="{'min-width': '100%'}"
                            styleClass="p-datatable-sm">
                            <ng-template pTemplate="body" let-item>
                                <tr
                                    [ngClass]="{'border-top-2 border-teal-200 bg-teal-50': item.label.includes('Caution') && item.label.includes('Nom')}">
                                    <td class="font-semibold text-600"
                                        [ngClass]="{'text-teal-700 font-bold': item.label.includes('Caution') && item.label.includes('Nom')}">
                                        {{ item.label }}
                                    </td>
                                    <td
                                        [ngClass]="{'font-semibold': item.label.includes('Caution') && item.label.includes('Nom')}">
                                        {{ item.value }}
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>

                    <!-- Analyse de la garantie personnelle -->
                    <div class="col-12 lg:col-4">
                        <div class="garantie-analysis-card">
                            <h5 class="text-teal-700 mb-3">
                                <i class="pi pi-shield mr-2"></i>
                                Analyse de Garantie
                            </h5>

                            <div class="analysis-content p-3 bg-teal-50 border-round">
                                <!-- Score de garantie -->
                                <div class="score-section mb-3">
                                    <div class="flex justify-content-between align-items-center mb-2">
                                        <span class="text-sm font-semibold text-teal-800">Niveau :</span>
                                        <p-tag [value]="getAnalyseGarantiePersonnelle().niveau"
                                            [severity]="getAnalyseGarantiePersonnelle().niveau === 'EXCELLENT' ? 'success' : 
                                                      getAnalyseGarantiePersonnelle().niveau === 'BON' ? 'info' :
                                                      getAnalyseGarantiePersonnelle().niveau === 'MOYEN' ? 'warn' : 'danger'" class="font-semibold">
                                        </p-tag>
                                    </div>

                                    <div class="flex justify-content-between align-items-center mb-2">
                                        <span class="text-sm font-semibold text-teal-800">Score :</span>
                                        <span class="text-lg font-bold text-teal-700">
                                            {{ getAnalyseGarantiePersonnelle().score }}/100
                                        </span>
                                    </div>

                                    <p-progressBar [value]="getAnalyseGarantiePersonnelle().score"
                                        [style]="{'height': '8px'}"
                                        [ngClass]="'progress-' + getAnalyseGarantiePersonnelle().niveau.toLowerCase()">
                                    </p-progressBar>
                                </div>

                                <!-- Description -->
                                <div class="description-section mb-3">
                                    <small class="text-teal-700 font-semibold block mb-1">Description :</small>
                                    <p class="text-sm text-teal-800 m-0">
                                        {{ getAnalyseGarantiePersonnelle().description }}
                                    </p>
                                </div>

                                <!-- Recommandations -->
                                <div class="recommendations-section">
                                    <small class="text-teal-700 font-semibold block mb-2">Recommandations :</small>
                                    @for (recommandation of getAnalyseGarantiePersonnelle().recommendations; track
                                    recommandation) {
                                    <div class="recommendation-item mb-1 p-2 bg-white border-round shadow-1">
                                        <small class="text-teal-800">‚Ä¢ {{ recommandation }}</small>
                                    </div>
                                    }
                                </div>
                            </div>

                            <!-- R√©sum√© compact -->
                            <div class="mt-3 p-2 bg-white border-round border-1 border-teal-200">
                                <small class="text-teal-700 font-semibold block mb-1">Personnes identifi√©es :</small>
                                @for (personne of getPersonnesCautionCompact(); track personne) {
                                <div class="text-xs text-teal-600 mb-1">‚Ä¢ {{ personne }}</div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                }
            </p-card>
        </div>
    </div>
    <!-- Bilan Financier -->
    <div class="grid mb-4">
        <!-- Bilan Entreprise -->
        <div class="col-12 lg:col-8">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="flex items-center gap-2 p-3">
                        <i class="pi pi-chart-bar text-orange-600"></i>
                        <h4 class="m-0">Bilan de l'Entreprise</h4>
                    </div>
                </ng-template>
                <p-table [value]="getBilanEntrepriseData()" [tableStyle]="{'min-width': '100%'}"
                    styleClass="p-datatable-sm">
                    <ng-template pTemplate="body" let-item>
                        <tr [ngClass]="{'font-bold bg-blue-50': item.isTotal}">
                            <td class="font-semibold text-600">{{ item.label }}</td>
                            <td>
                                @if (item.isRatio) {
                                <p-tag [value]="item.value" [severity]="item.severity"></p-tag>
                                } @else {
                                {{ item.value }}
                                }
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-card>
        </div>

        <!-- Bilan Personnel -->
        <div class="col-12 lg:col-4">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="flex items-center gap-2 p-3">
                        <i class="pi pi-wallet text-purple-600"></i>
                        <h4 class="m-0">Patrimoine Personnel</h4>
                    </div>
                </ng-template>
                <p-table [value]="getBilanPersonnelData()" [tableStyle]="{'min-width': '100%'}"
                    styleClass="p-datatable-sm">
                    <ng-template pTemplate="body" let-item>
                        <tr [ngClass]="{'font-bold bg-blue-50': item.isTotal}">
                            <td class="font-semibold text-600">{{ item.label }}</td>
                            <td>{{ item.value }}</td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-card>
        </div>
    </div>

    <!-- Exploitation -->
    <div class="grid mb-4">
        <!-- Exploitation Actuelle -->
        <div class="col-12 lg:col-6">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="flex items-center gap-2 p-3">
                        <i class="pi pi-calendar text-blue-600"></i>
                        <h4 class="m-0">Exploitation Actuelle</h4>
                    </div>
                </ng-template>
                <p-table [value]="getExploitationActuelleData()" [tableStyle]="{'min-width': '100%'}"
                    styleClass="p-datatable-sm">
                    <ng-template pTemplate="body" let-item>
                        <tr [ngClass]="{'font-bold bg-blue-50': item.isTotal}">
                            <td class="font-semibold text-600">{{ item.label }}</td>
                            <td>
                                @if (item.isRatio) {
                                <p-tag [value]="item.value" [severity]="item.severity"></p-tag>
                                } @else {
                                {{ item.value }}
                                }
                            </td>
                        </tr>
                    </ng-template>
                </p-table>

                <!-- D√©tail des charges actuelles -->
                <p-divider></p-divider>
                <h5 class="text-lg font-semibold mb-3">D√©tail des Charges</h5>
                <p-table [value]="getChargesData('actuelle')" [tableStyle]="{'min-width': '100%'}"
                    styleClass="p-datatable-sm">
                    <ng-template pTemplate="body" let-item>
                        <tr [ngClass]="{'font-bold bg-green-50': item.isTotal}">
                            <td class="font-semibold text-600">{{ item.label }}</td>
                            <td>{{ item.value }}</td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-card>
        </div>

        <!-- Exploitation Pr√©visionnelle -->
        <div class="col-12 lg:col-6">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="flex items-center gap-2 p-3">
                        <i class="pi pi-chart-line text-green-600"></i>
                        <h4 class="m-0">Exploitation Pr√©visionnelle</h4>
                    </div>
                </ng-template>
                <p-table [value]="getExploitationPrevisionnelleData()" [tableStyle]="{'min-width': '100%'}"
                    styleClass="p-datatable-sm">
                    <ng-template pTemplate="body" let-item>
                        <tr [ngClass]="{'font-bold bg-blue-50': item.isTotal}">
                            <td class="font-semibold text-600">{{ item.label }}</td>
                            <td>
                                @if (item.isRatio) {
                                <p-tag [value]="item.value" [severity]="item.severity"></p-tag>
                                } @else {
                                {{ item.value }}
                                }
                            </td>
                        </tr>
                    </ng-template>
                </p-table>

                <!-- D√©tail des charges pr√©visionnelles -->
                <p-divider></p-divider>
                <h5 class="text-lg font-semibold mb-3">D√©tail des Charges</h5>
                <p-table [value]="getChargesData('previsionnelle')" [tableStyle]="{'min-width': '100%'}"
                    styleClass="p-datatable-sm">
                    <ng-template pTemplate="body" let-item>
                        <tr [ngClass]="{'font-bold bg-green-50': item.isTotal}">
                            <td class="font-semibold text-600">{{ item.label }}</td>
                            <td>{{ item.value }}</td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-card>
        </div>
    </div>

    <!-- Section Demande de Cr√©dit MISE √Ä JOUR avec vraies donn√©es administratives -->
    <div class="grid mb-4">
        <div class="col-12">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="flex items-center gap-2 p-3">
                        <i class="pi pi-credit-card text-red-600"></i>
                        <h4 class="m-0">D√©tails de la Demande de Cr√©dit</h4>
                        @if (isLoadingInfoAdmin()) {
                        <p-progressSpinner [style]="{'width': '20px', 'height': '20px'}"
                            strokeWidth="4"></p-progressSpinner>
                        }
                    </div>
                </ng-template>

                <div class="grid">
                    <!-- Informations principales de la demande -->
                    <div class="col-12 lg:col-6">
                        <h5 class="text-red-700 mb-3">
                            <i class="pi pi-info-circle mr-2"></i>
                            Informations Principales
                        </h5>
                        <p-table [value]="getDemandeCreditData().slice(0, 7)" [tableStyle]="{'min-width': '100%'}"
                            styleClass="p-datatable-sm">
                            <ng-template pTemplate="body" let-item>
                                <tr>
                                    <td class="font-semibold text-600">{{ item.label }}</td>
                                    <td>
                                        @if (item.isRatio) {
                                        <p-tag [value]="item.value" [severity]="item.severity"></p-tag>
                                        } @else if (item.isStatus) {
                                        <p-tag [value]="item.value" [severity]="getStatutSeverity(item.value)"></p-tag>
                                        } @else {
                                        {{ item.value }}
                                        }
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>

                    <div class="col-12 lg:col-6">
                        <h5 class="text-blue-700 mb-3">
                            <i class="pi pi-building mr-2"></i>
                            Informations Administratives
                            @if (hasInfoAdministrative()) {
                            <i class="pi pi-check-circle text-green-500 ml-2" title="Donn√©es compl√®tes charg√©es"></i>
                            } @else if (isLoadingInfoAdmin()) {
                            <i class="pi pi-spin pi-spinner text-blue-500 ml-2" title="Chargement en cours..."></i>
                            } @else {
                            <i class="pi pi-exclamation-triangle text-orange-500 ml-2" title="Donn√©es partielles"></i>
                            }
                        </h5>

                        <!-- Affichage des donn√©es administratives -->
                        @if (isLoadingInfoAdmin()) {
                        <div class="loading-admin p-3 bg-blue-50 border-round text-center">
                            <p-progressSpinner [style]="{'width': '30px', 'height': '30px'}"
                                strokeWidth="4"></p-progressSpinner>
                            <p class="text-sm text-blue-600 mt-2 mb-0">Chargement des informations d√©taill√©es...</p>
                        </div>
                        } @else {
                        <p-table [value]="getDemandeCreditInfosComplementaires()" [tableStyle]="{'min-width': '100%'}"
                            styleClass="p-datatable-sm">
                            <ng-template pTemplate="body" let-item>
                                <tr [ngClass]="{'bg-green-50': hasInfoAdministrative()}">
                                    <td class="font-semibold text-600">{{ item.label }}</td>
                                    <td class="text-700">
                                        {{ item.value }}
                                        @if (hasInfoAdministrative() && !item.value.startsWith('ID:')) {
                                        <i class="pi pi-check text-green-500 ml-1 text-xs"
                                            title="Information compl√®te"></i>
                                        }
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                        }

                        <!-- R√©sum√© hi√©rarchique -->
                        @if (hasInfoAdministrative()) {
                        <div class="mt-3 p-2 bg-blue-50 border-round border-1 border-blue-200">
                            <small class="text-blue-700 font-semibold block mb-1">Hi√©rarchie :</small>
                            <div class="text-sm text-blue-800">{{ getResumeAdministratif() }}</div>
                        </div>
                        }

                        <!-- R√©sum√© financier existant -->
                        <div class="mt-4">
                            <h6 class="text-green-700 mb-3">
                                <i class="pi pi-chart-bar mr-2"></i>
                                R√©sum√© Financier
                            </h6>
                            <div class="bg-green-50 p-3 border-round">
                                <div class="grid gap-2 text-sm">
                                    <div class="col-12 flex justify-content-between align-items-center">
                                        <span class="text-600 font-medium">Total Actif:</span>
                                        <span class="font-bold text-green-800">{{ formatCurrency(calculerTotalActif())
                                            }}</span>
                                    </div>
                                    <div class="col-12 flex justify-content-between align-items-center">
                                        <span class="text-600 font-medium">Total Passif:</span>
                                        <span class="font-bold text-green-800">{{ formatCurrency(calculerTotalPassif())
                                            }}</span>
                                    </div>
                                    <div class="col-12 flex justify-content-between align-items-center">
                                        <span class="text-600 font-medium">Patrimoine Personnel:</span>
                                        <span class="font-bold text-green-800">{{
                                            formatCurrency(calculerPatrimoinePersonnel()) }}</span>
                                    </div>
                                    <div
                                        class="col-12 flex justify-content-between align-items-center border-top-1 border-green-200 pt-2">
                                        <span class="text-600 font-medium">Garantie Totale:</span>
                                        <span class="font-bold text-green-700">{{ formatCurrency(getValeurGarantie())
                                            }}</span>
                                    </div>
                                    @if (getNombrePersonnesCaution() > 0) {
                                    <div class="col-12">
                                        <small class="text-green-600 italic">
                                            (Inclut bonus {{ getNombrePersonnesCaution() }} personne(s) caution: +{{
                                            (getNombrePersonnesCaution() * 10).toFixed(0) }}%)
                                        </small>
                                    </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <p-divider></p-divider>
            </p-card>
        </div>
    </div>


    <!-- SECTION DEBUG/TEST mise √† jour -->
    <div class="grid mb-4" *ngIf="false">
        <div class="col-12">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="flex items-center gap-2 p-3">
                        <i class="pi pi-bug text-red-600"></i>
                        <h4 class="m-0">Section Debug - ACTIV√âE</h4>
                    </div>
                </ng-template>

                <div class="flex flex-wrap gap-2 mb-3">

                    <p-button label="Tester Info Administrative" icon="pi pi-building" outlined
                        (onClick)="testerInfoAdministrative()">
                    </p-button>
                    <p-button label="Recharger Info Admin" icon="pi pi-refresh" outlined
                        [disabled]="isLoadingInfoAdmin()" (onClick)="chargerInfoAdministrative()">
                    </p-button>

                </div>

                <!-- √âtat actuel en temps r√©el -->
                <div class="debug-status p-3 bg-gray-100 border-round mb-3">
                    <h6 class="text-gray-700 mb-2">üìä √âtat Actuel en Temps R√©el</h6>
                    <div class="grid text-sm">
                        <div class="col-12 md:col-4">
                            <p><strong>Resume cr√©dit charg√©:</strong>
                                <span [class]="state().resumeCredit ? 'text-green-600' : 'text-red-600'">
                                    {{ state().resumeCredit ? 'OUI' : 'NON' }}
                                </span>
                            </p>
                            <p><strong>Loading principal:</strong> {{ state().loading ? 'OUI' : 'NON' }}</p>
                            <p><strong>Loading admin:</strong> {{ state().loadingAdmin ? 'OUI' : 'NON' }}</p>
                        </div>
                        <div class="col-12 md:col-4">
                            <p><strong>Info admin disponible:</strong>
                                <span [class]="hasInfoAdministrative() ? 'text-green-600' : 'text-red-600'">
                                    {{ hasInfoAdministrative() ? 'OUI' : 'NON' }}
                                </span>
                            </p>
                            <p><strong>Nb personnes caution:</strong> {{ getNombrePersonnesCaution() }}</p>
                            <p><strong>R√©sum√© admin:</strong> {{ getResumeAdministratif() }}</p>
                        </div>
                        <div class="col-12 md:col-4">
                            @if (state().resumeCredit?.demande_credit) {
                            <p><strong>IDs demande:</strong></p>
                            <small>
                                - D√©l√©gation: {{ state().resumeCredit?.demande_credit?.delegation_id! }}<br>
                                - Agence: {{ state().resumeCredit?.demande_credit?.agence_id }}<br>
                                - Point vente: {{ state().resumeCredit?.demande_credit?.point_vente_id }}<br>
                                - User: {{ state().resumeCredit?.demande_credit?.user_id }}
                            </small>
                            }
                        </div>
                    </div>
                </div>

                <!-- Donn√©es administratives brutes -->
                @if (hasInfoAdministrative()) {
                <div class="debug-data p-3 bg-green-50 border-round">
                    <h6 class="text-green-700 mb-2">‚úÖ Donn√©es Administratives Charg√©es</h6>
                    <div class="grid text-sm">
                        <div class="col-12 md:col-3">
                            <strong>D√©l√©gation:</strong><br>
                            ID: {{ state().infoAdministrative?.delegationDto?.id }}<br>
                            Libell√©: {{ state().infoAdministrative?.delegationDto?.libele }}
                        </div>
                        <div class="col-12 md:col-3">
                            <strong>Agence:</strong><br>
                            ID: {{ state().infoAdministrative?.agenceDto?.id }}<br>
                            Libell√©: {{ state().infoAdministrative?.agenceDto?.libele }}
                        </div>
                        <div class="col-12 md:col-3">
                            <strong>Point de vente:</strong><br>
                            ID: {{ state().infoAdministrative?.pointVenteDto?.id }}<br>
                            Libell√©: {{ state().infoAdministrative?.pointVenteDto?.libele }}<br>
                            Code: {{ state().infoAdministrative?.pointVenteDto?.code }}
                        </div>
                        <div class="col-12 md:col-3">
                            <strong>Utilisateur:</strong><br>
                            ID: {{ state().infoAdministrative?.user?.userId }}<br>
                            Nom: {{ state().infoAdministrative?.user?.firstName }} {{
                            state().infoAdministrative?.user?.lastName }}<br>
                        </div>
                    </div>
                </div>
                } @else {
                <div class="debug-data p-3 bg-orange-50 border-round">
                    <h6 class="text-orange-700 mb-2">‚ö†Ô∏è Aucune Donn√©e Administrative</h6>
                    <p class="text-sm text-orange-800 m-0">
                        Les informations administratives n'ont pas √©t√© charg√©es ou ne sont pas disponibles.
                        Cliquez sur "Debug Complet" pour analyser le probl√®me.
                    </p>
                </div>
                }
            </p-card>
        </div>
    </div>

    <div class="grid mb-4">
        <div class="col-12">
            <app-motif-analyse [motifs_analyses]="state().resumeCredit?.motifs_analyses!" [demandeCreditId]="demandeId"
                [user]="state().user!">
            </app-motif-analyse>
        </div>
    </div>

    <!-- Actions Footer -->
    <div class="grid">
        <div class="col-12">
            <div class="flex justify-content-between align-items-center gap-3 p-4 bg-gray-50 border-round">
                <!-- Bouton Retour √† gauche -->
                <p-button label="Retour" icon="pi pi-arrow-left" outlined (onClick)="retourListe()">
                </p-button>

                <!-- Bouton Revoir l'analyse √† droite -->
                <p-button label="Revoir l'analyse compl√®te de l'associ√©" icon="pi pi-eye" outlined
                    (onClick)="viewCompleteAnalyse()">
                </p-button>
            </div>
        </div>
    </div>
    }

    <!-- Empty State -->
    @if (!state().resumeCredit && !state().loading && !state().error) {
    <div class="grid">
        <div class="col-12">
            <p-card>
                <div class="text-center p-8">
                    <i class="pi pi-info-circle text-6xl text-blue-500 mb-3"></i>
                    <h3 class="text-600">Aucune donn√©e disponible</h3>
                    <p class="text-500">Le r√©sum√© de cr√©dit n'est pas encore disponible.</p>
                    <p-button label="Retour" icon="pi pi-arrow-left" outlined (onClick)="retourListe()"></p-button>
                </div>
            </p-card>
        </div>
    </div>
    }
</div>

<!-- Toast Messages -->
<p-toast></p-toast>