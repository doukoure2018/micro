<div class="container-fluid">
    <!-- Header Section -->
    <div class="grid">
        <div class="col-12">
            <div class="flex flex-wrap gap-2 items-center justify-between mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-900 m-0">R√©sum√© d'Analyse de Cr√©dit</h2>
                    <p class="text-600 m-0 mt-1">Analyse compl√®te de la demande de cr√©dit</p>
                    @if (peutImprimer()) {
                    <small class="text-500 mt-1 block">{{ getResumeImpression() }}</small>
                    }
                </div>
                <div class="flex gap-2 flex-wrap">
                    @if (peutImprimer()) {
                    <div class="print-buttons-group flex gap-2 mr-3">
                        <p-button label="Imprimer" icon="pi pi-print"
                            [style]="{'background': '#28a745', 'border-color': '#28a745'}" (onClick)="imprimerBilan()"
                            pTooltip="Imprimer le r√©sum√© complet" tooltipPosition="bottom">
                        </p-button>
                        <p-splitButton label="Options" icon="pi pi-download" (onClick)="previsualiserImpression()"
                            [model]="printMenuModel" severity="secondary" size="small">
                        </p-splitButton>
                    </div>
                    } @else {
                    <div class="print-disabled-info mr-3">
                        <p-button label="Impression non disponible" icon="pi pi-print" disabled severity="secondary"
                            size="small" pTooltip="Chargez d'abord les donn√©es pour pouvoir imprimer"
                            tooltipPosition="bottom">
                        </p-button>
                    </div>
                    }
                    <p-button label="Retour" icon="pi pi-arrow-left" outlined (onClick)="retourListe()">
                    </p-button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    @if (state().loading) {
    <div class="grid">
        <div class="col-12">
            <div class="flex justify-center items-center p-8">
                <p-progressSpinner></p-progressSpinner>
            </div>
        </div>
    </div>
    }

    <!-- Error State -->
    @if (state().error && !state().loading) {
    <div class="grid">
        <div class="col-12">
            <p-card>
                <div class="text-center p-4">
                    <i class="pi pi-exclamation-triangle text-6xl text-red-500 mb-3"></i>
                    <h3 class="text-red-600">Erreur lors du chargement</h3>
                    <p class="text-600">{{ state().error?.message || 'Une erreur est survenue' }}</p>
                    <p-button label="R√©essayer" icon="pi pi-refresh" (onClick)="chargerResumeCredit()"></p-button>
                </div>
            </p-card>
        </div>
    </div>
    }

    <!-- ============================================================== -->
    <!-- MAIN CONTENT                                                    -->
    <!-- ============================================================== -->
    @if (state().resumeCredit && !state().loading) {

    <!-- ================================================================ -->
    <!-- SECTION 1 : RATIOS DE D√âCISION (EN HAUT) ‚Äî MANAGER / DA ONLY    -->
    <!-- Layout fid√®le √† l'image Excel                                    -->
    <!-- ================================================================ -->
    @if (state().user?.role === 'MANAGER' || state().user?.role === 'DA') {
    <div class="grid mb-4">
        <div class="col-12">
            <div class="surface-card border-round shadow-1">
                <!-- Titre section -->
                <div class="p-3 border-bottom-1 surface-border" style="background-color: #d9d9d9;">
                    <span class="font-bold text-lg">4. Ratios de d√©cision</span>
                </div>

                <div class="p-3">
                    <!-- Zone Proposition - simulation en haut √† droite -->
                    <div class="flex justify-content-end mb-3">
                        <div class="border-1 surface-border" style="min-width: 400px;">
                            <!-- Header Proposition -->
                            <div class="text-right p-2 border-bottom-1 surface-border font-semibold">
                                Proposition - simulation
                            </div>
                            <!-- Montant -->
                            <div class="flex border-bottom-1 surface-border">
                                <div class="p-2 text-right" style="width: 100px;">Montant :</div>
                                <div class="p-2 flex-1 text-center" style="background-color: #c6efce;">
                                    {{ formatCurrency(getMontantPropose()) || '-' }}
                                </div>
                            </div>
                            <!-- Dur√©e -->
                            <div class="flex border-bottom-1 surface-border">
                                <div class="p-2 text-right" style="width: 100px;">Dur√©e :</div>
                                <div class="p-2 text-center" style="width: 80px; background-color: #c6efce;">
                                    <em>{{ getDureeProposee() || '-' }} mois</em>
                                </div>
                                <div class="p-2 text-center flex-1">
                                    Nbre d'√©ch. : <strong>{{ getNbreEcheancePropose() || '-' }}</strong>
                                </div>
                            </div>
                            <!-- √âch√©ance -->
                            <div class="flex">
                                <div class="p-2 text-right" style="width: 100px;">√âch√©ance :</div>
                                <div class="p-2 flex-1 text-center" style="background-color: #c6efce;">
                                    {{ formatCurrency(getEcheanceProposee()) || '-' }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tableau des Ratios style Excel -->
                    <table class="w-full" style="border-collapse: collapse; border: 1px solid #000;">
                        <thead>
                            <tr>
                                <!-- Colonne Ratio (vide en header) -->
                                <th style="border: 1px solid #000; width: 35%;"></th>
                                <!-- Colonne Norme -->
                                <th class="p-2 text-center font-bold" style="border: 1px solid #000; width: 10%;">
                                    Norme
                                </th>
                                <!-- Colonne Sollicit√© avec texte vertical -->
                                <th class="p-2 text-center"
                                    style="border: 1px solid #000; width: 22%; position: relative;">
                                    <div
                                        style="writing-mode: vertical-rl; transform: rotate(180deg); height: 120px; display: flex; align-items: center; justify-content: center; font-size: 11px;">
                                        Ratios calcul√©s en fonction du montant sollicit√©
                                    </div>
                                </th>
                                <!-- Colonne Propos√© avec texte vertical -->
                                <th class="p-2 text-center"
                                    style="border: 1px solid #000; width: 22%; position: relative;">
                                    <div
                                        style="writing-mode: vertical-rl; transform: rotate(180deg); height: 120px; display: flex; align-items: center; justify-content: center; font-size: 11px;">
                                        Ratios associ√©s au montant propos√©
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- R.1 Capacit√© de remboursement -->
                            <tr>
                                <td class="p-2" style="border: 1px solid #000;">
                                    <div class="font-bold">R.1 Capacit√© de remboursement calcul√©e</div>
                                    <div class="text-sm text-600">(Cash Flow + Autres revenus) / Traite</div>
                                </td>
                                <td class="p-2 text-center font-bold" style="border: 1px solid #000;">
                                    ‚â• 200%
                                </td>
                                <td class="p-2 text-center" style="border: 1px solid #000;">
                                    <div class="border-1 surface-border p-2 border-round inline-block"
                                        style="min-width: 100px;">
                                        @if (calculerR1Capacite() !== '0.0') {
                                        <span class="font-bold">{{ calculerR1Capacite() }}%</span>
                                        <div class="mt-1">
                                            <p-tag [value]="getStatutR1()" [severity]="getSeveriteR1()"
                                                size="small"></p-tag>
                                        </div>
                                        } @else {
                                        <span class="text-500">Information<br>manquante</span>
                                        }
                                    </div>
                                </td>
                                <td class="p-2 text-center" style="border: 1px solid #000;">
                                    <div class="border-1 surface-border p-2 border-round inline-block"
                                        style="min-width: 100px;">
                                        @if (calculerR1Propose() !== 'N/A' && calculerR1Propose() !== '0.0') {
                                        <span class="font-bold">{{ calculerR1Propose() }}%</span>
                                        <div class="mt-1">
                                            <p-tag [value]="getStatutR1Propose()" [severity]="getSeveriteR1Propose()"
                                                size="small"></p-tag>
                                        </div>
                                        } @else {
                                        <span class="text-500">Information<br>manquante</span>
                                        }
                                    </div>
                                </td>
                            </tr>

                            <!-- R.2 Solvabilit√© -->
                            <tr>
                                <td class="p-2" style="border: 1px solid #000;">
                                    <div class="font-bold">R.2 Ratio de solvabilit√©</div>
                                    <div class="text-sm text-600">Capitaux propres / Total Actif</div>
                                </td>
                                <td class="p-2 text-center font-bold" style="border: 1px solid #000;">
                                    ‚â• 35%
                                </td>
                                <td class="p-2 text-center" style="border: 1px solid #000;">
                                    <div class="border-1 surface-border p-2 border-round inline-block"
                                        style="min-width: 100px;">
                                        @if (calculerR2Solvabilite() !== '0.0') {
                                        <span class="font-bold">{{ calculerR2Solvabilite() }}%</span>
                                        <div class="mt-1">
                                            <p-tag [value]="getStatutR2()" [severity]="getSeveriteR2()"
                                                size="small"></p-tag>
                                        </div>
                                        } @else {
                                        <span class="text-500">Information<br>manquante</span>
                                        }
                                    </div>
                                </td>
                                <td class="p-2 text-center" style="border: 1px solid #000;">
                                    <div class="border-1 surface-border p-2 border-round inline-block"
                                        style="min-width: 100px;">
                                        @if (calculerR2Solvabilite() !== '0.0') {
                                        <span class="font-bold">{{ calculerR2Solvabilite() }}%</span>
                                        <div class="mt-1">
                                            <p-tag [value]="getStatutR2()" [severity]="getSeveriteR2()"
                                                size="small"></p-tag>
                                        </div>
                                        } @else {
                                        <span class="text-500">Information<br>manquante</span>
                                        }
                                    </div>
                                </td>
                            </tr>

                            <!-- R.3 Liquidit√© -->
                            <tr>
                                <td class="p-2" style="border: 1px solid #000;">
                                    <div class="font-bold">R.3 Ratio de liquidit√© √† √©ch√©ance</div>
                                    <div class="text-sm text-600">(Cr√©ances+Tr√©sorerie) / Dettes √† court terme</div>
                                </td>
                                <td class="p-2 text-center font-bold" style="border: 1px solid #000;">
                                    ‚â• 100%
                                </td>
                                <td class="p-2 text-center" style="border: 1px solid #000;">
                                    <div class="border-1 surface-border p-2 border-round inline-block"
                                        style="min-width: 100px;">
                                        @if (calculerR3Liquidite() !== '0.0') {
                                        <span class="font-bold">{{ calculerR3Liquidite() }}%</span>
                                        <div class="mt-1">
                                            <p-tag [value]="getStatutR3()" [severity]="getSeveriteR3()"
                                                size="small"></p-tag>
                                        </div>
                                        } @else {
                                        <span class="text-500">Information<br>manquante</span>
                                        }
                                    </div>
                                </td>
                                <td class="p-2 text-center" style="border: 1px solid #000;">
                                    <div class="border-1 surface-border p-2 border-round inline-block"
                                        style="min-width: 100px;">
                                        @if (calculerR3Liquidite() !== '0.0') {
                                        <span class="font-bold">{{ calculerR3Liquidite() }}%</span>
                                        <div class="mt-1">
                                            <p-tag [value]="getStatutR3()" [severity]="getSeveriteR3()"
                                                size="small"></p-tag>
                                        </div>
                                        } @else {
                                        <span class="text-500">Information<br>manquante</span>
                                        }
                                    </div>
                                </td>
                            </tr>

                            <!-- R.4 Endettement -->
                            <tr>
                                <td class="p-2" style="border: 1px solid #000;">
                                    <div class="font-bold">R.4 Ratio d'endettement</div>
                                    <div class="text-sm text-600">(Dettes totales + Cr√©dit) / (Total Actif + Cr√©dit)
                                    </div>
                                </td>
                                <td class="p-2 text-center font-bold" style="border: 1px solid #000;">
                                    &lt; 50%
                                </td>
                                <td class="p-2 text-center" style="border: 1px solid #000;">
                                    <div class="border-1 surface-border p-2 border-round inline-block"
                                        style="min-width: 100px;">
                                        @if (calculerR4Endettement() !== '0.0') {
                                        <span class="font-bold">{{ calculerR4Endettement() }}%</span>
                                        <div class="mt-1">
                                            <p-tag [value]="getStatutR4()" [severity]="getSeveriteR4()"
                                                size="small"></p-tag>
                                        </div>
                                        } @else {
                                        <span class="text-500">Information<br>manquante</span>
                                        }
                                    </div>
                                </td>
                                <td class="p-2 text-center" style="border: 1px solid #000;">
                                    <div class="border-1 surface-border p-2 border-round inline-block"
                                        style="min-width: 100px;">
                                        @if (calculerR4Propose() !== 'N/A' && calculerR4Propose() !== '0.0') {
                                        <span class="font-bold">{{ calculerR4Propose() }}%</span>
                                        <div class="mt-1">
                                            <p-tag [value]="getStatutR4Propose()" [severity]="getSeveriteR4Propose()"
                                                size="small"></p-tag>
                                        </div>
                                        } @else {
                                        <span class="text-500">Information<br>manquante</span>
                                        }
                                    </div>
                                </td>
                            </tr>

                            <!-- R.5 D√©pendance -->
                            <tr>
                                <td class="p-2" style="border: 1px solid #000;">
                                    <div class="font-bold">R.5 Ratio de d√©pendance</div>
                                    <div class="text-sm text-600">Autres revenus / Revenus totaux</div>
                                </td>
                                <td class="p-2 text-center font-bold" style="border: 1px solid #000;">
                                    &lt; 50%
                                </td>
                                <td class="p-2 text-center" style="border: 1px solid #000;">
                                    <div class="border-1 surface-border p-2 border-round inline-block"
                                        style="min-width: 100px;">
                                        @if (calculerR5Dependance() !== '0.0') {
                                        <span class="font-bold">{{ calculerR5Dependance() }}%</span>
                                        <div class="mt-1">
                                            <p-tag [value]="getStatutR5()" [severity]="getSeveriteR5()"
                                                size="small"></p-tag>
                                        </div>
                                        } @else {
                                        <span class="text-500">Information<br>manquante</span>
                                        }
                                    </div>
                                </td>
                                <td class="p-2 text-center" style="border: 1px solid #000;">
                                    <div class="border-1 surface-border p-2 border-round inline-block"
                                        style="min-width: 100px;">
                                        @if (calculerR5Dependance() !== '0.0') {
                                        <span class="font-bold">{{ calculerR5Dependance() }}%</span>
                                        <div class="mt-1">
                                            <p-tag [value]="getStatutR5()" [severity]="getSeveriteR5()"
                                                size="small"></p-tag>
                                        </div>
                                        } @else {
                                        <span class="text-500">Information<br>manquante</span>
                                        }
                                    </div>
                                </td>
                            </tr>

                            <!-- R.6 Couverture Garantie -->
                            <tr>
                                <td class="p-2" style="border: 1px solid #000;">
                                    <div class="font-bold">R.6 Ratio de couverture de la garantie</div>
                                    <div class="text-sm text-600">Valeur de la garantie / Cr√©dit</div>
                                </td>
                                <td class="p-2 text-center font-bold" style="border: 1px solid #000;">
                                    &gt; 150%
                                </td>
                                <td class="p-2 text-center" style="border: 1px solid #000;">
                                    <div class="border-1 surface-border p-2 border-round inline-block"
                                        style="min-width: 100px;">
                                        @if (calculerR6Couverture() !== '0.0') {
                                        <span class="font-bold">{{ calculerR6Couverture() }}%</span>
                                        <div class="mt-1">
                                            <p-tag [value]="getStatutR6()" [severity]="getSeveriteR6()"
                                                size="small"></p-tag>
                                        </div>
                                        } @else {
                                        <span class="text-500">Information<br>manquante</span>
                                        }
                                    </div>
                                </td>
                                <td class="p-2 text-center" style="border: 1px solid #000;">
                                    <div class="border-1 surface-border p-2 border-round inline-block"
                                        style="min-width: 100px;">
                                        @if (calculerR6Propose() !== 'N/A' && calculerR6Propose() !== '0.0') {
                                        <span class="font-bold">{{ calculerR6Propose() }}%</span>
                                        <div class="mt-1">
                                            <p-tag [value]="getStatutR6Propose()" [severity]="getSeveriteR6Propose()"
                                                size="small"></p-tag>
                                        </div>
                                        } @else {
                                        <span class="text-500">Information<br>manquante</span>
                                        }
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- R√©sum√© conformit√© -->
                    <div class="grid mt-3">
                        <div class="col-6">
                            <div class="p-2 border-round text-center"
                                [ngClass]="allRatiosConformesSollicite() ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                <strong>Sollicit√© :</strong> {{ getNbSeuilsRespetesSollicite() }}/6 conformes
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 border-round text-center"
                                [ngClass]="allRatiosConformesPropose() ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                <strong>Propos√© :</strong> {{ getNbSeuilsRespetesPropose() }}/6 conformes
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommandations (MANAGER/DA) - Compact -->
    <div class="grid mb-4">
        <div class="col-12">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="flex align-items-center gap-2 p-3">
                        <i class="pi pi-lightbulb text-yellow-600"></i>
                        <h4 class="m-0">Recommandations et Analyse</h4>
                    </div>
                </ng-template>
                <div class="grid">
                    <div class="col-12 md:col-4">
                        <h6 class="text-blue-700 mb-2">üí° Recommandations</h6>
                        @for (recommandation of getRecommandations(); track recommandation) {
                        <div class="text-sm text-700 mb-1">{{ recommandation }}</div>
                        }
                    </div>
                    <div class="col-12 md:col-4">
                        <h6 class="text-orange-700 mb-2">‚ö†Ô∏è Facteurs de Risque</h6>
                        @for (facteur of getAnalyseRisque().facteurs; track facteur) {
                        <div class="text-sm text-700 mb-1">‚Ä¢ {{ facteur }}</div>
                        }
                    </div>
                    <div class="col-12 md:col-4">
                        <h6 class="text-purple-700 mb-2">‚öñÔ∏è D√©cision</h6>
                        <div class="flex align-items-center gap-2 mb-2">
                            <p-tag [value]="getRecommandationDecision().decision.replace('_', ' ')"
                                [severity]="getDecisionSeverity()"></p-tag>
                        </div>
                        <div class="text-sm text-700">{{ getRecommandationDecision().justification }}</div>
                    </div>
                </div>
            </p-card>
        </div>
    </div>
    } <!-- fin MANAGER/DA -->

    <!-- ================================================================ -->
    <!-- SECTION 2 : DEMANDE DE CR√âDIT (COMPACT - 2 LIGNES)               -->
    <!-- ================================================================ -->
    <div class="grid mb-3">
        <div class="col-12">
            <div class="surface-card p-3 border-round shadow-1">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-credit-card text-red-600"></i>
                    <span class="font-bold text-lg">Demande de Cr√©dit</span>
                </div>
                <!-- Ligne 1 : Montant, Dur√©e, √âch√©ance, Nbre √©ch -->
                <div class="grid">
                    <div class="col-3">
                        <span class="text-600 text-sm">Montant demand√©:</span>
                        <span class="font-bold ml-2">{{ formatCurrency(getMontantDemande()) }}</span>
                    </div>
                    <div class="col-2">
                        <span class="text-600 text-sm">Dur√©e:</span>
                        <span class="font-bold ml-2">{{ getDureeDemande() }} mois</span>
                    </div>
                    <div class="col-2">
                        <span class="text-600 text-sm">√âch√©ance:</span>
                        <span class="font-bold ml-2">{{ formatCurrency(getEcheanceDemande()) }}</span>
                    </div>
                    <div class="col-2">
                        <span class="text-600 text-sm">Nbre √©ch.:</span>
                        <span class="font-bold ml-2">{{ getNbreEcheanceDemande() }}</span>
                    </div>
                    <div class="col-3">
                        <span class="text-600 text-sm">Statut:</span>
                        <p-tag [value]="getStatutDemande()" [severity]="getStatutSeverity(getStatutDemande())"
                            class="ml-2"></p-tag>
                    </div>
                </div>
                <!-- Ligne 2 : Objet, P√©riodicit√©, Localisation -->
                <div class="grid mt-2">
                    <div class="col-4">
                        <span class="text-600 text-sm">Objet:</span>
                        <span class="ml-2">{{ getObjetCredit() }}</span>
                    </div>
                    <div class="col-2">
                        <span class="text-600 text-sm">P√©riodicit√©:</span>
                        <span class="ml-2">{{ getPeriodicite() }}</span>
                    </div>
                    <div class="col-6">
                        <span class="text-600 text-sm">Localisation:</span>
                        <span class="ml-2">{{ getResumeAdministratif() }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================================================ -->
    <!-- SECTION 3 : INFORMATIONS PROMOTEUR + ENTREPRISE (COMPACT)        -->
    <!-- ================================================================ -->
    <div class="grid mb-3">
        <div class="col-12 lg:col-6">
            <div class="surface-card p-3 border-round shadow-1 h-full">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-user text-blue-600"></i>
                    <span class="font-bold">Promoteur</span>
                </div>
                <div class="grid text-sm">
                    @for (item of getPromoteurData().slice(0, 6); track item.label) {
                    <div class="col-6 py-1">
                        <span class="text-600">{{ item.label }}:</span>
                        <span class="ml-1 font-medium">{{ item.value }}</span>
                    </div>
                    }
                </div>
            </div>
        </div>
        <div class="col-12 lg:col-6">
            <div class="surface-card p-3 border-round shadow-1 h-full">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-building text-green-600"></i>
                    <span class="font-bold">Entreprise</span>
                </div>
                <div class="grid text-sm">
                    @for (item of getEntrepriseData().slice(0, 6); track item.label) {
                    <div class="col-6 py-1">
                        <span class="text-600">{{ item.label }}:</span>
                        <span class="ml-1 font-medium">{{ item.value }}</span>
                    </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- ================================================================ -->
    <!-- SECTION 4 : PERSONNES CAUTION (COMPACT)                          -->
    <!-- ================================================================ -->
    <div class="grid mb-3">
        <div class="col-12">
            <div class="surface-card p-3 border-round shadow-1">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-users text-teal-600"></i>
                    <span class="font-bold">Personnes Caution</span>
                    <p-badge [value]="getNombrePersonnesCaution().toString()"
                        [severity]="getNombrePersonnesCaution() > 0 ? 'success' : 'warn'"></p-badge>
                </div>
                @if (!hasPersonnesCaution()) {
                <div class="text-center text-orange-600 py-2">
                    <i class="pi pi-exclamation-triangle mr-2"></i>
                    Aucune personne caution renseign√©e
                </div>
                } @else {
                <div class="grid text-sm">
                    @for (personne of getPersonnesCautionCompact(); track personne) {
                    <div class="col-12 md:col-4 py-1">
                        <i class="pi pi-user text-teal-500 mr-1"></i>{{ personne }}
                    </div>
                    }
                </div>
                }
            </div>
        </div>
    </div>

    <!-- ================================================================ -->
    <!-- SECTION 5 : BILAN (COMPACT)                                      -->
    <!-- ================================================================ -->
    <div class="grid mb-3">
        <div class="col-12 lg:col-8">
            <div class="surface-card p-3 border-round shadow-1 h-full">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-chart-bar text-orange-600"></i>
                    <span class="font-bold">Bilan Entreprise</span>
                </div>
                <div class="grid text-sm">
                    @for (item of getBilanEntrepriseData(); track item.label) {
                    <div class="col-6 md:col-4 py-1" [ngClass]="{'font-bold bg-blue-50 border-round': item.isTotal}">
                        <span class="text-600">{{ item.label }}:</span>
                        <span class="ml-1">
                            @if (item.isRatio) {
                            <p-tag [value]="item.value" [severity]="item.severity" size="small"></p-tag>
                            } @else {
                            {{ item.value }}
                            }
                        </span>
                    </div>
                    }
                </div>
            </div>
        </div>
        <div class="col-12 lg:col-4">
            <div class="surface-card p-3 border-round shadow-1 h-full">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-wallet text-purple-600"></i>
                    <span class="font-bold">Patrimoine Personnel</span>
                </div>
                <div class="text-sm">
                    @for (item of getBilanPersonnelData(); track item.label) {
                    <div class="py-1" [ngClass]="{'font-bold bg-blue-50 border-round px-2': item.isTotal}">
                        <span class="text-600">{{ item.label }}:</span>
                        <span class="ml-1">{{ item.value }}</span>
                    </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- ================================================================ -->
    <!-- SECTION 6 : EXPLOITATION (COMPACT)                               -->
    <!-- ================================================================ -->
    <div class="grid mb-3">
        <div class="col-12 lg:col-6">
            <div class="surface-card p-3 border-round shadow-1 h-full">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-calendar text-blue-600"></i>
                    <span class="font-bold">Exploitation Actuelle</span>
                </div>
                <div class="grid text-sm">
                    @for (item of getExploitationActuelleData(); track item.label) {
                    <div class="col-6 py-1" [ngClass]="{'font-bold bg-blue-50 border-round': item.isTotal}">
                        <span class="text-600">{{ item.label }}:</span>
                        <span class="ml-1">
                            @if (item.isRatio) {
                            <p-tag [value]="item.value" [severity]="item.severity" size="small"></p-tag>
                            } @else {
                            {{ item.value }}
                            }
                        </span>
                    </div>
                    }
                </div>
            </div>
        </div>
        <div class="col-12 lg:col-6">
            <div class="surface-card p-3 border-round shadow-1 h-full">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-chart-line text-green-600"></i>
                    <span class="font-bold">Exploitation Pr√©visionnelle</span>
                </div>
                <div class="grid text-sm">
                    @for (item of getExploitationPrevisionnelleData(); track item.label) {
                    <div class="col-6 py-1" [ngClass]="{'font-bold bg-blue-50 border-round': item.isTotal}">
                        <span class="text-600">{{ item.label }}:</span>
                        <span class="ml-1">
                            @if (item.isRatio) {
                            <p-tag [value]="item.value" [severity]="item.severity" size="small"></p-tag>
                            } @else {
                            {{ item.value }}
                            }
                        </span>
                    </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- ================================================================ -->
    <!-- SECTION 7 : R√âSUM√â FINANCIER (COMPACT - 1 LIGNE)                 -->
    <!-- ================================================================ -->
    <div class="grid mb-3">
        <div class="col-12">
            <div class="surface-card p-3 border-round shadow-1">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-chart-bar text-green-600"></i>
                    <span class="font-bold">R√©sum√© Financier</span>
                </div>
                <div class="grid text-sm">
                    <div class="col-3 text-center">
                        <span class="text-600">Total Actif:</span>
                        <span class="font-bold text-green-700 ml-1">{{ formatCurrency(calculerTotalActif()) }}</span>
                    </div>
                    <div class="col-3 text-center">
                        <span class="text-600">Total Passif:</span>
                        <span class="font-bold text-green-700 ml-1">{{ formatCurrency(calculerTotalPassif()) }}</span>
                    </div>
                    <div class="col-3 text-center">
                        <span class="text-600">Patrimoine:</span>
                        <span class="font-bold text-green-700 ml-1">{{ formatCurrency(calculerPatrimoinePersonnel())
                            }}</span>
                    </div>
                    <div class="col-3 text-center">
                        <span class="text-600">Garantie:</span>
                        <span class="font-bold text-blue-700 ml-1">{{ formatCurrency(getValeurGarantie()) }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================================================ -->
    <!-- ACTIONS FOOTER                                                    -->
    <!-- ================================================================ -->
    <div class="grid">
        <div class="col-12">
            <div class="flex justify-content-between align-items-center gap-3 p-3 bg-gray-50 border-round">
                <p-button label="Retour" icon="pi pi-arrow-left" outlined (onClick)="retourListe()"></p-button>
                @if (peutImprimer()) {
                <div class="flex gap-2">
                    <p-button label="Aper√ßu" icon="pi pi-eye" outlined size="small"
                        (onClick)="previsualiserImpression()"></p-button>
                    <p-button label="Imprimer" icon="pi pi-print"
                        [style]="{'background': '#28a745', 'border-color': '#28a745'}"
                        (onClick)="imprimerBilan()"></p-button>
                </div>
                }
            </div>
        </div>
    </div>
    } <!-- fin @if resumeCredit -->

    <!-- Empty State -->
    @if (!state().resumeCredit && !state().loading && !state().error) {
    <div class="grid">
        <div class="col-12">
            <p-card>
                <div class="text-center p-8">
                    <i class="pi pi-info-circle text-6xl text-blue-500 mb-3"></i>
                    <h3 class="text-600">Aucune donn√©e disponible</h3>
                    <p class="text-500">Le r√©sum√© de cr√©dit n'est pas encore disponible.</p>
                    <p-button label="Retour" icon="pi pi-arrow-left" outlined (onClick)="retourListe()"></p-button>
                </div>
            </p-card>
        </div>
    </div>
    }
</div>

<p-toast></p-toast>