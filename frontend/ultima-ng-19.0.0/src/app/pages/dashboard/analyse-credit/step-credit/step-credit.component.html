<!-- step-credit.component.html -->
<div class="card">
    <h1 class="text-surface-900 dark:text-surface-0 text-xl font-bold mb-6">Analyse de Demande de Crédit</h1>

    <!-- PrimeNG Toast pour les notifications -->
    <p-toast></p-toast>

    <!-- Stepper -->
    <p-steps [model]="items()" [activeIndex]="activeIndex()" [readonly]="false" styleClass="mb-5"></p-steps>

    <div class="p-fluid">
        <!-- Étape 1: Informations de base (promoteur et entreprise) -->
        <div *ngIf="activeIndex() === 0">
            <p-card header="Informations du promoteur et de l'entreprise" class="shadow-3">
                <form [formGroup]="infoBaseForm" class="p-fluid">

                    <div class="grid gap-3">
                        <!-- Section Promoteur -->
                        <div class="col-12">
                            <h2 class="text-xl font-bold border-bottom-1 surface-border pb-2 mb-3">Informations du
                                promoteur</h2>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="nomPromoteur" class="font-medium block mb-2">Nom *</label>
                                <input id="nomPromoteur" type="text" pInputText formControlName="nomPromoteur"
                                    class="w-full" />
                                <small
                                    *ngIf="infoBaseForm.get('nomPromoteur')?.invalid && infoBaseForm.get('nomPromoteur')?.touched"
                                    class="p-error block mt-1">
                                    Le nom est requis
                                </small>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="prenomPromoteur" class="font-medium block mb-2">Prénom *</label>
                                <input id="prenomPromoteur" type="text" pInputText formControlName="prenomPromoteur"
                                    class="w-full" />
                                <small
                                    *ngIf="infoBaseForm.get('prenomPromoteur')?.invalid && infoBaseForm.get('prenomPromoteur')?.touched"
                                    class="p-error block mt-1">
                                    Le prénom est requis
                                </small>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="dateNaissance" class="font-medium block mb-2">Date de naissance</label>
                                <p-calendar id="dateNaissance" formControlName="dateNaissance" [showIcon]="true"
                                    dateFormat="dd/mm/yy" class="w-full"></p-calendar>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="numeroIdentite" class="font-medium block mb-2">Numéro d'identité</label>
                                <input id="numeroIdentite" type="text" pInputText formControlName="numeroIdentite"
                                    class="w-full" />
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="telephonePromoteur" class="font-medium block mb-2">Téléphone</label>
                                <input id="telephonePromoteur" type="text" pInputText
                                    formControlName="telephonePromoteur" class="w-full" />
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="emailPromoteur" class="font-medium block mb-2">Email</label>
                                <input id="emailPromoteur" type="email" pInputText formControlName="emailPromoteur"
                                    class="w-full" />
                                <small
                                    *ngIf="infoBaseForm.get('emailPromoteur')?.invalid && infoBaseForm.get('emailPromoteur')?.touched"
                                    class="p-error block mt-1">
                                    L'email n'est pas valide
                                </small>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="field">
                                <label for="adressePromoteur" class="font-medium block mb-2">Adresse</label>
                                <input id="adressePromoteur" pTextarea formControlName="adressePromoteur" rows="2"
                                    class="w-full" [autoResize]="true" fluid />
                            </div>
                        </div>

                        <!-- Section Entreprise -->
                        <div class="col-12 mt-5">
                            <h2 class="text-xl font-bold border-bottom-1 surface-border pb-2 mb-3">Informations de
                                l'entreprise</h2>
                        </div>

                        <div class="col-12 md:col-8">
                            <div class="field">
                                <label for="nomEntreprise" class="font-medium block mb-2">Nom de l'entreprise *</label>
                                <input id="nomEntreprise" type="text" pInputText formControlName="nomEntreprise"
                                    class="w-full" />
                                <small
                                    *ngIf="infoBaseForm.get('nomEntreprise')?.invalid && infoBaseForm.get('nomEntreprise')?.touched"
                                    class="p-error block mt-1">
                                    Le nom est requis
                                </small>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="dateCreation" class="font-medium block mb-2">Date de création</label>
                                <p-calendar id="dateCreation" formControlName="dateCreation" [showIcon]="true"
                                    dateFormat="dd/mm/yy" class="w-full"></p-calendar>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="formeJuridique" class="font-medium block mb-2">Forme juridique</label>
                                <p-dropdown id="formeJuridique" formControlName="formeJuridique"
                                    [options]="formeJuridiques" optionLabel="label" class="w-full"></p-dropdown>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="secteurActivite" class="font-medium block mb-2">Secteur d'activité</label>
                                <p-dropdown id="secteurActivite" formControlName="secteurActivite"
                                    [options]="secteursActivite" optionLabel="label" class="w-full"></p-dropdown>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="numeroRegistre" class="font-medium block mb-2">Numéro de registre</label>
                                <input id="numeroRegistre" type="text" pInputText formControlName="numeroRegistre"
                                    class="w-full" />
                            </div>
                        </div>

                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label for="telephoneEntreprise" class="font-medium block mb-2">Téléphone</label>
                                <input id="telephoneEntreprise" type="text" pInputText
                                    formControlName="telephoneEntreprise" class="w-full" />
                            </div>
                        </div>

                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label for="emailEntreprise" class="font-medium block mb-2">Email</label>
                                <input id="emailEntreprise" type="email" pInputText formControlName="emailEntreprise"
                                    class="w-full" />
                                <small
                                    *ngIf="infoBaseForm.get('emailEntreprise')?.invalid && infoBaseForm.get('emailEntreprise')?.touched"
                                    class="p-error block mt-1">
                                    L'email n'est pas valide
                                </small>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="field">
                                <label for="adresseEntreprise" class="font-medium block mb-2">Adresse</label>
                                <input id="adresseEntreprise" pTextarea formControlName="adresseEntreprise" rows="2"
                                    class="w-full" [autoResize]="true" fluid />
                            </div>
                        </div>
                    </div>
                </form>
            </p-card>
        </div>

        <!-- Étape 2: Bilan entreprise -->
        <div *ngIf="activeIndex() === 1">
            <p-card header="Bilan de l'entreprise">
                <form [formGroup]="bilanEntrepriseForm" class="p-fluid">
                    <div class="grid gap-3">
                        <!-- Section Actifs -->
                        <div class="col-12">
                            <h2 class="text-xl font-bold border-bottom-1 surface-border pb-2 mb-4">Actifs</h2>
                        </div>

                        <div class="col-12 md:col-6 lg:col-3">
                            <div class="field">
                                <label for="liquidites" class="block font-medium mb-2">
                                    Liquidités
                                    <small class="block text-color-secondary">Argent en caisse et en banque</small>
                                </label>
                                <p-inputNumber id="liquidites" formControlName="liquidites" mode="currency"
                                    currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-3">
                            <div class="field">
                                <label for="creancesClients" class="block font-medium mb-2">
                                    Créances clients
                                    <small class="block text-color-secondary">Montant dû par vos clients</small>
                                </label>
                                <p-inputNumber id="creancesClients" formControlName="creancesClients" mode="currency"
                                    currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-3">
                            <div class="field">
                                <label for="valeurStocks" class="block font-medium mb-2">Valeur des stocks</label>
                                <p-inputNumber id="valeurStocks" formControlName="valeurStocks" mode="currency"
                                    currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-3">
                            <div class="field">
                                <label for="valeurEquipements" class="block font-medium mb-2">Valeur des
                                    équipements</label>
                                <p-inputNumber id="valeurEquipements" formControlName="valeurEquipements"
                                    mode="currency" currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <!-- Total Actif -->
                        <!-- <div class="col-12 mt-3">
                            <div class="p-3 bg-green-50 border-round font-bold border-1 border-green-200">
                                Total Actif: {{calculerTotalActif() | currency:'GNF':'symbol':'1.0-0':'fr-FR'}}
                            </div>
                        </div> -->

                        <!-- Section Passifs -->
                        <div class="col-12 mt-5">
                            <h2 class="text-xl font-bold border-bottom-1 surface-border pb-2 mb-4">Passifs</h2>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="dettesFournisseurs" class="block font-medium mb-2">Dettes
                                    fournisseurs</label>
                                <p-inputNumber id="dettesFournisseurs" formControlName="dettesFournisseurs"
                                    mode="currency" currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="emprunts" class="block font-medium mb-2">Emprunts actuels</label>
                                <p-inputNumber id="emprunts" formControlName="emprunts" mode="currency" currency="GNF"
                                    locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="capitalPropre" class="block font-medium mb-2">Capital propre</label>
                                <p-inputNumber id="capitalPropre" formControlName="capitalPropre" mode="currency"
                                    currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <!-- Total Passif -->
                        <!-- <div class="col-12 mt-3">
                            <div class="p-3 bg-green-50 border-round font-bold border-1 border-green-200">
                                Total Passif: {{calculerTotalPassif() | currency:'GNF':'symbol':'1.0-0':'fr-FR'}}
                            </div>
                        </div> -->

                        <!-- Ratio -->
                        <!-- <div class="col-12 mt-5">
                            <div class="p-3 bg-blue-50 border-round border-1 border-blue-200">
                                <div class="flex align-items-center justify-content-between">
                                    <span class="font-bold">Ratio de liquidité:</span>
                                    <span class="text-2xl font-bold text-blue-600">
                                        {{calculerRatioLiquidite() | number:'1.2-2'}}
                                    </span>
                                </div>
                            </div>
                        </div> -->
                    </div>
                </form>
            </p-card>
        </div>

        <!-- Étape 3: Bilan personnel du promoteur -->
        <div *ngIf="activeIndex() === 2">
            <p-card header="Bilan personnel du promoteur">
                <form [formGroup]="bilanPersonnelForm" class="p-fluid">
                    <div class="grid gap-3">
                        <div class="col-12">
                            <h3 class="text-lg font-bold border-bottom-1 surface-border pb-2 mb-3">Patrimoine Personnel
                            </h3>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="epargnes" class="block font-medium mb-2">Épargnes personnelles</label>
                                <p-inputNumber id="epargnes" formControlName="epargnes" mode="currency" currency="GNF"
                                    locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="valeurBiensDurables" class="block font-medium mb-2">Valeur des biens
                                    durables</label>
                                <p-inputNumber id="valeurBiensDurables" formControlName="valeurBiensDurables"
                                    mode="currency" currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <!-- <div class="col-12 mt-3">
                            <div class="p-3 bg-green-50 border-round font-bold border-1 border-green-200">
                                Total patrimoine personnel: {{ (bilanPersonnelForm.value.epargnes || 0) +
                                (bilanPersonnelForm.value.valeurBiensDurables || 0) |
                                currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                            </div>
                        </div> -->
                    </div>
                </form>
            </p-card>
        </div>

        <!-- Étape 4: Résultats actuels -->
        <div *ngIf="activeIndex() === 3">
            <p-card header="Résultats actuels (année précédente)">
                <form [formGroup]="resultatActuelForm" class="p-fluid">
                    <div class="grid gap-3">
                        <div class="col-12">
                            <h3 class="text-lg font-bold mb-3 border-bottom-1 surface-border pb-2">Résultat Actuel</h3>
                        </div>

                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label for="chiffreAffaires" class="block font-medium mb-2">Chiffre d'affaires *</label>
                                <p-inputNumber id="chiffreAffaires" formControlName="chiffreAffaires" mode="currency"
                                    currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                                <small
                                    *ngIf="resultatActuelForm.get('chiffreAffaires')?.invalid && resultatActuelForm.get('chiffreAffaires')?.touched"
                                    class="p-error block mt-1">
                                    <i class="pi pi-exclamation-circle mr-1"></i>Ce champ est obligatoire
                                </small>
                            </div>
                        </div>
                        <!-- NOUVEAU CHAMP AUTRES REVENUS ACTUEL -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label for="autresRevenusActuel" class="block font-medium mb-2">
                                    Autres revenus
                                    <small class="block text-color-secondary">Subventions, commissions, revenus
                                        annexes...</small>
                                </label>
                                <p-inputNumber id="autresRevenusActuel" formControlName="autresRevenus" mode="currency"
                                    currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <!-- AJOUTER APRÈS LES CHAMPS EXISTANTS - Total revenus et ratio -->
                        <!-- <div class="col-12 mt-2">
                            <div class="p-3 bg-blue-50 border-round border-1 border-blue-200">
                                <div class="flex align-items-center justify-content-between">
                                    <span class="font-bold">Revenus totaux actuels:</span>
                                    <span class="text-lg font-bold text-blue-600">
                                        {{ calculerRevenusTotauxActuel() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </span>
                                </div>
                            </div>
                        </div> -->

                        <!-- <div class="col-12">
                            <div class="p-3 bg-yellow-50 border-round border-1 border-yellow-200">
                                <div class="flex align-items-center justify-content-between">
                                    <span class="font-bold">Ratio de dépendance:</span>
                                    <span class="text-lg font-bold text-yellow-600">
                                        {{ calculerRatioDependanceActuel() | percent:'1.2-2' }}
                                    </span>
                                </div>
                                <small class="text-color-secondary">
                                    Part des autres revenus dans les revenus totaux
                                </small>
                            </div>
                        </div> -->

                        <!-- MODIFIER le calcul du résultat brut pour utiliser les revenus totaux -->
                        <!-- <div class="col-12 mt-2">
                            <div class="p-3 bg-green-50 border-round border-1 border-green-200">
                                <div class="flex align-items-center justify-content-between">
                                    <span class="font-bold">Résultat brut:</span>
                                    <span class="text-lg font-bold text-green-600">
                                        {{ calculerRevenusTotauxActuel() - (resultatActuelForm.value.coutMarchandises ||
                                        0) |
                                        currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </span>
                                </div>
                            </div>
                        </div> -->

                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label for="coutMarchandises" class="block font-medium mb-2">Coût des marchandises
                                    *</label>
                                <p-inputNumber id="coutMarchandises" formControlName="coutMarchandises" mode="currency"
                                    currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                                <small
                                    *ngIf="resultatActuelForm.get('coutMarchandises')?.invalid && resultatActuelForm.get('coutMarchandises')?.touched"
                                    class="p-error block mt-1">
                                    <i class="pi pi-exclamation-circle mr-1"></i>Ce champ est obligatoire
                                </small>
                            </div>
                        </div>

                        <!-- <div class="col-12 mt-2">
                            <div class="p-3 bg-green-50 border-round border-1 border-green-200">
                                <div class="flex align-items-center justify-content-between">
                                    <span class="font-bold">Résultat brut:</span>
                                    <span class="text-lg font-bold text-green-600">
                                        {{ (resultatActuelForm.value.chiffreAffaires || 0) -
                                        (resultatActuelForm.value.coutMarchandises || 0) |
                                        currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </span>
                                </div>
                            </div>
                        </div> -->

                        <!-- <div class="col-12">
                            <div class="p-3 bg-blue-50 border-round border-1 border-blue-200">
                                <div class="flex align-items-center justify-content-between">
                                    <span class="font-bold">Marge brute:</span>
                                    <span class="text-lg font-bold text-blue-600">
                                        {{ calculerMargeButeActuelle() | percent:'1.2-2' }}
                                    </span>
                                </div>
                            </div>
                        </div> -->
                    </div>
                </form>
            </p-card>
        </div>

        <!-- Étape 5: Résultats prévisionnels -->
        <div *ngIf="activeIndex() === 4">
            <p-card header="Résultats prévisionnels (après financement)">
                <form [formGroup]="resultatPrevisionnelForm" class="p-fluid">
                    <div class="grid gap-3">
                        <div class="col-12">
                            <h3 class="text-lg font-bold mb-3 border-bottom-1 surface-border pb-2">Prévisions
                                Financières</h3>
                        </div>

                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label for="chiffreAffairesPrev" class="block font-medium mb-2">Chiffre d'affaires
                                    prévisionnel *</label>
                                <p-inputNumber id="chiffreAffairesPrev" formControlName="chiffreAffaires"
                                    mode="currency" currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                                <small
                                    *ngIf="resultatPrevisionnelForm.get('chiffreAffaires')?.invalid && resultatPrevisionnelForm.get('chiffreAffaires')?.touched"
                                    class="p-error block mt-1">
                                    <i class="pi pi-exclamation-circle mr-1"></i>Ce champ est obligatoire
                                </small>
                            </div>
                        </div>
                        <!-- NOUVEAU CHAMP AUTRES REVENUS PRÉVISIONNEL -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label for="autresRevenusPrev" class="block font-medium mb-2">
                                    Autres revenus prévisionnels
                                    <small class="block text-color-secondary">Subventions, commissions, revenus
                                        annexes...</small>
                                </label>
                                <p-inputNumber id="autresRevenusPrev" formControlName="autresRevenus" mode="currency"
                                    currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <!-- AJOUTER APRÈS LES CHAMPS EXISTANTS - Total revenus et ratio prévisionnels -->
                        <!-- <div class="col-12 mt-2">
                            <div class="p-3 bg-blue-50 border-round border-1 border-blue-200">
                                <div class="flex align-items-center justify-content-between">
                                    <span class="font-bold">Revenus totaux prévisionnels:</span>
                                    <span class="text-lg font-bold text-blue-600">
                                        {{ calculerRevenusTotauxPrevisionnel() | currency:'GNF':'symbol':'1.0-0':'fr-FR'
                                        }}
                                    </span>
                                </div>
                            </div>
                        </div> -->

                        <!-- <div class="col-12">
                            <div class="p-3 bg-yellow-50 border-round border-1 border-yellow-200">
                                <div class="flex align-items-center justify-content-between">
                                    <span class="font-bold">Ratio de dépendance prévisionnel:</span>
                                    <span class="text-lg font-bold text-yellow-600">
                                        {{ calculerRatioDependancePrevisionnel() | percent:'1.2-2' }}
                                    </span>
                                </div>
                                <small class="text-color-secondary">
                                    Part des autres revenus dans les revenus totaux prévisionnels
                                </small>
                            </div>
                        </div> -->

                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label for="coutMarchandisesPrev" class="block font-medium mb-2">Coût marchandises
                                    prévisionnel *</label>
                                <p-inputNumber id="coutMarchandisesPrev" formControlName="coutMarchandises"
                                    mode="currency" currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                                <small
                                    *ngIf="resultatPrevisionnelForm.get('coutMarchandises')?.invalid && resultatPrevisionnelForm.get('coutMarchandises')?.touched"
                                    class="p-error block mt-1">
                                    <i class="pi pi-exclamation-circle mr-1"></i>Ce champ est obligatoire
                                </small>
                            </div>
                        </div>

                        <!-- MODIFIER le calcul du résultat brut prévisionnel pour utiliser les revenus totaux -->
                        <!-- <div class="col-12 mt-2">
                            <div class="p-3 bg-green-50 border-round border-1 border-green-200">
                                <div class="flex align-items-center justify-content-between">
                                    <span class="font-bold">Résultat brut prévisionnel:</span>
                                    <span class="text-lg font-bold text-green-600">
                                        {{ calculerRevenusTotauxPrevisionnel() -
                                        (resultatPrevisionnelForm.value.coutMarchandises || 0) |
                                        currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </span>
                                </div>
                            </div>
                        </div> -->

                        <!-- <div class="col-12">
                            <div class="p-3 bg-blue-50 border-round border-1 border-blue-200">
                                <div class="flex align-items-center justify-content-between">
                                    <span class="font-bold">Marge brute prévisionnelle:</span>
                                    <span class="text-lg font-bold text-blue-600">
                                        {{ calculerMargeButePrevisionnelle() | percent:'1.2-2' }}
                                    </span>
                                </div>
                            </div>
                        </div> -->
                    </div>
                </form>
            </p-card>
        </div>

        <!-- Étape 6: Charges actuelles -->
        <div *ngIf="activeIndex() === 5">
            <p-card header="Charges d'exploitation actuelles (année précédente)">
                <form [formGroup]="chargesActuellesForm" class="p-fluid">
                    <div class="grid gap-3">
                        <div class="col-12">
                            <h3 class="text-lg font-bold mb-3 border-bottom-1 surface-border pb-2">Charges Actuelles
                            </h3>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="coutTransportProduction" class="block font-medium mb-2">Transport
                                    production</label>
                                <p-inputNumber id="coutTransportProduction" formControlName="coutTransportProduction"
                                    mode="currency" currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="fraisTransportPersonnel" class="block font-medium mb-2">Transport
                                    personnel</label>
                                <p-inputNumber id="fraisTransportPersonnel" formControlName="fraisTransportPersonnel"
                                    mode="currency" currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="fraisManutention" class="block font-medium mb-2">Frais manutention</label>
                                <p-inputNumber id="fraisManutention" formControlName="fraisManutention" mode="currency"
                                    currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="montantAideExterne" class="block font-medium mb-2">Aide externe</label>
                                <p-inputNumber id="montantAideExterne" formControlName="montantAideExterne"
                                    mode="currency" currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="fraisHebergementRestauration"
                                    class="block font-medium mb-2">Hébergement/Restauration</label>
                                <p-inputNumber id="fraisHebergementRestauration"
                                    formControlName="fraisHebergementRestauration" mode="currency" currency="GNF"
                                    locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="impots" class="block font-medium mb-2">Impôts et taxes</label>
                                <p-inputNumber id="impots" formControlName="impots" mode="currency" currency="GNF"
                                    locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="loyers" class="block font-medium mb-2">Loyers</label>
                                <p-inputNumber id="loyers" formControlName="loyers" mode="currency" currency="GNF"
                                    locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>


                    </div>
                </form>
            </p-card>
        </div>

        <!-- Étape 7: Charges prévisionnelles -->
        <div *ngIf="activeIndex() === 6">
            <p-card header="Charges d'exploitation prévisionnelles (après financement)">
                <form [formGroup]="chargesPrevisionellesForm" class="p-fluid">
                    <div class="grid gap-3">
                        <div class="col-12">
                            <h3 class="text-lg font-bold mb-3 border-bottom-1 surface-border pb-2">Charges
                                Prévisionnelles</h3>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="coutTransportProductionPrev" class="block font-medium mb-2">Transport
                                    production</label>
                                <p-inputNumber id="coutTransportProductionPrev"
                                    formControlName="coutTransportProduction" mode="currency" currency="GNF"
                                    locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="fraisTransportPersonnelPrev" class="block font-medium mb-2">Transport
                                    personnel</label>
                                <p-inputNumber id="fraisTransportPersonnelPrev"
                                    formControlName="fraisTransportPersonnel" mode="currency" currency="GNF"
                                    locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="fraisManutentionPrev" class="block font-medium mb-2">Manutention</label>
                                <p-inputNumber id="fraisManutentionPrev" formControlName="fraisManutention"
                                    mode="currency" currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="montantAideExternePrev" class="block font-medium mb-2">Aide externe</label>
                                <p-inputNumber id="montantAideExternePrev" formControlName="montantAideExterne"
                                    mode="currency" currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="fraisHebergementRestaurationPrev"
                                    class="block font-medium mb-2">Hébergement/Restauration</label>
                                <p-inputNumber id="fraisHebergementRestaurationPrev"
                                    formControlName="fraisHebergementRestauration" mode="currency" currency="GNF"
                                    locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="impotsPrev" class="block font-medium mb-2">Impôts et taxes</label>
                                <p-inputNumber id="impotsPrev" formControlName="impots" mode="currency" currency="GNF"
                                    locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="loyersPrev" class="block font-medium mb-2">Loyers</label>
                                <p-inputNumber id="loyersPrev" formControlName="loyers" mode="currency" currency="GNF"
                                    locale="fr-FR" class="w-full"></p-inputNumber>
                            </div>
                        </div>


                    </div>
                </form>
            </p-card>
        </div>

        <!-- Étape 8: Demande de crédit -->
        <div *ngIf="activeIndex() === 7">
            <p-card header="Informations sur la demande de crédit">
                <form [formGroup]="demandeCreditForm" class="p-fluid">
                    <div class="grid gap-3">
                        <div class="col-12">
                            <h3 class="text-lg font-bold mb-3 border-bottom-1 surface-border pb-2">Demande de Crédit
                            </h3>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="montantDemande" class="block font-medium mb-2">Montant demandé *</label>
                                <p-inputNumber id="montantDemande" formControlName="montantDemande" mode="currency"
                                    currency="GNF" locale="fr-FR" class="w-full"></p-inputNumber>
                                <small
                                    *ngIf="demandeCreditForm.get('montantDemande')?.invalid && demandeCreditForm.get('montantDemande')?.touched"
                                    class="p-error block mt-1">
                                    <i class="pi pi-exclamation-circle mr-1"></i>Montant requis (min 1 GNF)
                                </small>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="field">
                                <label for="dureeMois" class="block font-medium mb-2">Durée (mois) *</label>
                                <p-inputNumber id="dureeMois" formControlName="dureeMois" [showButtons]="true" [min]="1"
                                    [max]="120" class="w-full" suffix=" mois"></p-inputNumber>
                                <small
                                    *ngIf="demandeCreditForm.get('dureeMois')?.invalid && demandeCreditForm.get('dureeMois')?.touched"
                                    class="p-error block mt-1">
                                    <i class="pi pi-exclamation-circle mr-1"></i>Durée entre 1 et 120 mois
                                </small>
                            </div>
                        </div>

                        <div class="col-12 lg:col-4">
                            <div class="p-3 bg-blue-50 border-round border-1 border-blue-200">
                                <div class="flex align-items-center justify-content-between">
                                    <span class="font-medium">Mensualité estimée:</span>
                                    <span class="text-lg font-bold text-blue-600">
                                        {{ calculerMensualite() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="field">
                                <label for="objetFinancement" class="block font-medium mb-2">Objet du financement
                                    *</label>
                                <input id="objetFinancement" pTextarea formControlName="objetFinancement" rows="4"
                                    class="w-full" [autoResize]="true" />

                                <small
                                    *ngIf="demandeCreditForm.get('objetFinancement')?.invalid && demandeCreditForm.get('objetFinancement')?.touched"
                                    class="p-error block mt-1">
                                    <i class="pi pi-exclamation-circle mr-1"></i>Veuillez décrire l'objet du financement
                                </small>
                            </div>
                        </div>
                    </div>
                </form>
            </p-card>
        </div>

        <!-- Étape 9: Résumé -->
        <div *ngIf="activeIndex() === 8">
            <p-card header="Résumé de votre demande de crédit">
                <div class="grid">
                    <!-- Informations du promoteur et de l'entreprise -->
                    <div class="col-12 md:col-6 mb-4">
                        <p-panel header="Informations du promoteur" [toggleable]="true">
                            <p-table [value]="[
                                { label: 'Nom', value: resumeData.promoteur?.nom || '-' },
                                { label: 'Prénom', value: resumeData.promoteur?.prenom || '-' },
                                { label: 'Email', value: resumeData.promoteur?.email || '-' },
                                { label: 'Téléphone', value: resumeData.promoteur?.telephone || '-' },
                                { label: 'Numéro d\'identité', value: resumeData.promoteur?.numero_identite || '-' },
                                { label: 'Date de naissance', value: formatDateForDisplay(resumeData.promoteur?.date_naissance) || '-' }
                            ]" styleClass="p-datatable-sm" [tableStyle]="{'min-width': '50rem'}">
                                <ng-template pTemplate="body" let-item>
                                    <tr>
                                        <td class="font-medium">{{item.label}}</td>
                                        <td>{{item.value}}</td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </p-panel>
                    </div>

                    <div class="col-12 md:col-6 mb-4">
                        <p-panel header="Informations de l'entreprise" [toggleable]="true">
                            <p-table [value]="[
                                { label: 'Nom', value: resumeData.entreprise?.nom || '-' },
                                { label: 'Forme juridique', value: resumeData.entreprise?.forme_juridique || '-' },
                                { label: 'Secteur d\'activité', value: resumeData.entreprise?.secteur_activite || '-' },
                                { label: 'Numéro de registre', value: resumeData.entreprise?.numero_registre || '-' },
                                { label: 'Email', value: resumeData.entreprise?.email || '-' },
                                { label: 'Téléphone', value: resumeData.entreprise?.telephone || '-' }
                            ]" styleClass="p-datatable-sm" [tableStyle]="{'min-width': '50rem'}">
                                <ng-template pTemplate="body" let-item>
                                    <tr>
                                        <td class="font-medium">{{item.label}}</td>
                                        <td>{{item.value}}</td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </p-panel>
                    </div>

                    <!-- Bilan financier -->
                    <div class="col-12 mb-4">
                        <p-panel header="Bilan financier" [toggleable]="true">
                            <div class="grid">
                                <div class="col-12 md:col-6">
                                    <h3 class="text-lg font-medium">Bilan entreprise</h3>
                                    <p-table [value]="[
                                        { label: 'Total actifs', value: calculerTotalActif() | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        { label: 'Total passifs', value: calculerTotalPassif() | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                    ]" styleClass="p-datatable-sm" [tableStyle]="{'min-width': '30rem'}">
                                        <ng-template pTemplate="body" let-item>
                                            <tr>
                                                <td class="font-medium">{{item.label}}</td>
                                                <td>
                                                    <span *ngIf="item.severity" [ngClass]="{
                                                        'text-green-500': item.severity === 'success',
                                                        'text-blue-500': item.severity === 'info',
                                                        'text-yellow-500': item.severity === 'warn',
                                                        'text-red-500': item.severity === 'danger'
                                                    }">{{item.value}}</span>
                                                    <span *ngIf="!item.severity">{{item.value}}</span>
                                                </td>
                                            </tr>
                                        </ng-template>
                                    </p-table>
                                </div>

                                <div class="col-12 md:col-6">
                                    <h3 class="text-lg font-medium">Bilan personnel</h3>
                                    <p-table [value]="[
                                        { label: 'Épargnes', value: resumeData.bilanPersonnel?.epargnes | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        { label: 'Biens durables', value: resumeData.bilanPersonnel?.valeur_biens_durables | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        { label: 'Total patrimoine', value: (resumeData.bilanPersonnel?.epargnes || 0) + (resumeData.bilanPersonnel?.valeur_biens_durables || 0) | currency:'GNF':'symbol':'1.0-0':'en-US' }
                                    ]" styleClass="p-datatable-sm" [tableStyle]="{'min-width': '30rem'}">
                                        <ng-template pTemplate="body" let-item>
                                            <tr>
                                                <td class="font-medium">{{item.label}}</td>
                                                <td>{{item.value}}</td>
                                            </tr>
                                        </ng-template>
                                    </p-table>
                                </div>
                            </div>
                        </p-panel>
                    </div>

                    <!-- Performance économique -->
                    <div class="col-12 mb-4">
                        <p-panel header="Performance économique" [toggleable]="true">
                            <div class="grid">
                                <div class="col-12 md:col-6">
                                    <h3 class="text-lg font-medium">Résultats actuels</h3>
                                    <p-table [value]="[
                                            { label: 'Chiffre d\'affaires', value: resumeData.resultatActuel?.chiffre_affaires | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                            { label: 'Autres revenus', value: resumeData.resultatActuel?.autres_revenus | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                            { label: 'Revenus totaux', value: (resumeData.resultatActuel?.chiffre_affaires || 0) + (resumeData.resultatActuel?.autres_revenus || 0) | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                            { label: 'Coût des marchandises', value: resumeData.resultatActuel?.cout_marchandises | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        ]" styleClass="p-datatable-sm" [tableStyle]="{'min-width': '30rem'}">
                                        <ng-template pTemplate="body" let-item>
                                            <tr>
                                                <td class="font-medium">{{item.label}}</td>
                                                <td>
                                                    <span *ngIf="item.severity" [ngClass]="{
                                                        'text-green-500': item.severity === 'success',
                                                        'text-blue-500': item.severity === 'info',
                                                        'text-yellow-500': item.severity === 'warn',
                                                        'text-red-500': item.severity === 'danger'
                                                    }">{{item.value}}</span>
                                                    <span *ngIf="!item.severity">{{item.value}}</span>
                                                </td>
                                            </tr>
                                        </ng-template>
                                    </p-table>
                                </div>

                                <div class="col-12 md:col-6">
                                    <h3 class="text-lg font-medium">Résultats prévisionnels</h3>
                                    <p-table [value]="[
                                            { label: 'Chiffre d\'affaires', value: resumeData.resultatPrevisionnel?.chiffre_affaires | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                            { label: 'Autres revenus', value: resumeData.resultatPrevisionnel?.autres_revenus | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                            { label: 'Revenus totaux', value: (resumeData.resultatPrevisionnel?.chiffre_affaires || 0) + (resumeData.resultatPrevisionnel?.autres_revenus || 0) | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                            { label: 'Coût des marchandises', value: resumeData.resultatPrevisionnel?.cout_marchandises | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        ]" styleClass="p-datatable-sm" [tableStyle]="{'min-width': '30rem'}">
                                        <ng-template pTemplate="body" let-item>
                                            <tr>
                                                <td class="font-medium">{{item.label}}</td>
                                                <td>
                                                    <span *ngIf="item.severity" [ngClass]="{
                                                        'text-green-500': item.severity === 'success',
                                                        'text-blue-500': item.severity === 'info',
                                                        'text-yellow-500': item.severity === 'warn',
                                                        'text-red-500': item.severity === 'danger'
                                                    }">{{item.value}}</span>
                                                    <span *ngIf="!item.severity">{{item.value}}</span>
                                                </td>
                                            </tr>
                                        </ng-template>
                                    </p-table>
                                </div>
                            </div>
                        </p-panel>
                    </div>

                    <!-- Charges d'exploitation -->
                    <div class="col-12 mb-4">
                        <p-panel header="Charges d'exploitation" [toggleable]="true">
                            <div class="grid">
                                <div class="col-12 md:col-6">
                                    <h3 class="text-lg font-medium">Charges actuelles</h3>
                                    <p-table [value]="[
                                        { label: 'Transport production', value: resumeData.chargesActuelles?.cout_transport_production | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        { label: 'Transport personnel', value: resumeData.chargesActuelles?.frais_transport_personnel | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        { label: 'Manutention', value: resumeData.chargesActuelles?.frais_manutention | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        { label: 'Aide externe', value: resumeData.chargesActuelles?.montant_aide_externe | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        { label: 'Hébergement/Restauration', value: resumeData.chargesActuelles?.frais_hebergement_restauration | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        { label: 'Impôts', value: resumeData.chargesActuelles?.impots | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        { label: 'Loyers', value: resumeData.chargesActuelles?.loyers | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        { label: 'Total charges', value: calculerTotalChargesActuelles() | currency:'GNF':'symbol':'1.0-0':'en-US', isTotal: true }
                                    ]" styleClass="p-datatable-sm" [tableStyle]="{'min-width': '30rem'}">
                                        <ng-template pTemplate="body" let-item>
                                            <tr [ngClass]="{'bg-gray-100 dark:bg-gray-800 font-bold': item.isTotal}">
                                                <td class="font-medium">{{item.label}}</td>
                                                <td>{{item.value}}</td>
                                            </tr>
                                        </ng-template>
                                    </p-table>
                                </div>

                                <div class="col-12 md:col-6">
                                    <h3 class="text-lg font-medium">Charges prévisionnelles</h3>
                                    <p-table [value]="[
                                        { label: 'Transport production', value: resumeData.chargesPrevisionnelles?.cout_transport_production | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        { label: 'Transport personnel', value: resumeData.chargesPrevisionnelles?.frais_transport_personnel | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        { label: 'Manutention', value: resumeData.chargesPrevisionnelles?.frais_manutention | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        { label: 'Aide externe', value: resumeData.chargesPrevisionnelles?.montant_aide_externe | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        { label: 'Hébergement/Restauration', value: resumeData.chargesPrevisionnelles?.frais_hebergement_restauration | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        { label: 'Impôts', value: resumeData.chargesPrevisionnelles?.impots | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        { label: 'Loyers', value: resumeData.chargesPrevisionnelles?.loyers | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        { label: 'Total charges', value: calculerTotalChargesPrevisionnelles() | currency:'GNF':'symbol':'1.0-0':'en-US', isTotal: true }
                                    ]" styleClass="p-datatable-sm" [tableStyle]="{'min-width': '30rem'}">
                                        <ng-template pTemplate="body" let-item>
                                            <tr [ngClass]="{'bg-gray-100 dark:bg-gray-800 font-bold': item.isTotal}">
                                                <td class="font-medium">{{item.label}}</td>
                                                <td>{{item.value}}</td>
                                            </tr>
                                        </ng-template>
                                    </p-table>
                                </div>
                            </div>
                        </p-panel>
                    </div>

                    <!-- Demande de crédit -->
                    <div class="col-12 mb-4">
                        <p-panel header="Demande de crédit" [toggleable]="true">
                            <div class="grid">
                                <div class="col-12 md:col-6">
                                    <p-table [value]="[
                                        { label: 'Montant demandé', value: resumeData.demandeCredit?.montant_demande | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                        { label: 'Durée', value: (resumeData.demandeCredit?.duree_mois || 0) + ' mois' },
                                        { label: 'Mensualité estimée', value: calculerMensualite() | currency:'GNF':'symbol':'1.0-0':'en-US' },
                                    ]" styleClass="p-datatable-sm" [tableStyle]="{'min-width': '30rem'}">
                                        <ng-template pTemplate="body" let-item>
                                            <tr>
                                                <td class="font-medium">{{item.label}}</td>
                                                <td>
                                                    <span *ngIf="item.severity" [ngClass]="{
                                                        'text-green-500': item.severity === 'success',
                                                        'text-blue-500': item.severity === 'info',
                                                        'text-yellow-500': item.severity === 'warn',
                                                        'text-red-500': item.severity === 'danger'
                                                    }">{{item.value}}</span>
                                                    <span *ngIf="!item.severity">{{item.value}}</span>
                                                </td>
                                            </tr>
                                        </ng-template>
                                    </p-table>
                                </div>
                                <div class="col-12 md:col-6">
                                    <h4 class="text-lg font-medium mb-2">Objet du financement:</h4>
                                    <p-card styleClass="h-full">
                                        <p class="text-justify">{{resumeData.demandeCredit?.objet_financement || '-'}}
                                        </p>
                                    </p-card>
                                </div>
                            </div>
                        </p-panel>
                    </div>

                    <!-- Bouton pour finaliser la demande -->
                    <div class="col-12 mt-4 flex justify-content-center">
                        <button pButton pRipple type="button" label="Soumettre la demande complète"
                            icon="pi pi-check-circle" class="p-button-success p-button-lg" (click)="finaliserDemande()"
                            [loading]="loading()">
                        </button>
                    </div>
                </div>
            </p-card>
        </div>

        <!-- Boutons de navigation -->
        <div class="flex justify-between mt-4">
            <button pButton pRipple type="button" label="Précédent" class="p-button-outlined"
                [disabled]="activeIndex() === 0" (click)="prevStep()"></button>

            <button pButton pRipple type="button" label="Suivant" class="p-button-outlined"
                [disabled]="activeIndex() === 8" (click)="nextStep()"></button>
        </div>
    </div>
</div>