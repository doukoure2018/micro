<div class="min-h-screen bg-gray-100">
    <p-toast></p-toast>
    <p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>

    <!-- Loading Spinner -->
    <div *ngIf="state().loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-lg">
            <p-progressSpinner></p-progressSpinner>
            <p class="text-center mt-4 text-gray-700">Chargement en cours...</p>
        </div>
    </div>

    <!-- Error Message -->
    <div *ngIf="state().error" class="container mx-auto px-6 py-4">
        <div class="bg-red-50 border border-red-400 rounded p-4">
            <div class="flex items-center gap-3">
                <i class="pi pi-exclamation-triangle text-red-500"></i>
                <span class="text-red-700">{{ state().error }}</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div *ngIf="state().demandeIndividuel" class="container mx-auto px-4 py-6 max-w-6xl">

        <!-- Document Header -->
        <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-6">
            <div class="bg-gray-800 text-white text-center py-3">
                <h1 class="text-xl font-bold uppercase tracking-wider">DEMANDE DE CRÉDIT - GROS DOSSIER</h1>
            </div>

            <!-- Agency and Date Info -->
            <div class="grid grid-cols-2 gap-4 p-4 bg-gray-50 border-b-2 border-gray-300">
                <div class="flex items-center gap-2">
                    <span class="font-semibold">Date de la demande :</span>
                    <span class="bg-green-100 px-3 py-1 rounded">
                        {{ state().demandeIndividuel?.createdAt | date:'dd/MM/yyyy' }}
                    </span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="font-semibold">Agence de crédit :</span>
                    <span class="bg-green-100 px-3 py-1 rounded">
                        {{ state().pointVente?.libele || 'Non assigné' }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Section Impression du Dossier Complet -->
        <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-6">
            <div class="bg-green-600 text-white px-4 py-3">
                <h2 class="font-bold flex items-center gap-2">
                    <i class="pi pi-print"></i>
                    IMPRESSION DU DOSSIER
                </h2>
            </div>

            <div class="p-6 bg-green-50">
                <div class="text-center">
                    <p class="text-gray-700 mb-4">
                        <i class="pi pi-info-circle text-blue-600 mr-2"></i>
                        Générer et imprimer le dossier complet de demande de crédit
                    </p>

                    <div class="flex justify-center gap-3 flex-wrap">
                        <button pButton type="button" (click)="imprimerDossierComplet()"
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg"
                            icon="pi pi-print" label="Imprimer le Dossier Complet">
                        </button>

                        <button pButton type="button" (click)="previsualiserDossier()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg"
                            icon="pi pi-eye" label="Prévisualiser">
                        </button>

                        <button pButton type="button" (click)="exporterPDF()"
                            class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg"
                            icon="pi pi-file-pdf" label="Exporter en PDF">
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 1: INFORMATIONS SUR LE MEMBRE/CLIENT -->
        <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-6">
            <div class="bg-gray-700 text-white px-4 py-2">
                <h2 class="font-bold">1. INFORMATIONS SUR LE MEMBRE/CLIENT</h2>
            </div>

            <div class="p-6 bg-green-50">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold min-w-[180px]">Nom et Prénoms :</label>
                        <span class="bg-white px-3 py-1 rounded border border-gray-300 flex-1">
                            {{ state().demandeIndividuel?.nom }} {{ state().demandeIndividuel?.prenom }}
                        </span>
                    </div>
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold min-w-[140px]">Numéro/membre :</label>
                        <span class="bg-white px-3 py-1 rounded border border-gray-300 flex-1">
                            {{ state().demandeIndividuel?.numeroMembre }}
                        </span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold min-w-[180px]">Type de pièce d'identité :</label>
                        <span class="bg-yellow-100 px-3 py-1 rounded border border-gray-300 flex-1">
                            {{ state().demandeIndividuel?.typePiece }}
                        </span>
                    </div>
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold min-w-[140px]">Référence :</label>
                        <span class="bg-yellow-100 px-3 py-1 rounded border border-gray-300 flex-1">
                            {{ state().demandeIndividuel?.numId }}
                        </span>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold min-w-[150px]">Date et lieu de naissance :</label>
                        <span class="bg-white px-3 py-1 rounded border border-gray-300">
                            {{ state().demandeIndividuel?.dateNaissance | date:'dd/MM/yyyy' }}
                        </span>
                    </div>
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold">à</label>
                        <span class="bg-white px-3 py-1 rounded border border-gray-300 ml-2 flex-1">
                            {{ state().demandeIndividuel?.lieuxNaissance }}
                        </span>
                    </div>
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold min-w-[60px]">Genre :</label>
                        <span class="bg-white px-3 py-1 rounded border border-gray-300 flex-1">
                            {{ state().demandeIndividuel?.genre }}
                        </span>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold">Situation matrimoniale :</label>
                        <span class="bg-white px-3 py-1 rounded border border-gray-300 ml-2">
                            {{ state().demandeIndividuel?.situationMatrimoniale }}
                        </span>
                    </div>
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold">Personnes à charge :</label>
                        <span class="bg-white px-3 py-1 rounded border border-gray-300 ml-2">
                            {{ state().demandeIndividuel?.nombrePersonneEnCharge }}
                        </span>
                    </div>
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold">Enfants scolarisés :</label>
                        <span class="bg-white px-3 py-1 rounded border border-gray-300 ml-2">
                            {{ state().demandeIndividuel?.nombrePersonneScolarise }}
                        </span>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-4 mb-4">
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold min-w-[180px]">Adresse de domicile et Contact :</label>
                        <span class="bg-green-100 px-3 py-1 rounded border border-gray-300 flex-1">
                            {{ state().demandeIndividuel?.addresseDomicileContact }}
                        </span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold min-w-[180px]">Nombre d'années à l'adresse :</label>
                        <span class="bg-yellow-100 px-3 py-1 rounded border border-gray-300">
                            {{ state().demandeIndividuel?.nombreAnneeHabitation }} ans
                        </span>
                    </div>
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold min-w-[140px]">Type de propriété :</label>
                        <span class="bg-white px-3 py-1 rounded border border-gray-300 flex-1">
                            {{ state().demandeIndividuel?.typePropriete }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: ACTIVITÉS -->
        <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-6">
            <div class="bg-gray-700 text-white px-4 py-2">
                <h2 class="font-bold">2. ACTIVITÉS</h2>
            </div>

            <div class="p-6 bg-green-50">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold min-w-[120px]">Type d'activité :</label>
                        <span class="bg-white px-3 py-1 rounded border border-gray-300 flex-1">
                            {{ state().demandeIndividuel?.currentActivite }}
                        </span>
                    </div>
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold min-w-[120px]">Sous-activité :</label>
                        <span class="bg-white px-3 py-1 rounded border border-gray-300 flex-1">
                            {{ state().demandeIndividuel?.descriptionActivite }}
                        </span>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="font-semibold block mb-2">Description de l'activité :</label>
                    <div class="bg-green-100 p-3 rounded border border-gray-300">
                        {{ state().demandeIndividuel?.descriptionActivite }}
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold">Nombre d'années dans l'activité :</label>
                        <span class="bg-white px-3 py-1 rounded border border-gray-300 ml-2">
                            {{ state().demandeIndividuel?.nombreAnneeActivite }} ans
                        </span>
                    </div>
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold">Adresse du lieu d'activité :</label>
                        <span class="bg-white px-3 py-1 rounded border border-gray-300 ml-2 flex-1">
                            {{ state().demandeIndividuel?.adresseLieuActivite }}
                        </span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold">Autres activités :</label>
                        <span class="bg-yellow-100 px-3 py-1 rounded border border-gray-300 ml-2 flex-1">
                            {{ state().demandeIndividuel?.autreActivite || 'Aucune' }}
                        </span>
                    </div>
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold">Lieu de l'activité :</label>
                        <span class="bg-yellow-100 px-3 py-1 rounded border border-gray-300 ml-2 flex-1">
                            {{ state().demandeIndividuel?.lieuActivite || 'N/A' }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 3: MODALITÉS DE LA DEMANDE -->
        <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-6">
            <div class="bg-gray-700 text-white px-4 py-2">
                <h2 class="font-bold">3. MODALITÉS DE LA DEMANDE</h2>
            </div>

            <div class="p-6 bg-green-50">
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold">Montant demandé :</label>
                        <span class="bg-yellow-100 px-3 py-1 rounded border border-gray-300 ml-2 font-bold">
                            {{ state().demandeIndividuel?.montantDemande | currency:'GNF':'':'1.0-0' }}
                        </span>
                    </div>
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold">Durée demandée :</label>
                        <span class="bg-white px-3 py-1 rounded border border-gray-300 ml-2">
                            {{ state().demandeIndividuel?.dureeDemande }} Mois
                        </span>
                    </div>
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold">Périodicité :</label>
                        <span class="bg-white px-3 py-1 rounded border border-gray-300 ml-2">
                            {{ state().demandeIndividuel?.periodiciteRemboursement }}
                        </span>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold">Taux d'intérêts :</label>
                        <span class="bg-yellow-100 px-3 py-1 rounded border border-gray-300 ml-2">
                            {{ state().demandeIndividuel?.tauxInteret }}%
                        </span>
                    </div>
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold">Période de différé :</label>
                        <span class="bg-white px-3 py-1 rounded border border-gray-300 ml-2">
                            {{ state().demandeIndividuel?.periodeDiffere }} Mois
                        </span>
                    </div>
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold">Nombre d'échéance :</label>
                        <span class="bg-white px-3 py-1 rounded border border-gray-300 ml-2">
                            {{ state().demandeIndividuel?.nombreEcheance }}
                        </span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold">Échéance :</label>
                        <span class="bg-yellow-100 px-3 py-1 rounded border border-gray-300 ml-2 font-bold">
                            {{ state().demandeIndividuel?.echeance | currency:'GNF':'':'1.0-0' }}
                        </span>
                    </div>
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold">Objet du crédit sollicité :</label>
                        <span class="bg-white px-3 py-1 rounded border border-gray-300 ml-2 flex-1">
                            {{ state().demandeIndividuel?.objectCredit }}
                        </span>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="font-semibold block mb-2">Détail de l'objet de crédit :</label>
                    <div class="bg-white p-3 rounded border border-gray-300">
                        {{ state().demandeIndividuel?.detailObjectCredit }}
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="flex items-center">
                        <label class="font-semibold">Nouveau crédit :</label>
                        <span class="ml-2">
                            <input type="checkbox" [checked]="state().demandeIndividuel?.statutCredit === 'Nouveau'"
                                disabled>
                        </span>
                    </div>
                    <div class="flex items-center">
                        <label class="font-semibold">Renouvellement :</label>
                        <span class="ml-2">
                            <input type="checkbox"
                                [checked]="state().demandeIndividuel?.statutCredit === 'Renouvellement'" disabled>
                        </span>
                    </div>
                    <div class="flex items-center border-b border-gray-300 pb-2">
                        <label class="font-semibold">Rang de crédit :</label>
                        <span class="bg-white px-3 py-1 rounded border border-gray-300 ml-2">
                            {{ state().demandeIndividuel?.rangCredit }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 4: GARANTIES PROPOSÉES -->
        <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-6">
            <div class="bg-gray-700 text-white px-4 py-2">
                <h2 class="font-bold">4. GARANTIES PROPOSÉES</h2>
            </div>

            <div class="p-6">
                <table class="w-full border-collapse border border-gray-400">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="border border-gray-400 px-4 py-2 text-left font-bold">Type de Garantie</th>
                            <th class="border border-gray-400 px-4 py-2 text-left font-bold">Nature / Description des
                                garanties</th>
                            <th class="border border-gray-400 px-4 py-2 text-right font-bold">Valeur de la garantie</th>
                            <th class="border border-gray-400 px-4 py-2 text-right font-bold">Valeur d'emprunt</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let garantie of state().demandeIndividuel?.garanties" class="hover:bg-gray-50">
                            <td class="border border-gray-400 px-4 py-2">{{ garantie.typeGarantie }}</td>
                            <td class="border border-gray-400 px-4 py-2">{{ garantie.descriptionGarantie }}</td>
                            <td class="border border-gray-400 px-4 py-2 text-right font-semibold">
                                {{ garantie.valeurGarantie | currency:'':'':'1.0-0' }}
                            </td>
                            <td class="border border-gray-400 px-4 py-2 text-right font-semibold">
                                {{ garantie.valeurEmprunte | currency:'':'':'1.0-0' }}
                            </td>
                        </tr>
                        <tr class="bg-gray-100 font-bold">
                            <td colspan="2" class="border border-gray-400 px-4 py-2 text-right">Total</td>
                            <td class="border border-gray-400 px-4 py-2 text-right">
                                {{ getTotalGaranties() | currency:'':'':'1.0-0' }}
                            </td>
                            <td class="border border-gray-400 px-4 py-2 text-right">
                                {{ getTotalEmprunte() | currency:'':'':'1.0-0' }}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Section de rejet pour le DA uniquement -->
        <div *ngIf="state().user?.role === 'DA' && state().demandeIndividuel?.validationState !== 'REJECTED' 
               && !state().hasDemandeCredit && !state().hasDossierCredit"
            class="bg-white shadow-lg rounded-lg overflow-hidden mb-6">
            <div class="bg-red-600 text-white px-4 py-3">
                <h2 class="font-bold flex items-center gap-2">
                    <i class="pi pi-ban"></i>
                    ACTION DE REJET - DIRECTEUR D'AGENCE
                </h2>
            </div>

            <div class="p-6 bg-red-50">
                <div class="bg-white p-4 rounded border-2 border-red-300 mb-4">
                    <p class="text-gray-700 font-medium mb-3">
                        <i class="pi pi-info-circle text-red-600 mr-2"></i>
                        En tant que Directeur d'Agence, vous avez le pouvoir de rejeter cette demande si elle ne répond
                        pas aux critères d'acceptation.
                    </p>

                    <div class="bg-yellow-50 border border-yellow-300 rounded p-3 mb-4">
                        <p class="text-sm text-yellow-800">
                            <strong>⚠️ Attention :</strong> Le rejet d'une demande est une action définitive.
                            Assurez-vous d'avoir examiné tous les éléments du dossier avant de prendre cette décision.
                        </p>
                    </div>

                    <div class="space-y-2 text-sm text-gray-600 mb-4">
                        <p><strong>Critères de rejet possibles :</strong></p>
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>Demande de crédit Incohérente </li>
                            <li>Garanties insuffisantes ou inappropriées</li>
                            <li>Capacité de remboursement douteuse</li>
                            <li>Documents manquants ou falsifiés</li>
                            <li>Historique de crédit défavorable</li>
                            <li>Activité non viable ou à haut risque</li>
                        </ul>
                    </div>
                </div>

                <div class="flex justify-center gap-4">
                    <!-- Bouton Rejeter -->
                    <button pButton type="button" (click)="rejectDemande()" [disabled]="state().loading"
                        class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all duration-300"
                        icon="pi pi-times-circle" label="REJETER CETTE DEMANDE">
                    </button>

                    <!-- Bouton Voir l'Analyse - Ouvre dans un nouvel onglet -->
                    <button pButton type="button" (click)="openInNewTab('/dashboards/credit/analyse-credit')"
                        [disabled]="state().loading"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all duration-300"
                        icon="pi pi-chart-line" label="ANALYSER SON ANCIEN CRÉDIT">
                    </button>
                </div>
            </div>
        </div>

        <!-- Section de traitement de la demande -->
        <div *ngIf="state().demandeIndividuel?.validationState !== 'SELECTION'"
            class="bg-white shadow-lg rounded-lg overflow-hidden mb-6">
            <div class="bg-orange-600 text-white px-4 py-3">
                <h2 class="font-bold">TRAITEMENT DE LA DEMANDE</h2>
            </div>

            <div class="p-6 bg-orange-50">
                <!-- Description de l'action -->
                <div class="mb-6">
                    <div class="bg-white p-4 rounded border-2 border-orange-300">
                        <p class="text-gray-700 font-medium">
                            <i class="pi pi-info-circle text-orange-600 mr-2"></i>
                            Rediriger la demande vers un agent pour l'analyse de son crédit
                        </p>
                    </div>
                </div>

                <form [formGroup]="updateForm" (ngSubmit)="onSubmit()">
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block font-semibold mb-2">Point de Service :</label>
                            <p-dropdown formControlName="code" [options]="state().pointVentes || []"
                                optionLabel="libele" placeholder="Sélectionner..." [showClear]="true"
                                styleClass="w-full" (onChange)="onPointVenteChange($event)">
                            </p-dropdown>
                            <small
                                *ngIf="updateForm.get('code')?.hasError('required') && updateForm.get('code')?.touched"
                                class="text-red-500">
                                Point de service obligatoire
                            </small>
                        </div>

                        <div>
                            <label class="block font-semibold mb-2">Agent de Crédit :</label>
                            <p-dropdown formControlName="usuario" [options]="state().usuarios || []"
                                optionLabel="nom_USUARIO" placeholder="Sélectionner..." [showClear]="true"
                                styleClass="w-full" [disabled]="!updateForm.get('code')?.value">
                            </p-dropdown>
                            <small
                                *ngIf="updateForm.get('usuario')?.hasError('required') && updateForm.get('usuario')?.touched"
                                class="text-red-500">
                                Agent de crédit obligatoire
                            </small>
                        </div>

                        <div>
                            <label class="block font-semibold mb-2">Statut :</label>
                            <p-dropdown formControlName="statut" [options]="state().statusOptions" optionLabel="label"
                                optionValue="value" placeholder="Sélectionner..." styleClass="w-full">
                            </p-dropdown>
                            <small
                                *ngIf="updateForm.get('statut')?.hasError('required') && updateForm.get('statut')?.touched"
                                class="text-red-500">
                                Statut obligatoire
                            </small>
                        </div>
                    </div>

                    <div class="mt-6 text-center">
                        <button pButton type="submit" [disabled]="updateForm.invalid || state().loading"
                            class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded font-bold shadow-lg">
                            <i *ngIf="!state().loading" class="pi pi-check mr-2"></i>
                            <i *ngIf="state().loading" class="pi pi-spinner pi-spin mr-2"></i>
                            {{ updateForm.get('statut')?.value === 'VALIDATION' ?
                            'VALIDER POUR OCTROI' :
                            'VALIDER POUR SÉLECTION' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>


        <!-- ============================================= -->
        <!-- SECTION COMPLÈTE ANALYSE ET AVIS -->
        <!-- ============================================= -->

        <!-- SECTION POUR AGENT DE CRÉDIT -->
        <div *ngIf="state().user?.role === 'AGENT_CREDIT'" class="bg-white shadow-lg rounded-lg overflow-hidden mb-6">
            <div class="bg-blue-600 text-white px-4 py-3">
                <h2 class="font-bold">ACTIONS DE L'AGENT DE CRÉDIT</h2>
            </div>

            <div class="p-6 bg-blue-50">
                <div class="bg-white p-4 rounded border-2 border-blue-300">

                    <!-- 1. ANALYSE BILAN ACTIVITÉ -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-gray-700">
                            <i class="pi pi-chart-bar mr-2"></i>1. Analyse Bilan Activité
                        </h3>

                        <!-- Si bilan non fait -->
                        <div *ngIf="!state().hasDemandeCredit">
                            <p class="text-gray-600 mb-3">
                                <i class="pi pi-info-circle text-blue-500 mr-2"></i>
                                Le bilan d'activité n'a pas encore été renseigné pour cette demande
                            </p>
                            <button type="button"
                                (click)="navigateTo('/dashboards/credit/individuel/detail/analyse-bilan-activite/' + state().demandeIndividuel?.demandeIndividuelId)"
                                class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-200">
                                <i class="pi pi-pencil mr-2"></i>
                                Renseigner le bilan d'activité client
                            </button>
                        </div>

                        <!-- Si bilan fait -->
                        <div *ngIf="state().hasDemandeCredit">
                            <div class="bg-green-50 border border-green-300 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <i class="pi pi-check-circle text-green-600 text-xl mr-2"></i>
                                        <span class="font-semibold text-green-700">Bilan d'activité complété</span>
                                        <div class="text-sm text-gray-600 mt-1">
                                            Montant: {{ state().demandeIndividuel?.montantDemande |
                                            currency:'GNF':'symbol':'1.0-0' }}
                                            | Durée: {{ state().demandeIndividuel?.dureeDemande }} mois
                                        </div>
                                    </div>
                                    <a [routerLink]="['/dashboards/credit', state().user?.userId, 'resume-credit', state().demande_credit?.demandeCreditId]"
                                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                                        <i class="pi pi-eye mr-2"></i>
                                        Visualiser l'analyse
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p-divider />

                    <!-- 2. ANALYSE FLUX DE TRÉSORERIE -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-gray-700">
                            <i class="pi pi-money-bill mr-2"></i>2. Analyse Flux de Trésorerie
                        </h3>
                        <!-- Si flux non fait -->
                        <div *ngIf="!state().hasDossierCredit">
                            <p class="text-gray-600 mb-3">
                                <i class="pi pi-info-circle text-orange-500 mr-2"></i>
                                L'analyse des flux de trésorerie n'a pas encore été effectuée
                            </p>
                            <button type="button"
                                (click)="navigateTo('/dashboards/credit/individuel/detail/analyse-flux-tresorerie/' + state().demandeIndividuel?.demandeIndividuelId)"
                                class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-200">
                                <i class="pi pi-pencil mr-2"></i>
                                Saisir les informations de flux de trésorerie
                            </button>
                        </div>

                        <!-- Si flux fait -->
                        <div *ngIf="state().hasDossierCredit">
                            <div class="bg-green-50 border border-green-300 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <i class="pi pi-check-circle text-green-600 text-xl mr-2"></i>
                                        <span class="font-semibold text-green-700">Flux de trésorerie analysé</span>
                                    </div>
                                    <a [routerLink]="['/dashboards/credit/individuel/detail/analyse-flux-tresorerie/' + state().demandeIndividuel?.demandeIndividuelId]"
                                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                                        <i class="pi pi-eye mr-2"></i>
                                        Visualiser l'analyse
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p-divider />

                    <!-- 3. TÉLÉVERSER DOCUMENTS -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-gray-700">
                            <i class="pi pi-upload mr-2"></i>3. Documents du Dossier
                        </h3>
                        <button type="button"
                            (click)="navigateTo('/dashboards/agent-credit/selection/' + state().demandeIndividuel?.demandeIndividuelId)"
                            class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-200">
                            <i class="pi pi-folder-open mr-2"></i>
                            Gérer les documents du dossier
                        </button>
                    </div>

                    <!-- Indicateur de progression -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-gray-700">Progression du dossier</span>

                            <span class="text-sm text-gray-600">
                                {{ (state().hasDemandeCredit ? 1 : 0) + (state().hasDossierCredit ? 1 : 0) }}/2 analyses
                                complétées
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                [style.width.%]="((state().hasDemandeCredit ? 1 : 0) + (state().hasDossierCredit ? 1 : 0)) * 50">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION POUR DA, DR, MANAGER -->
        <div *ngIf="state().user?.role === 'DA' || state().user?.role === 'DR' || state().user?.role === 'MANAGER'"
            class="bg-white shadow-lg rounded-lg overflow-hidden mb-6">

            <div class="bg-indigo-600 text-white px-4 py-3">
                <h2 class="font-bold">
                    CONSULTATION DES ANALYSES -
                    <span *ngIf="state().user?.role === 'DA'">DIRECTEUR D'AGENCE</span>
                    <span *ngIf="state().user?.role === 'DR'">DIRECTEUR RÉGIONAL</span>
                    <span *ngIf="state().user?.role === 'MANAGER'">MANAGER</span>
                </h2>
            </div>

            <div class="p-6 bg-indigo-50">
                <div class="bg-white p-4 rounded border-2 border-indigo-300">

                    <!-- 1. BILAN ACTIVITÉ -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-gray-700">
                            <i class="pi pi-chart-bar mr-2"></i>1. Bilan d'Activité
                        </h3>

                        <!-- Si bilan non disponible -->
                        <div *ngIf="!state().hasDemandeCredit">
                            <div class="bg-amber-50 border border-amber-300 rounded-lg p-4">
                                <i class="pi pi-clock text-amber-600 text-xl mr-2"></i>
                                <span class="text-amber-800">L'agent de crédit n'a pas encore effectué l'analyse du
                                    bilan d'activité</span>
                            </div>
                        </div>

                        <!-- Si bilan disponible -->
                        <div *ngIf="state().hasDemandeCredit">
                            <div class="bg-green-50 border border-green-300 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <i class="pi pi-check-circle text-green-600 text-xl mr-2"></i>
                                        <span class="font-semibold text-green-700">Bilan d'activité disponible</span>
                                        <div class="text-sm text-gray-600 mt-1">
                                            Montant: {{ state().demandeIndividuel?.montantDemande |
                                            currency:'GNF':'symbol':'1.0-0' }}
                                            | Durée: {{ state().demandeIndividuel?.dureeDemande }} mois
                                        </div>
                                    </div>
                                    <a [routerLink]="['/dashboards/credit', state().user?.userId, 'resume-credit', state().demande_credit?.demandeCreditId]"
                                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                                        <i class="pi pi-eye mr-2"></i>
                                        Visualiser l'analyse
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p-divider />

                    <!-- 2. FLUX DE TRÉSORERIE -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-gray-700">
                            <i class="pi pi-money-bill mr-2"></i>2. Flux de Trésorerie
                        </h3>

                        <!-- Si flux non disponible -->
                        <div *ngIf="!state().hasDossierCredit">
                            <div class="bg-amber-50 border border-amber-300 rounded-lg p-4">
                                <i class="pi pi-clock text-amber-600 text-xl mr-2"></i>
                                <span class="text-amber-800">L'agent de crédit n'a pas encore effectué l'analyse sur le
                                    flux de trésorerie</span>
                            </div>
                        </div>

                        <!-- Si flux disponible -->
                        <div *ngIf="state().hasDossierCredit">
                            <div class="bg-green-50 border border-green-300 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <i class="pi pi-check-circle text-green-600 text-xl mr-2"></i>
                                        <span class="font-semibold text-green-700">Analyse des flux disponible</span>
                                    </div>
                                    <a [routerLink]="['/dashboards/credit/individuel/detail/analyse-flux-tresorerie/' + state().demandeIndividuel?.demandeIndividuelId]"
                                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                                        <i class="pi pi-eye mr-2"></i>
                                        Visualiser l'analyse
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p-divider />

                    <!-- 3. DOCUMENTS -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-gray-700">
                            <i class="pi pi-folder mr-2"></i>3. Documents du Dossier
                        </h3>
                        <button type="button"
                            (click)="navigateTo('/dashboards/agent-credit/selection/' + state().demandeIndividuel?.demandeIndividuelId)"
                            class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-200">
                            <i class="pi pi-folder-open mr-2"></i>
                            Consulter les documents du dossier
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- SECTION AVIS - AGENT DE CRÉDIT (après flux) -->
        <!-- ============================================= -->
        <div *ngIf="state().user?.role === 'AGENT_CREDIT' && state().hasDossierCredit" class="mt-6">
            <p-divider />

            <div class="mb-4">
                <h3 class="text-xl font-semibold flex items-center gap-2">
                    <i class="pi pi-comments text-primary"></i>
                    Mon Avis sur le Dossier
                    <span *ngIf="!state().userHasAvis"
                        class="text-sm bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full ml-2">
                        <i class="pi pi-exclamation-triangle mr-1"></i>
                        Requis avant approbation
                    </span>
                </h3>
            </div>

            <!-- Formulaire d'avis pour l'agent -->
            <div *ngIf="!state().userHasAvis || state().editingAvis" class="mb-6 avis-form-section">
                <p-card [style]="{'background-color': state().editingAvis ? '#fef3c7' : '#f8f9fa'}">
                    <ng-template pTemplate="header">
                        <div class="px-4 pt-3">
                            <h4 class="text-lg font-medium flex items-center gap-2">
                                <p-avatar
                                    [label]="state().user?.firstName?.charAt(0)! + state().user?.lastName?.charAt(0)!"
                                    shape="circle"
                                    [style]="{'background-color': state().editingAvis ? '#f59e0b' : '#6366f1', 'color': 'white'}" />
                                <span *ngIf="!state().editingAvis">
                                    Donner votre avis professionnel sur ce dossier
                                </span>
                                <span *ngIf="state().editingAvis" class="flex items-center gap-2">
                                    <i class="pi pi-pencil"></i>
                                    Modifier votre avis
                                </span>
                            </h4>
                        </div>
                    </ng-template>

                    <form [formGroup]="avisForm" (ngSubmit)="submitAvis()">
                        <div class="mb-3">
                            <p-chip label="Agent de Crédit" icon="pi pi-user"
                                [style]="{'background-color': '#e0e7ff', 'color': '#4338ca'}" />
                        </div>

                        <div class="field">
                            <label for="avis" class="block text-sm font-medium text-gray-700 mb-2">
                                Votre analyse et recommandation <span class="text-red-500">*</span>
                            </label>
                            <textarea pTextarea id="avis" formControlName="libele" rows="5" class="w-full"
                                placeholder="Donnez votre avis professionnel sur la solvabilité du client, la viabilité de son activité, et votre recommandation finale..."
                                [autoResize]="true">
                    </textarea>

                            <small *ngIf="avisForm.get('libele')?.invalid && avisForm.get('libele')?.touched"
                                class="p-error block mt-1">
                                <span *ngIf="avisForm.get('libele')?.errors?.['required']">
                                    L'avis est obligatoire avant l'approbation
                                </span>
                                <span *ngIf="avisForm.get('libele')?.errors?.['minlength']">
                                    L'avis doit contenir au moins 10 caractères
                                </span>
                            </small>

                            <div class="text-right mt-1">
                                <small class="text-gray-500">
                                    {{ avisForm.get('libele')?.value?.length || 0 }} / 1000 caractères
                                </small>
                            </div>
                        </div>

                        <div class="flex justify-end gap-2 mt-4">
                            <p-button label="Annuler" icon="pi pi-times" severity="secondary" [outlined]="true"
                                type="button" (click)="state().editingAvis ? cancelEdit() : avisForm.reset()" />

                            <p-button [label]="state().editingAvis ? 'Modifier l\'avis' : 'Soumettre mon avis'"
                                [icon]="state().editingAvis ? 'pi pi-pencil' : 'pi pi-send'" type="submit"
                                [severity]="state().editingAvis ? 'warn' : 'primary'" [loading]="state().submittingAvis"
                                [disabled]="avisForm.invalid || state().submittingAvis" />
                        </div>
                    </form>
                </p-card>
            </div>

            <!-- Affichage de l'avis de l'agent s'il existe -->
            <div *ngIf="state().userHasAvis && !state().editingAvis" class="mb-6">
                <p-card class="current-user-avis"
                    [style]="{'background-color': '#eff6ff', 'border': '1px solid #3b82f6'}">
                    <ng-template pTemplate="header">
                        <div class="px-4 pt-3 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <p-avatar
                                    [label]="state().user?.firstName?.charAt(0)! + state().user?.lastName?.charAt(0)!"
                                    shape="circle" [style]="{'background-color': '#3b82f6', 'color': 'white'}" />
                                <div>
                                    <p class="font-semibold">Mon avis professionnel</p>
                                    <p class="text-sm text-gray-600">Agent de Crédit</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <p-badge label="Avis soumis" severity="success" />
                                <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" severity="warn"
                                    pTooltip="Modifier mon avis" tooltipPosition="left"
                                    (onClick)="editAvis(state().currentUserAvis!)" />
                            </div>
                        </div>
                    </ng-template>

                    <p class="whitespace-pre-wrap">{{ state().currentUserAvis?.libele }}</p>

                    <ng-template pTemplate="footer">
                        <div class="text-sm text-gray-500">
                            <i class="pi pi-calendar mr-1"></i>
                            Soumis le {{ formatDate(state().currentUserAvis?.dateCreation) }}
                            <span
                                *ngIf="state().currentUserAvis?.updatedDate && state().currentUserAvis?.updatedDate !== state().currentUserAvis?.dateCreation">
                                | Modifié le {{ formatDate(state().currentUserAvis?.updatedDate) }}
                            </span>
                        </div>
                    </ng-template>
                </p-card>
            </div>

            <!-- Bouton d'approbation finale -->
            <div class="text-center mt-6 p-6 bg-green-50 rounded-lg border-2 border-green-300">
                <h4 class="font-semibold text-lg mb-3">Approbation Finale</h4>
                <p class="mb-4 text-gray-700">
                    <i class="pi pi-info-circle text-blue-600 mr-2"></i>
                    Après avoir complété toutes les analyses et donné votre avis, vous pouvez approuver définitivement
                    cette demande
                </p>
                <button (click)="approvedDemande(state().demandeIndividuel!)" pButton pRipple
                    [disabled]="!state().userHasAvis"
                    class="font-semibold bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 border-0 px-8 py-3 text-white shadow-lg hover:shadow-xl transition-all duration-300"
                    icon="pi pi-check-circle" label="APPROUVER LA DEMANDE DE CRÉDIT">
                </button>
                <p *ngIf="!state().userHasAvis" class="text-sm text-red-600 mt-2">
                    <i class="pi pi-exclamation-triangle mr-1"></i>
                    Vous devez d'abord donner votre avis avant de pouvoir approuver
                </p>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- SECTION AVIS - DA, DR, MANAGER (après approbation) -->
        <!-- ============================================= -->
        <div *ngIf="(state().user?.role === 'DA' || state().user?.role === 'DR' || state().user?.role === 'MANAGER') 
            && state().demandeIndividuel?.validationState === 'APPROVED'" class="mt-6">
            <p-divider />

            <div class="mb-4">
                <h3 class="text-xl font-semibold flex items-center gap-2">
                    <i class="pi pi-comments text-primary"></i>
                    Avis et Recommandations
                    <p-badge [value]="state().avisList.length.toString()" severity="info" />
                </h3>
                <p class="text-sm text-green-600 mt-2">
                    <i class="pi pi-check-circle mr-1"></i>
                    Cette demande a été approuvée par l'agent de crédit. Vous pouvez donner votre avis.
                </p>
            </div>

            <!-- Formulaire d'avis -->
            <div *ngIf="(!state().userHasAvis && state().showAvisForm) || state().editingAvis" class="mb-6">
                <p-card [style]="{'background-color': state().editingAvis ? '#fef3c7' : '#f8f9fa'}">
                    <ng-template pTemplate="header">
                        <div class="px-4 pt-3">
                            <h4 class="text-lg font-medium flex items-center gap-2">
                                <p-avatar
                                    [label]="state().user?.firstName?.charAt(0)! + state().user?.lastName?.charAt(0)!"
                                    shape="circle" [style]="{'background-color': '#6366f1', 'color': 'white'}" />
                                <span>
                                    Donner votre avis en tant que {{ getRoleLabel(state().user?.role!) }}
                                </span>
                            </h4>
                        </div>
                    </ng-template>

                    <form [formGroup]="avisForm" (ngSubmit)="submitAvis()">
                        <div class="mb-3">
                            <p-chip [label]="getRoleLabel(state().user?.role!)" icon="pi pi-user"
                                [style]="{'background-color': '#e0e7ff', 'color': '#4338ca'}" />
                        </div>

                        <div class="field">
                            <label for="avis" class="block text-sm font-medium text-gray-700 mb-2">
                                Votre avis et recommandations <span class="text-red-500">*</span>
                            </label>
                            <textarea pTextarea id="avis" formControlName="libele" rows="5" class="w-full"
                                placeholder="Partagez votre avis sur cette demande de crédit approuvée..."
                                [autoResize]="true">
                    </textarea>

                            <small *ngIf="avisForm.get('libele')?.invalid && avisForm.get('libele')?.touched"
                                class="p-error block mt-1">
                                L'avis est obligatoire
                            </small>

                            <div class="text-right mt-1">
                                <small class="text-gray-500">
                                    {{ avisForm.get('libele')?.value?.length || 0 }} / 1000 caractères
                                </small>
                            </div>
                        </div>

                        <div class="flex justify-end gap-2 mt-4">
                            <p-button label="Annuler" icon="pi pi-times" severity="secondary" [outlined]="true"
                                type="button" (click)="cancelEdit()" />

                            <p-button label="Soumettre mon avis" icon="pi pi-send" type="submit"
                                [loading]="state().submittingAvis"
                                [disabled]="avisForm.invalid || state().submittingAvis" />
                        </div>
                    </form>
                </p-card>
            </div>

            <!-- Liste des avis existants -->
            <div class="mt-6">
                <h4 class="font-semibold mb-3">Historique des avis</h4>

                <div *ngIf="state().avisList.length === 0" class="text-center py-8 text-gray-500">
                    <i class="pi pi-comments text-4xl mb-3 block"></i>
                    <p>Aucun avis n'a encore été donné</p>
                </div>

                <div *ngIf="state().avisList.length > 0" class="space-y-4">
                    <p-timeline [value]="state().avisList" align="left">
                        <ng-template pTemplate="marker" let-avis>
                            <span class="flex w-10 h-10 items-center justify-center text-white rounded-full shadow-lg"
                                [style]="{'background-color': avis.idUser === state().user?.userId ? '#3b82f6' : '#6b7280'}">
                                <i class="pi pi-comment"></i>
                            </span>
                        </ng-template>

                        <ng-template pTemplate="content" let-avis>
                            <p-card [style]="{'margin-bottom': '1rem'}">
                                <ng-template pTemplate="header">
                                    <div class="px-4 pt-3">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-3">
                                                <p-avatar
                                                    [label]="(avis.userFullName || 'U').substring(0, 2).toUpperCase()"
                                                    shape="circle"
                                                    [style]="{'background-color': '#6366f1', 'color': 'white'}" />
                                                <div>
                                                    <p class="font-semibold">
                                                        {{ avis.userFullName || 'Utilisateur' }}
                                                        <span *ngIf="avis.idUser === state().user?.userId"
                                                            class="ml-2 text-sm text-blue-600">(Vous)</span>
                                                    </p>
                                                    <p class="text-sm text-gray-600">
                                                        {{ formatDate(avis.dateCreation) }}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </ng-template>

                                <div class="whitespace-pre-wrap text-gray-700">
                                    {{ avis.libele }}
                                </div>
                            </p-card>
                        </ng-template>
                    </p-timeline>
                </div>
            </div>
        </div>

        <!-- Message si la demande n'est pas encore approuvée -->
        <div *ngIf="(state().user?.role === 'DA' || state().user?.role === 'DR' || state().user?.role === 'MANAGER') 
            && state().demandeIndividuel?.validationState !== 'APPROVED'" class="mt-6">
            <p-divider />

            <div class="bg-gray-50 border border-gray-300 rounded-lg p-6 text-center">
                <i class="pi pi-lock text-gray-500 text-3xl mb-3"></i>
                <h4 class="font-semibold text-gray-700 mb-2">Section Avis Non Disponible</h4>
                <p class="text-gray-600">
                    Les avis seront disponibles uniquement après que l'agent de crédit ait approuvé la demande.
                </p>
                <div class="mt-4">
                    <span class="inline-block bg-gray-200 px-4 py-2 rounded-full text-gray-700">
                        <i class="pi pi-info-circle mr-2"></i>
                        Statut actuel: {{ state().demandeIndividuel?.validationState || 'En cours d\'analyse' }}
                    </span>
                </div>
            </div>
        </div>