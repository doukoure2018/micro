<div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
    <p-toast></p-toast>
    <p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>

    <!-- Loading Spinner -->
    <div *ngIf="state().loading"
        class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl">
            <p-progressSpinner strokeWidth="4"></p-progressSpinner>
            <p class="text-center mt-4 text-gray-700 font-medium">Chargement en cours...</p>
        </div>
    </div>

    <!-- Error Message -->
    <div *ngIf="state().error" class="container mx-auto px-6 py-4">
        <div class="bg-red-50 border-l-4 border-red-500 rounded-r-lg p-4 shadow-sm">
            <div class="flex items-center gap-3">
                <i class="pi pi-exclamation-triangle text-red-500 text-xl"></i>
                <span class="text-red-700 font-medium">{{ state().error }}</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div *ngIf="state().demandeIndividuel" class="container mx-auto px-4 py-4 max-w-7xl">

        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <!-- HEADER STICKY - Navigation + Statut + Actions rapides                  -->
        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <div class="sticky top-0 z-40 bg-white/95 backdrop-blur-sm rounded-xl shadow-lg mb-4 p-4">
            <div class="flex flex-wrap items-center justify-between gap-3">
                <!-- Left: Back + Dossier Info -->
                <div class="flex items-center gap-4">
                    <button pButton type="button" (click)="goBack()" icon="pi pi-arrow-left"
                        class="p-button-text p-button-rounded p-button-secondary" pTooltip="Retour"></button>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <i class="pi pi-file-edit text-blue-600"></i>
                            Dossier N° {{ state().demandeIndividuel?.demandeIndividuelId }}
                        </h1>
                        <p class="text-sm text-gray-500">
                            {{ state().demandeIndividuel?.nom }} {{ state().demandeIndividuel?.prenom }} •
                            {{ state().demandeIndividuel?.createdAt | date:'dd/MM/yyyy' }}
                        </p>
                    </div>
                </div>

                <!-- Center: Status Tags -->
                <div class="flex items-center gap-2">
                    <p-tag [value]="state().demandeIndividuel?.statutDemande"
                        [severity]="state().demandeIndividuel?.statutDemande === 'EN_ATTENTE' ? 'warn' : 'success'"
                        [rounded]="true"></p-tag>
                    <p-tag [value]="state().demandeIndividuel?.validationState" severity="info"
                        [rounded]="true"></p-tag>
                </div>

                <!-- Right: Quick Actions -->
                <div class="flex items-center gap-2">
                    <button pButton type="button" (click)="imprimerDossierComplet()" icon="pi pi-print"
                        class="p-button-sm p-button-success p-button-rounded" pTooltip="Imprimer"></button>
                    <button pButton type="button" (click)="previsualiserDossier()" icon="pi pi-eye"
                        class="p-button-sm p-button-info p-button-rounded" pTooltip="Prévisualiser"></button>
                    <button pButton type="button" (click)="exporterPDF()" icon="pi pi-file-pdf"
                        class="p-button-sm p-button-danger p-button-rounded" pTooltip="Export PDF"></button>
                    <button pButton type="button"
                        (click)="navigateTo('/dashboards/agent-credit/selection/' + state().demandeIndividuel?.demandeIndividuelId)"
                        icon="pi pi-folder-open" class="p-button-sm p-button-secondary p-button-rounded"
                        pTooltip="Documents"></button>
                </div>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <!-- NATURE DU CLIENT - Affichage prominent en haut                         -->
        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <div class="nature-client-card"
            [ngClass]="{
                'nature-pme': state().demandeIndividuel?.natureClient?.includes('PME'),
                'nature-professionnel': state().demandeIndividuel?.natureClient?.includes('Professionnel'),
                'nature-particulier': !state().demandeIndividuel?.natureClient?.includes('PME') && !state().demandeIndividuel?.natureClient?.includes('Professionnel')
            }">
            <div class="nature-client-header">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="nature-icon-wrapper">
                            <i [ngClass]="{
                                    'pi pi-building': state().demandeIndividuel?.natureClient?.includes('PME'),
                                    'pi pi-briefcase': state().demandeIndividuel?.natureClient?.includes('Professionnel'),
                                    'pi pi-user': !state().demandeIndividuel?.natureClient?.includes('PME') && !state().demandeIndividuel?.natureClient?.includes('Professionnel')
                                }"></i>
                        </div>
                        <div>
                            <p class="nature-label">Nature du Client</p>
                            <h2 class="nature-title">
                                {{ state().demandeIndividuel?.natureClient?.includes('PME') ? 'Entreprise (PME/PMI)' :
                                   state().demandeIndividuel?.natureClient?.includes('Professionnel') ? 'Professionnel' :
                                   'Particulier' }}
                            </h2>
                            <!-- Affichage conditionnel pour PME -->
                            <p *ngIf="state().demandeIndividuel?.natureClient?.includes('PME') && state().demandeIndividuel?.nomPersonneMorale"
                                class="nature-subtitle">
                                <span *ngIf="state().demandeIndividuel?.sigle" class="font-bold">{{ state().demandeIndividuel?.sigle }} - </span>
                                {{ state().demandeIndividuel?.nomPersonneMorale }}
                            </p>
                        </div>
                    </div>
                    <div class="nature-category">
                        <p class="category-label">Catégorie</p>
                        <p class="category-value">{{ state().demandeIndividuel?.categorie || 'Non spécifiée' }}</p>
                    </div>
                </div>
            </div>
            <!-- Informations supplémentaires selon la nature -->
            <div class="nature-client-details" *ngIf="state().demandeIndividuel?.email || state().demandeIndividuel?.prefecture || state().demandeIndividuel?.sousPrefecture || (state().demandeIndividuel?.natureClient?.includes('PME') && state().demandeIndividuel?.titreDirecteur)">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="detail-item" *ngIf="state().demandeIndividuel?.email">
                        <span class="detail-label">Email</span>
                        <span class="detail-value">{{ state().demandeIndividuel?.email }}</span>
                    </div>
                    <div class="detail-item" *ngIf="state().demandeIndividuel?.prefecture">
                        <span class="detail-label">Préfecture</span>
                        <span class="detail-value">{{ state().demandeIndividuel?.prefecture }}</span>
                    </div>
                    <div class="detail-item" *ngIf="state().demandeIndividuel?.sousPrefecture">
                        <span class="detail-label">Sous-Préfecture</span>
                        <span class="detail-value">{{ state().demandeIndividuel?.sousPrefecture }}</span>
                    </div>
                    <div class="detail-item" *ngIf="state().demandeIndividuel?.natureClient?.includes('PME') && state().demandeIndividuel?.titreDirecteur">
                        <span class="detail-label">Titre du Directeur</span>
                        <span class="detail-value">{{ state().demandeIndividuel?.titreDirecteur }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <!-- RÉSUMÉ DE LA DEMANDE - Tableau simple                                  -->
        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200 mb-8">
            <div class="bg-gray-600 text-white px-6 py-4 flex items-center gap-3">
                <i class="pi pi-info-circle text-xl"></i>
                <span class="font-bold text-lg uppercase tracking-wide">Résumé de la Demande</span>
            </div>
            <div class="p-6">
                <table class="w-full">
                    <tbody>
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-4 text-gray-600 font-medium w-1/4">Montant Sollicité</td>
                            <td class="py-3 px-4 font-bold text-lg text-gray-800">{{
                                state().demandeIndividuel?.montantDemande | currency:'GNF':'symbol':'1.0-0' }}</td>
                            <td class="py-3 px-4 text-gray-600 font-medium w-1/4">Échéance</td>
                            <td class="py-3 px-4 font-bold text-lg text-green-600">{{
                                state().demandeIndividuel?.echeance | currency:'GNF':'symbol':'1.0-0' }}</td>
                        </tr>
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-4 text-gray-600 font-medium">Durée</td>
                            <td class="py-3 px-4 font-bold text-lg text-blue-600">{{
                                state().demandeIndividuel?.dureeDemande }} mois</td>
                            <td class="py-3 px-4 text-gray-600 font-medium">Taux d'intérêt</td>
                            <td class="py-3 px-4 font-bold text-lg text-purple-600">{{
                                state().demandeIndividuel?.tauxInteret }}%</td>
                        </tr>
                        <tr>
                            <td class="py-3 px-4 text-gray-600 font-medium">Agence</td>
                            <td class="py-3 px-4 font-semibold text-gray-800" colspan="3">{{ state().pointVente?.libele
                                || 'Non assigné' }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <!-- SECTION 1: INFORMATIONS CLIENT - Tableau simple                        -->
        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200 mb-8">
            <div class="bg-blue-600 text-white px-6 py-4 flex items-center gap-3">
                <i class="pi pi-user text-xl"></i>
                <span class="font-bold text-lg uppercase tracking-wide">1. Informations Client</span>
            </div>
            <div class="p-6">
                <table class="w-full">
                    <tbody>
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-4 text-gray-600 font-medium w-1/4">Nom complet</td>
                            <td class="py-3 px-4 font-semibold text-gray-800">{{ state().demandeIndividuel?.nom }} {{
                                state().demandeIndividuel?.prenom }}</td>
                            <td class="py-3 px-4 text-gray-600 font-medium w-1/4">N° Membre</td>
                            <td class="py-3 px-4 font-mono">{{ state().demandeIndividuel?.numeroMembre }}</td>
                        </tr>
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-4 text-gray-600 font-medium">Type de pièce</td>
                            <td class="py-3 px-4">{{ state().demandeIndividuel?.typePiece }}</td>
                            <td class="py-3 px-4 text-gray-600 font-medium">N° Pièce</td>
                            <td class="py-3 px-4 font-mono">{{ state().demandeIndividuel?.numId }}</td>
                        </tr>
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-4 text-gray-600 font-medium">Date de naissance</td>
                            <td class="py-3 px-4">{{ state().demandeIndividuel?.dateNaissance | date:'dd/MM/yyyy' }}
                            </td>
                            <td class="py-3 px-4 text-gray-600 font-medium">Lieu de naissance</td>
                            <td class="py-3 px-4">{{ state().demandeIndividuel?.lieuxNaissance }}</td>
                        </tr>
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-4 text-gray-600 font-medium">Genre</td>
                            <td class="py-3 px-4">{{ state().demandeIndividuel?.genre }}</td>
                            <td class="py-3 px-4 text-gray-600 font-medium">Situation matrimoniale</td>
                            <td class="py-3 px-4">{{ state().demandeIndividuel?.situationMatrimoniale }}</td>
                        </tr>
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-4 text-gray-600 font-medium">Personnes à charge</td>
                            <td class="py-3 px-4 font-bold text-blue-600">{{
                                state().demandeIndividuel?.nombrePersonneEnCharge }}</td>
                            <td class="py-3 px-4 text-gray-600 font-medium">Personnes scolarisées</td>
                            <td class="py-3 px-4 font-bold text-blue-600">{{
                                state().demandeIndividuel?.nombrePersonneScolarise }}</td>
                        </tr>
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-4 text-gray-600 font-medium">Adresse & Contact</td>
                            <td class="py-3 px-4" colspan="3">{{ state().demandeIndividuel?.addresseDomicileContact }}
                            </td>
                        </tr>
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-4 text-gray-600 font-medium">Années à l'adresse</td>
                            <td class="py-3 px-4">{{ state().demandeIndividuel?.nombreAnneeHabitation }} ans</td>
                            <td class="py-3 px-4 text-gray-600 font-medium">Type de propriété</td>
                            <td class="py-3 px-4">{{ state().demandeIndividuel?.typePropriete }}</td>
                        </tr>
                        <!-- Informations familiales -->
                        <tr class="border-b border-gray-200"
                            *ngIf="state().demandeIndividuel?.nomPere || state().demandeIndividuel?.nomMere">
                            <td class="py-3 px-4 text-gray-600 font-medium">Nom du père</td>
                            <td class="py-3 px-4">{{ state().demandeIndividuel?.nomPere || 'Non renseigné' }}</td>
                            <td class="py-3 px-4 text-gray-600 font-medium">Nom de la mère</td>
                            <td class="py-3 px-4">{{ state().demandeIndividuel?.nomMere || 'Non renseigné' }}</td>
                        </tr>
                        <tr *ngIf="state().demandeIndividuel?.nomConjoint">
                            <td class="py-3 px-4 text-gray-600 font-medium">Nom du conjoint</td>
                            <td class="py-3 px-4" colspan="3">{{ state().demandeIndividuel?.nomConjoint }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <!-- SECTION 2: ACTIVITÉS - Tableau simple                                  -->
        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200 mb-8">
            <div class="bg-emerald-600 text-white px-6 py-4 flex items-center gap-3">
                <i class="pi pi-briefcase text-xl"></i>
                <span class="font-bold text-lg uppercase tracking-wide">2. Activités</span>
            </div>
            <div class="p-6">
                <table class="w-full">
                    <tbody>
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-4 text-gray-600 font-medium w-1/4">Type d'activité</td>
                            <td class="py-3 px-4 font-semibold text-emerald-700">{{
                                state().demandeIndividuel?.currentActivite }}</td>
                            <td class="py-3 px-4 text-gray-600 font-medium w-1/4">Expérience</td>
                            <td class="py-3 px-4 font-bold text-emerald-600">{{
                                state().demandeIndividuel?.nombreAnneeActivite }} ans</td>
                        </tr>
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-4 text-gray-600 font-medium">Description</td>
                            <td class="py-3 px-4" colspan="3">{{ state().demandeIndividuel?.descriptionActivite }}</td>
                        </tr>
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-4 text-gray-600 font-medium">Lieu d'activité</td>
                            <td class="py-3 px-4">{{ state().demandeIndividuel?.lieuActivite || 'N/A' }}</td>
                            <td class="py-3 px-4 text-gray-600 font-medium">Adresse</td>
                            <td class="py-3 px-4">{{ state().demandeIndividuel?.adresseLieuActivite }}</td>
                        </tr>
                        <tr>
                            <td class="py-3 px-4 text-gray-600 font-medium">Autres activités</td>
                            <td class="py-3 px-4" colspan="3">{{ state().demandeIndividuel?.autreActivite || 'Aucune' }}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <!-- SECTION 3: MODALITÉS DE LA DEMANDE - Tableau simple                   -->
        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200 mb-8">
            <div class="bg-amber-500 text-white px-6 py-4 flex items-center gap-3">
                <i class="pi pi-money-bill text-xl"></i>
                <span class="font-bold text-lg uppercase tracking-wide">3. Modalités de la Demande</span>
            </div>
            <div class="p-6">
                <table class="w-full">
                    <tbody>
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-4 text-gray-600 font-medium w-1/4">Périodicité</td>
                            <td class="py-3 px-4">{{ state().demandeIndividuel?.periodiciteRemboursement }}</td>
                            <td class="py-3 px-4 text-gray-600 font-medium w-1/4">Période de différé</td>
                            <td class="py-3 px-4">{{ state().demandeIndividuel?.periodeDiffere }} mois</td>
                        </tr>
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-4 text-gray-600 font-medium">Nombre d'échéances</td>
                            <td class="py-3 px-4 font-semibold">{{ state().demandeIndividuel?.nombreEcheance }}</td>
                            <td class="py-3 px-4 text-gray-600 font-medium">Type de crédit</td>
                            <td class="py-3 px-4">
                                <span class="flex items-center gap-2">
                                    <i *ngIf="state().demandeIndividuel?.statutCredit === 'Nouveau'"
                                        class="pi pi-check-circle text-green-500"></i>
                                    {{ state().demandeIndividuel?.statutCredit }}
                                </span>
                            </td>
                        </tr>
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-4 text-gray-600 font-medium">Rang du crédit</td>
                            <td class="py-3 px-4">{{ state().demandeIndividuel?.rangCredit }}</td>
                            <td class="py-3 px-4 text-gray-600 font-medium">Objet du crédit</td>
                            <td class="py-3 px-4 font-semibold text-amber-700">{{
                                state().demandeIndividuel?.objectCredit }}</td>
                        </tr>
                        <tr>
                            <td class="py-3 px-4 text-gray-600 font-medium">Détail de l'objet</td>
                            <td class="py-3 px-4" colspan="3">{{ state().demandeIndividuel?.detailObjectCredit }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <!-- SECTION 4: GARANTIES PROPOSÉES                                         -->
        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200 mb-8">
            <div class="bg-indigo-600 text-white px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="pi pi-shield text-xl"></i>
                    <span class="font-bold text-lg uppercase tracking-wide">4. Garanties Proposées</span>
                </div>
                <div class="flex gap-8">
                    <span class="text-base">Total: <strong class="text-yellow-300 text-lg">{{ getTotalGaranties() |
                            currency:'GNF':'symbol':'1.0-0' }}</strong></span>
                    <span class="text-base">Empruntable: <strong class="text-green-300 text-lg">{{ getTotalEmprunte() |
                            currency:'GNF':'symbol':'1.0-0' }}</strong></span>
                </div>
            </div>
            <div class="p-6">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="text-left p-4 font-semibold rounded-tl-lg">Type</th>
                                <th class="text-left p-4 font-semibold">Description</th>
                                <th class="text-right p-4 font-semibold">Valeur Garantie</th>
                                <th class="text-right p-4 font-semibold rounded-tr-lg">Valeur Emprunt</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let garantie of state().demandeIndividuel?.garanties; let i = index"
                                class="border-b border-gray-100 hover:bg-indigo-50/50 transition-colors"
                                [class.bg-gray-50]="i % 2 === 0">
                                <td class="p-4">
                                    <p-tag [value]="garantie.typeGarantie"
                                        [severity]="getGarantieSeverity(garantie.typeGarantie!)"></p-tag>
                                </td>
                                <td class="p-4">{{ garantie.descriptionGarantie }}</td>
                                <td class="p-4 text-right font-mono font-semibold text-indigo-700">
                                    {{ garantie.valeurGarantie | currency:'GNF':'symbol':'1.0-0' }}
                                </td>
                                <td class="p-4 text-right font-mono font-semibold text-green-700">
                                    {{ garantie.valeurEmprunte | currency:'GNF':'symbol':'1.0-0' }}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <!-- SECTION TRAITEMENT DE LA DEMANDE (Assignment)                          -->
        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <div *ngIf="state().demandeIndividuel?.validationState !== 'SELECTION'"
            class="bg-white rounded-xl shadow-md overflow-hidden border-2 border-orange-300 mb-8">
            <div class="bg-orange-500 text-white px-6 py-4 flex items-center gap-3">
                <i class="pi pi-send text-xl"></i>
                <span class="font-bold text-lg uppercase tracking-wide">Traitement de la Demande</span>
            </div>

            <div class="p-6">
                <div class="bg-orange-50 border-l-4 border-orange-400 rounded-r-lg p-5 mb-8">
                    <i class="pi pi-info-circle text-orange-600 mr-2 text-xl"></i>
                    <span class="text-base font-medium text-orange-800">Rediriger la demande vers un agent pour
                        l'analyse de son crédit</span>
                </div>

                <form [formGroup]="updateForm" (ngSubmit)="onSubmit()">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Point de Service -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">
                                <i class="pi pi-map-marker mr-2 text-blue-500"></i>Point de Service <span
                                    class="text-red-500">*</span>
                            </label>
                            <p-dropdown formControlName="code" [options]="state().pointVentes || []"
                                optionLabel="libele" optionValue="code"
                                placeholder="-- Sélectionner un point de service --" [showClear]="true" [filter]="true"
                                filterPlaceholder="Rechercher..." [style]="{'width': '100%'}" appendTo="body"
                                (onChange)="onPointVenteChange($event)">
                            </p-dropdown>
                        </div>

                        <!-- Code User SAF -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">
                                <i class="pi pi-user mr-2 text-blue-500"></i>CODE USER SAF <span
                                    class="text-red-500">*</span>
                            </label>
                            <input pInputText formControlName="codAgent" placeholder="Ex: AGCR001"
                                class="w-full uppercase"
                                (input)="onAgentCodeChange($any($event.target).value)"
                                [disabled]="!updateForm.get('code')?.value" />
                            <small *ngIf="!updateForm.get('code')?.value" class="text-gray-500 mt-2 block">
                                <i class="pi pi-info-circle mr-1"></i>Sélectionnez d'abord un point de service
                            </small>
                        </div>

                        <!-- Statut -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">
                                <i class="pi pi-tag mr-2 text-blue-500"></i>Action <span class="text-red-500">*</span>
                            </label>
                            <p-dropdown formControlName="statut" [options]="state().statusOptions" optionLabel="label"
                                optionValue="value" placeholder="-- Sélectionner une action --"
                                [style]="{'width': '100%'}" appendTo="body">
                            </p-dropdown>
                        </div>
                    </div>

                    <div class="mt-6 text-center">
                        <button pButton type="submit" [disabled]="updateForm.invalid || state().loading"
                            class="px-10 py-3 font-bold shadow-lg text-base"
                            [ngClass]="updateForm.valid ? 'bg-gradient-to-r from-green-500 to-emerald-600' : 'bg-gray-400'">
                            <i class="pi mr-2" [ngClass]="state().loading ? 'pi-spinner pi-spin' : 'pi-check'"></i>
                            {{ updateForm.get('statut')?.value === 'VALIDATION' ? 'VALIDER POUR OCTROI' : 'VALIDER POUR
                            SÉLECTION' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <!-- SECTION REJET - DA uniquement                                          -->
        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <div *ngIf="state().user?.role === 'DA' && state().demandeIndividuel?.validationState !== 'REJECTED'
               && !state().hasDemandeCredit && !state().hasDossierCredit"
            class="bg-white rounded-xl shadow-md overflow-hidden border-2 border-red-200 mb-8">
            <div class="bg-red-500 text-white px-6 py-4 flex items-center gap-3">
                <i class="pi pi-ban text-xl"></i>
                <span class="font-bold text-lg uppercase tracking-wide">Action de Rejet - Directeur d'Agence</span>
            </div>
            <div class="p-6">
                <div class="bg-yellow-50 border-l-4 border-yellow-400 rounded-r-lg p-5 mb-6">
                    <i class="pi pi-exclamation-triangle text-yellow-600 mr-2 text-lg"></i>
                    <span class="font-medium">Le rejet d'une demande est une action définitive.</span>
                </div>
                <div class="flex justify-center gap-5">
                    <button pButton type="button" (click)="rejectDemande()" [disabled]="state().loading"
                        class="bg-red-600 hover:bg-red-700" icon="pi pi-times-circle" label="REJETER">
                    </button>
                    <button pButton type="button" (click)="openInNewTab('/dashboards/credit/analyse-credit')"
                        class="bg-blue-600 hover:bg-blue-700" icon="pi pi-chart-line" label="ANALYSER ANCIEN CRÉDIT">
                    </button>
                </div>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <!-- SECTION ANALYSE - AGENT DE CRÉDIT                                      -->
        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <div *ngIf="state().user?.role === 'AGENT_CREDIT'"
            class="bg-white rounded-xl shadow-md overflow-hidden border-2 border-blue-200 mb-8">
            <div class="bg-blue-600 text-white px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="pi pi-chart-bar text-xl"></i>
                    <span class="font-bold text-lg uppercase tracking-wide">Actions de l'Agent de Crédit</span>
                </div>
                <!-- Progress Badge -->
                <span class="px-4 py-2 rounded-full font-semibold"
                    [ngClass]="((state().hasAnalyseFinanciere ? 1 : 0) + (state().hasDossierCredit ? 1 : 0)) === 2 ? 'bg-green-500' : 'bg-blue-400'">
                    {{ (state().hasAnalyseFinanciere ? 1 : 0) + (state().hasDossierCredit ? 1 : 0) }}/2 analyses
                </span>
            </div>

            <div class="p-6">
                <!-- Progress Bar -->
                <div class="w-full bg-gray-200 rounded-full h-3 mb-6">
                    <div class="h-full rounded-full transition-all duration-500"
                        [ngClass]="((state().hasAnalyseFinanciere ? 1 : 0) + (state().hasDossierCredit ? 1 : 0)) === 2 ? 'bg-gradient-to-r from-green-400 to-emerald-500' : 'bg-gradient-to-r from-blue-400 to-indigo-500'"
                        [style.width.%]="((state().hasAnalyseFinanciere ? 1 : 0) + (state().hasDossierCredit ? 1 : 0)) * 50">
                    </div>
                </div>

                <!-- Grid des 2 analyses -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- 1. Bilan d'Activité -->
                    <div class="border-2 rounded-xl p-5 transition-all hover:shadow-md overflow-visible"
                        [ngClass]="state().analyseStatut === 'SOUMISE' || state().analyseStatut === 'VALIDEE' ? 'border-green-300 bg-green-50' :
                                   state().analyseStatut === 'BROUILLON' ? 'border-yellow-300 bg-yellow-50' : 'border-blue-300 bg-blue-50'">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white"
                                [ngClass]="state().analyseStatut === 'SOUMISE' || state().analyseStatut === 'VALIDEE' ? 'bg-green-500' :
                                           state().analyseStatut === 'BROUILLON' ? 'bg-yellow-500' : 'bg-blue-500'">
                                <i class="pi text-lg" [ngClass]="state().analyseStatut === 'SOUMISE' || state().analyseStatut === 'VALIDEE' ? 'pi-check' :
                                           state().analyseStatut === 'BROUILLON' ? 'pi-clock' : 'pi-chart-bar'"></i>
                            </div>
                            <div>
                                <div class="font-bold text-base text-gray-800">1. Bilan d'Activité</div>
                                <div class="text-sm font-medium"
                                    [ngClass]="state().analyseStatut === 'SOUMISE' || state().analyseStatut === 'VALIDEE' ? 'text-green-600' :
                                               state().analyseStatut === 'BROUILLON' ? 'text-yellow-600' : 'text-blue-600'">
                                    {{ state().analyseStatut === 'SOUMISE' || state().analyseStatut === 'VALIDEE' ? '✓ Complété' :
                                       state().analyseStatut === 'BROUILLON' ? '⏳ En cours' : '○ À renseigner' }}
                                </div>
                            </div>
                        </div>

                        <!-- Boutons d'action -->
                        <div class="mt-4">
                            <!-- Bouton Visualiser - quand complété -->
                            <a *ngIf="state().analyseStatut === 'SOUMISE' || state().analyseStatut === 'VALIDEE'"
                                [routerLink]="['/dashboards/credit/individuel/detail/resume-analyse', state().demandeIndividuel?.demandeIndividuelId]"
                                class="flex items-center justify-center w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors no-underline">
                                <i class="pi pi-eye mr-2"></i>Visualiser
                            </a>
                            <!-- Bouton Continuer - quand en brouillon -->
                            <a *ngIf="state().analyseStatut === 'BROUILLON'"
                                [routerLink]="['/dashboards/credit/individuel/detail/analyse-bilan-activite', state().demandeIndividuel?.demandeIndividuelId]"
                                class="flex items-center justify-center w-full bg-yellow-600 hover:bg-yellow-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors no-underline">
                                <i class="pi pi-pencil mr-2"></i>Continuer
                            </a>
                            <!-- Bouton Renseigner - quand pas d'analyse -->
                            <a *ngIf="state().analyseStatut !== 'SOUMISE' && state().analyseStatut !== 'VALIDEE' && state().analyseStatut !== 'BROUILLON'"
                                [routerLink]="['/dashboards/credit/individuel/detail/analyse-bilan-activite', state().demandeIndividuel?.demandeIndividuelId]"
                                class="flex items-center justify-center w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors no-underline cursor-pointer"
                                style="display: flex !important; visibility: visible !important;">
                                <i class="pi pi-plus mr-2"></i>Renseigner
                            </a>
                        </div>
                    </div>

                    <!-- 2. Flux de Trésorerie -->
                    <div class="border-2 rounded-xl p-5 transition-all hover:shadow-md overflow-visible"
                        [ngClass]="state().hasDossierCredit ? 'border-green-300 bg-green-50' : 'border-orange-300 bg-orange-50'">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white"
                                [ngClass]="state().hasDossierCredit ? 'bg-green-500' : 'bg-orange-500'">
                                <i class="pi text-lg" [ngClass]="state().hasDossierCredit ? 'pi-check' : 'pi-money-bill'"></i>
                            </div>
                            <div>
                                <div class="font-bold text-base text-gray-800">2. Flux de Trésorerie</div>
                                <div class="text-sm font-medium"
                                    [ngClass]="state().hasDossierCredit ? 'text-green-600' : 'text-orange-600'">
                                    {{ state().hasDossierCredit ? '✓ Complété' : '○ À renseigner' }}
                                </div>
                            </div>
                        </div>

                        <!-- Boutons d'action -->
                        <div class="mt-4">
                            <!-- Bouton Visualiser - quand complété -->
                            <a *ngIf="state().hasDossierCredit"
                                [routerLink]="['/dashboards/credit/individuel/detail/analyse-flux-tresorerie', state().demandeIndividuel?.demandeIndividuelId]"
                                class="flex items-center justify-center w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors no-underline">
                                <i class="pi pi-eye mr-2"></i>Visualiser
                            </a>
                            <!-- Bouton Renseigner - quand pas de dossier crédit -->
                            <a *ngIf="!state().hasDossierCredit"
                                [routerLink]="['/dashboards/credit/individuel/detail/analyse-flux-tresorerie', state().demandeIndividuel?.demandeIndividuelId]"
                                class="flex items-center justify-center w-full bg-orange-600 hover:bg-orange-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors no-underline cursor-pointer"
                                style="display: flex !important; visibility: visible !important;">
                                <i class="pi pi-plus mr-2"></i>Renseigner
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Bouton Ancien Crédit -->
                <div class="text-center mt-4">
                    <button pButton type="button" (click)="openInNewTab('/dashboards/credit/analyse-credit')"
                        class="p-button-outlined p-button-secondary" icon="pi pi-chart-line"
                        label="Analyser son ancien crédit">
                    </button>
                </div>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <!-- SECTION CONSULTATION - DA/DR/MANAGER                                   -->
        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <div *ngIf="state().user?.role === 'DA' || state().user?.role === 'DR' || state().user?.role === 'MANAGER'"
            class="bg-white rounded-xl shadow-md overflow-hidden border-2 border-indigo-200 mb-8">
            <div class="bg-indigo-600 text-white px-6 py-4 flex items-center gap-3">
                <i class="pi pi-eye text-xl"></i>
                <span class="font-bold text-lg uppercase tracking-wide">
                    Consultation des Analyses - {{ getRoleLabel(state().user?.role!) }}
                </span>
            </div>

            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Bilan d'Activité -->
                    <div class="border-2 rounded-xl p-5 flex items-center justify-between"
                        [ngClass]="state().analyseStatut === 'SOUMISE' || state().analyseStatut === 'VALIDEE' ? 'border-green-300 bg-green-50' :
                                   state().analyseStatut === 'BROUILLON' ? 'border-yellow-300 bg-yellow-50' : 'border-gray-300 bg-gray-50'">
                        <div class="flex items-center gap-4">
                            <i class="pi pi-chart-bar text-3xl"
                                [ngClass]="state().analyseStatut === 'SOUMISE' || state().analyseStatut === 'VALIDEE' ? 'text-green-500' :
                                           state().analyseStatut === 'BROUILLON' ? 'text-yellow-500' : 'text-gray-400'"></i>
                            <div>
                                <div class="font-bold text-lg">Bilan d'Activité</div>
                                <div class="font-medium"
                                    [ngClass]="state().analyseStatut === 'SOUMISE' || state().analyseStatut === 'VALIDEE' ? 'text-green-600' :
                                               state().analyseStatut === 'BROUILLON' ? 'text-yellow-600' : 'text-gray-500'">
                                    {{ state().analyseStatut === 'SOUMISE' || state().analyseStatut === 'VALIDEE' ? '✓
                                    Disponible' :
                                    state().analyseStatut === 'BROUILLON' ? '⏳ En cours' : '○ Non renseigné' }}
                                </div>
                            </div>
                        </div>
                        <a *ngIf="state().analyseStatut === 'SOUMISE' || state().analyseStatut === 'VALIDEE'"
                            [routerLink]="['/dashboards/credit/individuel/detail/resume-analyse', state().demandeIndividuel?.demandeIndividuelId]"
                            class="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold text-base transition-all shadow-lg border-2 border-indigo-700">
                            <i class="pi pi-eye text-lg"></i>
                            <span>Voir</span>
                        </a>
                    </div>

                    <!-- Flux de Trésorerie -->
                    <div class="border-2 rounded-xl p-5 flex items-center justify-between"
                        [ngClass]="state().hasDossierCredit ? 'border-green-300 bg-green-50' : 'border-gray-300 bg-gray-50'">
                        <div class="flex items-center gap-4">
                            <i class="pi pi-money-bill text-3xl"
                                [ngClass]="state().hasDossierCredit ? 'text-green-500' : 'text-gray-400'"></i>
                            <div>
                                <div class="font-bold text-lg">Flux de Trésorerie</div>
                                <div class="font-medium"
                                    [ngClass]="state().hasDossierCredit ? 'text-green-600' : 'text-gray-500'">
                                    {{ state().hasDossierCredit ? '✓ Disponible' : '○ Non renseigné' }}
                                </div>
                            </div>
                        </div>
                        <a *ngIf="state().hasDossierCredit"
                            [routerLink]="['/dashboards/credit/individuel/detail/analyse-flux-tresorerie/' + state().demandeIndividuel?.demandeIndividuelId]"
                            class="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold text-base transition-all shadow-lg border-2 border-indigo-700">
                            <i class="pi pi-eye text-lg"></i>
                            <span>Voir</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <!-- SECTION AVIS - AGENT DE CRÉDIT (après flux)                            -->
        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <div *ngIf="state().user?.role === 'AGENT_CREDIT' && state().hasDossierCredit"
            class="bg-white rounded-xl shadow-md overflow-hidden border-2 border-teal-200 mb-8 mt-10">
            <div class="bg-teal-500 text-white px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="pi pi-comments text-xl"></i>
                    <span class="font-bold text-lg uppercase tracking-wide">Mon Avis sur le Dossier</span>
                </div>
                <span *ngIf="!state().userHasAvis"
                    class="bg-yellow-400 text-yellow-900 px-4 py-2 rounded-full font-semibold">
                    <i class="pi pi-exclamation-triangle mr-1"></i>Requis
                </span>
            </div>

            <div class="p-6">
                <!-- Formulaire d'avis -->
                <div *ngIf="!state().userHasAvis || state().editingAvis" class="avis-form-section">
                    <form [formGroup]="avisForm" (ngSubmit)="submitAvis()">
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Votre analyse et recommandation <span class="text-red-500">*</span>
                            </label>
                            <textarea pTextarea formControlName="libele" rows="4" class="w-full"
                                placeholder="Donnez votre avis professionnel..." [autoResize]="true">
                            </textarea>
                            <div class="flex justify-between mt-2">
                                <small *ngIf="avisForm.get('libele')?.invalid && avisForm.get('libele')?.touched"
                                    class="text-red-500">
                                    Minimum 10 caractères requis
                                </small>
                                <small class="text-gray-500">{{ avisForm.get('libele')?.value?.length || 0 }} /
                                    1000</small>
                            </div>
                        </div>
                        <div class="flex justify-end gap-3">
                            <p-button *ngIf="state().editingAvis" label="Annuler" icon="pi pi-times"
                                severity="secondary" [outlined]="true" (onClick)="cancelEdit()"></p-button>
                            <p-button [label]="getSubmitButtonLabel()" [icon]="getSubmitButtonIcon()" type="submit"
                                [loading]="state().submittingAvis" [disabled]="avisForm.invalid"></p-button>
                        </div>
                    </form>
                </div>

                <!-- Avis existant -->
                <div *ngIf="state().userHasAvis && !state().editingAvis"
                    class="bg-blue-50 border border-blue-200 rounded-xl p-5">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-3">
                                <p-badge value="Mon avis" severity="info"></p-badge>
                                <span class="text-gray-500">{{ formatDate(state().currentUserAvis?.dateCreation)
                                    }}</span>
                            </div>
                            <p class="text-gray-700 whitespace-pre-wrap">{{ state().currentUserAvis?.libele }}</p>
                        </div>
                        <button pButton icon="pi pi-pencil" class="p-button-text p-button-warning"
                            (click)="editAvis(state().currentUserAvis!)" pTooltip="Modifier"></button>
                    </div>
                </div>

                <!-- Bouton Approbation -->
                <div
                    class="mt-6 text-center p-6 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border-2 border-green-200">
                    <button pButton (click)="approvedDemande(state().demandeIndividuel!)"
                        [disabled]="!state().userHasAvis" class="px-10 py-3 font-bold shadow-lg text-base"
                        [ngClass]="state().userHasAvis ? 'bg-gradient-to-r from-green-500 to-emerald-600' : 'bg-gray-400'"
                        icon="pi pi-check-circle" label="APPROUVER LA DEMANDE">
                    </button>
                    <p *ngIf="!state().userHasAvis" class="text-red-600 mt-4 font-medium">
                        <i class="pi pi-exclamation-triangle mr-2"></i>Donnez d'abord votre avis
                    </p>
                </div>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <!-- SECTION AVIS - DA/DR/MANAGER (après approbation)                       -->
        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <div *ngIf="(state().user?.role === 'DA' || state().user?.role === 'DR' || state().user?.role === 'MANAGER')
            && state().demandeIndividuel?.validationState === 'APPROVED'"
            class="bg-white rounded-xl shadow-md overflow-hidden border-2 border-teal-200 mb-8 mt-10">
            <div class="bg-teal-500 text-white px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="pi pi-comments text-xl"></i>
                    <span class="font-bold text-lg uppercase tracking-wide">Avis et Recommandations</span>
                </div>
                <p-badge [value]="state().avisList.length.toString()" severity="contrast"></p-badge>
            </div>

            <div class="p-6">
                <!-- Formulaire -->
                <div *ngIf="(!state().userHasAvis && state().showAvisForm) || state().editingAvis" class="mb-6">
                    <form [formGroup]="avisForm" (ngSubmit)="submitAvis()" class="bg-gray-50 rounded-xl p-5">
                        <div class="mb-4">
                            <p-chip [label]="getRoleLabel(state().user?.role!)" icon="pi pi-user"></p-chip>
                        </div>
                        <textarea pTextarea formControlName="libele" rows="4" class="w-full mb-4"
                            placeholder="Partagez votre avis..." [autoResize]="true">
                        </textarea>
                        <div class="flex justify-end gap-4">
                            <p-button label="Annuler" icon="pi pi-times" severity="secondary" [outlined]="true"
                                (onClick)="cancelEdit()"></p-button>
                            <p-button label="Soumettre" icon="pi pi-send" type="submit"
                                [loading]="state().submittingAvis" [disabled]="avisForm.invalid"></p-button>
                        </div>
                    </form>
                </div>

                <!-- Liste des avis -->
                <div *ngIf="state().avisList.length > 0" class="space-y-6">
                    <div *ngFor="let avis of state().avisList"
                        class="border rounded-xl p-5 transition-all hover:shadow-md"
                        [ngClass]="avis.idUser === state().user?.userId ? 'border-blue-300 bg-blue-50' : 'border-gray-200 bg-white'">
                        <div class="flex items-start justify-between">
                            <div class="flex items-center gap-4">
                                <p-avatar [label]="(avis.userFullName || 'U').substring(0, 2).toUpperCase()"
                                    shape="circle" size="large"
                                    [style]="{'background-color': '#6366f1', 'color': 'white'}"></p-avatar>
                                <div>
                                    <p class="font-semibold text-base">
                                        {{ avis.userFullName || 'Utilisateur' }}
                                        <span *ngIf="avis.idUser === state().user?.userId"
                                            class="text-blue-600">(Vous)</span>
                                    </p>
                                    <p class="text-gray-500">{{ formatDate(avis.dateCreation) }}</p>
                                </div>
                            </div>
                            <div *ngIf="canEditAvis(avis)" class="flex gap-2">
                                <button pButton icon="pi pi-pencil" class="p-button-text p-button-warning"
                                    (click)="editAvis(avis)"></button>
                                <button pButton icon="pi pi-trash" class="p-button-text p-button-danger"
                                    (click)="deleteAvis(avis)"></button>
                            </div>
                        </div>
                        <p class="mt-4 text-gray-700 whitespace-pre-wrap">{{ avis.libele }}</p>
                    </div>
                </div>

                <div *ngIf="state().avisList.length === 0" class="text-center py-10 text-gray-500">
                    <i class="pi pi-comments text-5xl mb-4 block opacity-50"></i>
                    <p class="text-lg">Aucun avis n'a encore été donné</p>
                </div>
            </div>
        </div>

        <!-- Message si demande non approuvée (pour DA/DR/MANAGER) -->
        <div *ngIf="(state().user?.role === 'DA' || state().user?.role === 'DR' || state().user?.role === 'MANAGER')
            && state().demandeIndividuel?.validationState !== 'APPROVED'"
            class="bg-gray-100 border border-gray-300 rounded-xl p-8 text-center mb-8">
            <i class="pi pi-lock text-gray-400 text-5xl mb-4"></i>
            <h4 class="font-semibold text-gray-600 text-lg mb-3">Section Avis Non Disponible</h4>
            <p class="text-gray-500 mb-4">
                Les avis seront disponibles après l'approbation par l'agent de crédit.
            </p>
            <span class="inline-block bg-gray-200 px-5 py-2 rounded-full text-gray-700 font-medium">
                Statut: {{ state().demandeIndividuel?.validationState || 'En cours' }}
            </span>
        </div>

    </div>
</div>