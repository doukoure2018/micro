<!-- analyse-flux-tresorerie.component.html -->
<div class="analyse-flux-container">
    <p-confirmDialog></p-confirmDialog>
    <p-toast></p-toast>

    <!-- Section Informations du Demandeur -->
    <p-card class="mb-3" *ngIf="demandeIndividuel()">
        <ng-template pTemplate="header">
            <div class="flex justify-content-between align-items-center p-3">
                <h2>
                    <i class="pi pi-user mr-2"></i>
                    Informations du Demandeur
                </h2>
                <p-tag [value]="'Demande N°' + demandeIndividuelId" severity="info"></p-tag>
            </div>
        </ng-template>

        <div class="grid">
            <!-- Informations personnelles -->
            <div class="col-12 md:col-6 lg:col-4">
                <div class="info-group">
                    <label class="text-sm text-gray-600">Nom complet</label>
                    <div class="font-semibold text-lg">
                        {{ demandeIndividuel().prenom }} {{ demandeIndividuel().nom }}
                    </div>
                </div>
            </div>

            <div class="col-12 md:col-6 lg:col-4">
                <div class="info-group">
                    <label class="text-sm text-gray-600">Date de naissance</label>
                    <div class="font-semibold">
                        {{ formatDateFromArray(demandeIndividuel().dateNaissance) }}
                        <span class="text-sm text-gray-500 ml-2">
                            ({{ calculateAge(demandeIndividuel().dateNaissance) }} ans)
                        </span>
                    </div>
                </div>
            </div>

            <div class="col-12 md:col-6 lg:col-4">
                <div class="info-group">
                    <label class="text-sm text-gray-600">Téléphone</label>
                    <div class="font-semibold">
                        <i class="pi pi-phone mr-1"></i>
                        {{ demandeIndividuel().telephone }}
                    </div>
                </div>
            </div>

            <!-- Informations du crédit -->
            <div class="col-12">
                <p-divider></p-divider>
            </div>

            <div class="col-12 md:col-6 lg:col-3">
                <div class="info-group">
                    <label class="text-sm text-gray-600">Montant demandé</label>
                    <div class="font-semibold text-primary text-xl">
                        {{ formatMontant(demandeIndividuel().montantDemande) }}
                    </div>
                </div>
            </div>

            <div class="col-12 md:col-6 lg:col-3">
                <div class="info-group">
                    <label class="text-sm text-gray-600">Durée du prêt</label>
                    <div class="font-semibold">
                        {{ demandeIndividuel().dureeDemande }} mois
                    </div>
                </div>
            </div>

            <div class="col-12 md:col-6 lg:col-3">
                <div class="info-group">
                    <label class="text-sm text-gray-600">Taux d'intérêt</label>
                    <div class="font-semibold">
                        {{ demandeIndividuel().tauxInteret }}% annuel
                    </div>
                </div>
            </div>

            <div class="col-12 md:col-6 lg:col-3">
                <div class="info-group">
                    <label class="text-sm text-gray-600">Échéance mensuelle</label>
                    <div class="font-semibold">
                        {{ formatMontant(mensualite().total) }}
                    </div>
                </div>
            </div>

            <!-- Activité -->
            <div class="col-12">
                <p-divider></p-divider>
                <div class="info-group">
                    <label class="text-sm text-gray-600">Description de l'activité</label>
                    <div class="font-semibold">
                        {{ demandeIndividuel().descriptionActivite }}
                    </div>
                    <small class="text-gray-500">
                        Ancienneté: {{ demandeIndividuel().nombreAnneeActivite }} ans |
                        Lieu: {{ demandeIndividuel().adresseLieuActivite }}
                    </small>
                </div>
            </div>

            <!-- Garanties -->
            <div class="col-12" *ngIf="garanties().length > 0">
                <p-divider></p-divider>
                <h4 class="mb-3">
                    <i class="pi pi-shield mr-2"></i>
                    Garanties proposées ({{ garanties().length }})
                </h4>
                <p-table [value]="garanties()" styleClass="p-datatable-sm" [scrollable]="true">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Type</th>
                            <th>Description</th>
                            <th class="text-right">Valeur garantie</th>
                            <th class="text-center">Couverture</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-garantie>
                        <tr>
                            <td>{{ garantie.typeGarantie }}</td>
                            <td>{{ garantie.descriptionGarantie }}</td>
                            <td class="text-right">{{ formatMontant(garantie.valeurGarantie) }}</td>
                            <td class="text-center">
                                <p-tag
                                    [value]="((garantie.valeurGarantie / demandeIndividuel().montantDemande) * 100).toFixed(0) + '%'"
                                    [severity]="garantie.valeurGarantie >= demandeIndividuel().montantDemande ? 'success' : 'warn'">
                                </p-tag>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>
    </p-card>

    <p-divider></p-divider>

    <!-- Section Statut du Dossier de Crédit -->
    <div class="credit-status-section mb-4" *ngIf="demandeIndividuel()">
        <!-- Si dossier existe -->
        <div *ngIf="creditParams().dossierId > 0" class="dossier-existant">
            <div class="status-card bg-green-50 border-round-lg border-1 border-green-300 p-3">
                <div class="flex align-items-center justify-content-between flex-wrap gap-3">
                    <div class="flex align-items-center gap-3">
                        <div class="status-icon bg-green-500 border-circle p-3">
                            <i class="pi pi-check-circle text-white text-2xl"></i>
                        </div>
                        <div>
                            <div class="text-green-800 font-bold text-lg">
                                Dossier N°{{ creditParams().dossierId }} créé
                            </div>
                            <div class="text-green-600 text-sm">
                                {{ demandeIndividuel().prenom }} {{ demandeIndividuel().nom }} •
                                {{ formatMontant(creditParams().montantCredit) }} •
                                {{ creditParams().duree }} mois à {{ creditParams().tauxInteret }}%
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2 align-items-center">
                        <p-tag severity="success" value="Prêt pour saisie" icon="pi pi-check"></p-tag>
                        <span class="text-sm text-gray-600">
                            Mensualité: <strong class="text-primary">{{ formatMontant(mensualite().total) }}</strong>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Si dossier n'existe pas encore -->
        <div *ngIf="!creditParams().dossierId || creditParams().dossierId === 0" class="dossier-a-creer">
            <div class="status-card bg-orange-50 border-round-lg border-1 border-orange-300 p-3">
                <div class="flex align-items-center justify-content-between flex-wrap gap-3">
                    <div class="flex align-items-center gap-3">
                        <div class="status-icon bg-orange-500 border-circle p-3">
                            <i class="pi pi-exclamation-circle text-white text-2xl"></i>
                        </div>
                        <div>
                            <div class="text-orange-800 font-bold text-lg">
                                Dossier de crédit à créer
                            </div>
                            <div class="text-orange-600 text-sm">
                                {{ demandeIndividuel().prenom }} {{ demandeIndividuel().nom }} •
                                {{ formatMontant(creditParams().montantCredit) }} •
                                {{ creditParams().duree }} mois à {{ creditParams().tauxInteret }}%
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2 align-items-center flex-wrap">
                        <div
                            class="mensualite-preview text-center px-3 py-2 bg-white border-round border-1 border-orange-200">
                            <div class="text-xs text-gray-500">Mensualité calculée</div>
                            <div class="font-bold text-primary text-lg">{{ formatMontant(mensualite().total) }}</div>
                            <div class="text-xs text-gray-500">
                                ({{ formatMontant(mensualite().capital) }} + {{ formatMontant(mensualite().interet) }})
                            </div>
                        </div>
                        <p-button label="Créer le dossier" icon="pi pi-plus-circle" severity="warn"
                            (onClick)="createDossierCredit()" [loading]="state().saving"
                            pTooltip="Créer le dossier pour pouvoir sauvegarder les prévisions">
                        </p-button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SECTION PRINCIPALE : TABLEAU DE TRÉSORERIE -->
    <p-card>
        <ng-template pTemplate="header">
            <div class="card-header-tresorerie p-3">
                <div class="flex justify-content-between align-items-center flex-wrap gap-2">
                    <!-- Titre et badges -->
                    <div class="flex align-items-center gap-3">
                        <h2 class="m-0 flex align-items-center gap-2">
                            <i class="pi pi-table text-primary"></i>
                            Prévision de Trésorerie
                        </h2>
                        <div class="flex gap-2">
                            @if (!hasDossierCredit()) {
                            <p-tag severity="danger" value="Dossier requis" icon="pi pi-lock"></p-tag>
                            }
                            <p-tag *ngIf="getTableMonthsWithData() > 0 && hasDossierCredit()" severity="info"
                                [value]="getTableMonthsWithData() + '/' + (nombreMois() + 1) + ' mois'"
                                icon="pi pi-calendar">
                            </p-tag>
                            <p-tag *ngIf="tresorerieState.hasUnsavedChanges() && hasDossierCredit()" severity="warn" value="Modifications"
                                icon="pi pi-exclamation-triangle">
                            </p-tag>
                            <p-tag *ngIf="!tresorerieState.hasUnsavedChanges() && getTableMonthsWithData() > 0 && hasDossierCredit()"
                                severity="success" value="Sauvegardé" icon="pi pi-check">
                            </p-tag>
                        </div>
                    </div>

                    <!-- Boutons d'action -->
                    <div class="flex gap-2 align-items-center flex-wrap">
                        @if (peutImprimer() && hasDossierCredit()) {
                        <div class="btn-group-print flex gap-1">
                            <p-button icon="pi pi-print" label="Imprimer" severity="success" size="small"
                                (onClick)="imprimerTableauTresorerie()" pTooltip="Imprimer le tableau">
                            </p-button>
                            <p-splitButton icon="pi pi-ellipsis-v" size="small" severity="success"
                                [model]="splitButtonOptions" styleClass="split-btn-only-icon">
                            </p-splitButton>
                        </div>
                        } @else {
                        <p-button icon="pi pi-print" label="Imprimer" severity="secondary" size="small"
                            [disabled]="true" pTooltip="Créez d'abord le dossier pour imprimer">
                        </p-button>
                        }
                    </div>
                </div>
            </div>
        </ng-template>

        <!-- BLOQUER SI PAS DE DOSSIER -->
        @if (!hasDossierCredit()) {
        <div class="dossier-required-overlay">
            <div class="overlay-content text-center p-5">
                <div class="overlay-icon mb-4">
                    <i class="pi pi-lock text-6xl text-orange-500"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">
                    Dossier de crédit requis
                </h3>
                <p class="text-gray-600 mb-4 max-w-30rem mx-auto">
                    Avant de pouvoir saisir les prévisions de trésorerie, vous devez d'abord créer le dossier de crédit.
                    Cette étape est obligatoire pour enregistrer vos données.
                </p>
                <div class="flex justify-content-center gap-3 flex-wrap">
                    <p-button label="Créer le dossier maintenant" icon="pi pi-plus-circle" severity="warn" size="large"
                        (onClick)="createDossierCredit()" [loading]="state().saving">
                    </p-button>
                </div>
                <div class="mt-4 text-sm text-gray-500">
                    <i class="pi pi-info-circle mr-1"></i>
                    Montant: <strong>{{ formatMontant(creditParams().montantCredit) }}</strong> |
                    Durée: <strong>{{ creditParams().duree }} mois</strong> |
                    Taux: <strong>{{ creditParams().tauxInteret }}%</strong>
                </div>
            </div>
        </div>
        } @else {

        <!-- Bannière de progression -->
        @if (peutImprimer()) {
        <div class="progress-banner mb-3">
            <div class="p-3 surface-100 border-round-lg border-1 surface-border">
                <div class="flex align-items-center justify-content-between mb-2">
                    <span class="font-semibold text-gray-700">
                        <i class="pi pi-chart-line mr-2"></i>
                        Progression: {{ getTableMonthsWithData() }}/{{ nombreMois() + 1 }} mois
                    </span>
                    <span [ngClass]="{
                            'text-red-500': (getCellValue('soldeFin', dernierMois()) ?? 0) < 0,
                            'text-green-600': (getCellValue('soldeFin', dernierMois()) ?? 0) >= 0
                        }">
                        Solde final: <strong>{{ formatMontant(getCellValue('soldeFin', dernierMois()) ?? 0) }}</strong>
                    </span>
                </div>

                <!-- Segments pour chaque mois -->
                <div class="month-segments flex gap-1">
                    @for (mois of moisColumns(); track mois) {
                    <div class="month-segment flex-1"
                        [class.segment-empty]="!checkIfMoisHasData(getMoisFormGroup(mois).getRawValue())"
                        [class.segment-filled]="checkIfMoisHasData(getMoisFormGroup(mois).getRawValue()) && !moisSauvegardes().has(mois)"
                        [class.segment-saved]="moisSauvegardes().has(mois)"
                        [pTooltip]="'M' + mois + (moisSauvegardes().has(mois) ? ' ✓' : '')" tooltipPosition="top">
                        <span class="segment-label">{{ mois }}</span>
                    </div>
                    }
                </div>

                <!-- Légende -->
                <div class="flex justify-content-between align-items-center mt-2">
                    <div class="flex gap-3 text-xs">
                        <span class="flex align-items-center gap-1">
                            <span class="legend-dot bg-gray-300"></span> Vide
                        </span>
                        <span class="flex align-items-center gap-1">
                            <span class="legend-dot bg-orange-400"></span> Renseigné
                        </span>
                        <span class="flex align-items-center gap-1">
                            <span class="legend-dot bg-green-500"></span> Sauvegardé
                        </span>
                    </div>
                </div>
            </div>
        </div>
        }

        <!-- Info sur le solde final -->
        <div class="solde-final-info mb-3 p-3 border-round flex justify-content-between align-items-center" [ngClass]="{
                'bg-green-50 border-green-200': (getCellValue('soldeFin', dernierMois()) ?? 0) >= 0, 
                'bg-red-50 border-red-200': (getCellValue('soldeFin', dernierMois()) ?? 0) < 0
            }">
            <div>
                <span class="text-sm">Solde final prévu (Mois {{ dernierMois() }}):</span>
            </div>
            <div>
                <span class="font-bold text-2xl" [ngClass]="{
                        'text-green-600': (getCellValue('soldeFin', dernierMois()) ?? 0) >= 0, 
                        'text-red-600': (getCellValue('soldeFin', dernierMois()) ?? 0) < 0
                    }">
                    {{ formatMontant(getCellValue('soldeFin', dernierMois()) ?? 0) }}
                </span>
            </div>
        </div>

        <!-- TABLEAU PRINCIPAL -->
        <div class="tresorerie-table-wrapper">
            <table class="tresorerie-table">
                <thead>
                    <tr class="header-row">
                        <th class="col-libelle sticky-col">Libellé</th>
                        @for (mois of moisColumns(); track mois) {
                        <th class="col-mois" [class.col-mois-0]="mois === 0">
                            {{ getTableMoisLabel(mois) }}
                            <small *ngIf="mois === 0" class="block text-xs opacity-70">Démarrage</small>
                        </th>
                        }
                        <th class="col-cumul">Cumul</th>
                    </tr>
                </thead>
                <tbody>
                    @for (ligne of lignesTableau; track ligne.id; let i = $index) {
                    <!-- Séparateurs de section -->
                    @if (ligne.id === 'ventes') {
                    <tr class="section-header-row">
                        <td [attr.colspan]="moisColumns().length + 2" class="section-title section-encaissement">
                            <i class="pi pi-download mr-2"></i> ENCAISSEMENTS
                        </td>
                    </tr>
                    }
                    @if (ligne.id === 'achatmarchandises') {
                    <tr class="section-header-row">
                        <td [attr.colspan]="moisColumns().length + 2" class="section-title section-decaissement">
                            <i class="pi pi-upload mr-2"></i> DÉCAISSEMENTS
                        </td>
                    </tr>
                    }
                    @if (ligne.id === 'disponibleEnCaisse') {
                    <tr class="section-header-row">
                        <td [attr.colspan]="moisColumns().length + 2" class="section-title section-calcul">
                            <i class="pi pi-calculator mr-2"></i> RÉSULTATS
                        </td>
                    </tr>
                    }
                    @if (ligne.id === 'interetsAVerser') {
                    <tr class="section-header-row">
                        <td [attr.colspan]="moisColumns().length + 2" class="section-title section-remboursement">
                            <i class="pi pi-money-bill mr-2"></i> REMBOURSEMENTS CRÉDIT
                        </td>
                    </tr>
                    }

                    <!-- Ligne de données -->
                    <tr [class]="ligne.cssClass">
                        <!-- Colonne libellé -->
                        <td class="col-libelle sticky-col">
                            <div class="flex align-items-center justify-content-between">
                                <span class="libelle-text">{{ ligne.libelle }}</span>
                                <!-- @if (ligne.editable) {
                                <button pButton type="button" icon="pi pi-copy"
                                    class="p-button-text p-button-sm p-button-rounded copy-btn"
                                    [pTooltip]="'Copier M0 vers M1-M' + nombreMois()" tooltipPosition="right"
                                    (click)="copyToFollowingMonths(ligne.id, 0)">
                                </button>
                                } -->
                            </div>
                        </td>

                        <!-- Cellules pour chaque mois -->
                        @for (mois of moisColumns(); track mois) {
                        <td class="col-mois" [class.col-mois-0]="mois === 0"
                            [class.cell-editable]="isCellEditable(ligne, mois)"
                            [class.cell-readonly]="!isCellEditable(ligne, mois)"
                            [class.cell-negative]="(getCellValue(ligne.id, mois) ?? 0) < 0"
                            [class.cell-positive]="(getCellValue(ligne.id, mois) ?? 0) > 0 && ligne.type === 'calcul'"
                            [pTooltip]="getCellTooltip(ligne, mois)" tooltipPosition="top"
                            [tooltipOptions]="{ showDelay: 300, hideDelay: 0 }">

                            <!-- Cellule éditable -->
                            @if (isCellEditable(ligne, mois)) {
                            <div class="cell-container">
                                <p-inputNumber [ngModel]="getCellValue(ligne.id, mois)"
                                    (ngModelChange)="onTableCellChange(ligne.id, mois, $event)" mode="decimal"
                                    [minFractionDigits]="0" [maxFractionDigits]="0" [useGrouping]="true" locale="fr-FR"
                                    inputStyleClass="table-cell-input" [placeholder]="'-'">
                                </p-inputNumber>

                                <!-- Bouton copie vers mois suivants (visible au survol) -->
                                @if (mois < nombreMois() && getCellValue(ligne.id, mois) !==null &&
                                    getCellValue(ligne.id, mois) !==0) { <button pButton type="button"
                                    icon="pi pi-arrow-right"
                                    class="copy-cell-btn p-button-text p-button-sm p-button-rounded"
                                    [pTooltip]="'Copier vers M' + (mois + 1) + ' à M' + nombreMois()"
                                    tooltipPosition="top"
                                    (click)="copyToFollowingMonths(ligne.id, mois); $event.stopPropagation()">
                                    </button>
                                    }
                            </div>
                            } @else {
                            <!-- Cellule en lecture seule -->
                            <span class="cell-value-display">
                                {{ getCellValue(ligne.id, mois) | number:'1.0-0' }}
                            </span>
                            }
                        </td>
                        }

                        <!-- Colonne Cumul avec tooltip -->
                        <td class="col-cumul" [pTooltip]="getCumulTooltip(ligne)" tooltipPosition="top"
                            [tooltipOptions]="{ showDelay: 300 }">
                            <span class="cumul-value">
                                {{ getCumulForLigne(ligne.id) | number:'1.0-0' }}
                            </span>
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pied de page avec actions -->
        <div class="actions-footer mt-4 pt-4 border-top-1 surface-border">
            <div class="flex justify-content-between align-items-center flex-wrap gap-3">
                <div class="status-info flex align-items-center gap-2">
                    <i class="pi pi-info-circle text-primary"></i>
                    <span class="text-sm">
                        @if (getTableMonthsWithData() === 0) {
                        <span class="text-orange-500">
                            Commencez par saisir les données dans le tableau
                        </span>
                        } @else if (tresorerieState.hasUnsavedChanges()) {
                        <span class="text-orange-500">
                            {{ getTableMonthsWithData() }} mois renseignés - Modifications non sauvegardées
                        </span>
                        } @else {
                        <span class="text-green-600">
                            <i class="pi pi-check-circle mr-1"></i>
                            Tous les changements sont sauvegardés
                        </span>
                        }
                    </span>
                </div>

                <div class="flex gap-2 flex-wrap">
                    <p-button label="Retour" icon="pi pi-arrow-left" outlined
                        [routerLink]="['/dashboards/credit/individuel/attente/detail', demandeIndividuelId]">
                    </p-button>

                    @if (peutImprimer()) {
                    <p-button label="Imprimer" icon="pi pi-print" severity="secondary"
                        (onClick)="imprimerTableauTresorerie()">
                    </p-button>
                    }

                    <p-button label="Sauvegarder" icon="pi pi-save" severity="success" [loading]="state().saving"
                        [disabled]="!canSaveTableau()" (onClick)="savePrevisions()">
                    </p-button>
                </div>
            </div>
        </div>
        }
    </p-card>
</div>