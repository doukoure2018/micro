<!-- Status Filter Cards -->
<div class="flex flex-wrap gap-3 mb-4">
    <!-- TOUTES -->
    <div class="flex-1 surface-card shadow-1 border-round p-3 cursor-pointer border-left-3 transition-all"
         style="min-width: 170px"
         [class.border-left-primary]="activeFilter() === 'ALL'"
         [class.surface-ground]="activeFilter() === 'ALL'"
         (click)="activeFilter.set('ALL')">
        <div class="flex justify-between items-center">
            <div>
                <span class="block text-500 font-medium mb-1">Toutes</span>
                <div class="text-900 font-bold text-xl">{{ state().demandeAttentes?.length || 0 }}</div>
            </div>
            <div class="flex items-center justify-center border-round"
                 style="width:2.5rem;height:2.5rem;background:var(--surface-200)">
                <i class="pi pi-list text-xl" style="color:var(--text-color-secondary)"></i>
            </div>
        </div>
    </div>

    <!-- EN ATTENTE -->
    <div class="flex-1 surface-card shadow-1 border-round p-3 cursor-pointer border-left-3 transition-all"
         style="min-width: 170px"
         [style.border-left-color]="activeFilter() === 'EN_ATTENTE' ? 'var(--blue-500)' : 'transparent'"
         [class.surface-ground]="activeFilter() === 'EN_ATTENTE'"
         (click)="activeFilter.set('EN_ATTENTE')">
        <div class="flex justify-between items-center">
            <div>
                <span class="block text-500 font-medium mb-1">En Attente</span>
                <div class="text-900 font-bold text-xl">{{ countEnAttente() }}</div>
            </div>
            <div class="flex items-center justify-center border-round"
                 style="width:2.5rem;height:2.5rem;background:var(--blue-50)">
                <i class="pi pi-clock text-xl" style="color:var(--blue-500)"></i>
            </div>
        </div>
    </div>

    <!-- AFFECTATION / SELECTION -->
    <div class="flex-1 surface-card shadow-1 border-round p-3 cursor-pointer border-left-3 transition-all"
         style="min-width: 170px"
         [style.border-left-color]="activeFilter() === 'AFFECTATION' ? 'var(--orange-500)' : 'transparent'"
         [class.surface-ground]="activeFilter() === 'AFFECTATION'"
         (click)="activeFilter.set('AFFECTATION')">
        <div class="flex justify-between items-center">
            <div>
                <span class="block text-500 font-medium mb-1">Affectation</span>
                <div class="text-900 font-bold text-xl">{{ countAffectation() }}</div>
            </div>
            <div class="flex items-center justify-center border-round"
                 style="width:2.5rem;height:2.5rem;background:var(--orange-50)">
                <i class="pi pi-user-edit text-xl" style="color:var(--orange-500)"></i>
            </div>
        </div>
    </div>

    <!-- APPROUVEE -->
    <div class="flex-1 surface-card shadow-1 border-round p-3 cursor-pointer border-left-3 transition-all"
         style="min-width: 170px"
         [style.border-left-color]="activeFilter() === 'APPROUVEE' ? 'var(--green-500)' : 'transparent'"
         [class.surface-ground]="activeFilter() === 'APPROUVEE'"
         (click)="activeFilter.set('APPROUVEE')">
        <div class="flex justify-between items-center">
            <div>
                <span class="block text-500 font-medium mb-1">Approuvées</span>
                <div class="text-900 font-bold text-xl">{{ countApprouvee() }}</div>
            </div>
            <div class="flex items-center justify-center border-round"
                 style="width:2.5rem;height:2.5rem;background:var(--green-50)">
                <i class="pi pi-check-circle text-xl" style="color:var(--green-500)"></i>
            </div>
        </div>
    </div>

    <!-- REJETEE -->
    <div class="flex-1 surface-card shadow-1 border-round p-3 cursor-pointer border-left-3 transition-all"
         style="min-width: 170px"
         [style.border-left-color]="activeFilter() === 'REJETEE' ? 'var(--red-500)' : 'transparent'"
         [class.surface-ground]="activeFilter() === 'REJETEE'"
         (click)="activeFilter.set('REJETEE')">
        <div class="flex justify-between items-center">
            <div>
                <span class="block text-500 font-medium mb-1">Rejetées</span>
                <div class="text-900 font-bold text-xl">{{ countRejetee() }}</div>
            </div>
            <div class="flex items-center justify-center border-round"
                 style="width:2.5rem;height:2.5rem;background:var(--red-50)">
                <i class="pi pi-times-circle text-xl" style="color:var(--red-500)"></i>
            </div>
        </div>
    </div>
</div>

<!-- Table des demandes -->
<div class="card">
    <p-table #dt [value]="filteredDemandes()" [paginator]="true" paginatorDropdownAppendTo="body" [rows]="15"
        [showCurrentPageReport]="true" responsiveLayout="scroll"
        currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} entrées"
        [rowsPerPageOptions]="[15, 30, 50]"
        groupRowsBy="dateGroup" rowGroupMode="subheader"
        sortField="dateGroup" [sortOrder]="-1"
        [globalFilterFields]="['nom', 'prenom', 'numeroMembre', 'typeActivite', 'telephone', 'montantDemande']">

        <ng-template pTemplate="caption">
            <div class="flex flex-wrap gap-2 items-center justify-between">
                <div class="flex gap-2 items-center">
                    <button pButton icon="pi pi-refresh" class="p-button-outlined p-button-sm"
                        pTooltip="Rafraîchir les données" (click)="refreshData()">
                    </button>

                    @if(activeFilter() !== 'ALL') {
                    <p-tag [value]="activeFilter() === 'EN_ATTENTE' ? 'En Attente' :
                                    activeFilter() === 'AFFECTATION' ? 'Affectation' :
                                    activeFilter() === 'APPROUVEE' ? 'Approuvées' : 'Rejetées'"
                           [severity]="activeFilter() === 'EN_ATTENTE' ? 'info' :
                                       activeFilter() === 'AFFECTATION' ? 'warn' :
                                       activeFilter() === 'APPROUVEE' ? 'success' : 'danger'">
                    </p-tag>
                    <button pButton icon="pi pi-filter-slash" label="Toutes"
                        class="p-button-text p-button-sm" (click)="activeFilter.set('ALL')">
                    </button>
                    }

                    @if(state().agenceId || state().pointVenteId) {
                    <button pButton icon="pi pi-filter-slash" label="Réinitialiser filtres"
                        class="p-button-text p-button-sm" (click)="clearFilters()">
                    </button>
                    }
                </div>

                <p-icon-field class="w-full sm:w-80 order-1 sm:order-none">
                    <p-inputicon class="pi pi-search" />
                    <input pInputText type="text" (input)="onGlobalFilter(dt, $event)"
                        placeholder="Recherche globale..." class="w-full" />
                </p-icon-field>
            </div>
        </ng-template>

        <ng-template pTemplate="header">
            <tr>
                <th pSortableColumn="demandeIndividuelId" style="width:5%">
                    ID <p-sortIcon field="demandeIndividuelId"></p-sortIcon>
                </th>
                <th pSortableColumn="nom" style="width:20%">
                    Demandeur <p-sortIcon field="nom"></p-sortIcon>
                </th>
                <th pSortableColumn="numeroMembre" style="width:10%">
                    N° Membre <p-sortIcon field="numeroMembre"></p-sortIcon>
                </th>
                <th pSortableColumn="montantDemande" style="width:12%">
                    Montant <p-sortIcon field="montantDemande"></p-sortIcon>
                </th>
                <th pSortableColumn="typeActivite" style="width:13%">
                    Activité <p-sortIcon field="typeActivite"></p-sortIcon>
                </th>
                <th style="width:8%">
                    Garanties
                </th>
                <th pSortableColumn="dureeDemande" style="width:8%">
                    Durée <p-sortIcon field="dureeDemande"></p-sortIcon>
                </th>
                <th pSortableColumn="statutDemande" style="width:12%">
                    Statut <p-sortIcon field="statutDemande"></p-sortIcon>
                </th>
                <th pSortableColumn="createdAt" style="width:10%">
                    Date <p-sortIcon field="createdAt"></p-sortIcon>
                </th>
                <th style="width:7%">Actions</th>
            </tr>
        </ng-template>

        <ng-template pTemplate="groupheader" let-demande>
            <tr pRowGroupHeader>
                <td colspan="10">
                    <div class="flex align-items-center gap-3 py-2">
                        <i class="pi pi-calendar text-primary"></i>
                        <span class="font-bold text-lg">{{ formatDateGroup(demande.dateGroup) }}</span>
                        <p-badge [value]="getCountForDate(demande.dateGroup).toString()" severity="info"></p-badge>
                        <span class="text-500 text-sm ml-2">
                            Total: {{ getTotalMontantForDate(demande.dateGroup) | currency:'GNF':'symbol':'1.0-0' }}
                        </span>
                    </div>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-demande>
            <tr>
                <td>
                    <span class="font-bold text-primary">
                        #{{ demande.demandeIndividuelId || demande.demandeindividuel_id }}
                    </span>
                </td>
                <td>
                    <div class="flex flex-column gap-1">
                        <span class="font-semibold">
                            {{ demande.prenom }} {{ demande.nom }}
                        </span>
                        <small class="text-gray-500">
                            <i class="pi pi-phone mr-1"></i>{{ demande.telephone }}
                        </small>
                        @if(demande.addresseDomicileContact) {
                        <small class="text-gray-500">
                            <i class="pi pi-map-marker mr-1"></i>{{ demande.addresseDomicileContact }}
                        </small>
                        }
                    </div>
                </td>
                <td>
                    <span class="font-medium">{{ demande.numeroMembre }}</span>
                </td>
                <td>
                    <div class="flex flex-column gap-1">
                        <span class="font-bold text-primary">
                            {{ (demande.montantDemande || demande.montant) | currency:'GNF':'symbol':'1.0-0' }}
                        </span>
                        @if(demande.echeance) {
                        <small class="text-gray-500">
                            Échéance: {{ demande.echeance | currency:'GNF':'symbol':'1.0-0' }}
                        </small>
                        }
                    </div>
                </td>
                <td>
                    <div class="flex flex-column gap-1">
                        <span>{{ demande.typeActivite || demande.activite }}</span>
                        @if(demande.sousActivite) {
                        <small class="text-gray-500">{{ demande.sousActivite }}</small>
                        }
                        @if(demande.descriptionActivite) {
                        <small class="text-gray-500" [pTooltip]="demande.descriptionActivite">
                            <i class="pi pi-info-circle mr-1"></i>Description
                        </small>
                        }
                    </div>
                </td>
                <td class="text-center">
                    @if(demande.garanties && demande.garanties.length > 0) {
                    <div class="flex flex-column align-items-center gap-1">
                        <p-badge [value]="demande.garanties.length.toString()" severity="info"
                            [pTooltip]="getGarantiesTooltip(demande.garanties)">
                        </p-badge>
                        <small class="text-gray-500">
                            {{ getTotalGaranties(demande.garanties) | currency:'GNF':'symbol':'1.0-0' }}
                        </small>
                    </div>
                    } @else {
                    <p-badge value="0" severity="secondary"></p-badge>
                    }
                </td>
                <td class="text-center">
                    @if(demande.dureeDemande) {
                    <div class="flex flex-column align-items-center gap-1">
                        <span class="font-semibold">{{ demande.dureeDemande }} mois</span>
                        @if(demande.periodiciteRemboursement) {
                        <small class="text-gray-500">
                            {{ formatPeriodicite(demande.periodiciteRemboursement) }}
                        </small>
                        }
                    </div>
                    } @else {
                    <span>-</span>
                    }
                </td>
                <td>
                    <div class="flex flex-column gap-1">
                        <p-tag [value]="getStatusLabel(demande.statutDemande, demande.validationState)"
                            [severity]="getStatusSeverity(demande.statutDemande, demande.validationState)">
                        </p-tag>
                        @if(demande.statutCredit) {
                        <small>
                            <p-tag [value]="demande.statutCredit" severity="secondary" styleClass="text-xs">
                            </p-tag>
                        </small>
                        }
                    </div>
                </td>
                <td>
                    <div class="flex flex-column gap-1">
                        <span>{{ demande.createdAt | date: 'dd/MM/yyyy' }}</span>
                        <small class="text-gray-500">
                            {{ demande.createdAt | date: 'HH:mm' }}
                        </small>
                    </div>
                </td>
                <td>
                    <div class="flex gap-2 justify-center">
                        <button pButton icon="pi pi-eye" class="p-button-rounded p-button-text p-button-sm"
                            pTooltip="Voir détails complets"
                            (click)="viewDetailDemandeAttente(demande.demandeIndividuelId || demande.demandeindividuel_id)">
                        </button>
                        @if(demande.garanties && demande.garanties.length > 0) {
                        <button pButton icon="pi pi-shield"
                            class="p-button-rounded p-button-text p-button-sm p-button-success"
                            [pTooltip]="'Voir ' + demande.garanties.length + ' garantie(s)'"
                            (click)="viewDetailDemandeAttente(demande.demandeIndividuelId || demande.demandeindividuel_id)">
                        </button>
                        }
                    </div>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="10" class="text-center p-4">
                    <div class="flex flex-column align-items-center gap-3">
                        <i class="pi pi-inbox text-5xl text-gray-400"></i>
                        @if(activeFilter() === 'ALL') {
                        <h3 class="text-xl font-semibold text-gray-600">Aucune demande en attente</h3>
                        <p class="text-gray-500">Les nouvelles demandes apparaîtront ici</p>
                        } @else if(activeFilter() === 'EN_ATTENTE') {
                        <h3 class="text-xl font-semibold text-gray-600">Aucune demande en attente</h3>
                        <p class="text-gray-500">Aucune nouvelle demande à traiter</p>
                        } @else if(activeFilter() === 'AFFECTATION') {
                        <h3 class="text-xl font-semibold text-gray-600">Aucune demande en affectation</h3>
                        <p class="text-gray-500">Aucune demande en cours de sélection</p>
                        } @else if(activeFilter() === 'APPROUVEE') {
                        <h3 class="text-xl font-semibold text-gray-600">Aucune demande approuvée</h3>
                        <p class="text-gray-500">Les demandes approuvées apparaîtront ici</p>
                        } @else {
                        <h3 class="text-xl font-semibold text-gray-600">Aucune demande rejetée</h3>
                        <p class="text-gray-500">Aucune demande rejetée pour le moment</p>
                        }
                    </div>
                </td>
            </tr>
        </ng-template>

        <!-- Loading -->
        @if(state().loading) {
        <ng-template pTemplate="loading">
            <tr>
                <td colspan="10" class="text-center p-4">
                    <p-progressBar mode="indeterminate" [style]="{'height': '6px'}"></p-progressBar>
                    <p class="mt-2">Chargement des demandes...</p>
                </td>
            </tr>
        </ng-template>
        }

        <!-- Summary Footer -->
        <ng-template pTemplate="summary">
            <div class="flex align-items-center justify-between p-3 border-top-1 surface-border">
                <div class="flex gap-4">
                    <span class="text-gray-600">
                        <strong>Demandes affichées:</strong> {{ filteredDemandes().length }}
                        @if(activeFilter() !== 'ALL') {
                        <span class="text-500"> / {{ state().demandeAttentes?.length || 0 }}</span>
                        }
                    </span>
                    @if(filteredDemandes().length > 0) {
                    <span class="text-gray-600">
                        <strong>Montant total:</strong>
                        {{ calculateTotalMontant() | currency:'GNF':'symbol':'1.0-0' }}
                    </span>
                    <span class="text-gray-600">
                        <strong>Total garanties:</strong>
                        {{ calculateTotalAllGaranties() | currency:'GNF':'symbol':'1.0-0' }}
                    </span>
                    }
                </div>
                @if(state().userInfo) {
                <div class="text-gray-600">
                    <i class="pi pi-user mr-2"></i>
                    <span>{{ getUserName() }}</span>
                    @if(getUserAgenceName() !== 'N/A') {
                    <span class="ml-2">| {{ getUserAgenceName() }}</span>
                    }
                </div>
                }
            </div>
        </ng-template>
    </p-table>
</div>
