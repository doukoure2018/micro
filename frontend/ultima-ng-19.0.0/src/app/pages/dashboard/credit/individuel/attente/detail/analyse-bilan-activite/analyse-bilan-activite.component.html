<div class="card">
    <h1 class="text-surface-900 dark:text-surface-0 text-xl font-bold mb-6">Analyse Financière</h1>

    <p-toast></p-toast>

    <!-- Bouton créer analyse si pas encore créée -->
    <div class="mb-4" *ngIf="!state().analyseExiste">
        <div
            class="p-3 bg-yellow-50 border-round border-1 border-yellow-200 flex align-items-center justify-content-between">
            <span><i class="pi pi-info-circle mr-2"></i>Aucune analyse financière n'existe pour cette demande.</span>
            <button pButton label="Créer l'analyse" icon="pi pi-plus" class="p-button-success"
                (click)="createOrUpdateAnalyse()" [loading]="loading()"></button>
        </div>
    </div>

    <!-- Message quand l'analyse existe -->
    <div class="mb-4" *ngIf="state().analyseExiste">
        <div class="p-3 bg-green-50 border-round border-1 border-green-200 flex align-items-center">
            <i class="pi pi-check-circle text-green-600 mr-2"></i>
            <span class="text-green-700">Analyse financière #{{state().analyseId}} en cours d'édition</span>
        </div>
    </div>

    <!-- Stepper -->
    <p-steps [model]="items()" [activeIndex]="activeIndex()" [readonly]="false" styleClass="mb-5"></p-steps>

    <div class="p-fluid">
        <!-- ==================== ETAPE 0: COLLECTE ==================== -->
        <div *ngIf="activeIndex() === 0">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="flex align-items-center justify-content-between p-3 bg-primary text-white">
                        <h2 class="m-0 text-xl font-bold">COLLECTE DES DONNEES</h2>
                        <div class="flex align-items-center gap-2">
                            <p-tag *ngIf="collecte()" [value]="(collecte()?.pourcentageCompletion || 0) + '%'"
                                severity="info"></p-tag>
                            <span class="text-sm">en GNF</span>
                        </div>
                    </div>
                </ng-template>

                <!-- Bouton creer collecte -->
                <div class="mb-4" *ngIf="!collecteSaved()">
                    <div
                        class="p-3 bg-yellow-50 border-round border-1 border-yellow-200 flex align-items-center justify-content-between">
                        <span><i class="pi pi-info-circle mr-2"></i>Aucune collecte n'existe pour cette demande.</span>
                        <button pButton label="Creer la Collecte" icon="pi pi-plus" class="p-button-success"
                            (click)="createCollecte()" [loading]="savingCollecte()"></button>
                    </div>
                </div>

                <div *ngIf="collecteSaved()">
                    <!-- En-tete collecte -->
                    <div [formGroup]="collecteHeaderForm" class="mb-4 p-3 border-round surface-ground grid">
                        <div class="col-12 md:col-4">
                            <label class="block text-sm font-medium mb-1">Date d'evaluation</label>
                            <p-datePicker formControlName="dateEvaluation" dateFormat="dd/mm/yy"
                                class="w-full"></p-datePicker>
                        </div>
                        <div class="col-12 md:col-4">
                            <label class="block text-sm font-medium mb-1">Nom du membre</label>
                            <input type="text" pInputText [value]="state().demandeIndividuel?.nomMembre || ''"
                                class="w-full" readonly />
                        </div>
                        <div class="col-12 md:col-4">
                            <label class="block text-sm font-medium mb-1">N. membre</label>
                            <input type="text" pInputText [value]="state().demandeIndividuel?.numeroMembre || ''"
                                class="w-full" readonly />
                        </div>
                    </div>

                    <p-accordion [multiple]="true">

                        <!-- ===== SECTION 1: ACTIVITE (depuis la demande) ===== -->
                        <p-accordion-panel value="0">
                        <p-accordion-header>Section 1 - Activite</p-accordion-header>
                        <p-accordion-content>
                            <!-- Cas Particulier -->
                            <div *ngIf="isParticulier()" class="overflow-x-auto">
                                <table class="w-full text-sm border-collapse">
                                    <thead>
                                        <tr class="surface-ground">
                                            <th class="p-2 border-1 surface-border text-left font-medium">Description de
                                                l'activite</th>
                                            <th class="p-2 border-1 surface-border text-left font-medium">Secteur
                                                d'activite</th>
                                            <th class="p-2 border-1 surface-border text-left font-medium">Profession
                                            </th>
                                            <th class="p-2 border-1 surface-border text-left font-medium">Nbre annees
                                                activite</th>
                                            <th class="p-2 border-1 surface-border text-left font-medium">Adresse lieu
                                                d'activite</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="p-2 border-1 surface-border font-semibold">{{
                                                state().demandeIndividuel?.descriptionActivite ||
                                                state().demandeIndividuel?.currentActivite || '-' }}</td>
                                            <td class="p-2 border-1 surface-border font-semibold">{{
                                                state().demandeIndividuel?.secteurActivite ||
                                                state().demandeIndividuel?.typeActivite || '-' }}</td>
                                            <td class="p-2 border-1 surface-border font-semibold">{{
                                                state().demandeIndividuel?.profession || '-' }}</td>
                                            <td class="p-2 border-1 surface-border font-semibold text-center">{{
                                                state().demandeIndividuel?.nombreAnneeActivite || '-' }} ans</td>
                                            <td class="p-2 border-1 surface-border font-semibold">{{
                                                state().demandeIndividuel?.adresseLieuActivite || '-' }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Cas Professionnel / PME/PMI -->
                            <div *ngIf="!isParticulier()" class="overflow-x-auto">
                                <table class="w-full text-sm border-collapse">
                                    <thead>
                                        <tr class="surface-ground">
                                            <th class="p-2 border-1 surface-border text-left font-medium">Secteur
                                                d'activite</th>
                                            <th class="p-2 border-1 surface-border text-left font-medium">Sous-secteur
                                                d'activite</th>
                                            <th class="p-2 border-1 surface-border text-left font-medium">
                                                Sous-sous-secteur</th>
                                            <th class="p-2 border-1 surface-border text-left font-medium">Nbre annees
                                                activite</th>
                                            <th class="p-2 border-1 surface-border text-left font-medium">Adresse lieu
                                                d'activite</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="p-2 border-1 surface-border font-semibold">{{ getActiviteLabel()
                                                }}</td>
                                            <td class="p-2 border-1 surface-border font-semibold">{{
                                                getSousActiviteLabel() }}</td>
                                            <td class="p-2 border-1 surface-border font-semibold">{{
                                                getSousSousActiviteLabel() }}</td>
                                            <td class="p-2 border-1 surface-border font-semibold text-center">{{
                                                state().demandeIndividuel?.nombreAnneeActivite || '-' }} ans</td>
                                            <td class="p-2 border-1 surface-border font-semibold">{{
                                                state().demandeIndividuel?.adresseLieuActivite || '-' }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="grid align-items-center py-2 px-3 mt-2 surface-ground border-round">
                                    <div class="col-3 text-sm font-medium">Description de l'activite</div>
                                    <div class="col-9 font-semibold">{{ state().demandeIndividuel?.descriptionActivite
                                        || state().demandeIndividuel?.currentActivite || '-' }}</div>
                                </div>
                            </div>
                        </p-accordion-content>
                        </p-accordion-panel>

                        <!-- ===== SECTION 2: CONDITIONS DE CREDIT ===== -->
                        <p-accordion-panel value="1">
                        <p-accordion-header>Section 2 - Conditions de credit sollicite</p-accordion-header>
                        <p-accordion-content>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm border-collapse">
                                    <thead>
                                        <tr class="surface-ground">
                                            <th class="p-2 border-1 surface-border text-left font-medium">Objet du
                                                credit</th>
                                            <th class="p-2 border-1 surface-border text-left font-medium">Montant
                                                sollicite</th>
                                            <th class="p-2 border-1 surface-border text-left font-medium">Duree</th>
                                            <th class="p-2 border-1 surface-border text-left font-medium">Periodicite
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="p-2 border-1 surface-border font-bold bg-yellow-50">{{
                                                state().demandeIndividuel?.objectCredit ||
                                                state().demandeIndividuel?.objetCredit || '-' }}</td>
                                            <td class="p-2 border-1 surface-border font-bold bg-yellow-50">{{
                                                (state().demandeIndividuel?.montantDemande || 0) |
                                                currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</td>
                                            <td class="p-2 border-1 surface-border text-center">{{
                                                state().demandeIndividuel?.dureeDemande ||
                                                state().demandeIndividuel?.dureeMois || '-' }} mois</td>
                                            <td class="p-2 border-1 surface-border">{{
                                                state().demandeIndividuel?.periodiciteRemboursement ||
                                                state().demandeIndividuel?.periodicite || '-' }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="overflow-x-auto mt-2">
                                <table class="w-full text-sm border-collapse">
                                    <thead>
                                        <tr class="surface-ground">
                                            <th class="p-2 border-1 surface-border text-left font-medium">Periode de
                                                differe</th>
                                            <th class="p-2 border-1 surface-border text-left font-medium">Nbre echeances
                                            </th>
                                            <th class="p-2 border-1 surface-border text-left font-medium">Echeance
                                                correspondante</th>
                                            <th class="p-2 border-1 surface-border text-left font-medium">Valeur
                                                garantie proposee</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="p-2 border-1 surface-border text-center">{{
                                                state().demandeIndividuel?.periodeDiffere || 0 }} mois</td>
                                            <td class="p-2 border-1 surface-border text-center">{{
                                                state().demandeIndividuel?.nombreEcheance ||
                                                state().demandeIndividuel?.nombreEcheances || '-' }}</td>
                                            <td class="p-2 border-1 surface-border font-bold bg-yellow-50">{{
                                                (state().demandeIndividuel?.echeance || 0) |
                                                currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</td>
                                            <td class="p-2 border-1 surface-border font-bold bg-yellow-50">{{
                                                (getTotalEmprunte()) | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div [formGroup]="section2Form"
                                class="grid align-items-center py-2 px-3 mt-3 surface-ground border-round">
                                <div class="col-6 text-sm font-medium">Capacite de remboursement periodique declaree
                                </div>
                                <div class="col-6">
                                    <p-inputNumber formControlName="capaciteRemboursementDeclaree" mode="decimal"
                                        [useGrouping]="true" class="w-full"
                                        placeholder="Saisir le montant"></p-inputNumber>
                                </div>
                            </div>
                            <div class="flex justify-content-end mt-3">
                                <button pButton label="Enregistrer Section 2" icon="pi pi-save"
                                    (click)="saveCollecteSection(2)" [loading]="savingCollecte()"></button>
                            </div>
                        </p-accordion-content>
                        </p-accordion-panel>

                        <!-- ===== SECTION 3: CHIFFRE D'AFFAIRES ===== -->
                        <p-accordion-panel value="2">
                        <p-accordion-header>Section 3 - Quel Chiffre d'Affaires?</p-accordion-header>
                        <p-accordion-content>
                            <form [formGroup]="section3Form">
                                <!-- Estimation initiale -->
                                <div class="surface-ground border-round p-3 mb-4">
                                    <h4 class="mt-0 mb-3 text-sm font-semibold">Estimation initiale du Chiffre
                                        d'affaires</h4>
                                    <div class="grid">
                                        <div class="col-12 md:col-6">
                                            <label class="block text-sm mb-1">CA hebdomadaire</label>
                                            <p-inputNumber formControlName="caHebdomadaireDeclare" mode="decimal"
                                                [useGrouping]="true" class="w-full"></p-inputNumber>
                                        </div>
                                        <div class="col-12 md:col-6">
                                            <label class="block text-sm mb-1">CA mensuel</label>
                                            <p-inputNumber formControlName="caMensuelDeclare" mode="decimal"
                                                [useGrouping]="true" class="w-full"></p-inputNumber>
                                        </div>
                                    </div>
                                </div>

                                <!-- Cycle mensuel -->
                                <div class="mb-4">
                                    <h4 class="text-sm font-semibold mb-2">Cycle d'affaires mensuel</h4>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm border-collapse">
                                            <thead>
                                                <tr class="surface-ground">
                                                    <th class="p-2 border-1 surface-border text-left"
                                                        style="width:70px">Cycle</th>
                                                    <th *ngFor="let m of months"
                                                        class="p-2 border-1 surface-border text-center font-medium">{{ m
                                                        }}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr *ngFor="let level of cycleLevels">
                                                    <td class="p-2 border-1 surface-border font-medium"
                                                        [ngClass]="{'text-green-600': level === 'Fort', 'text-blue-600': level === 'Moyen', 'text-orange-600': level === 'Faible'}">
                                                        {{ level }}</td>
                                                    <td *ngFor="let m of months"
                                                        class="p-1 border-1 surface-border text-center">
                                                        <button type="button" pButton [ngClass]="getCycleLevel('month', m) === level
                                                                ? (level === 'Fort' ? 'p-button-success' : level === 'Faible' ? 'p-button-warning' : 'p-button-info')
                                                                : 'p-button-secondary p-button-outlined'"
                                                            class="p-button-sm p-button-rounded"
                                                            style="width:2rem;height:2rem;padding:0"
                                                            [label]="getCycleLevel('month', m) === level ? '✓' : ''"
                                                            (click)="toggleCycleCell('month', m, level)">
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Cycle hebdomadaire -->
                                <div class="mb-4">
                                    <h4 class="text-sm font-semibold mb-2">Structure du CA Hebdomadaire</h4>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm border-collapse">
                                            <thead>
                                                <tr class="surface-ground">
                                                    <th class="p-2 border-1 surface-border text-left"
                                                        style="width:70px">Cycle</th>
                                                    <th *ngFor="let d of days"
                                                        class="p-2 border-1 surface-border text-center font-medium">{{ d
                                                        }}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr *ngFor="let level of cycleLevels">
                                                    <td class="p-2 border-1 surface-border font-medium"
                                                        [ngClass]="{'text-green-600': level === 'Fort', 'text-blue-600': level === 'Moyen', 'text-orange-600': level === 'Faible'}">
                                                        {{ level }}</td>
                                                    <td *ngFor="let d of days"
                                                        class="p-1 border-1 surface-border text-center">
                                                        <button type="button" pButton [ngClass]="getCycleLevel('week', d) === level
                                                                ? (level === 'Fort' ? 'p-button-success' : level === 'Faible' ? 'p-button-warning' : 'p-button-info')
                                                                : 'p-button-secondary p-button-outlined'"
                                                            class="p-button-sm p-button-rounded"
                                                            style="width:2rem;height:2rem;padding:0"
                                                            [label]="getCycleLevel('week', d) === level ? '✓' : ''"
                                                            (click)="toggleCycleCell('week', d, level)">
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- CA jour fort/moyen/faible -->
                                <div class="grid mb-3">
                                    <div class="col-12 md:col-4">
                                        <label class="block text-sm mb-1">CA jour fort</label>
                                        <p-inputNumber formControlName="caJourFort" mode="decimal" [useGrouping]="true"
                                            class="w-full"></p-inputNumber>
                                    </div>
                                    <div class="col-12 md:col-4">
                                        <label class="block text-sm mb-1">CA jour moyen</label>
                                        <p-inputNumber formControlName="caJourMoyen" mode="decimal" [useGrouping]="true"
                                            class="w-full"></p-inputNumber>
                                    </div>
                                    <div class="col-12 md:col-4">
                                        <label class="block text-sm mb-1">CA jour faible</label>
                                        <p-inputNumber formControlName="caJourFaible" mode="decimal"
                                            [useGrouping]="true" class="w-full"></p-inputNumber>
                                    </div>
                                </div>

                                <div class="flex justify-content-end mt-3">
                                    <button pButton label="Enregistrer Section 3" icon="pi pi-save"
                                        (click)="saveCollecteSection(3)" [loading]="savingCollecte()"></button>
                                </div>
                            </form>
                        </p-accordion-content>
                        </p-accordion-panel>

                        <!-- ===== SECTION 4: MARGE BRUTE ===== -->
                        <p-accordion-panel value="3">
                        <p-accordion-header>Section 4 - Structure de la marge brute</p-accordion-header>
                        <p-accordion-content>
                            <form [formGroup]="section4Form">
                                <div
                                    class="grid align-items-center py-2 px-3 border-bottom-1 surface-border hover:surface-hover">
                                    <div class="col-6 text-sm">Connaissez-vous votre pourcentage de marge brute ?</div>
                                    <div class="col-6 flex align-items-center gap-2">
                                        <p-select formControlName="connaitTauxMarge" [options]="ouiNonOptions"
                                            optionLabel="label" optionValue="value" class="w-8rem"></p-select>
                                        <p-inputNumber *ngIf="section4Form.get('connaitTauxMarge')?.value"
                                            formControlName="tauxMargeDeclare" mode="decimal" suffix="%"
                                            class="w-8rem"></p-inputNumber>
                                    </div>
                                </div>
                                <div
                                    class="grid align-items-center py-2 px-3 border-bottom-1 surface-border hover:surface-hover">
                                    <div class="col-6 text-sm">Procedez au calcul du taux marge brute ?</div>
                                    <div class="col-6">
                                        <p-select formControlName="calculerTauxMarge" [options]="ouiNonOptions"
                                            optionLabel="label" optionValue="value" class="w-8rem"></p-select>
                                    </div>
                                </div>
                            </form>

                            <ng-container *ngIf="section4Form.get('calculerTauxMarge')?.value">
                                <div [formGroup]="section4Form"
                                    class="grid align-items-center py-2 px-3 border-bottom-1 surface-border hover:surface-hover">
                                    <div class="col-6 text-sm">Quelle est la frequence des ventes ?</div>
                                    <div class="col-6">
                                        <p-select formControlName="frequenceVentes" [options]="frequenceVentesOptions"
                                            optionLabel="label" optionValue="value" placeholder="Selectionner..."
                                            class="w-full"></p-select>
                                    </div>
                                </div>

                                <!-- Produits table -->
                                <div class="mt-4">
                                    <div class="flex align-items-center justify-content-between mb-2">
                                        <h4 class="m-0 text-sm font-semibold">Produits ou Articles</h4>
                                        <button pButton icon="pi pi-plus" label="Ajouter un produit"
                                            class="p-button-sm p-button-success" (click)="addProduit()"></button>
                                    </div>
                                    <p-table [value]="produits()" *ngIf="produits().length > 0"
                                        styleClass="p-datatable-sm">
                                        <ng-template pTemplate="header">
                                            <tr>
                                                <th style="width:40px">#</th>
                                                <th>Produit</th>
                                                <th>Prix de vente (GNF)</th>
                                                <th>Cout d'achat (GNF)</th>
                                                <th>Quantite</th>
                                                <th class="text-right">CA (GNF)</th>
                                                <th class="text-right">Cout total</th>
                                                <th style="width:40px"></th>
                                            </tr>
                                        </ng-template>
                                        <ng-template pTemplate="body" let-produit let-rowIndex="rowIndex">
                                            <tr>
                                                <td>{{ rowIndex + 1 }}</td>
                                                <td><input type="text" pInputText [(ngModel)]="produit.nomProduit"
                                                        [ngModelOptions]="{standalone: true}" class="w-full p-1" /></td>
                                                <td><p-inputNumber [(ngModel)]="produit.prixVente"
                                                        [ngModelOptions]="{standalone: true}" mode="decimal"
                                                        [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                                </td>
                                                <td><p-inputNumber [(ngModel)]="produit.coutAchat"
                                                        [ngModelOptions]="{standalone: true}" mode="decimal"
                                                        [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                                </td>
                                                <td><p-inputNumber [(ngModel)]="produit.quantite"
                                                        [ngModelOptions]="{standalone: true}"
                                                        class="w-full input-sm"></p-inputNumber></td>
                                                <td class="text-right font-mono bg-green-50">{{ (produit.prixVente || 0)
                                                    * (produit.quantite || 0) | currency:'GNF':'symbol':'1.0-0':'fr-FR'
                                                    }}</td>
                                                <td class="text-right font-mono bg-green-50">{{ (produit.coutAchat || 0)
                                                    * (produit.quantite || 0) | currency:'GNF':'symbol':'1.0-0':'fr-FR'
                                                    }}</td>
                                                <td><button pButton icon="pi pi-trash"
                                                        class="p-button-rounded p-button-danger p-button-text p-button-sm"
                                                        (click)="removeProduit(rowIndex)"></button></td>
                                            </tr>
                                        </ng-template>
                                    </p-table>
                                </div>

                                <!-- Totaux marge -->
                                <div class="grid mt-3 p-3 surface-ground border-round">
                                    <div class="col-4 text-center">
                                        <div class="text-sm text-500">Total Ventes</div>
                                        <div class="text-xl font-bold">{{ totalProduitsVentes() |
                                            currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</div>
                                    </div>
                                    <div class="col-4 text-center">
                                        <div class="text-sm text-500">Total Couts</div>
                                        <div class="text-xl font-bold">{{ totalProduitsCouts() |
                                            currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</div>
                                    </div>
                                    <div class="col-4 text-center">
                                        <div class="text-sm text-500">Taux de Marge</div>
                                        <div class="text-xl font-bold text-green-600">{{ tauxMargeCalcule() |
                                            number:'1.2-2' }}%</div>
                                    </div>
                                </div>
                            </ng-container>

                            <div class="flex justify-content-end mt-3">
                                <button pButton label="Enregistrer Section 4" icon="pi pi-save"
                                    (click)="saveCollecteSection(4)" [loading]="savingCollecte()"></button>
                            </div>
                        </p-accordion-content>
                        </p-accordion-panel>

                        <!-- ===== SECTION 5: ACTIFS / PASSIFS ===== -->
                        <p-accordion-panel value="4">
                        <p-accordion-header>Section 5 - Evaluation des actifs nets de l'entreprise</p-accordion-header>
                        <p-accordion-content>
                            <form [formGroup]="section5Form">
                                <!-- a) Terrains -->
                                <div
                                    class="grid align-items-center py-2 px-3 border-bottom-1 surface-border hover:surface-hover">
                                    <div class="col-6 text-sm">a) Existe-t-il des terrains utilises pour l'activite ?
                                    </div>
                                    <div class="col-6">
                                        <p-select formControlName="terrainExiste" [options]="ouiNonOptions"
                                            optionLabel="label" optionValue="value" class="w-8rem"></p-select>
                                    </div>
                                </div>
                                <div *ngIf="section5Form.get('terrainExiste')?.value"
                                    class="flex align-items-center gap-3 pl-5 py-2 surface-ground border-round mx-3 mb-2">
                                    <span class="text-sm text-600">Valeur estimee</span>
                                    <p-inputNumber formControlName="terrainValeur" mode="decimal" [useGrouping]="true"
                                        class="w-12rem"></p-inputNumber>
                                </div>

                                <!-- b) Batiments -->
                                <div
                                    class="grid align-items-center py-2 px-3 border-bottom-1 surface-border hover:surface-hover">
                                    <div class="col-5 text-sm">b) Existe-t-il des batiments et magasin dedies a
                                        l'activite ?</div>
                                    <div class="col-7 flex align-items-center gap-2">
                                        <p-select formControlName="batimentExiste" [options]="ouiNonOptions"
                                            optionLabel="label" optionValue="value" class="w-8rem"></p-select>
                                        <ng-container *ngIf="section5Form.get('batimentExiste')?.value">
                                            <span class="text-sm text-500">Est-ce votre propriete ?</span>
                                            <p-select formControlName="batimentPropriete" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-8rem"></p-select>
                                        </ng-container>
                                    </div>
                                </div>
                                <div *ngIf="section5Form.get('batimentExiste')?.value && section5Form.get('batimentPropriete')?.value"
                                    class="mx-3 mb-2 p-2 bg-blue-50 border-round text-sm text-blue-700 flex align-items-center gap-2">
                                    <i class="pi pi-file-edit"></i> Referez-vous a la feuille Amorts pour les details
                                </div>

                                <!-- c) Installations -->
                                <div
                                    class="grid align-items-center py-2 px-3 border-bottom-1 surface-border hover:surface-hover">
                                    <div class="col-5 text-sm">c) Existe-t-il des installations dediees a l'activite ?
                                    </div>
                                    <div class="col-7 flex align-items-center gap-2">
                                        <p-select formControlName="installationExiste" [options]="ouiNonOptions"
                                            optionLabel="label" optionValue="value" class="w-8rem"></p-select>
                                        <ng-container *ngIf="section5Form.get('installationExiste')?.value">
                                            <span class="text-sm text-500">Est-ce votre propriete ?</span>
                                            <p-select formControlName="installationPropriete" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-8rem"></p-select>
                                        </ng-container>
                                    </div>
                                </div>

                                <!-- d) Materiels roulants -->
                                <div
                                    class="grid align-items-center py-2 px-3 border-bottom-1 surface-border hover:surface-hover">
                                    <div class="col-5 text-sm">d) Existe-t-il des materiels roulants dedies a l'activite
                                        ?</div>
                                    <div class="col-7 flex align-items-center gap-2">
                                        <p-select formControlName="materielRoulantExiste" [options]="ouiNonOptions"
                                            optionLabel="label" optionValue="value" class="w-8rem"></p-select>
                                        <ng-container *ngIf="section5Form.get('materielRoulantExiste')?.value">
                                            <span class="text-sm text-500">Est-ce votre propriete ?</span>
                                            <p-select formControlName="materielRoulantPropriete"
                                                [options]="ouiNonOptions" optionLabel="label" optionValue="value"
                                                class="w-8rem"></p-select>
                                        </ng-container>
                                    </div>
                                </div>

                                <!-- e) Mobiliers -->
                                <div
                                    class="grid align-items-center py-2 px-3 border-bottom-1 surface-border hover:surface-hover">
                                    <div class="col-5 text-sm">e) Existe-t-il des mobiliers et materiels de bureau ?
                                    </div>
                                    <div class="col-7 flex align-items-center gap-2">
                                        <p-select formControlName="mobilierExiste" [options]="ouiNonOptions"
                                            optionLabel="label" optionValue="value" class="w-8rem"></p-select>
                                        <ng-container *ngIf="section5Form.get('mobilierExiste')?.value">
                                            <span class="text-sm text-500">Propriete ?</span>
                                            <p-select formControlName="mobilierPropriete" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-8rem"></p-select>
                                        </ng-container>
                                    </div>
                                </div>

                                <!-- f) Machines -->
                                <div
                                    class="grid align-items-center py-2 px-3 border-bottom-1 surface-border hover:surface-hover">
                                    <div class="col-5 text-sm">f) Existent-ils des machines et equipements de production
                                        ?</div>
                                    <div class="col-7 flex align-items-center gap-2">
                                        <p-select formControlName="machineExiste" [options]="ouiNonOptions"
                                            optionLabel="label" optionValue="value" class="w-8rem"></p-select>
                                        <ng-container *ngIf="section5Form.get('machineExiste')?.value">
                                            <span class="text-sm text-500">Propriete ?</span>
                                            <p-select formControlName="machinePropriete" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-8rem"></p-select>
                                        </ng-container>
                                    </div>
                                </div>

                                <!-- g) Caution financiere + h) Prets employes -->
                                <div class="grid">
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">g) Caution financiere/depot financier ?</span>
                                            <p-select formControlName="cautionFinanciereExiste"
                                                [options]="ouiNonOptions" optionLabel="label" optionValue="value"
                                                class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section5Form.get('cautionFinanciereExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Evalue a</span>
                                            <p-inputNumber formControlName="cautionFinanciereValeur" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">h) Prets faits a vos employes ?</span>
                                            <p-select formControlName="pretEmployeExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section5Form.get('pretEmployeExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Evalue a</span>
                                            <p-inputNumber formControlName="pretEmployeValeur" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                </div>

                                <!-- i) Stock -->
                                <div
                                    class="grid align-items-center py-2 px-3 border-bottom-1 surface-border hover:surface-hover">
                                    <div class="col-5 text-sm">i) Avez-vous un stock de marchandises a vendre ?</div>
                                    <div class="col-7 flex align-items-center gap-2">
                                        <p-select formControlName="stockExiste" [options]="ouiNonOptions"
                                            optionLabel="label" optionValue="value" class="w-8rem"></p-select>
                                        <ng-container *ngIf="section5Form.get('stockExiste')?.value">
                                            <span class="text-sm text-500">Avez-vous une idee de sa valeur ?</span>
                                            <p-select formControlName="stockConnaitValeur" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-8rem"></p-select>
                                        </ng-container>
                                    </div>
                                </div>
                                <div *ngIf="section5Form.get('stockExiste')?.value && section5Form.get('stockConnaitValeur')?.value"
                                    class="flex align-items-center gap-3 pl-5 py-2 surface-ground border-round mx-3 mb-2">
                                    <span class="text-sm text-600">Valeur estimee</span>
                                    <p-inputNumber formControlName="stockValeurEstimee" mode="decimal"
                                        [useGrouping]="true" class="w-12rem"></p-inputNumber>
                                </div>

                                <!-- Evaluation detaillee du stock -->
                                <ng-container *ngIf="section5Form.get('stockExiste')?.value">
                                    <div
                                        class="grid align-items-center py-2 px-3 border-bottom-1 surface-border hover:surface-hover">
                                        <div class="col-6 text-sm">Faire l'evaluation du stock disponible ?</div>
                                        <div class="col-6"><p-select formControlName="stockEvaluerDetail"
                                                [options]="ouiNonOptions" optionLabel="label" optionValue="value"
                                                class="w-8rem"></p-select></div>
                                    </div>
                                    <div *ngIf="section5Form.get('stockEvaluerDetail')?.value" class="mx-3 mb-3">
                                        <div class="flex align-items-center justify-content-between mb-2">
                                            <h4 class="m-0 text-sm font-semibold">Evaluation du stock disponible</h4>
                                            <button pButton icon="pi pi-plus" label="Ajouter un article"
                                                class="p-button-sm p-button-success"
                                                (click)="addStockArticle()"></button>
                                        </div>
                                        <p-table [value]="stockArticles()" *ngIf="stockArticles().length > 0"
                                            styleClass="p-datatable-sm">
                                            <ng-template pTemplate="header">
                                                <tr>
                                                    <th style="width:40px">#</th>
                                                    <th>Produit/Article</th>
                                                    <th>Quantite</th>
                                                    <th>Cout d'achat</th>
                                                    <th class="text-right">Valeur Stock</th>
                                                    <th style="width:40px"></th>
                                                </tr>
                                            </ng-template>
                                            <ng-template pTemplate="body" let-article let-rowIndex="rowIndex">
                                                <tr>
                                                    <td>{{ rowIndex + 1 }}</td>
                                                    <td><input type="text" pInputText [(ngModel)]="article.nomArticle"
                                                            [ngModelOptions]="{standalone: true}" class="w-full p-1" />
                                                    </td>
                                                    <td><p-inputNumber [(ngModel)]="article.quantite"
                                                            [ngModelOptions]="{standalone: true}"
                                                            class="w-full input-sm"></p-inputNumber></td>
                                                    <td><p-inputNumber [(ngModel)]="article.coutUnitaire"
                                                            [ngModelOptions]="{standalone: true}" mode="decimal"
                                                            [useGrouping]="true"
                                                            class="w-full input-sm"></p-inputNumber></td>
                                                    <td class="text-right font-mono bg-green-50">{{ (article.quantite ||
                                                        0) * (article.coutUnitaire || 0) |
                                                        currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</td>
                                                    <td><button pButton icon="pi pi-trash"
                                                            class="p-button-rounded p-button-danger p-button-text p-button-sm"
                                                            (click)="removeStockArticle(rowIndex)"></button></td>
                                                </tr>
                                            </ng-template>
                                        </p-table>
                                        <div
                                            class="mt-2 p-3 surface-ground border-round flex justify-content-between align-items-center">
                                            <span class="font-medium text-green-700">TOTAL Stock</span>
                                            <span class="text-xl font-bold text-green-700">{{ totalStockArticles() |
                                                currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</span>
                                        </div>
                                    </div>
                                </ng-container>

                                <!-- j) Credit fournisseur + k) Creances clients -->
                                <div class="grid">
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">j) Credits fournisseurs ?</span>
                                            <p-select formControlName="creditFournisseurExiste"
                                                [options]="ouiNonOptions" optionLabel="label" optionValue="value"
                                                class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section5Form.get('creditFournisseurExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Evalue a</span>
                                            <p-inputNumber formControlName="creditFournisseurValeur" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">k) Clients qui vous doivent ?</span>
                                            <p-select formControlName="creanceClientExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section5Form.get('creanceClientExiste')?.value" class="mx-1 mb-1">
                                            <div
                                                class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mb-1">
                                                <span class="text-xs text-600">Creances &gt; 3 mois</span>
                                                <p-inputNumber formControlName="creancePlus3Mois" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                            <div
                                                class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round">
                                                <span class="text-xs text-600">Creances &lt; 3 mois</span>
                                                <p-inputNumber formControlName="creanceMoins3Mois" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tresorerie -->
                                <div class="mt-4 pt-3 border-top-1 surface-border">
                                    <h4 class="text-sm font-semibold mb-3">Tresorerie</h4>

                                    <div class="grid">
                                        <!-- l) Cash + m) Compte CRG -->
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">l) Argent cash quelque part ?</span>
                                                <p-select formControlName="cashExiste" [options]="ouiNonOptions"
                                                    optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                            </div>
                                            <div *ngIf="section5Form.get('cashExiste')?.value"
                                                class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                                <span class="text-xs text-600">Montant</span>
                                                <p-inputNumber formControlName="cashValeur" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">m) Argent dans un compte CRG ?</span>
                                                <p-select formControlName="compteCrgExiste" [options]="ouiNonOptions"
                                                    optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                            </div>
                                            <div *ngIf="section5Form.get('compteCrgExiste')?.value"
                                                class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                                <span class="text-xs text-600">Montant</span>
                                                <p-inputNumber formControlName="compteCrgValeur" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <!-- n) Tontinier + o) Banque/Mobile money -->
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">n) Argent aupres d'un tontinier ?</span>
                                                <p-select formControlName="tontinierExiste" [options]="ouiNonOptions"
                                                    optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                            </div>
                                            <div *ngIf="section5Form.get('tontinierExiste')?.value"
                                                class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                                <span class="text-xs text-600">Montant</span>
                                                <p-inputNumber formControlName="tontinierValeur" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">o) Argent en banque/mobile money ?</span>
                                                <p-select formControlName="compteBanqueExiste" [options]="ouiNonOptions"
                                                    optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                            </div>
                                            <div *ngIf="section5Form.get('compteBanqueExiste')?.value"
                                                class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                                <span class="text-xs text-600">Montant</span>
                                                <p-inputNumber formControlName="compteBanqueValeur" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dettes (Passif) -->
                                <div class="mt-4 pt-3 border-top-1 surface-border">
                                    <h4 class="text-sm font-semibold mb-3">Dettes et Engagements</h4>

                                    <div class="grid">
                                        <!-- p) Emprunt IMF + q) Emprunt bancaire LT -->
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">p) Dette institution microfinance ?</span>
                                                <p-select formControlName="empruntImfExiste" [options]="ouiNonOptions"
                                                    optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                            </div>
                                            <div *ngIf="section5Form.get('empruntImfExiste')?.value"
                                                class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                                <span class="text-xs text-600">Montant</span>
                                                <p-inputNumber formControlName="empruntImfValeur" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">q) Emprunt bancaire a + d'1 an ?</span>
                                                <p-select formControlName="empruntBancaireLtExiste"
                                                    [options]="ouiNonOptions" optionLabel="label" optionValue="value"
                                                    class="w-7rem"></p-select>
                                            </div>
                                            <div *ngIf="section5Form.get('empruntBancaireLtExiste')?.value"
                                                class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                                <span class="text-xs text-600">Montant</span>
                                                <p-inputNumber formControlName="empruntBancaireLtValeur" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <!-- r) Emprunt bancaire CT + s) Avances clients -->
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">r) Emprunt bancaire a - d'1 an ?</span>
                                                <p-select formControlName="empruntBancaireCtExiste"
                                                    [options]="ouiNonOptions" optionLabel="label" optionValue="value"
                                                    class="w-7rem"></p-select>
                                            </div>
                                            <div *ngIf="section5Form.get('empruntBancaireCtExiste')?.value"
                                                class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                                <span class="text-xs text-600">Montant</span>
                                                <p-inputNumber formControlName="empruntBancaireCtValeur" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">s) Avances recues de clients ?</span>
                                                <p-select formControlName="avanceClientExiste" [options]="ouiNonOptions"
                                                    optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                            </div>
                                            <div *ngIf="section5Form.get('avanceClientExiste')?.value"
                                                class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                                <span class="text-xs text-600">Montant</span>
                                                <p-inputNumber formControlName="avanceClientValeur" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <!-- t) Dettes fournisseurs + u) Impots non payes -->
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">t) Dette envers fournisseurs ?</span>
                                                <p-select formControlName="detteFournisseurExiste"
                                                    [options]="ouiNonOptions" optionLabel="label" optionValue="value"
                                                    class="w-7rem"></p-select>
                                            </div>
                                            <div *ngIf="section5Form.get('detteFournisseurExiste')?.value"
                                                class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                                <span class="text-xs text-600">Montant</span>
                                                <p-inputNumber formControlName="detteFournisseurValeur" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">u) Imposition non encore reglee ?</span>
                                                <p-select formControlName="impotNonPayeExiste" [options]="ouiNonOptions"
                                                    optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                            </div>
                                            <div *ngIf="section5Form.get('impotNonPayeExiste')?.value"
                                                class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                                <span class="text-xs text-600">Montant</span>
                                                <p-inputNumber formControlName="impotNonPayeValeur" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <!-- v) Loyers non payes + w) Factures non payees -->
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">v) Loyers non encore payes ?</span>
                                                <p-select formControlName="loyerNonPayeExiste" [options]="ouiNonOptions"
                                                    optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                            </div>
                                            <div *ngIf="section5Form.get('loyerNonPayeExiste')?.value"
                                                class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                                <span class="text-xs text-600">Montant</span>
                                                <p-inputNumber formControlName="loyerNonPayeValeur" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">w) Factures electricite non payees ?</span>
                                                <p-select formControlName="factureNonPayeeExiste"
                                                    [options]="ouiNonOptions" optionLabel="label" optionValue="value"
                                                    class="w-7rem"></p-select>
                                            </div>
                                            <div *ngIf="section5Form.get('factureNonPayeeExiste')?.value"
                                                class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                                <span class="text-xs text-600">Montant</span>
                                                <p-inputNumber formControlName="factureNonPayeeValeur" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <!-- x) Tontine dette + y) Autres dettes -->
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">x) Tontine (tour deja passe) ?</span>
                                                <p-select formControlName="tontineDetteExiste" [options]="ouiNonOptions"
                                                    optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                            </div>
                                            <div *ngIf="section5Form.get('tontineDetteExiste')?.value"
                                                class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                                <span class="text-xs text-600">Montant restant</span>
                                                <p-inputNumber formControlName="tontineDetteValeur" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">y) Dette quelconque a regler ?</span>
                                                <p-select formControlName="autreDetteExiste" [options]="ouiNonOptions"
                                                    optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                            </div>
                                            <div *ngIf="section5Form.get('autreDetteExiste')?.value"
                                                class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                                <span class="text-xs text-600">Montant</span>
                                                <p-inputNumber formControlName="autreDetteValeur" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <div class="flex justify-content-end mt-3">
                                <button pButton label="Enregistrer Section 5" icon="pi pi-save"
                                    (click)="saveCollecteSection(5)" [loading]="savingCollecte()"></button>
                            </div>
                        </p-accordion-content>
                        </p-accordion-panel>

                        <!-- ===== SECTION 6: CHARGES MENSUELLES DE L'ENTREPRISE ===== -->
                        <p-accordion-panel value="5">
                        <p-accordion-header>Section 6 - Evaluation des charges mensuelles de l'entreprise</p-accordion-header>
                        <p-accordion-content>
                            <form [formGroup]="section6Form">
                                <div class="grid">
                                    <!-- a) Loyer + b) Salaires -->
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">a) Loyer magasins et boutiques</span>
                                            <p-select formControlName="loyerExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('loyerExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="loyerMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">b) Salaire des employes</span>
                                            <p-select formControlName="salaireExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('salaireExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="salaireMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <!-- c) Fournitures + d) Publicite -->
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">c) Achat de fournitures de bureau</span>
                                            <p-select formControlName="fournitureExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('fournitureExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="fournitureMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">d) Frais publicite et promotion</span>
                                            <p-select formControlName="publiciteExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('publiciteExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="publiciteMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <!-- e) Telephone + f) Electricite -->
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">e) Frais Telephone / Internet</span>
                                            <p-select formControlName="telephoneExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('telephoneExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="telephoneMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">f) Frais d'electricite</span>
                                            <p-select formControlName="electriciteExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('electriciteExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="electriciteMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <!-- g) Eau + h) Transport achat -->
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">g) Frais d'eau</span>
                                            <p-select formControlName="eauExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('eauExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="eauMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">h) Frais transport sur achat</span>
                                            <p-select formControlName="transportAchatExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('transportAchatExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="transportAchatMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <!-- i) Transport vente + j) Transport divers -->
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">i) Frais transport sur vente</span>
                                            <p-select formControlName="transportVenteExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('transportVenteExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="transportVenteMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">j) Frais transport divers</span>
                                            <p-select formControlName="transportDiversExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('transportDiversExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="transportDiversMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <!-- k) Entretien + l) Carburant -->
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">k) Frais entretien et reparation</span>
                                            <p-select formControlName="entretienExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('entretienExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="entretienMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">l) Frais de carburant</span>
                                            <p-select formControlName="carburantExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('carburantExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="carburantMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <!-- m) Assurance + n) Frais bancaires -->
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">m) Frais d'assurance</span>
                                            <p-select formControlName="assuranceExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('assuranceExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="assuranceMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">n) Frais bancaires</span>
                                            <p-select formControlName="fraisBancairesExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('fraisBancairesExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="fraisBancairesMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <!-- o) Interets emprunts + p) Impots taxes -->
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">o) Interets sur emprunts</span>
                                            <p-select formControlName="interetsEmpruntsExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('interetsEmpruntsExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="interetsEmpruntsMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">p) Impots - Taxes et permis</span>
                                            <p-select formControlName="impotsTaxesExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('impotsTaxesExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="impotsTaxesMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <!-- q) Honoraires + r) Provisions -->
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">q) Honoraires professionnels</span>
                                            <p-select formControlName="honorairesExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('honorairesExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="honorairesMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">r) Provisions mensuelles</span>
                                            <p-select formControlName="provisionsExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('provisionsExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="provisionsMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <!-- s) Echeance autre credit + t) Autres charges -->
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">s) Echeance autre credit</span>
                                            <p-select formControlName="echeanceAutreCreditExiste"
                                                [options]="ouiNonOptions" optionLabel="label" optionValue="value"
                                                class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('echeanceAutreCreditExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="echeanceAutreCreditMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">t) Autres charges</span>
                                            <p-select formControlName="autresChargesExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section6Form.get('autresChargesExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="autresChargesMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <div class="flex justify-content-end mt-3">
                                <button pButton label="Enregistrer Section 6" icon="pi pi-save"
                                    (click)="saveCollecteSection(6)" [loading]="savingCollecte()"></button>
                            </div>
                        </p-accordion-content>
                        </p-accordion-panel>

                        <!-- ===== SECTION 7: CHARGES PERSONNELLES ===== -->
                        <p-accordion-panel value="6">
                        <p-accordion-header>Section 7 - Evaluation des charges personnelles de l'entrepreneur</p-accordion-header>
                        <p-accordion-content>
                            <form [formGroup]="section7Form">
                                <div
                                    class="grid align-items-center py-2 px-3 border-bottom-1 surface-border hover:surface-hover">
                                    <div class="col-6 text-sm font-medium">Avez-vous fixe un salaire pour vous-meme au
                                        niveau de votre activite ?</div>
                                    <div class="col-6"><p-select formControlName="salaireFixe" [options]="ouiNonOptions"
                                            optionLabel="label" optionValue="value" class="w-8rem"></p-select></div>
                                </div>

                                <!-- Si salaire fixe = OUI -->
                                <div *ngIf="section7Form.get('salaireFixe')?.value === true"
                                    class="ml-5 mt-3 p-3 bg-green-50 border-round border-1 border-green-200">
                                    <div class="flex align-items-center gap-3">
                                        <span class="text-green-700 font-medium text-sm">Quel est le montant par mois
                                            ?</span>
                                        <p-inputNumber formControlName="salaireMontant" mode="decimal"
                                            [useGrouping]="true" class="w-12rem"></p-inputNumber>
                                        <span class="text-sm text-500">GNF</span>
                                    </div>
                                </div>

                                <!-- Si salaire fixe = NON -->
                                <ng-container *ngIf="section7Form.get('salaireFixe')?.value === false">
                                    <div
                                        class="mt-3 p-3 bg-orange-50 border-round border-1 border-orange-200 mx-3 mb-3">
                                        <p class="text-orange-700 text-sm m-0"><strong>Note:</strong> Veuillez detailler
                                            vos charges personnelles mensuelles prelevees sur l'activite.</p>
                                    </div>
                                    <div class="grid">
                                        <!-- a) Alimentation + b) Loyer residence -->
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">a) Frais d'alimentation</span>
                                                <p-inputNumber formControlName="alimentationMontant" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">b) Loyer residence personnelle</span>
                                                <p-inputNumber formControlName="loyerResidenceMontant" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <!-- c) Transport + d) Electricite/eau/comm -->
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">c) Frais de transport prive</span>
                                                <p-inputNumber formControlName="transportPriveMontant" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">d) Electricite - eau - communication</span>
                                                <p-inputNumber formControlName="electriciteEauCommMontant"
                                                    mode="decimal" [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <!-- e) Habillement + f) Frais medicaux -->
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">e) Frais d'habillement</span>
                                                <p-inputNumber formControlName="habillementMontant" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">f) Frais medicaux</span>
                                                <p-inputNumber formControlName="fraisMedicauxMontant" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <!-- g) Echeance credit + h) Scolarite -->
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">g) Echeance autre credit</span>
                                                <p-inputNumber formControlName="echeanceCreditPersoMontant"
                                                    mode="decimal" [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">h) Frais de scolarite</span>
                                                <p-inputNumber formControlName="scolariteMontant" mode="decimal"
                                                    [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <!-- i) Constructions + j) Autres charges -->
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">i) Travaux constructions privees</span>
                                                <p-inputNumber formControlName="travauxConstructionMontant"
                                                    mode="decimal" [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                        <div class="col-12 md:col-6">
                                            <div
                                                class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                                <span class="text-sm">j) Autres charges personnelles</span>
                                                <p-inputNumber formControlName="autresChargesPersoMontant"
                                                    mode="decimal" [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Question k) -->
                                    <div class="grid align-items-center py-3 px-3 bg-yellow-50 border-round mt-3 mx-3">
                                        <div class="col-8 text-sm font-medium">k) Toutes ces depenses sont prelevees
                                            dans l'activite ?</div>
                                        <div class="col-4"><p-select formControlName="depensesPreleveesActivite"
                                                [options]="ouiNonOptions" optionLabel="label" optionValue="value"
                                                class="w-8rem"></p-select></div>
                                    </div>

                                    <!-- Total -->
                                    <div
                                        class="mt-3 p-3 surface-ground border-round mx-3 flex justify-content-between align-items-center">
                                        <span class="font-medium text-orange-700">Total charges personnelles
                                            mensuelles</span>
                                        <span class="text-xl font-bold text-orange-700">{{ totalChargesPersonnelles() |
                                            currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</span>
                                    </div>
                                </ng-container>
                            </form>
                            <div class="flex justify-content-end mt-3">
                                <button pButton label="Enregistrer Section 7" icon="pi pi-save"
                                    (click)="saveCollecteSection(7)" [loading]="savingCollecte()"></button>
                            </div>
                        </p-accordion-content>
                        </p-accordion-panel>

                        <!-- ===== SECTION 8: AUTRES REVENUS ===== -->
                        <p-accordion-panel value="7">
                        <p-accordion-header>Section 8 - Evaluation des autres revenus mensuels</p-accordion-header>
                        <p-accordion-content>
                            <form [formGroup]="section8Form">
                                <div class="grid">
                                    <!-- a) Salaire externe + b) Loyers percus -->
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">a) Salaire et remunerations en tant que
                                                salarie</span>
                                            <p-select formControlName="salaireExterneExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section8Form.get('salaireExterneExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="salaireExterneMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">b) Loyers percus</span>
                                            <p-select formControlName="loyersPercusExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section8Form.get('loyersPercusExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="loyersPercusMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <!-- c) Activites secondaires + d) Autres revenus -->
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">c) Revenus issus d'activites secondaires</span>
                                            <p-select formControlName="activiteSecondaireExiste"
                                                [options]="ouiNonOptions" optionLabel="label" optionValue="value"
                                                class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section8Form.get('activiteSecondaireExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="activiteSecondaireMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">d) Autres revenus</span>
                                            <p-select formControlName="autresRevenusExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section8Form.get('autresRevenusExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Montant</span>
                                            <p-inputNumber formControlName="autresRevenusMontant" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <div class="flex justify-content-end mt-3">
                                <button pButton label="Enregistrer Section 8" icon="pi pi-save"
                                    (click)="saveCollecteSection(8)" [loading]="savingCollecte()"></button>
                            </div>
                        </p-accordion-content>
                        </p-accordion-panel>

                        <!-- ===== SECTION 9: BIENS PERSONNELS ===== -->
                        <p-accordion-panel value="8">
                        <p-accordion-header>Section 9 - Evaluation des biens personnels de l'entrepreneur</p-accordion-header>
                        <p-accordion-content>
                            <form [formGroup]="section9Form">
                                <div class="grid">
                                    <!-- a) Terrains + b) Maisons -->
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">a) Avez-vous des terrains vides</span>
                                            <p-select formControlName="terrainExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section9Form.get('terrainExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Valeur estimee</span>
                                            <p-inputNumber formControlName="terrainValeur" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">b) Avez-vous des maisons</span>
                                            <p-select formControlName="maisonExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section9Form.get('maisonExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Valeur estimee</span>
                                            <p-inputNumber formControlName="maisonValeur" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <!-- c) Vehicules + d) Motos -->
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">c) Avez-vous des vehicules</span>
                                            <p-select formControlName="vehiculeExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section9Form.get('vehiculeExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Valeur estimee</span>
                                            <p-inputNumber formControlName="vehiculeValeur" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">d) Avez-vous des motos</span>
                                            <p-select formControlName="motoExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section9Form.get('motoExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Valeur estimee</span>
                                            <p-inputNumber formControlName="motoValeur" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                    <!-- e) Autres biens -->
                                    <div class="col-12 md:col-6">
                                        <div
                                            class="flex align-items-center gap-3 py-2 px-2 border-bottom-1 surface-border hover:surface-hover">
                                            <span class="text-sm">e) Autres biens personnels</span>
                                            <p-select formControlName="autreBienExiste" [options]="ouiNonOptions"
                                                optionLabel="label" optionValue="value" class="w-7rem"></p-select>
                                        </div>
                                        <div *ngIf="section9Form.get('autreBienExiste')?.value"
                                            class="flex align-items-center gap-2 pl-3 py-1 surface-ground border-round mx-1 mb-1">
                                            <span class="text-xs text-600">Valeur estimee</span>
                                            <p-inputNumber formControlName="autreBienValeur" mode="decimal"
                                                [useGrouping]="true" class="w-10rem"></p-inputNumber>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <div class="flex justify-content-end mt-3">
                                <button pButton label="Enregistrer Section 9" icon="pi pi-save"
                                    (click)="saveCollecteSection(9)" [loading]="savingCollecte()"></button>
                            </div>
                        </p-accordion-content>
                        </p-accordion-panel>
                    </p-accordion>
                </div>
            </p-card>
        </div>

        <!-- ==================== ETAPE 1: AMORTISSEMENTS ==================== -->
        <div *ngIf="activeIndex() === 1">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="flex align-items-center justify-content-between p-3 bg-primary text-white">
                        <h2 class="m-0 text-xl font-bold">TABLEAU DES AMORTISSEMENTS</h2>
                        <div class="flex gap-2">
                            <button pButton icon="pi pi-refresh" label="Recalculer" class="p-button-sm p-button-warning"
                                (click)="recalculerAmortissements()" [disabled]="!collecte()"></button>
                        </div>
                    </div>
                </ng-template>

                <div *ngIf="!collecte()"
                    class="p-3 bg-yellow-50 border-round border-1 border-yellow-200 text-center mb-3">
                    <i class="pi pi-info-circle mr-2"></i>
                    <span>Veuillez d'abord creer une collecte (etape precedente).</span>
                </div>

                <!-- Notification: amortissements manquants -->
                <div *ngIf="collecte() && missingAmortissementTypes().length > 0"
                    class="mb-3 p-3 bg-orange-50 border-round border-1 border-orange-300">
                    <div class="flex align-items-center mb-2">
                        <i class="pi pi-exclamation-triangle text-orange-600 mr-2 text-xl"></i>
                        <span class="font-bold text-orange-700">Amortissements manquants</span>
                    </div>
                    <p class="text-sm text-orange-700 mt-0 mb-3">
                        Vous avez declare posseder les actifs suivants en Section 5.
                        Veuillez ajouter les amortissements correspondants :
                    </p>
                    <div class="flex flex-wrap gap-2">
                        <div *ngFor="let missing of missingAmortissementTypes()"
                            class="flex align-items-center gap-2 p-2 bg-white border-round border-1 border-orange-200">
                            <i class="pi pi-plus-circle text-orange-500"></i>
                            <span class="text-sm font-medium">{{ missing.label }}</span>
                            <button pButton label="Ajouter" icon="pi pi-plus"
                                class="p-button-sm p-button-warning"
                                (click)="addAmortissementForType(missing.type)"></button>
                        </div>
                    </div>
                </div>

                <!-- Inline table editing -->
                <div *ngIf="collecte()" class="overflow-x-auto">
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="surface-100">
                                <th class="p-2 border-1 surface-border text-left" style="width:40px">N.</th>
                                <th class="p-2 border-1 surface-border text-left">Nature de l'immobilisation</th>
                                <th class="p-2 border-1 surface-border text-left" style="width:180px">Type
                                    d'immobilisation</th>
                                <th class="p-2 border-1 surface-border text-center" style="width:130px">Date
                                    d'acquisition</th>
                                <th class="p-2 border-1 surface-border text-center" style="width:80px">Duree (mois)</th>
                                <th class="p-2 border-1 surface-border text-right" style="width:140px">Valeur
                                    d'acquisition</th>
                                <th class="p-2 border-1 surface-border text-right" style="width:120px">Amort. mensuel
                                </th>
                                <th class="p-2 border-1 surface-border text-right" style="width:130px">Cumul amort.</th>
                                <th class="p-2 border-1 surface-border text-center" style="width:110px">Date fin</th>
                                <th class="p-2 border-1 surface-border text-right" style="width:130px">VNC</th>
                                <th class="p-2 border-1 surface-border text-right" style="width:140px">VNC ajustee</th>
                                <th class="p-2 border-1 surface-border text-center" style="width:90px">Statut</th>
                                <th class="p-2 border-1 surface-border" style="width:40px"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let amort of amortissements(); let i = index"
                                class="border-bottom-1 surface-border hover:surface-hover"
                                [ngClass]="{'surface-ground': i % 2 !== 0}">
                                <td class="p-2 border-1 surface-border text-500 font-medium">{{ i + 1 }}</td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText [(ngModel)]="amort.natureImmobilisation"
                                        [ngModelOptions]="{standalone: true}" class="w-full p-1 text-sm"
                                        placeholder="Description..." (blur)="updateAmortissementRow(amort)" />
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <select class="w-full p-1 text-sm border-1 surface-border border-round"
                                        [ngModel]="amort.typeImmobilisation" [ngModelOptions]="{standalone: true}"
                                        (change)="onAmortTypeChange(amort, $any($event.target).value)">
                                        <option value="">-- Type --</option>
                                        <option *ngFor="let t of typesImmobilisation" [value]="t.value">{{ t.label }}
                                        </option>
                                    </select>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="date" [(ngModel)]="amort.dateAcquisition"
                                        [ngModelOptions]="{standalone: true}"
                                        class="w-full p-1 text-sm border-1 surface-border border-round"
                                        (change)="updateAmortissementRow(amort)" />
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="number" [(ngModel)]="amort.dureeAmortissementMois"
                                        [ngModelOptions]="{standalone: true}"
                                        class="w-full p-1 text-sm text-center border-1 surface-border border-round"
                                        (blur)="updateAmortissementRow(amort)" />
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [(ngModel)]="amort.valeurAcquisition"
                                        [ngModelOptions]="{standalone: true}" mode="decimal" [useGrouping]="true"
                                        class="w-full input-sm"
                                        (onBlur)="updateAmortissementRow(amort)"></p-inputNumber>
                                </td>
                                <td class="p-2 border-1 surface-border text-right font-mono text-blue-700 bg-blue-50">
                                    {{ (amort.amortissementMensuel || 0) | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td
                                    class="p-2 border-1 surface-border text-right font-mono text-orange-700 bg-orange-50">
                                    {{ (amort.amortissementCumule || 0) | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border text-center font-mono text-sm">
                                    {{ getDateFin(amort) }}
                                </td>
                                <td
                                    class="p-2 border-1 surface-border text-right font-mono text-green-700 bg-green-50 font-bold">
                                    {{ (amort.valeurNetteComptable || 0) | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [(ngModel)]="amort.valeurNetteAjustee"
                                        [ngModelOptions]="{standalone: true}" mode="decimal" [useGrouping]="true"
                                        class="w-full input-sm" placeholder="Optionnel"
                                        (onBlur)="updateAmortissementRow(amort)"></p-inputNumber>
                                </td>
                                <td class="p-2 border-1 surface-border text-center">
                                    <p-tag *ngIf="amort.statutAmortissement === 'Amorti'" value="Amorti"
                                        severity="danger"></p-tag>
                                    <p-tag *ngIf="amort.statutAmortissement === 'En cours'" value="En cours"
                                        severity="success"></p-tag>
                                </td>
                                <td class="p-1 border-1 surface-border text-center">
                                    <button pButton icon="pi pi-trash"
                                        class="p-button-rounded p-button-danger p-button-text p-button-sm"
                                        (click)="deleteAmortissementRow(amort)"></button>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="surface-200 border-top-2 surface-border">
                                <td colspan="5" class="p-2 border-1 surface-border">
                                    <button pButton icon="pi pi-plus" label="Ajouter une immobilisation"
                                        class="p-button-text p-button-sm text-primary"
                                        (click)="addAmortissementRow()"></button>
                                </td>
                                <td class="p-2 border-1 surface-border text-right font-mono font-bold">
                                    {{ totalAmortValeurAcquisition() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td
                                    class="p-2 border-1 surface-border text-right font-mono font-bold text-blue-700 bg-blue-100">
                                    {{ totalAmortMensuel() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border"></td>
                                <td class="p-2 border-1 surface-border"></td>
                                <td
                                    class="p-2 border-1 surface-border text-right font-mono font-bold text-green-700 bg-green-100">
                                    {{ totalAmortVNC() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border"></td>
                                <td class="p-2 border-1 surface-border"></td>
                                <td class="border-1 surface-border"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Resume par categorie -->
                <div *ngIf="collecte() && getAmortCategories().length > 0" class="mt-4">
                    <h3 class="text-base font-semibold mb-3">Resume par categorie</h3>
                    <div class="grid">
                        <div *ngFor="let cat of getAmortCategories()" class="col-6 md:col-3">
                            <div class="surface-ground border-round p-3">
                                <div class="text-xs text-500 uppercase">{{ cat.type }}</div>
                                <div class="text-lg font-bold mt-1">{{ cat.totalVNC |
                                    currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</div>
                                <div class="text-xs text-400 mt-1">{{ cat.count }} immobilisation(s)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </p-card>

            <p-confirmDialog></p-confirmDialog>
        </div>

        <!-- ==================== ÉTAPE 2: BILAN ==================== -->
        <div *ngIf="activeIndex() === 2">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="flex align-items-center justify-content-between p-3 bg-primary text-white">
                        <h2 class="m-0 text-xl font-bold">BILAN</h2>
                        <span class="text-sm">en GNF</span>
                    </div>
                </ng-template>

                <!-- Bouton pre-remplir depuis collecte -->
                <div class="flex justify-content-end mb-3" *ngIf="collecte()?.collecteId && state().analyseExiste">
                    <p-button label="Pre-remplir depuis la collecte" icon="pi pi-sync" [loading]="loading()"
                        severity="info" [outlined]="true" (onClick)="autoRemplirDepuisCollecte()"
                        [disabled]="!state().analyseId || !collecte()?.collecteId"
                        pTooltip="Remplir automatiquement Bilan, Rentabilite et Besoin de credit depuis les donnees de collecte" />
                </div>

                <!-- Tableau Bilan -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="p-3 text-left border-1 surface-border" style="width: 35%">Bilan</th>
                                <th class="p-3 text-center border-1 surface-border bg-blue-50" style="width: 25%">
                                    Évaluation actuelle<br><small class="font-normal">Montant (N)</small>
                                </th>
                                <th class="p-3 text-center border-1 surface-border bg-gray-50" style="width: 25%">
                                    Évaluation précédente<br><small class="font-normal">Montant (N-1)</small>
                                </th>
                                <th class="p-3 text-center border-1 surface-border" style="width: 15%">Observations</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- ACTIF Header -->
                            <tr class="bg-blue-100">
                                <td class="p-2 font-bold border-1 surface-border" colspan="4">ACTIF</td>
                            </tr>

                            <!-- Immobilisations Section -->
                            <tr class="bg-gray-50">
                                <td class="p-2 font-semibold border-1 surface-border">Immobilisations</td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-primary">
                                    {{ totalActifImmobiliseN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold">
                                    {{ totalActifImmobiliseN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border"></td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-5 border-1 surface-border">Terrains</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'terrains')" mode="decimal"
                                        [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'terrains')" mode="decimal"
                                        [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-5 border-1 surface-border">Bâtiments et magasin</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'constructions')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'constructions')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-5 border-1 surface-border">Installations et agencements</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'installationsTechniques')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'installationsTechniques')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-5 border-1 surface-border">Matériels industriels</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'autresImmobilisations')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'autresImmobilisations')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-5 border-1 surface-border">Mobilier de bureau</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'materielBureau')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'materielBureau')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-5 border-1 surface-border">Matériel informatique</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'immobilisationsFinancieres')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'immobilisationsFinancieres')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-5 border-1 surface-border">Matériel de transport</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'materielTransport')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'materielTransport')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-5 border-1 surface-border">Autres immobilisations</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'immobilisationsEnCours')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'immobilisationsEnCours')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <!-- Actif Circulant -->
                            <tr>
                                <td class="p-2 font-semibold border-1 surface-border">Stocks</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'stocks')" mode="decimal"
                                        [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'stocks')" mode="decimal"
                                        [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 font-semibold border-1 surface-border">Créances, Clients</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'creances')" mode="decimal"
                                        [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'creances')" mode="decimal"
                                        [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 font-semibold border-1 surface-border">Trésorerie (Caisse+Banque)</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'tresorerieActif')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'tresorerieActif')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <!-- Total Actif -->
                            <tr class="bg-green-100">
                                <td class="p-2 font-bold border-1 surface-border">TOTAL ACTIF</td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-green-700">
                                    {{ totalActifN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-green-700">
                                    {{ totalActifN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border"></td>
                            </tr>

                            <!-- Separator -->
                            <tr>
                                <td colspan="4" class="p-2"></td>
                            </tr>

                            <!-- PASSIF Header -->
                            <tr class="bg-purple-100">
                                <td class="p-2 font-bold border-1 surface-border" colspan="4">PASSIF</td>
                            </tr>

                            <tr>
                                <td class="p-2 font-semibold border-1 surface-border">Situation nette (Capitaux propres)
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'capitauxPropre')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'capitauxPropre')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 font-semibold border-1 surface-border">Emprunt à plus d'un an</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'dettesLongTerme')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'dettesLongTerme')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 font-semibold border-1 surface-border">Emprunt à moins d'un an</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'dettesCourtTerme')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'dettesCourtTerme')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 font-semibold border-1 surface-border">Autres dettes</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'tresoreriePassif')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'tresoreriePassif')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <!-- Total Passif / Bilan -->
                            <tr class="bg-green-100">
                                <td class="p-2 font-bold border-1 surface-border">TOTAL BILAN</td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-green-700">
                                    {{ totalPassifN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-green-700">
                                    {{ totalPassifN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border"></td>
                            </tr>

                            <!-- Separator -->
                            <tr>
                                <td colspan="4" class="p-2"></td>
                            </tr>

                            <!-- Indicateurs -->
                            <tr class="bg-yellow-50">
                                <td class="p-2 font-semibold border-1 surface-border">Fonds de roulement</td>
                                <td class="p-2 text-right border-1 surface-border font-bold"
                                    [ngClass]="fondsRoulementN() >= 0 ? 'text-green-700' : 'text-red-700'">
                                    {{ fondsRoulementN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold"
                                    [ngClass]="fondsRoulementN1() >= 0 ? 'text-green-700' : 'text-red-700'">
                                    {{ fondsRoulementN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border text-xs">= CP + DLT - Immo</td>
                            </tr>

                            <tr class="bg-yellow-50">
                                <td class="p-2 font-semibold border-1 surface-border">Besoin en fonds de roulement</td>
                                <td class="p-2 text-right border-1 surface-border font-bold">
                                    {{ besoinFondsRoulementN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold">
                                    {{ besoinFondsRoulementN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border text-xs">= Stocks + Créances - DCT</td>
                            </tr>

                            <tr class="bg-yellow-50">
                                <td class="p-2 font-semibold border-1 surface-border">Trésorerie nette</td>
                                <td class="p-2 text-right border-1 surface-border font-bold"
                                    [ngClass]="tresorerieNetteN() >= 0 ? 'text-green-700' : 'text-red-700'">
                                    {{ tresorerieNetteN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold"
                                    [ngClass]="tresorerieNetteN1() >= 0 ? 'text-green-700' : 'text-red-700'">
                                    {{ tresorerieNetteN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border text-xs">= FR - BFR</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <ng-template pTemplate="footer">
                    <div class="flex justify-content-end gap-2">
                        <!-- Bouton Enregistrer (première fois) -->
                        <button *ngIf="!bilanSaved()" pButton label="Enregistrer Bilan" icon="pi pi-save"
                            (click)="saveBilanAll()" [loading]="savingBilan()"
                            [disabled]="!state().analyseExiste"></button>
                        <!-- Bouton Modifier (après enregistrement) -->
                        <button *ngIf="bilanSaved()" pButton label="Modifier Bilan" icon="pi pi-pencil"
                            class="p-button-warning" (click)="saveBilanAll()" [loading]="savingBilan()"
                            [disabled]="!state().analyseExiste"></button>
                    </div>
                </ng-template>
            </p-card>
        </div>

        <!-- ==================== ÉTAPE 3: RENTABILITÉ ==================== -->
        <div *ngIf="activeIndex() === 3">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="flex align-items-center justify-content-between p-3 bg-primary text-white">
                        <h2 class="m-0 text-xl font-bold">RENTABILITÉ DE L'ACTIVITÉ</h2>
                        <span class="text-sm">en GNF</span>
                    </div>
                </ng-template>

                <!-- Tableau Rentabilité -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="p-3 text-left border-1 surface-border" style="width: 30%">Rentabilité de
                                    l'activité</th>
                                <th class="p-3 text-center border-1 surface-border bg-blue-50" style="width: 20%">
                                    Évaluation actuelle<br><small class="font-normal">Montant (N)</small>
                                </th>
                                <th class="p-3 text-center border-1 surface-border bg-gray-50" style="width: 20%">
                                    Évaluation précédente<br><small class="font-normal">Montant (N-1)</small>
                                </th>
                                <th class="p-3 text-center border-1 surface-border bg-green-50" style="width: 20%">
                                    Analyse du Projet<br><small class="font-normal">Montant (N+1)</small>
                                </th>
                                <th class="p-3 text-center border-1 surface-border" style="width: 10%">Obs.</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Chiffre d'affaires -->
                            <tr class="bg-blue-50">
                                <td class="p-2 font-bold border-1 surface-border">Chiffre d'affaires</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'chiffreAffaires')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'chiffreAffaires')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'chiffreAffaires')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-select [options]="hypotheseCaOptions" [(ngModel)]="selectedHypotheseCa"
                                        [ngModelOptions]="{standalone: true}" (onChange)="onHypotheseCaChange($event)"
                                        placeholder="Hyp." styleClass="w-full text-xs"></p-select>
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 border-1 surface-border">Coût d'achats des marchandises vendues</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'coutAchatMarchandises')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteN1Form, 'coutAchatMarchandises')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteN2Form, 'coutAchatMarchandises')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <!-- Marge brute -->
                            <tr class="bg-green-100">
                                <td class="p-2 font-bold border-1 surface-border">
                                    Marge brute
                                    <span class="ml-2 text-sm font-normal text-color-secondary">
                                        ({{ tauxMargeBruteN() | number:'1.0-0' }}%)
                                    </span>
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-green-700">
                                    {{ margeBruteN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-green-700">
                                    {{ margeBruteN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-green-700">
                                    {{ margeBruteN2() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-select [options]="typeMargeOptions" [(ngModel)]="selectedTypeMarge"
                                        [ngModelOptions]="{standalone: true}" (onChange)="onTypeMargeChange($event)"
                                        placeholder="%" styleClass="w-full text-xs"></p-select>
                                </td>
                            </tr>

                            <!-- Autres charges header - 13 charges -->
                            <tr class="bg-red-50">
                                <td class="p-2 font-bold border-1 surface-border" colspan="5">Autres charges</td>
                            </tr>

                            <!-- 1. Salaires -->
                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Salaires</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'salaires')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'salaires')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'salaires')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <!-- 2. Prélèvement de l'entrepreneur -->
                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Prélèvement de l'entrepreneur</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteNForm, 'prelevementEntrepreneur')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteN1Form, 'prelevementEntrepreneur')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteN2Form, 'prelevementEntrepreneur')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <!-- 3. Loyers -->
                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Loyers</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'loyers')" mode="decimal"
                                        [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'loyers')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'loyers')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <!-- 4. Transport -->
                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Transport</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'transport')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'transport')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'transport')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <!-- 5. Électricité, eau, téléphone -->
                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Électricité, eau, téléphone</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteNForm, 'electriciteEauTelephone')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteN1Form, 'electriciteEauTelephone')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteN2Form, 'electriciteEauTelephone')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <!-- 6. Fournitures et autres besoins -->
                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Fournitures et autres besoins</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteNForm, 'fournituresAutresBesoins')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteN1Form, 'fournituresAutresBesoins')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteN2Form, 'fournituresAutresBesoins')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <!-- 7. Entretien et réparation -->
                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Entretien et réparation</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'entretienReparation')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'entretienReparation')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'entretienReparation')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <!-- 8. Carburant et lubrifiants -->
                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Carburant et lubrifiants</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'carburantLubrifiants')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'carburantLubrifiants')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'carburantLubrifiants')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <!-- 9. Frais de publicité et promotion -->
                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Frais de publicité et promotion</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'publicitePromotion')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'publicitePromotion')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'publicitePromotion')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <!-- 10. Redevance, impôts et taxes -->
                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Redevance, impôts et taxes</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'impotsTaxes')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'impotsTaxes')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'impotsTaxes')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <!-- 11. Frais bancaires, Intérêts payés -->
                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Frais bancaires, Intérêts payés</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteNForm, 'fraisBancairesInterets')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteN1Form, 'fraisBancairesInterets')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteN2Form, 'fraisBancairesInterets')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <!-- 12. Échéance autre crédit -->
                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Échéance autre crédit</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'echeanceAutreCredit')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'echeanceAutreCredit')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'echeanceAutreCredit')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <!-- 13. Diverses charges -->
                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Diverses charges</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'diversesCharges')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'diversesCharges')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'diversesCharges')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <!-- Total Autres Charges d'exploitation -->
                            <tr class="bg-red-100">
                                <td class="p-2 font-bold border-1 surface-border">Total autres charges d'exploitation
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-red-700">
                                    {{ totalChargesN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-red-700">
                                    {{ totalChargesN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-red-700">
                                    {{ totalChargesN2() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border text-xs">Auto.</td>
                            </tr>

                            <!-- Amortissements et provisions (en gras, après Total Charges) -->
                            <tr class="bg-orange-50">
                                <td class="p-2 pl-4 font-bold border-1 surface-border">Amortissements et Provisions</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteNForm, 'amortissementsProvisions')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteN1Form, 'amortissementsProvisions')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteN2Form, 'amortissementsProvisions')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <!-- Résultat d'exploitation de l'activité -->
                            <tr class="bg-blue-100">
                                <td class="p-2 font-bold border-1 surface-border">Résultat d'exploitation de l'activité
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold"
                                    [ngClass]="resultatExploitationN() >= 0 ? 'text-green-700' : 'text-red-700'">
                                    {{ resultatExploitationN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold"
                                    [ngClass]="resultatExploitationN1() >= 0 ? 'text-green-700' : 'text-red-700'">
                                    {{ resultatExploitationN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold"
                                    [ngClass]="resultatExploitationN2() >= 0 ? 'text-green-700' : 'text-red-700'">
                                    {{ resultatExploitationN2() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border text-xs">MB - Charges - Amort.</td>
                            </tr>

                            <!-- Separator -->
                            <tr>
                                <td colspan="5" class="p-1"></td>
                            </tr>

                            <!-- Cash-Flow (Excédent de trésorerie) -->
                            <tr class="bg-purple-100">
                                <td class="p-2 font-bold border-1 surface-border">Cash-flow (Excédent de trésorerie)
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-purple-700">
                                    {{ cashFlowN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-purple-700">
                                    {{ cashFlowN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-purple-700">
                                    {{ cashFlowN2() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border text-xs">Résultat + Amort.</td>
                            </tr>

                            <!-- Separator -->
                            <tr>
                                <td colspan="5" class="p-1"></td>
                            </tr>

                            <!-- Autres revenus net hors activité -->
                            <tr>
                                <td class="p-2 font-semibold border-1 surface-border">Autres revenus net hors activité
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteNForm, 'autresRevenusHorsActivite')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteN1Form, 'autresRevenusHorsActivite')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteN2Form, 'autresRevenusHorsActivite')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <!-- Separator -->
                            <tr>
                                <td colspan="5" class="p-1"></td>
                            </tr>

                            <!-- Capacité de remboursement calculée (= Cash-flow + Autres revenus) -->
                            <tr class="bg-green-200">
                                <td class="p-2 font-bold border-1 surface-border">Capacité de remboursement calculée
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold"
                                    [ngClass]="resultatNetN() >= 0 ? 'text-green-800' : 'text-red-700'">
                                    {{ resultatNetN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold"
                                    [ngClass]="resultatNetN1() >= 0 ? 'text-green-800' : 'text-red-700'">
                                    {{ resultatNetN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold"
                                    [ngClass]="resultatNetN2() >= 0 ? 'text-green-800' : 'text-red-700'">
                                    {{ resultatNetN2() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border text-xs">CF + Autres rev.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <ng-template pTemplate="footer">
                    <div class="flex justify-content-end gap-2">
                        <!-- Bouton Enregistrer (première fois) -->
                        <button *ngIf="!rentabiliteSaved()" pButton label="Enregistrer Rentabilité" icon="pi pi-save"
                            (click)="saveRentabiliteAll()" [loading]="savingRentabilite()"
                            [disabled]="!state().analyseExiste"></button>
                        <!-- Bouton Modifier (après enregistrement) -->
                        <button *ngIf="rentabiliteSaved()" pButton label="Modifier Rentabilité" icon="pi pi-pencil"
                            class="p-button-warning" (click)="saveRentabiliteAll()" [loading]="savingRentabilite()"
                            [disabled]="!state().analyseExiste"></button>
                    </div>
                </ng-template>
            </p-card>
        </div>

        <!-- ==================== ÉTAPE 4: PERSONNES CAUTION ==================== -->
        <div *ngIf="activeIndex() === 4">
            <p-card header="Personnes Caution">
                <div class="grid gap-3">
                    <div class="col-12">
                        <h3 class="text-lg font-bold mb-3 border-bottom-1 surface-border pb-2">
                            Ajouter une personne caution
                        </h3>
                        <p class="text-color-secondary mb-4">
                            Les personnes caution sont optionnelles mais peuvent renforcer le dossier.
                        </p>
                    </div>

                    <div class="col-12">
                        <form [formGroup]="personnecautionForm" class="p-fluid">
                            <div class="grid gap-3">
                                <div class="col-12 md:col-6">
                                    <label class="block font-medium mb-1">Nom</label>
                                    <input type="text" pInputText formControlName="nom" class="w-full" />
                                </div>
                                <div class="col-12 md:col-6">
                                    <label class="block font-medium mb-1">Prénom</label>
                                    <input type="text" pInputText formControlName="prenom" class="w-full" />
                                </div>
                                <div class="col-12 md:col-6">
                                    <label class="block font-medium mb-1">Téléphone</label>
                                    <input type="text" pInputText formControlName="telephone" class="w-full" />
                                </div>
                                <div class="col-12 md:col-6">
                                    <label class="block font-medium mb-1">Âge</label>
                                    <p-inputNumber formControlName="age" [showButtons]="true" [min]="18" [max]="100"
                                        suffix=" ans" class="w-full"></p-inputNumber>
                                </div>
                                <div class="col-12 md:col-6">
                                    <label class="block font-medium mb-1">Activité</label>
                                    <input type="text" pInputText formControlName="activite" class="w-full" />
                                </div>
                                <div class="col-12 md:col-6">
                                    <label class="block font-medium mb-1">Profession</label>
                                    <input type="text" pInputText formControlName="profession" class="w-full" />
                                </div>
                                <div class="col-12">
                                    <button pButton type="button" label="Ajouter cette personne caution"
                                        icon="pi pi-plus" class="p-button-success"
                                        (click)="addPersonnecaution()"></button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="col-12" *ngIf="personnecautions.length > 0">
                        <h3 class="text-lg font-bold mb-3 border-bottom-1 surface-border pb-2">
                            Personnes caution ajoutées ({{ personnecautions.length }})
                        </h3>
                        <div class="grid gap-3">
                            <div class="col-12 md:col-6" *ngFor="let caution of personnecautions; let i = index">
                                <p-card>
                                    <ng-template pTemplate="header">
                                        <div class="flex align-items-center justify-content-between p-3 bg-gray-100">
                                            <span class="font-bold">{{ caution.prenom }} {{ caution.nom }}</span>
                                            <button pButton type="button" icon="pi pi-trash"
                                                class="p-button-rounded p-button-danger p-button-text"
                                                (click)="removePersonnecaution(i)" pTooltip="Supprimer"></button>
                                        </div>
                                    </ng-template>
                                    <div class="grid">
                                        <div class="col-6" *ngIf="caution.telephone">
                                            <strong>Téléphone:</strong> {{ caution.telephone }}
                                        </div>
                                        <div class="col-6" *ngIf="caution.age">
                                            <strong>Âge:</strong> {{ caution.age }} ans
                                        </div>
                                        <div class="col-6" *ngIf="caution.activite">
                                            <strong>Activité:</strong> {{ caution.activite }}
                                        </div>
                                        <div class="col-6" *ngIf="caution.profession">
                                            <strong>Profession:</strong> {{ caution.profession }}
                                        </div>
                                    </div>
                                </p-card>
                            </div>
                        </div>
                    </div>

                    <div class="col-12" *ngIf="personnecautions.length === 0">
                        <div class="p-3 bg-yellow-50 border-round border-1 border-yellow-200 text-center">
                            <i class="pi pi-info-circle mr-2"></i>
                            <span>Aucune personne caution ajoutée.</span>
                        </div>
                    </div>
                </div>
            </p-card>
        </div>

        <!-- ==================== ÉTAPE 6: SYNTHÈSE ==================== -->
        <div *ngIf="activeIndex() === 6">
            <p-card header="Synthèse de l'Analyse">
                <div class="grid">
                    <!-- Récapitulatif du crédit sollicité -->
                    <div class="col-12">
                        <h3 class="text-lg font-bold mb-4 border-bottom-1 surface-border pb-2">
                            <i class="pi pi-file-check mr-2"></i>Récapitulatif de la demande
                        </h3>
                    </div>

                    <div class="col-12 md:col-6 lg:col-3">
                        <div class="p-3 bg-blue-50 border-round text-center">
                            <span class="block text-color-secondary mb-1">Montant sollicité</span>
                            <strong class="text-lg text-blue-700">{{ state().demandeIndividuel?.montantDemande |
                                currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</strong>
                        </div>
                    </div>
                    <div class="col-12 md:col-6 lg:col-3">
                        <div class="p-3 bg-blue-50 border-round text-center">
                            <span class="block text-color-secondary mb-1">Durée sollicitée</span>
                            <strong class="text-lg text-blue-700">{{ state().demandeIndividuel?.dureeDemande }}
                                mois</strong>
                        </div>
                    </div>
                    <div class="col-12 md:col-6 lg:col-3">
                        <div class="p-3 bg-green-50 border-round text-center">
                            <span class="block text-color-secondary mb-1">Besoin Investissement</span>
                            <strong class="text-lg text-green-700">{{ besoinReelInvestissementFinal() |
                                currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</strong>
                        </div>
                    </div>
                    <div class="col-12 md:col-6 lg:col-3">
                        <div class="p-3 bg-purple-50 border-round text-center">
                            <span class="block text-color-secondary mb-1">Besoin Exploitation</span>
                            <strong class="text-lg text-purple-700">{{ besoinReelExploitationFinal() |
                                currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</strong>
                        </div>
                    </div>

                    <!-- Besoin total -->
                    <div class="col-12 mt-3">
                        <div class="p-4 bg-primary border-round text-white text-center">
                            <span class="block text-lg mb-1">Besoin Total de Financement (effectif)</span>
                            <strong class="text-3xl">{{ besoinTotalFinancementFinal() |
                                currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</strong>
                        </div>
                    </div>

                    <!-- Personnes caution -->
                    <div class="col-12 mt-4">
                        <h3 class="text-lg font-bold mb-3 border-bottom-1 surface-border pb-2">
                            <i class="pi pi-users mr-2"></i>Personnes caution ({{ personnecautions.length }})
                        </h3>
                        <div *ngIf="personnecautions.length > 0" class="grid">
                            <div class="col-12 md:col-6" *ngFor="let caution of personnecautions">
                                <div class="p-3 bg-gray-50 border-round">
                                    <strong>{{ caution.prenom }} {{ caution.nom }}</strong>
                                    <span *ngIf="caution.profession" class="ml-2 text-color-secondary">- {{
                                        caution.profession }}</span>
                                </div>
                            </div>
                        </div>
                        <div *ngIf="personnecautions.length === 0"
                            class="p-3 bg-yellow-50 border-round border-1 border-yellow-200">
                            <i class="pi pi-info-circle mr-2"></i>Aucune personne caution ajoutée
                        </div>
                    </div>

                    <!-- Message de soumission -->
                    <div class="col-12 mt-4">
                        <div class="p-3 bg-yellow-50 border-round border-1 border-yellow-200">
                            <i class="pi pi-exclamation-triangle mr-2 text-yellow-700"></i>
                            <span>En soumettant cette analyse, le dossier sera transféré au comité de crédit pour
                                examen.</span>
                        </div>
                    </div>
                </div>

                <ng-template pTemplate="footer">
                    <div class="flex justify-content-end">
                        <button pButton label="Soumettre l'Analyse" icon="pi pi-send" (click)="submitAnalyse()"
                            [loading]="loading()" class="p-button-success" [disabled]="!state().analyseExiste"></button>
                    </div>
                </ng-template>
            </p-card>
        </div>

        <!-- ==================== ÉTAPE 5: BESOIN CRÉDIT ==================== -->
        <div *ngIf="activeIndex() === 5">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="flex align-items-center justify-content-between p-3 bg-primary text-white">
                        <h2 class="m-0 text-xl font-bold">BESOIN EN CRÉDIT</h2>
                        <span class="text-sm">en GNF</span>
                    </div>
                </ng-template>

                <form [formGroup]="besoinCreditForm">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="p-3 text-left border-1 surface-border" style="width: 30%">Désignation
                                    </th>
                                    <th class="p-3 text-center border-1 surface-border bg-blue-50" style="width: 23%">
                                        Montant</th>
                                    <th class="p-3 text-center border-1 surface-border bg-yellow-50" style="width: 23%">
                                        Ajustement</th>
                                    <th class="p-3 text-center border-1 surface-border bg-green-50" style="width: 24%">
                                        Montant effectif</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- ========== SECTION INVESTISSEMENT ========== -->
                                <tr class="bg-blue-100">
                                    <td class="p-2 font-bold border-1 surface-border" colspan="4">
                                        <i class="pi pi-building mr-2"></i>INVESTISSEMENT
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-4 border-1 surface-border">Coût de l'équipement</td>
                                    <td class="p-1 border-1 surface-border">
                                        <p-inputNumber formControlName="coutEquipement" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-1 border-1 surface-border bg-yellow-50">
                                        <p-inputNumber formControlName="ajustCoutEquipement" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-2 text-right border-1 surface-border bg-green-50 font-semibold">
                                        {{ effCoutEquipement() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-4 border-1 surface-border">Dépenses rattachées</td>
                                    <td class="p-1 border-1 surface-border">
                                        <p-inputNumber formControlName="depensesRattachees" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-1 border-1 surface-border bg-yellow-50">
                                        <p-inputNumber formControlName="ajustDepensesRattachees" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-2 text-right border-1 surface-border bg-green-50 font-semibold">
                                        {{ effDepensesRattachees() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <!-- Total Investissement -->
                                <tr class="bg-blue-50">
                                    <td class="p-2 pl-4 font-semibold border-1 surface-border">Total Investissement</td>
                                    <td class="p-2 text-right border-1 surface-border font-bold text-blue-700">
                                        {{ totalInvestissementMontant() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-yellow-700 bg-yellow-50">
                                        {{ totalInvestissementAjuste() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-green-700 bg-green-50">
                                        {{ totalInvestissementEffectif() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-4 border-1 surface-border text-green-700">(-) Apport personnel
                                    </td>
                                    <td class="p-1 border-1 surface-border">
                                        <p-inputNumber formControlName="apportPersonnel" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-1 border-1 surface-border bg-yellow-50">
                                        <p-inputNumber formControlName="ajustApportPersonnel" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border bg-green-50 font-semibold text-green-700">
                                        {{ effApportPersonnel() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <!-- Besoin réel investissement -->
                                <tr class="bg-blue-200">
                                    <td class="p-2 font-bold border-1 surface-border">= BESOIN RÉEL INVESTISSEMENT</td>
                                    <td class="p-2 text-right border-1 surface-border font-bold text-blue-800">
                                        {{ besoinReelInvestissementMontant() | currency:'GNF':'symbol':'1.0-0':'fr-FR'
                                        }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-yellow-800 bg-yellow-100">
                                        {{ besoinReelInvestissementAjuste() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-green-800 bg-green-100">
                                        {{ besoinReelInvestissementFinal() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <!-- Separator -->
                                <tr>
                                    <td colspan="4" class="p-2"></td>
                                </tr>

                                <!-- ========== SECTION EXPLOITATION ========== -->
                                <tr class="bg-purple-100">
                                    <td class="p-2 font-bold border-1 surface-border" colspan="4">
                                        <i class="pi pi-sync mr-2"></i>EXPLOITATION
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-4 border-1 surface-border">Coût d'achat du cycle</td>
                                    <td class="p-1 border-1 surface-border">
                                        <p-inputNumber formControlName="coutAchatCycle" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-1 border-1 surface-border bg-yellow-50">
                                        <p-inputNumber formControlName="ajustCoutAchatCycle" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-2 text-right border-1 surface-border bg-green-50 font-semibold">
                                        {{ effCoutAchatCycle() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-4 border-1 surface-border">Nombre de cycles à financer</td>
                                    <td class="p-1 border-1 surface-border" colspan="2">
                                        <p-inputNumber formControlName="nbreCycleFinancer" [showButtons]="true"
                                            [min]="1" [max]="12" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-2 text-center border-1 surface-border bg-green-50 font-semibold">
                                        {{ exploitationNbreCycles() }}
                                    </td>
                                </tr>

                                <!-- Besoin brut exploitation -->
                                <tr class="bg-purple-50">
                                    <td class="p-2 pl-4 font-semibold border-1 surface-border">Besoin brut (Coût ×
                                        Cycles)</td>
                                    <td class="p-2 text-right border-1 surface-border font-bold text-purple-700">
                                        {{ besoinBrutExploitationMontant() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-yellow-700 bg-yellow-50">
                                        {{ besoinBrutExploitationAjuste() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-green-700 bg-green-50">
                                        {{ besoinBrutExploitationEffectif() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <!-- Ressources disponibles header -->
                                <tr class="bg-gray-50">
                                    <td class="p-2 pl-4 font-semibold border-1 surface-border text-green-700"
                                        colspan="4">
                                        (-) Ressources disponibles
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-6 border-1 surface-border">Trésorerie disponible</td>
                                    <td class="p-1 border-1 surface-border">
                                        <p-inputNumber formControlName="tresorerieDisponible" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-1 border-1 surface-border bg-yellow-50">
                                        <p-inputNumber formControlName="ajustTresorerieDispo" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-2 text-right border-1 surface-border bg-green-50 font-semibold">
                                        {{ effTresorerieDispo() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-6 border-1 surface-border">Stock actuel</td>
                                    <td class="p-1 border-1 surface-border">
                                        <p-inputNumber formControlName="stockActuel" mode="decimal" [useGrouping]="true"
                                            class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-1 border-1 surface-border bg-yellow-50">
                                        <p-inputNumber formControlName="ajustStockActuel" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-2 text-right border-1 surface-border bg-green-50 font-semibold">
                                        {{ effStockActuel() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-6 border-1 surface-border">Comptes à recevoir</td>
                                    <td class="p-1 border-1 surface-border">
                                        <p-inputNumber formControlName="comptesRecevoir" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-1 border-1 surface-border bg-yellow-50">
                                        <p-inputNumber formControlName="ajustComptesRecevoir" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-2 text-right border-1 surface-border bg-green-50 font-semibold">
                                        {{ effComptesRecevoir() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <!-- Total ressources -->
                                <tr class="bg-green-50">
                                    <td class="p-2 pl-4 font-semibold border-1 surface-border text-green-700">Total
                                        ressources disponibles</td>
                                    <td class="p-2 text-right border-1 surface-border font-bold text-green-700">
                                        {{ ressourcesDisponiblesMontant() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-yellow-700 bg-yellow-50">
                                        {{ ressourcesDisponiblesAjuste() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td class="p-2 text-right border-1 surface-border font-bold text-green-800">
                                        {{ ressourcesDisponiblesEffectif() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <!-- Dettes header -->
                                <tr class="bg-gray-50">
                                    <td class="p-2 pl-4 font-semibold border-1 surface-border text-red-700" colspan="4">
                                        (+) Dettes à payer
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-6 border-1 surface-border">Dettes fournisseurs</td>
                                    <td class="p-1 border-1 surface-border">
                                        <p-inputNumber formControlName="dettesFournisseurs" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-1 border-1 surface-border bg-yellow-50">
                                        <p-inputNumber formControlName="ajustDettesFournisseurs" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-2 text-right border-1 surface-border bg-green-50 font-semibold">
                                        {{ effDettesFournisseurs() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-6 border-1 surface-border">Crédit fournisseur</td>
                                    <td class="p-1 border-1 surface-border">
                                        <p-inputNumber formControlName="creditFournisseur" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-1 border-1 surface-border bg-yellow-50">
                                        <p-inputNumber formControlName="ajustCreditFournisseur" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-2 text-right border-1 surface-border bg-green-50 font-semibold">
                                        {{ effCreditFournisseur() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <!-- Total dettes -->
                                <tr class="bg-red-50">
                                    <td class="p-2 pl-4 font-semibold border-1 surface-border text-red-700">Total dettes
                                        à payer</td>
                                    <td class="p-2 text-right border-1 surface-border font-bold text-red-700">
                                        {{ totalDettesMontant() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-yellow-700 bg-yellow-50">
                                        {{ totalDettesAjuste() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-red-800 bg-red-100">
                                        {{ totalDettesEffectif() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <!-- Besoin réel exploitation -->
                                <tr class="bg-purple-200">
                                    <td class="p-2 font-bold border-1 surface-border">= BESOIN RÉEL EXPLOITATION</td>
                                    <td class="p-2 text-right border-1 surface-border font-bold text-purple-800">
                                        {{ besoinReelExploitationMontant() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-yellow-800 bg-yellow-100">
                                        {{ besoinReelExploitationAjuste() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-green-800 bg-green-100">
                                        {{ besoinReelExploitationFinal() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <!-- Separator -->
                                <tr>
                                    <td colspan="4" class="p-3"></td>
                                </tr>

                                <!-- ========== TOTAL FINANCEMENT ========== -->
                                <tr class="bg-primary text-white">
                                    <td class="p-3 font-bold border-1 border-white">
                                        <i class="pi pi-wallet mr-2"></i>BESOIN TOTAL DE FINANCEMENT
                                    </td>
                                    <td class="p-3 text-right border-1 border-white font-bold text-xl">
                                        {{ besoinTotalFinancementMontant() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td class="p-3 text-right border-1 border-white font-bold text-xl bg-yellow-600">
                                        {{ besoinTotalFinancementAjuste() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td class="p-3 text-right border-1 border-white font-bold text-xl bg-green-600">
                                        {{ besoinTotalFinancementFinal() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Récapitulatif visuel -->
                    <div class="grid mt-4">
                        <div class="col-12 md:col-4">
                            <div class="p-3 bg-blue-100 border-round text-center">
                                <span class="block text-color-secondary mb-1">Besoin Investissement</span>
                                <strong class="text-lg text-blue-700">{{ besoinReelInvestissementFinal() |
                                    currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</strong>
                            </div>
                        </div>
                        <div class="col-12 md:col-4">
                            <div class="p-3 bg-purple-100 border-round text-center">
                                <span class="block text-color-secondary mb-1">Besoin Exploitation</span>
                                <strong class="text-lg text-purple-700">{{ besoinReelExploitationFinal() |
                                    currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</strong>
                            </div>
                        </div>
                        <div class="col-12 md:col-4">
                            <div class="p-3 bg-green-100 border-round text-center">
                                <span class="block text-color-secondary mb-1">Total Financement (effectif)</span>
                                <strong class="text-xl text-green-700">{{ besoinTotalFinancementFinal() |
                                    currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</strong>
                            </div>
                        </div>
                    </div>
                </form>

                <ng-template pTemplate="footer">
                    <div class="flex justify-content-end gap-2">
                        <button *ngIf="!besoinCreditSaved()" pButton label="Enregistrer Besoin Crédit" icon="pi pi-save"
                            (click)="saveBesoinCredit()" [loading]="savingBesoinCredit()"
                            [disabled]="!state().analyseExiste"></button>
                        <button *ngIf="besoinCreditSaved()" pButton label="Modifier Besoin Crédit" icon="pi pi-pencil"
                            class="p-button-warning" (click)="saveBesoinCredit()" [loading]="savingBesoinCredit()"
                            [disabled]="!state().analyseExiste"></button>
                    </div>
                </ng-template>
            </p-card>
        </div>

        <!-- Boutons de navigation -->
        <div class="flex justify-content-between mt-4">
            <button pButton type="button" label="Précédent" icon="pi pi-arrow-left" class="p-button-outlined"
                [disabled]="activeIndex() === 0" (click)="prevStep()"></button>
            <button pButton type="button" label="Suivant" icon="pi pi-arrow-right" iconPos="right"
                class="p-button-outlined" [disabled]="activeIndex() === 6" (click)="nextStep()"></button>
        </div>
    </div>
</div>