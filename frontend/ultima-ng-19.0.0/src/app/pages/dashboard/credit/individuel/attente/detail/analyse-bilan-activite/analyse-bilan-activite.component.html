<div class="card">
    <h1 class="text-surface-900 dark:text-surface-0 text-xl font-bold mb-6">Analyse Financière</h1>

    <p-toast></p-toast>

    <!-- Bouton créer analyse si pas encore créée -->
    <div class="mb-4" *ngIf="!state().analyseExiste">
        <div
            class="p-3 bg-yellow-50 border-round border-1 border-yellow-200 flex align-items-center justify-content-between">
            <span><i class="pi pi-info-circle mr-2"></i>Aucune analyse financière n'existe pour cette demande.</span>
            <button pButton label="Créer l'analyse" icon="pi pi-plus" class="p-button-success"
                (click)="createOrUpdateAnalyse()" [loading]="loading()"></button>
        </div>
    </div>

    <!-- Message quand l'analyse existe -->
    <div class="mb-4" *ngIf="state().analyseExiste">
        <div class="p-3 bg-green-50 border-round border-1 border-green-200 flex align-items-center">
            <i class="pi pi-check-circle text-green-600 mr-2"></i>
            <span class="text-green-700">Analyse financière #{{state().analyseId}} en cours d'édition</span>
        </div>
    </div>

    <!-- Stepper -->
    <p-steps [model]="items()" [activeIndex]="activeIndex()" [readonly]="false" styleClass="mb-5"></p-steps>

    <div class="p-fluid">
        <!-- ==================== ÉTAPE 0: BILAN ==================== -->
        <div *ngIf="activeIndex() === 0">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="flex align-items-center justify-content-between p-3 bg-primary text-white">
                        <h2 class="m-0 text-xl font-bold">BILAN</h2>
                        <span class="text-sm">en GNF</span>
                    </div>
                </ng-template>

                <!-- Tableau Bilan -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="p-3 text-left border-1 surface-border" style="width: 35%">Bilan</th>
                                <th class="p-3 text-center border-1 surface-border bg-blue-50" style="width: 25%">
                                    Évaluation actuelle<br><small class="font-normal">Montant (N)</small>
                                </th>
                                <th class="p-3 text-center border-1 surface-border bg-gray-50" style="width: 25%">
                                    Évaluation précédente<br><small class="font-normal">Montant (N-1)</small>
                                </th>
                                <th class="p-3 text-center border-1 surface-border" style="width: 15%">Observations</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- ACTIF Header -->
                            <tr class="bg-blue-100">
                                <td class="p-2 font-bold border-1 surface-border" colspan="4">ACTIF</td>
                            </tr>

                            <!-- Immobilisations Section -->
                            <tr class="bg-gray-50">
                                <td class="p-2 font-semibold border-1 surface-border">Immobilisations</td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-primary">
                                    {{ totalActifImmobiliseN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold">
                                    {{ totalActifImmobiliseN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border"></td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-5 border-1 surface-border">Terrains</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'terrains')" mode="decimal"
                                        [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'terrains')" mode="decimal"
                                        [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-5 border-1 surface-border">Bâtiments et magasin</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'constructions')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'constructions')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-5 border-1 surface-border">Installations et agencements</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'installationsTechniques')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'installationsTechniques')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-5 border-1 surface-border">Matériels industriels</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'autresImmobilisations')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'autresImmobilisations')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-5 border-1 surface-border">Mobilier de bureau</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'materielBureau')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'materielBureau')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-5 border-1 surface-border">Matériel informatique</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'immobilisationsFinancieres')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'immobilisationsFinancieres')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-5 border-1 surface-border">Matériel de transport</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'materielTransport')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'materielTransport')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-5 border-1 surface-border">Autres immobilisations</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'immobilisationsEnCours')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'immobilisationsEnCours')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <!-- Actif Circulant -->
                            <tr>
                                <td class="p-2 font-semibold border-1 surface-border">Stocks</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'stocks')" mode="decimal"
                                        [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'stocks')" mode="decimal"
                                        [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 font-semibold border-1 surface-border">Créances, Clients</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'creances')" mode="decimal"
                                        [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'creances')" mode="decimal"
                                        [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 font-semibold border-1 surface-border">Trésorerie (Caisse+Banque)</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'tresorerieActif')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'tresorerieActif')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <!-- Total Actif -->
                            <tr class="bg-green-100">
                                <td class="p-2 font-bold border-1 surface-border">TOTAL ACTIF</td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-green-700">
                                    {{ totalActifN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-green-700">
                                    {{ totalActifN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border"></td>
                            </tr>

                            <!-- Separator -->
                            <tr>
                                <td colspan="4" class="p-2"></td>
                            </tr>

                            <!-- PASSIF Header -->
                            <tr class="bg-purple-100">
                                <td class="p-2 font-bold border-1 surface-border" colspan="4">PASSIF</td>
                            </tr>

                            <tr>
                                <td class="p-2 font-semibold border-1 surface-border">Situation nette (Capitaux propres)
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'capitauxPropre')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'capitauxPropre')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 font-semibold border-1 surface-border">Emprunt à plus d'un an</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'dettesLongTerme')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'dettesLongTerme')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 font-semibold border-1 surface-border">Emprunt à moins d'un an</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'dettesCourtTerme')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'dettesCourtTerme')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <tr>
                                <td class="p-2 font-semibold border-1 surface-border">Autres dettes</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanNForm, 'tresoreriePassif')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(bilanN1Form, 'tresoreriePassif')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <input type="text" pInputText class="w-full p-1 text-sm" />
                                </td>
                            </tr>

                            <!-- Total Passif / Bilan -->
                            <tr class="bg-green-100">
                                <td class="p-2 font-bold border-1 surface-border">TOTAL BILAN</td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-green-700">
                                    {{ totalPassifN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-green-700">
                                    {{ totalPassifN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border"></td>
                            </tr>

                            <!-- Separator -->
                            <tr>
                                <td colspan="4" class="p-2"></td>
                            </tr>

                            <!-- Indicateurs -->
                            <tr class="bg-yellow-50">
                                <td class="p-2 font-semibold border-1 surface-border">Fonds de roulement</td>
                                <td class="p-2 text-right border-1 surface-border font-bold"
                                    [ngClass]="fondsRoulementN() >= 0 ? 'text-green-700' : 'text-red-700'">
                                    {{ fondsRoulementN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold"
                                    [ngClass]="fondsRoulementN1() >= 0 ? 'text-green-700' : 'text-red-700'">
                                    {{ fondsRoulementN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border text-xs">= CP + DLT - Immo</td>
                            </tr>

                            <tr class="bg-yellow-50">
                                <td class="p-2 font-semibold border-1 surface-border">Besoin en fonds de roulement</td>
                                <td class="p-2 text-right border-1 surface-border font-bold">
                                    {{ besoinFondsRoulementN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold">
                                    {{ besoinFondsRoulementN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border text-xs">= Stocks + Créances - DCT</td>
                            </tr>

                            <tr class="bg-yellow-50">
                                <td class="p-2 font-semibold border-1 surface-border">Trésorerie nette</td>
                                <td class="p-2 text-right border-1 surface-border font-bold"
                                    [ngClass]="tresorerieNetteN() >= 0 ? 'text-green-700' : 'text-red-700'">
                                    {{ tresorerieNetteN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold"
                                    [ngClass]="tresorerieNetteN1() >= 0 ? 'text-green-700' : 'text-red-700'">
                                    {{ tresorerieNetteN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border text-xs">= FR - BFR</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <ng-template pTemplate="footer">
                    <div class="flex justify-content-end gap-2">
                        <button pButton label="Enregistrer Bilan" icon="pi pi-save" (click)="saveBilanAll()"
                            [loading]="savingBilan()" [disabled]="!state().analyseExiste"></button>
                    </div>
                </ng-template>
            </p-card>
        </div>

        <!-- ==================== ÉTAPE 1: RENTABILITÉ ==================== -->
        <div *ngIf="activeIndex() === 1">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="flex align-items-center justify-content-between p-3 bg-primary text-white">
                        <h2 class="m-0 text-xl font-bold">RENTABILITÉ DE L'ACTIVITÉ</h2>
                        <span class="text-sm">en GNF</span>
                    </div>
                </ng-template>

                <!-- Tableau Rentabilité -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="p-3 text-left border-1 surface-border" style="width: 30%">Rentabilité de
                                    l'activité</th>
                                <th class="p-3 text-center border-1 surface-border bg-blue-50" style="width: 20%">
                                    Évaluation actuelle<br><small class="font-normal">Montant (N)</small>
                                </th>
                                <th class="p-3 text-center border-1 surface-border bg-gray-50" style="width: 20%">
                                    Évaluation précédente<br><small class="font-normal">Montant (N-1)</small>
                                </th>
                                <th class="p-3 text-center border-1 surface-border bg-green-50" style="width: 20%">
                                    Analyse du Projet<br><small class="font-normal">Montant (N+1)</small>
                                </th>
                                <th class="p-3 text-center border-1 surface-border" style="width: 10%">Obs.</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Chiffre d'affaires -->
                            <tr class="bg-blue-50">
                                <td class="p-2 font-bold border-1 surface-border">Chiffre d'affaires</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'chiffreAffaires')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'chiffreAffaires')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'chiffreAffaires')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <tr>
                                <td class="p-2 border-1 surface-border">Coût d'achats des marchandises vendues</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'coutAchats')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'coutAchats')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'coutAchats')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <!-- Marge brute -->
                            <tr class="bg-green-100">
                                <td class="p-2 font-bold border-1 surface-border">
                                    Marge brute
                                    <span class="ml-2 text-sm font-normal text-color-secondary">
                                        ({{ tauxMargeBruteN() | number:'1.0-0' }}%)
                                    </span>
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-green-700">
                                    {{ margeBruteN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-green-700">
                                    {{ margeBruteN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-green-700">
                                    {{ margeBruteN2() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border text-xs">Auto.</td>
                            </tr>

                            <!-- Autres charges header -->
                            <tr class="bg-red-50">
                                <td class="p-2 font-bold border-1 surface-border" colspan="5">Autres charges</td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Salaires</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'salaires')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'salaires')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'salaires')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Prélèvement de l'entrepreneur</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'chargesSociales')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'chargesSociales')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'chargesSociales')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Loyers</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'loyer')" mode="decimal"
                                        [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'loyer')" mode="decimal"
                                        [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'loyer')" mode="decimal"
                                        [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Transport</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'transport')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'transport')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'transport')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Électricité, eau, téléphone</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'electricite')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'electricite')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'electricite')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Fournitures et autres besoins</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'entretien')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'entretien')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'entretien')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Impôts et taxes</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'impotsTaxes')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'impotsTaxes')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'impotsTaxes')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Frais financiers</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'fraisFinanciers')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'fraisFinanciers')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'fraisFinanciers')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Dotation amortissement</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'dotationAmortissement')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteN1Form, 'dotationAmortissement')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber
                                        [formControl]="getControl(rentabiliteN2Form, 'dotationAmortissement')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <tr>
                                <td class="p-2 pl-4 border-1 surface-border">Autres charges diverses</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'autresCharges')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'autresCharges')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'autresCharges')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <!-- Total Charges -->
                            <tr class="bg-red-100">
                                <td class="p-2 font-bold border-1 surface-border">Total Charges</td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-red-700">
                                    {{ totalChargesN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-red-700">
                                    {{ totalChargesN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-red-700">
                                    {{ totalChargesN2() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border"></td>
                            </tr>

                            <!-- Autres Revenus -->
                            <tr>
                                <td class="p-2 font-semibold border-1 surface-border">Autres revenus</td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteNForm, 'autresRevenus')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN1Form, 'autresRevenus')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border">
                                    <p-inputNumber [formControl]="getControl(rentabiliteN2Form, 'autresRevenus')"
                                        mode="decimal" [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                </td>
                                <td class="p-1 border-1 surface-border"></td>
                            </tr>

                            <!-- Separator -->
                            <tr>
                                <td colspan="5" class="p-2"></td>
                            </tr>

                            <!-- Résultat -->
                            <tr class="bg-blue-100">
                                <td class="p-2 font-bold border-1 surface-border">Résultat d'exploitation</td>
                                <td class="p-2 text-right border-1 surface-border font-bold"
                                    [ngClass]="resultatExploitationN() >= 0 ? 'text-green-700' : 'text-red-700'">
                                    {{ resultatExploitationN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold"
                                    [ngClass]="resultatExploitationN1() >= 0 ? 'text-green-700' : 'text-red-700'">
                                    {{ resultatExploitationN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold"
                                    [ngClass]="resultatExploitationN2() >= 0 ? 'text-green-700' : 'text-red-700'">
                                    {{ resultatExploitationN2() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border text-xs">Auto.</td>
                            </tr>

                            <!-- Cash-Flow -->
                            <tr class="bg-purple-100">
                                <td class="p-2 font-bold border-1 surface-border">Cash-Flow</td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-purple-700">
                                    {{ cashFlowN() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-purple-700">
                                    {{ cashFlowN1() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 text-right border-1 surface-border font-bold text-purple-700">
                                    {{ cashFlowN2() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                </td>
                                <td class="p-2 border-1 surface-border text-xs">Résultat + Amort.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <ng-template pTemplate="footer">
                    <div class="flex justify-content-end gap-2">
                        <button pButton label="Enregistrer Rentabilité" icon="pi pi-save" (click)="saveRentabiliteAll()"
                            [loading]="savingRentabilite()" [disabled]="!state().analyseExiste"></button>
                    </div>
                </ng-template>
            </p-card>
        </div>

        <!-- ==================== ÉTAPE 2: PERSONNES CAUTION ==================== -->
        <div *ngIf="activeIndex() === 2">
            <p-card header="Personnes Caution">
                <div class="grid gap-3">
                    <div class="col-12">
                        <h3 class="text-lg font-bold mb-3 border-bottom-1 surface-border pb-2">
                            Ajouter une personne caution
                        </h3>
                        <p class="text-color-secondary mb-4">
                            Les personnes caution sont optionnelles mais peuvent renforcer le dossier.
                        </p>
                    </div>

                    <div class="col-12">
                        <form [formGroup]="personnecautionForm" class="p-fluid">
                            <div class="grid gap-3">
                                <div class="col-12 md:col-6">
                                    <label class="block font-medium mb-1">Nom</label>
                                    <input type="text" pInputText formControlName="nom" class="w-full" />
                                </div>
                                <div class="col-12 md:col-6">
                                    <label class="block font-medium mb-1">Prénom</label>
                                    <input type="text" pInputText formControlName="prenom" class="w-full" />
                                </div>
                                <div class="col-12 md:col-6">
                                    <label class="block font-medium mb-1">Téléphone</label>
                                    <input type="text" pInputText formControlName="telephone" class="w-full" />
                                </div>
                                <div class="col-12 md:col-6">
                                    <label class="block font-medium mb-1">Âge</label>
                                    <p-inputNumber formControlName="age" [showButtons]="true" [min]="18" [max]="100"
                                        suffix=" ans" class="w-full"></p-inputNumber>
                                </div>
                                <div class="col-12 md:col-6">
                                    <label class="block font-medium mb-1">Activité</label>
                                    <input type="text" pInputText formControlName="activite" class="w-full" />
                                </div>
                                <div class="col-12 md:col-6">
                                    <label class="block font-medium mb-1">Profession</label>
                                    <input type="text" pInputText formControlName="profession" class="w-full" />
                                </div>
                                <div class="col-12">
                                    <button pButton type="button" label="Ajouter cette personne caution"
                                        icon="pi pi-plus" class="p-button-success"
                                        (click)="addPersonnecaution()"></button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="col-12" *ngIf="personnecautions.length > 0">
                        <h3 class="text-lg font-bold mb-3 border-bottom-1 surface-border pb-2">
                            Personnes caution ajoutées ({{ personnecautions.length }})
                        </h3>
                        <div class="grid gap-3">
                            <div class="col-12 md:col-6" *ngFor="let caution of personnecautions; let i = index">
                                <p-card>
                                    <ng-template pTemplate="header">
                                        <div class="flex align-items-center justify-content-between p-3 bg-gray-100">
                                            <span class="font-bold">{{ caution.prenom }} {{ caution.nom }}</span>
                                            <button pButton type="button" icon="pi pi-trash"
                                                class="p-button-rounded p-button-danger p-button-text"
                                                (click)="removePersonnecaution(i)" pTooltip="Supprimer"></button>
                                        </div>
                                    </ng-template>
                                    <div class="grid">
                                        <div class="col-6" *ngIf="caution.telephone">
                                            <strong>Téléphone:</strong> {{ caution.telephone }}
                                        </div>
                                        <div class="col-6" *ngIf="caution.age">
                                            <strong>Âge:</strong> {{ caution.age }} ans
                                        </div>
                                        <div class="col-6" *ngIf="caution.activite">
                                            <strong>Activité:</strong> {{ caution.activite }}
                                        </div>
                                        <div class="col-6" *ngIf="caution.profession">
                                            <strong>Profession:</strong> {{ caution.profession }}
                                        </div>
                                    </div>
                                </p-card>
                            </div>
                        </div>
                    </div>

                    <div class="col-12" *ngIf="personnecautions.length === 0">
                        <div class="p-3 bg-yellow-50 border-round border-1 border-yellow-200 text-center">
                            <i class="pi pi-info-circle mr-2"></i>
                            <span>Aucune personne caution ajoutée.</span>
                        </div>
                    </div>
                </div>
            </p-card>
        </div>

        <!-- ==================== ÉTAPE 3: SYNTHÈSE ==================== -->
        <div *ngIf="activeIndex() === 3">
            <p-card header="Synthèse de l'Analyse">
                <div class="grid">
                    <!-- Récapitulatif du crédit sollicité -->
                    <div class="col-12">
                        <h3 class="text-lg font-bold mb-4 border-bottom-1 surface-border pb-2">
                            <i class="pi pi-file-check mr-2"></i>Récapitulatif de la demande
                        </h3>
                    </div>

                    <div class="col-12 md:col-6 lg:col-3">
                        <div class="p-3 bg-blue-50 border-round text-center">
                            <span class="block text-color-secondary mb-1">Montant sollicité</span>
                            <strong class="text-lg text-blue-700">{{ state().demandeIndividuel?.montantDemande |
                                currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</strong>
                        </div>
                    </div>
                    <div class="col-12 md:col-6 lg:col-3">
                        <div class="p-3 bg-blue-50 border-round text-center">
                            <span class="block text-color-secondary mb-1">Durée sollicitée</span>
                            <strong class="text-lg text-blue-700">{{ state().demandeIndividuel?.dureeDemande }}
                                mois</strong>
                        </div>
                    </div>
                    <div class="col-12 md:col-6 lg:col-3">
                        <div class="p-3 bg-green-50 border-round text-center">
                            <span class="block text-color-secondary mb-1">Besoin Investissement</span>
                            <strong class="text-lg text-green-700">{{ besoinReelInvestissementFinal() |
                                currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</strong>
                        </div>
                    </div>
                    <div class="col-12 md:col-6 lg:col-3">
                        <div class="p-3 bg-purple-50 border-round text-center">
                            <span class="block text-color-secondary mb-1">Besoin Exploitation</span>
                            <strong class="text-lg text-purple-700">{{ besoinReelExploitationFinal() |
                                currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</strong>
                        </div>
                    </div>

                    <!-- Besoin total -->
                    <div class="col-12 mt-3">
                        <div class="p-4 bg-primary border-round text-white text-center">
                            <span class="block text-lg mb-1">Besoin Total de Financement (effectif)</span>
                            <strong class="text-3xl">{{ besoinTotalFinancementFinal() |
                                currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</strong>
                        </div>
                    </div>

                    <!-- Personnes caution -->
                    <div class="col-12 mt-4">
                        <h3 class="text-lg font-bold mb-3 border-bottom-1 surface-border pb-2">
                            <i class="pi pi-users mr-2"></i>Personnes caution ({{ personnecautions.length }})
                        </h3>
                        <div *ngIf="personnecautions.length > 0" class="grid">
                            <div class="col-12 md:col-6" *ngFor="let caution of personnecautions">
                                <div class="p-3 bg-gray-50 border-round">
                                    <strong>{{ caution.prenom }} {{ caution.nom }}</strong>
                                    <span *ngIf="caution.profession" class="ml-2 text-color-secondary">- {{
                                        caution.profession }}</span>
                                </div>
                            </div>
                        </div>
                        <div *ngIf="personnecautions.length === 0"
                            class="p-3 bg-yellow-50 border-round border-1 border-yellow-200">
                            <i class="pi pi-info-circle mr-2"></i>Aucune personne caution ajoutée
                        </div>
                    </div>

                    <!-- Message de soumission -->
                    <div class="col-12 mt-4">
                        <div class="p-3 bg-yellow-50 border-round border-1 border-yellow-200">
                            <i class="pi pi-exclamation-triangle mr-2 text-yellow-700"></i>
                            <span>En soumettant cette analyse, le dossier sera transféré au comité de crédit pour
                                examen.</span>
                        </div>
                    </div>
                </div>

                <ng-template pTemplate="footer">
                    <div class="flex justify-content-end">
                        <button pButton label="Soumettre l'Analyse" icon="pi pi-send" (click)="submitAnalyse()"
                            [loading]="loading()" class="p-button-success" [disabled]="!state().analyseExiste"></button>
                    </div>
                </ng-template>
            </p-card>
        </div>

        <!-- ==================== ÉTAPE 4: BESOIN CRÉDIT (Optionnel) ==================== -->
        <div *ngIf="activeIndex() === 4">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="flex align-items-center justify-content-between p-3 bg-primary text-white">
                        <h2 class="m-0 text-xl font-bold">BESOIN EN CRÉDIT</h2>
                        <span class="text-sm">en GNF</span>
                    </div>
                </ng-template>

                <form [formGroup]="besoinCreditForm">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="p-3 text-left border-1 surface-border" style="width: 30%">Désignation
                                    </th>
                                    <th class="p-3 text-center border-1 surface-border bg-blue-50" style="width: 23%">
                                        Montant</th>
                                    <th class="p-3 text-center border-1 surface-border bg-yellow-50" style="width: 23%">
                                        Ajustement</th>
                                    <th class="p-3 text-center border-1 surface-border bg-green-50" style="width: 24%">
                                        Montant effectif</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- ========== SECTION INVESTISSEMENT ========== -->
                                <tr class="bg-blue-100">
                                    <td class="p-2 font-bold border-1 surface-border" colspan="4">
                                        <i class="pi pi-building mr-2"></i>INVESTISSEMENT
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-4 border-1 surface-border">Coût de l'équipement</td>
                                    <td class="p-1 border-1 surface-border">
                                        <p-inputNumber formControlName="coutEquipement" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-1 border-1 surface-border bg-yellow-50">
                                        <p-inputNumber formControlName="ajustCoutEquipement" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-2 text-right border-1 surface-border bg-green-50 font-semibold">
                                        {{ effCoutEquipement() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-4 border-1 surface-border">Dépenses rattachées</td>
                                    <td class="p-1 border-1 surface-border">
                                        <p-inputNumber formControlName="depensesRattachees" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-1 border-1 surface-border bg-yellow-50">
                                        <p-inputNumber formControlName="ajustDepensesRattachees" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-2 text-right border-1 surface-border bg-green-50 font-semibold">
                                        {{ effDepensesRattachees() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <!-- Total Investissement -->
                                <tr class="bg-blue-50">
                                    <td class="p-2 pl-4 font-semibold border-1 surface-border">Total Investissement</td>
                                    <td class="p-2 text-right border-1 surface-border font-bold text-blue-700">
                                        {{ totalInvestissementMontant() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-yellow-700 bg-yellow-50">
                                        {{ totalInvestissementAjuste() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-green-700 bg-green-50">
                                        {{ totalInvestissementEffectif() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-4 border-1 surface-border text-green-700">(-) Apport personnel
                                    </td>
                                    <td class="p-1 border-1 surface-border">
                                        <p-inputNumber formControlName="apportPersonnel" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-1 border-1 surface-border bg-yellow-50">
                                        <p-inputNumber formControlName="ajustApportPersonnel" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border bg-green-50 font-semibold text-green-700">
                                        {{ effApportPersonnel() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <!-- Besoin réel investissement -->
                                <tr class="bg-blue-200">
                                    <td class="p-2 font-bold border-1 surface-border">= BESOIN RÉEL INVESTISSEMENT</td>
                                    <td class="p-2 text-right border-1 surface-border font-bold text-blue-800">
                                        {{ besoinReelInvestissementMontant() | currency:'GNF':'symbol':'1.0-0':'fr-FR'
                                        }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-yellow-800 bg-yellow-100">
                                        {{ besoinReelInvestissementAjuste() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-green-800 bg-green-100">
                                        {{ besoinReelInvestissementFinal() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <!-- Separator -->
                                <tr>
                                    <td colspan="4" class="p-2"></td>
                                </tr>

                                <!-- ========== SECTION EXPLOITATION ========== -->
                                <tr class="bg-purple-100">
                                    <td class="p-2 font-bold border-1 surface-border" colspan="4">
                                        <i class="pi pi-sync mr-2"></i>EXPLOITATION
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-4 border-1 surface-border">Coût d'achat du cycle</td>
                                    <td class="p-1 border-1 surface-border">
                                        <p-inputNumber formControlName="coutAchatCycle" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-1 border-1 surface-border bg-yellow-50">
                                        <p-inputNumber formControlName="ajustCoutAchatCycle" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-2 text-right border-1 surface-border bg-green-50 font-semibold">
                                        {{ effCoutAchatCycle() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-4 border-1 surface-border">Nombre de cycles à financer</td>
                                    <td class="p-1 border-1 surface-border" colspan="2">
                                        <p-inputNumber formControlName="nbreCycleFinancer" [showButtons]="true"
                                            [min]="1" [max]="12" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-2 text-center border-1 surface-border bg-green-50 font-semibold">
                                        {{ exploitationNbreCycles() }}
                                    </td>
                                </tr>

                                <!-- Besoin brut exploitation -->
                                <tr class="bg-purple-50">
                                    <td class="p-2 pl-4 font-semibold border-1 surface-border">Besoin brut (Coût ×
                                        Cycles)</td>
                                    <td class="p-2 text-right border-1 surface-border font-bold text-purple-700">
                                        {{ besoinBrutExploitationMontant() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-yellow-700 bg-yellow-50">
                                        {{ besoinBrutExploitationAjuste() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-green-700 bg-green-50">
                                        {{ besoinBrutExploitationEffectif() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <!-- Ressources disponibles header -->
                                <tr class="bg-gray-50">
                                    <td class="p-2 pl-4 font-semibold border-1 surface-border text-green-700"
                                        colspan="4">
                                        (-) Ressources disponibles
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-6 border-1 surface-border">Trésorerie disponible</td>
                                    <td class="p-1 border-1 surface-border">
                                        <p-inputNumber formControlName="tresorerieDisponible" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-1 border-1 surface-border bg-yellow-50">
                                        <p-inputNumber formControlName="ajustTresorerieDispo" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-2 text-right border-1 surface-border bg-green-50 font-semibold">
                                        {{ effTresorerieDispo() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-6 border-1 surface-border">Stock actuel</td>
                                    <td class="p-1 border-1 surface-border">
                                        <p-inputNumber formControlName="stockActuel" mode="decimal" [useGrouping]="true"
                                            class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-1 border-1 surface-border bg-yellow-50">
                                        <p-inputNumber formControlName="ajustStockActuel" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-2 text-right border-1 surface-border bg-green-50 font-semibold">
                                        {{ effStockActuel() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-6 border-1 surface-border">Comptes à recevoir</td>
                                    <td class="p-1 border-1 surface-border">
                                        <p-inputNumber formControlName="comptesRecevoir" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-1 border-1 surface-border bg-yellow-50">
                                        <p-inputNumber formControlName="ajustComptesRecevoir" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-2 text-right border-1 surface-border bg-green-50 font-semibold">
                                        {{ effComptesRecevoir() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <!-- Total ressources -->
                                <tr class="bg-green-50">
                                    <td class="p-2 pl-4 font-semibold border-1 surface-border text-green-700">Total
                                        ressources disponibles</td>
                                    <td class="p-2 text-right border-1 surface-border font-bold text-green-700">
                                        {{ ressourcesDisponiblesMontant() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-yellow-700 bg-yellow-50">
                                        {{ ressourcesDisponiblesAjuste() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td class="p-2 text-right border-1 surface-border font-bold text-green-800">
                                        {{ ressourcesDisponiblesEffectif() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <!-- Dettes header -->
                                <tr class="bg-gray-50">
                                    <td class="p-2 pl-4 font-semibold border-1 surface-border text-red-700" colspan="4">
                                        (+) Dettes à payer
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-6 border-1 surface-border">Dettes fournisseurs</td>
                                    <td class="p-1 border-1 surface-border">
                                        <p-inputNumber formControlName="dettesFournisseurs" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-1 border-1 surface-border bg-yellow-50">
                                        <p-inputNumber formControlName="ajustDettesFournisseurs" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-2 text-right border-1 surface-border bg-green-50 font-semibold">
                                        {{ effDettesFournisseurs() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-2 pl-6 border-1 surface-border">Crédit fournisseur</td>
                                    <td class="p-1 border-1 surface-border">
                                        <p-inputNumber formControlName="creditFournisseur" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-1 border-1 surface-border bg-yellow-50">
                                        <p-inputNumber formControlName="ajustCreditFournisseur" mode="decimal"
                                            [useGrouping]="true" class="w-full input-sm"></p-inputNumber>
                                    </td>
                                    <td class="p-2 text-right border-1 surface-border bg-green-50 font-semibold">
                                        {{ effCreditFournisseur() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <!-- Total dettes -->
                                <tr class="bg-red-50">
                                    <td class="p-2 pl-4 font-semibold border-1 surface-border text-red-700">Total dettes
                                        à payer</td>
                                    <td class="p-2 text-right border-1 surface-border font-bold text-red-700">
                                        {{ totalDettesMontant() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-yellow-700 bg-yellow-50">
                                        {{ totalDettesAjuste() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-red-800 bg-red-100">
                                        {{ totalDettesEffectif() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <!-- Besoin réel exploitation -->
                                <tr class="bg-purple-200">
                                    <td class="p-2 font-bold border-1 surface-border">= BESOIN RÉEL EXPLOITATION</td>
                                    <td class="p-2 text-right border-1 surface-border font-bold text-purple-800">
                                        {{ besoinReelExploitationMontant() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-yellow-800 bg-yellow-100">
                                        {{ besoinReelExploitationAjuste() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td
                                        class="p-2 text-right border-1 surface-border font-bold text-green-800 bg-green-100">
                                        {{ besoinReelExploitationFinal() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>

                                <!-- Separator -->
                                <tr>
                                    <td colspan="4" class="p-3"></td>
                                </tr>

                                <!-- ========== TOTAL FINANCEMENT ========== -->
                                <tr class="bg-primary text-white">
                                    <td class="p-3 font-bold border-1 border-white">
                                        <i class="pi pi-wallet mr-2"></i>BESOIN TOTAL DE FINANCEMENT
                                    </td>
                                    <td class="p-3 text-right border-1 border-white font-bold text-xl">
                                        {{ besoinTotalFinancementMontant() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td class="p-3 text-right border-1 border-white font-bold text-xl bg-yellow-600">
                                        {{ besoinTotalFinancementAjuste() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                    <td class="p-3 text-right border-1 border-white font-bold text-xl bg-green-600">
                                        {{ besoinTotalFinancementFinal() | currency:'GNF':'symbol':'1.0-0':'fr-FR' }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Récapitulatif visuel -->
                    <div class="grid mt-4">
                        <div class="col-12 md:col-4">
                            <div class="p-3 bg-blue-100 border-round text-center">
                                <span class="block text-color-secondary mb-1">Besoin Investissement</span>
                                <strong class="text-lg text-blue-700">{{ besoinReelInvestissementFinal() |
                                    currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</strong>
                            </div>
                        </div>
                        <div class="col-12 md:col-4">
                            <div class="p-3 bg-purple-100 border-round text-center">
                                <span class="block text-color-secondary mb-1">Besoin Exploitation</span>
                                <strong class="text-lg text-purple-700">{{ besoinReelExploitationFinal() |
                                    currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</strong>
                            </div>
                        </div>
                        <div class="col-12 md:col-4">
                            <div class="p-3 bg-green-100 border-round text-center">
                                <span class="block text-color-secondary mb-1">Total Financement (effectif)</span>
                                <strong class="text-xl text-green-700">{{ besoinTotalFinancementFinal() |
                                    currency:'GNF':'symbol':'1.0-0':'fr-FR' }}</strong>
                            </div>
                        </div>
                    </div>
                </form>

                <ng-template pTemplate="footer">
                    <div class="flex justify-content-end gap-2">
                        <button pButton label="Enregistrer Besoin Crédit" icon="pi pi-save" (click)="saveBesoinCredit()"
                            [loading]="savingBesoinCredit()" [disabled]="!state().analyseExiste"></button>
                    </div>
                </ng-template>
            </p-card>
        </div>

        <!-- Boutons de navigation -->
        <div class="flex justify-content-between mt-4">
            <button pButton type="button" label="Précédent" icon="pi pi-arrow-left" class="p-button-outlined"
                [disabled]="activeIndex() === 0" (click)="prevStep()"></button>
            <button pButton type="button" label="Suivant" icon="pi pi-arrow-right" iconPos="right"
                class="p-button-outlined" [disabled]="activeIndex() === 4" (click)="nextStep()"></button>
        </div>
    </div>
</div>