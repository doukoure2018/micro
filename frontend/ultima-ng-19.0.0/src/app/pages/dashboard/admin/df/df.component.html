<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="df-container">
    <!-- En-tête -->
    <div class="header-section">
        <div class="header-content">
            <h2><i class="pi pi-building"></i> Direction Financière - Gestion des demandes</h2>
            <p class="subtitle">Confirmez les demandes validées par le DRH et exportez les données</p>
        </div>

        <div class="header-actions">
            <p-button icon="pi pi-refresh" label="Actualiser" [text]="true" (onClick)="loadDemandesGroupedByDate()"
                [loading]="isLoading()"></p-button>

            @if (selectedStatut() === 'CONFIRMER') {
            <p-button icon="pi pi-file-excel" label="Exporter tout (Excel)" severity="success" [outlined]="true"
                (onClick)="exportAllConfirmed()" [loading]="isExporting()"></p-button>
            }
        </div>
    </div>

    <!-- Filtres par statut -->
    <div class="filter-section">
        <p-tabView (onChange)="onStatutChange($event.index === 0 ? 'VALIDER' : 'CONFIRMER')">
            <p-tabPanel>
                <ng-template pTemplate="header">
                    <i class="pi pi-clock mr-2"></i>
                    <span>À confirmer (validées par DRH)</span>
                    <p-badge [value]="selectedStatut() === 'VALIDER' ? totalDemandes().toString() : ''" severity="warn"
                        class="ml-2"></p-badge>
                </ng-template>
            </p-tabPanel>
            <p-tabPanel>
                <ng-template pTemplate="header">
                    <i class="pi pi-check-circle mr-2"></i>
                    <span>Confirmées</span>
                </ng-template>
            </p-tabPanel>
        </p-tabView>
    </div>

    <!-- Stats globales -->
    <div class="stats-section">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="pi pi-file"></i>
            </div>
            <div class="stat-info">
                <span class="stat-value">{{ totalDemandes() }}</span>
                <span class="stat-label">Demandes</span>
            </div>
        </div>

        <div class="stat-card amount">
            <div class="stat-icon">
                <i class="pi pi-wallet"></i>
            </div>
            <div class="stat-info">
                <span class="stat-value">{{ formatMontant(totalMontant()) }}</span>
                <span class="stat-label">Montant total</span>
            </div>
        </div>

        @if (hasSelection() && selectedStatut() === 'VALIDER') {
        <div class="stat-card selected">
            <div class="stat-icon">
                <i class="pi pi-check-square"></i>
            </div>
            <div class="stat-info">
                <span class="stat-value">{{ totalSelected() }}</span>
                <span class="stat-label">Sélectionnées</span>
            </div>
        </div>
        }
    </div>

    <!-- Bouton confirmation massive -->
    @if (hasSelection() && selectedStatut() === 'VALIDER') {
    <div class="bulk-action-bar">
        <div class="selection-info">
            <i class="pi pi-info-circle"></i>
            <span>{{ totalSelected() }} demande(s) sélectionnée(s)</span>
        </div>
        <p-button icon="pi pi-check-circle" label="Confirmer la sélection" severity="success"
            (onClick)="confirmConfirmerSelection()" [loading]="isConfirming()"></p-button>
    </div>
    }

    <!-- Loading -->
    @if (isLoading()) {
    <div class="loading-container">
        <p-progressSpinner></p-progressSpinner>
        <span>Chargement des demandes...</span>
    </div>
    }

    <!-- Liste des demandes par jour -->
    @if (!isLoading()) {
    @if (demandesParJour().length === 0) {
    <div class="empty-state">
        <i class="pi pi-inbox"></i>
        <h3>Aucune demande</h3>
        <p>
            @if (selectedStatut() === 'VALIDER') {
            Il n'y a pas de demandes validées par le DRH à confirmer pour le moment.
            } @else {
            Il n'y a pas de demandes confirmées pour le moment.
            }
        </p>
    </div>
    } @else {
    <div class="days-list">
        @for (jour of demandesParJour(); track jour.date) {
        <div class="day-card" [class.expanded]="jour.expanded">
            <!-- En-tête du jour -->
            <div class="day-header" (click)="toggleDay(jour)">
                <div class="day-info">
                    <div class="day-toggle">
                        <i [class]="jour.expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></i>
                    </div>
                    <div class="day-date">
                        <span class="date-full">{{ formatDate(jour.date) }}</span>
                        <span class="date-short">{{ formatDateShort(jour.date) }}</span>
                    </div>
                    <div class="day-badges">
                        <p-chip [label]="jour.count + ' demande(s)'" icon="pi pi-file"></p-chip>
                        <p-chip [label]="formatMontant(jour.totalAmount)" icon="pi pi-wallet"
                            styleClass="amount-chip"></p-chip>
                    </div>
                </div>

                <div class="day-actions" (click)="$event.stopPropagation()">
                    @if (selectedStatut() === 'VALIDER') {
                    <p-button icon="pi pi-check-circle" label="Tout confirmer" severity="success" [outlined]="true"
                        size="small" (onClick)="confirmConfirmerJour(jour)" [loading]="isConfirming()"></p-button>
                    } @else {
                    <p-button icon="pi pi-file-excel" label="Exporter" severity="success" [outlined]="true" size="small"
                        (onClick)="exportJour(jour)" [loading]="isExporting()"></p-button>
                    }
                </div>
            </div>

            <!-- Contenu du jour -->
            @if (jour.expanded) {
            <div class="day-content">
                <!-- Sélection globale (seulement pour VALIDER) -->
                @if (selectedStatut() === 'VALIDER') {
                <div class="select-all-row">
                    <p-checkbox [(ngModel)]="jour.allSelected" [binary]="true" (onChange)="toggleSelectAll(jour)"
                        inputId="selectAll-{{jour.date}}"></p-checkbox>
                    <label for="selectAll-{{jour.date}}">
                        Tout sélectionner ({{ jour.selectedIds?.length || 0 }}/{{ jour.count }})
                    </label>
                </div>
                }

                <!-- Table des demandes -->
                <p-table [value]="jour.demandes" styleClass="p-datatable-sm p-datatable-striped"
                    [tableStyle]="{ 'min-width': '60rem' }">
                    <ng-template pTemplate="header">
                        <tr>
                            @if (selectedStatut() === 'VALIDER') {
                            <th style="width: 50px"></th>
                            }
                            <th style="width: 80px">Matricule</th>
                            <th>Nom & Prénom</th>
                            <th style="width: 130px">N° Compte</th>
                            <th style="width: 120px">Téléphone</th>
                            <th style="width: 140px">Montant</th>
                            <th style="width: 100px">Heure</th>
                            <th style="width: 150px">Actions</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-demande>
                        <tr [class.selected-row]="isSelected(jour, demande.id)">
                            @if (selectedStatut() === 'VALIDER') {
                            <td>
                                <p-checkbox [binary]="true" [ngModel]="isSelected(jour, demande.id)"
                                    (onChange)="toggleSelectDemande(jour, demande.id)"></p-checkbox>
                            </td>
                            }
                            <td>
                                <span class="matricule-badge">{{ demande.matricule }}</span>
                            </td>
                            <td>
                                <div class="person-info">
                                    <span class="person-name">{{ demande.prenomPersonnel }} {{ demande.nomPersonnel
                                        }}</span>
                                </div>
                            </td>
                            <td>
                                <span class="numero-compte">{{ demande.numeroCompte || '-' }}</span>
                            </td>
                            <td>
                                <span class="phone">{{ demande.phone || '-' }}</span>
                            </td>
                            <td class="text-right">
                                <span class="montant">{{ formatMontant(demande.amount) }}</span>
                            </td>
                            <td>
                                {{ demande.createdAt | javaDate:'HH:mm' }}
                            </td>
                            <td>
                                @if (selectedStatut() === 'VALIDER') {
                                <div class="action-buttons">
                                    <p-button icon="pi pi-check" severity="success" [rounded]="true" [text]="true"
                                        size="small" (onClick)="confirmConfirmer(demande)"
                                        [loading]="confirmingId() === demande.id" pTooltip="Confirmer"></p-button>
                                    <p-button icon="pi pi-times" severity="danger" [rounded]="true" [text]="true"
                                        size="small" (onClick)="confirmRejeter(demande)"
                                        [loading]="confirmingId() === demande.id" pTooltip="Rejeter"></p-button>
                                </div>
                                } @else {
                                <p-tag [value]="getStatutLabel(demande.statut)"
                                    [severity]="getStatutSeverity(demande.statut)"></p-tag>
                                }
                            </td>
                        </tr>
                    </ng-template>

                    <!-- Footer avec total du jour -->
                    <ng-template pTemplate="footer">
                        <tr>
                            <td [attr.colspan]="selectedStatut() === 'VALIDER' ? 5 : 4" class="text-right">
                                <strong>Total du jour:</strong>
                            </td>
                            <td class="text-right">
                                <strong class="montant-total">{{ formatMontant(jour.totalAmount) }}</strong>
                            </td>
                            <td colspan="2"></td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
            }
        </div>
        }
    </div>
    }
    }
</div>