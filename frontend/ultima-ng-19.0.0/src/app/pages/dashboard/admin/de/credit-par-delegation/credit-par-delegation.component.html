<div class="grid">
    <div class="col-12">
        <p-toast></p-toast>

        <!-- Loading -->
        <div *ngIf="loading()" class="flex justify-center items-center py-8">
            <p-progressSpinner strokeWidth="4" [style]="{width: '50px', height: '50px'}"></p-progressSpinner>
            <span class="ml-3">Chargement...</span>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <!-- WORKFLOW CREDIT - Demandes a Valider par le DE                        -->
        <!-- ═══════════════════════════════════════════════════════════════════════ -->
        <div class="col-12" *ngIf="!loading()">
            <div class="card border-l-4 border-green-500">
                <div class="flex flex-wrap gap-3 items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold m-0">
                        <i class="pi pi-check-square mr-2 text-green-600"></i>
                        Demandes de Credit en attente de Validation DE
                        <p-badge *ngIf="workflowAValiderDE().length > 0"
                            [value]="workflowAValiderDE().length.toString()" severity="success" class="ml-2"></p-badge>
                    </h3>
                    <button pButton type="button" icon="pi pi-refresh" (click)="refreshWorkflow()"
                        class="p-button-secondary p-button-sm" pTooltip="Actualiser"></button>
                </div>

                <p-table #dtWorkflowDE [value]="workflowAValiderDE()" [paginator]="true" [rows]="10"
                    [showCurrentPageReport]="true" responsiveLayout="scroll"
                    currentPageReportTemplate="Affichage de {first} a {last} sur {totalRecords}"
                    [rowsPerPageOptions]="[10, 25, 50]"
                    [globalFilterFields]="['nom', 'prenom', 'numeroMembre', 'objectCredit', 'delegationLibele', 'agenceLibele', 'avisDr']"
                    styleClass="p-datatable-striped">

                    <ng-template pTemplate="caption">
                        <div class="flex flex-wrap gap-3 items-center justify-between">
                            <p-icon-field class="w-full sm:w-80">
                                <p-inputicon class="pi pi-search" />
                                <input pInputText type="text" (input)="onGlobalFilter(dtWorkflowDE, $event)"
                                    placeholder="Rechercher..." class="w-full" />
                            </p-icon-field>
                            <div class="text-sm text-500">
                                {{ workflowAValiderDE().length }} demande(s) en attente
                            </div>
                        </div>
                    </ng-template>

                    <ng-template pTemplate="header">
                        <tr>
                            <th pSortableColumn="createdAt" style="width:10%">Date <p-sortIcon field="createdAt"></p-sortIcon></th>
                            <th pSortableColumn="nom" style="width:15%">Client <p-sortIcon field="nom"></p-sortIcon></th>
                            <th style="width:10%">Delegation</th>
                            <th style="width:10%">Agence</th>
                            <th pSortableColumn="montantDemande" class="text-right" style="width:13%">Montant <p-sortIcon field="montantDemande"></p-sortIcon></th>
                            <th style="width:12%">Objet</th>
                            <th style="width:14%">Avis DR</th>
                            <th class="text-center" style="width:16%">Actions</th>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-demande>
                        <tr class="hover:bg-surface-50">
                            <td>{{ demande.createdAt | date:'dd/MM/yyyy' }}</td>
                            <td>
                                <div class="flex flex-column gap-1">
                                    <span class="font-semibold">{{ demande.prenom }} {{ demande.nom }}</span>
                                    <small class="text-500">{{ demande.numeroMembre }}</small>
                                </div>
                            </td>
                            <td><p-chip [label]="demande.delegationLibele || 'N/A'" styleClass="text-xs bg-purple-50 text-purple-700"></p-chip></td>
                            <td><p-chip [label]="demande.agenceLibele || 'N/A'" styleClass="text-xs"></p-chip></td>
                            <td class="text-right font-bold text-green-600">{{ formatMontantGNF(demande.montantDemande) }}</td>
                            <td>{{ demande.objectCredit }}</td>
                            <td>
                                <small *ngIf="demande.avisDr" class="text-600">{{ demande.avisDr | slice:0:40 }}...</small>
                                <small *ngIf="!demande.avisDr" class="text-400">-</small>
                            </td>
                            <td class="text-center">
                                <div class="flex gap-2 justify-center">
                                    <p-button icon="pi pi-eye" (click)="viewDemandeDetail(demande.demandeIndividuelId)"
                                        size="small" severity="info" pTooltip="Voir detail"></p-button>
                                    <p-button icon="pi pi-check" (click)="ouvrirValidation(demande)"
                                        size="small" severity="success" pTooltip="Valider"></p-button>
                                    <p-button icon="pi pi-times" (click)="ouvrirRejet(demande)"
                                        size="small" severity="danger" pTooltip="Rejeter"></p-button>
                                </div>
                            </td>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="8" class="text-center p-6">
                                <div class="flex flex-col items-center gap-3">
                                    <i class="pi pi-check-circle text-6xl text-green-500"></i>
                                    <span class="text-600 font-medium text-xl">Aucune demande en attente</span>
                                    <small class="text-500">Toutes les demandes ont ete traitees</small>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>
    </div>
</div>

<!-- Dialog Validation Finale -->
<p-dialog header="Validation Finale" [(visible)]="showValidationDialog" [modal]="true" [style]="{width: '500px'}">
    <div *ngIf="selectedDemande" class="mb-4 p-3 bg-green-50 border-round">
        <p class="font-semibold m-0">{{ selectedDemande.prenom }} {{ selectedDemande.nom }}</p>
        <p class="text-600 m-0">{{ formatMontantGNF(selectedDemande.montantDemande) }} - {{ selectedDemande.objectCredit }}</p>
    </div>
    <form [formGroup]="validationForm">
        <div class="flex flex-col gap-2 mb-4">
            <label class="font-semibold">Avis de la Direction *</label>
            <textarea pTextarea formControlName="avis" rows="4" placeholder="Saisissez votre avis pour la validation finale..." class="w-full"></textarea>
            <small *ngIf="validationForm.get('avis')?.touched && validationForm.get('avis')?.invalid" class="text-red-500">
                L'avis est obligatoire (min 10 caracteres)
            </small>
        </div>
    </form>
    <ng-template pTemplate="footer">
        <p-button label="Annuler" icon="pi pi-times" (click)="showValidationDialog = false" severity="secondary"></p-button>
        <p-button label="Valider definitivement" icon="pi pi-check-circle" (click)="confirmerValidation()" severity="success"
            [disabled]="validationForm.invalid"></p-button>
    </ng-template>
</p-dialog>

<!-- Dialog Rejet -->
<p-dialog header="Rejeter la demande" [(visible)]="showRejetDialog" [modal]="true" [style]="{width: '600px'}">
    <div *ngIf="selectedDemande" class="mb-4 p-3 bg-red-50 border-round">
        <p class="font-semibold m-0">{{ selectedDemande.prenom }} {{ selectedDemande.nom }}</p>
        <p class="text-600 m-0">{{ formatMontantGNF(selectedDemande.montantDemande) }}</p>
    </div>
    <form [formGroup]="rejetForm">
        <div class="flex flex-col gap-2 mb-4">
            <label class="font-semibold">Motif de rejet *</label>
            <textarea pTextarea formControlName="motifRejet" rows="3" placeholder="Motif du rejet..." class="w-full"></textarea>
            <small *ngIf="rejetForm.get('motifRejet')?.touched && rejetForm.get('motifRejet')?.invalid" class="text-red-500">
                Le motif est obligatoire (min 10 caracteres)
            </small>
        </div>
        <div class="flex flex-col gap-2 mb-4">
            <label class="font-semibold">Sections a revoir *</label>
            <div class="flex flex-wrap gap-3">
                <div *ngFor="let option of sectionsOptions" class="flex items-center gap-2">
                    <input type="checkbox" [value]="option.value" (change)="toggleSection(option.value, $event)">
                    <label>{{ option.label }}</label>
                </div>
            </div>
            <small *ngIf="rejetForm.get('sectionsARevoir')?.touched && rejetForm.get('sectionsARevoir')?.value?.length === 0" class="text-red-500">
                Au moins une section doit etre selectionnee
            </small>
        </div>
        <div class="flex flex-col gap-2">
            <label class="font-semibold">Instructions pour le DR</label>
            <textarea pTextarea formControlName="instructions" rows="2" placeholder="Instructions..." class="w-full"></textarea>
        </div>
    </form>
    <ng-template pTemplate="footer">
        <p-button label="Annuler" icon="pi pi-times" (click)="showRejetDialog = false" severity="secondary"></p-button>
        <p-button label="Rejeter" icon="pi pi-times-circle" (click)="confirmerRejet()" severity="danger"
            [disabled]="rejetForm.invalid"></p-button>
    </ng-template>
</p-dialog>
