<p-toast></p-toast>

<div class="suivi-arrete-caisse">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h1>
                <i class="pi pi-file-check mr-2"></i>
                Suivi des Arrêtés de Caisse
            </h1>
            <p class="subtitle">Visualisation des arrêtés de tous les points de vente</p>
        </div>
        <div class="header-actions">
            <p-button icon="pi pi-refresh" label="Actualiser" [outlined]="true" [loading]="state().loading"
                (onClick)="refresh()" pTooltip="Recharger les données">
            </p-button>
            <p-button icon="pi pi-file-excel" label="Exporter" severity="success" (onClick)="exportToExcel()">
            </p-button>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="stats-grid">
        <p-card styleClass="stat-card stat-warning">
            <div class="stat-content">
                <div class="stat-icon warning">
                    <i class="pi pi-clock"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value">{{ stats().totalEncours }}</span>
                    <span class="stat-label">En cours</span>
                    <span class="stat-amount">{{ formatMontant(stats().montantEncours) }}</span>
                </div>
            </div>
        </p-card>

        <p-card styleClass="stat-card stat-success">
            <div class="stat-content">
                <div class="stat-icon success">
                    <i class="pi pi-check-circle"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value">{{ stats().totalValide }}</span>
                    <span class="stat-label">Validés</span>
                    <span class="stat-amount">{{ formatMontant(stats().montantValide) }}</span>
                </div>
            </div>
        </p-card>

        <p-card styleClass="stat-card stat-primary">
            <div class="stat-content">
                <div class="stat-icon primary">
                    <i class="pi pi-list"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-value">{{ stats().total }}</span>
                    <span class="stat-label">Total</span>
                    <span class="stat-amount">{{ formatMontant(stats().montantTotal) }}</span>
                </div>
            </div>
        </p-card>
    </div>

    <!-- Filtres -->
    <p-card styleClass="filters-card">
        <ng-template pTemplate="header">
            <div class="filters-header">
                <h3><i class="pi pi-filter mr-2"></i>Filtres</h3>
                <p-selectButton [options]="viewModeOptions" [ngModel]="state().viewMode"
                    (onChange)="onViewModeChange($event)" optionLabel="label" optionValue="value">
                </p-selectButton>
            </div>
        </ng-template>

        <div class="filters-grid">
            <!-- Recherche globale -->
            <div class="filter-item filter-search">
                <label>Recherche</label>
                <p-iconField iconPosition="left">
                    <p-inputIcon styleClass="pi pi-search"></p-inputIcon>
                    <input type="text" pInputText placeholder="Rechercher..." [ngModel]="filters().globalFilter"
                        (ngModelChange)="updateFilter('globalFilter', $event)" />
                </p-iconField>
            </div>

            <!-- Délégation -->
            <div class="filter-item">
                <label>Délégation</label>
                <p-dropdown [options]="delegations()" [ngModel]="filters().delegation"
                    (ngModelChange)="updateFilter('delegation', $event)" optionLabel="label" optionValue="value"
                    placeholder="Toutes" [showClear]="true" styleClass="w-full">
                </p-dropdown>
            </div>

            <!-- Agence -->
            <div class="filter-item">
                <label>Agence</label>
                <p-dropdown [options]="agences()" [ngModel]="filters().agence"
                    (ngModelChange)="updateFilter('agence', $event)" optionLabel="label" optionValue="value"
                    placeholder="Toutes" [showClear]="true" styleClass="w-full">
                </p-dropdown>
            </div>

            <!-- Point de vente -->
            <div class="filter-item">
                <label>Point de vente</label>
                <p-dropdown [options]="pointventes()" [ngModel]="filters().pointvente"
                    (ngModelChange)="updateFilter('pointvente', $event)" optionLabel="label" optionValue="value"
                    placeholder="Tous" [showClear]="true" styleClass="w-full">
                </p-dropdown>
            </div>

            <!-- Statut -->
            <div class="filter-item">
                <label>Statut</label>
                <p-dropdown [options]="statutOptions" [ngModel]="filters().statut"
                    (ngModelChange)="updateFilter('statut', $event)" optionLabel="label" optionValue="value"
                    placeholder="Tous" styleClass="w-full">
                </p-dropdown>
            </div>

            <!-- Date début - Input natif -->
            <div class="filter-item">
                <label>Date début</label>
                <input type="date" pInputText class="p-inputtext w-full" [ngModel]="filters().dateDebut"
                    (ngModelChange)="updateFilter('dateDebut', $event)" />
            </div>

            <!-- Date fin - Input natif -->
            <div class="filter-item">
                <label>Date fin</label>
                <input type="date" pInputText class="p-inputtext w-full" [ngModel]="filters().dateFin"
                    (ngModelChange)="updateFilter('dateFin', $event)" />
            </div>
        </div>

        <div class="filters-footer">
            <p-button icon="pi pi-times" label="Réinitialiser" [outlined]="true" severity="secondary"
                (onClick)="resetFilters()">
            </p-button>
            <span class="results-count">
                <p-badge [value]="filteredArretes().length.toString()" severity="info"></p-badge>
                résultat(s) sur {{ state().arretes.length }}
            </span>
        </div>
    </p-card>

    <!-- Loading -->
    @if (state().loading) {
    <div class="loading-container">
        <p-progressSpinner strokeWidth="4" animationDuration=".5s"></p-progressSpinner>
        <p>Chargement des données...</p>
    </div>
    }

    <!-- Error -->
    @if (state().error) {
    <p-message severity="error" [text]="state().error!" styleClass="w-full mb-4"></p-message>
    }

    <!-- Table -->
    @if (!state().loading && !state().error) {
    <p-card styleClass="table-card">
        <p-table [value]="filteredArretes()" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10, 25, 50, 100]"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Affichage {first} - {last} sur {totalRecords} arrêtés"
            [globalFilterFields]="['delegationNom', 'agenceNom', 'pointventeNom']"
            styleClass="p-datatable-sm p-datatable-striped" [tableStyle]="{ 'min-width': '80rem' }" [rowHover]="true"
            [scrollable]="true" scrollHeight="500px">

            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="id" style="width: 80px">
                        ID <p-sortIcon field="id"></p-sortIcon>
                    </th>
                    <th pSortableColumn="delegationNom">
                        Délégation <p-sortIcon field="delegationNom"></p-sortIcon>
                    </th>
                    <th pSortableColumn="agenceNom">
                        Agence <p-sortIcon field="agenceNom"></p-sortIcon>
                    </th>
                    <th pSortableColumn="pointventeNom">
                        Point de vente <p-sortIcon field="pointventeNom"></p-sortIcon>
                    </th>
                    <th pSortableColumn="montant" class="text-right">
                        Montant <p-sortIcon field="montant"></p-sortIcon>
                    </th>
                    <th pSortableColumn="dateArreteCaisse">
                        Date Arrêté <p-sortIcon field="dateArreteCaisse"></p-sortIcon>
                    </th>
                    <th pSortableColumn="dateRemonte">
                        Date Remontée <p-sortIcon field="dateRemonte"></p-sortIcon>
                    </th>
                    <th pSortableColumn="statut" style="width: 120px">
                        Statut <p-sortIcon field="statut"></p-sortIcon>
                    </th>
                    <th style="width: 120px">Document</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-arrete>
                <tr>
                    <td>
                        <span class="id-badge">#{{ arrete.id }}</span>
                    </td>
                    <td>{{ arrete.delegationNom || '-' }}</td>
                    <td>{{ arrete.agenceNom || '-' }}</td>
                    <td>{{ arrete.pointventeNom || '-' }}</td>
                    <td class="text-right font-semibold">
                        {{ formatMontant(arrete.montant) }}
                    </td>
                    <td>{{ formatDate(arrete.dateArreteCaisse) }}</td>
                    <td>
                        @if (arrete.dateRemonte) {
                        {{ formatDateTime(arrete.dateRemonte) }}
                        } @else {
                        <span class="text-muted">-</span>
                        }
                    </td>
                    <td>
                        <p-tag [value]="getStatusLabel(arrete.statut)" [severity]="getStatusSeverity(arrete.statut)">
                        </p-tag>
                    </td>
                    <td>
                        @if (arrete.statut === 'VALIDE' && arrete.document) {
                        <p-button icon="pi pi-external-link" label="Voir" [text]="true" size="small"
                            (onClick)="openDocument(arrete.document!)" pTooltip="Ouvrir le document">
                        </p-button>
                        } @else {
                        <span class="text-muted">
                            <i class="pi pi-clock mr-1"></i>
                            Non disponible
                        </span>
                        }
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="9" class="text-center p-6">
                        <div class="empty-state">
                            <i class="pi pi-inbox" style="font-size: 3rem; color: var(--text-color-secondary);"></i>
                            <p class="mt-3 mb-0">Aucun arrêté trouvé</p>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </p-card>
    }
</div>