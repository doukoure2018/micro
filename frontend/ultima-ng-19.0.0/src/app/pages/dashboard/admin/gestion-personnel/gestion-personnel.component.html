<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="rh-container">
    <!-- En-tête -->
    <div class="header-section">
        <h2><i class="pi pi-users"></i> Gestion des Ressources Humaines</h2>
        <p class="subtitle">Import et gestion des fichiers du personnel et des salaires</p>
    </div>

    <p-tabView>
        <!-- TAB 1: Import Fichier Personnel -->
        <p-tabPanel>
            <ng-template pTemplate="header">
                <i class="pi pi-user-plus mr-2"></i>
                <span>Fichier Personnel</span>
                <p-badge [value]="countPersonnels().toString()" severity="info" class="ml-2"></p-badge>
            </ng-template>

            <div class="tab-content">
                <!-- Section Upload Personnel (inchangée) -->
                <p-card header="Importer le fichier du personnel" styleClass="mb-4">
                    <!-- ... contenu existant ... -->
                </p-card>

                <!-- Table Personnel avec gestion du statut -->
                <p-card header="Liste du personnel">
                    <div class="table-header">
                        <!-- ✅ Filtre par statut -->
                        <div class="filter-section">
                            <p-dropdown [options]="statutOptions" [(ngModel)]="selectedStatutFilter"
                                (onChange)="onStatutFilterChange($event)" optionLabel="label" optionValue="value"
                                [style]="{ width: '180px' }" placeholder="Filtrer par statut"></p-dropdown>
                        </div>

                        <!-- ✅ NOUVEAU: Recherche par nom/prénom -->
                        <div class="search-section">
                            <span class="p-input-icon-left p-input-icon-right">
                                <i class="pi pi-search"></i>
                                <input type="text" pInputText [ngModel]="searchTerm()" (input)="onSearchChange($event)"
                                    placeholder="Rechercher par nom, prénom ou matricule..."
                                    [style]="{ width: '300px' }" />
                                @if (searchTerm()) {
                                <i class="pi pi-times clear-icon" (click)="clearSearch()"></i>
                                }
                            </span>
                        </div>

                        <!-- ✅ Compteurs -->
                        <div class="statut-counters">
                            <span class="counter active">
                                <i class="pi pi-check-circle"></i>
                                {{ countActivePersonnels() }} actifs
                            </span>
                            <span class="counter inactive">
                                <i class="pi pi-times-circle"></i>
                                {{ countInactivePersonnels() }} inactifs
                            </span>
                        </div>

                        <p-button icon="pi pi-refresh" [text]="true" (onClick)="loadPersonnels()"
                            [loading]="isLoadingPersonnel()" pTooltip="Actualiser"></p-button>
                    </div>

                    <!-- ✅ NOUVEAU: Indicateur de résultats filtrés -->
                    @if (searchTerm()) {
                    <div class="search-results-info">
                        <i class="pi pi-filter"></i>
                        <span>
                            {{ countFilteredPersonnels() }} résultat(s) pour "{{ searchTerm() }}"
                        </span>
                        <p-button icon="pi pi-times" label="Effacer" [text]="true" size="small"
                            (onClick)="clearSearch()"></p-button>
                    </div>
                    }

                    <!-- ✅ IMPORTANT: Utiliser filteredPersonnels() au lieu de personnels() -->
                    <p-table [value]="filteredPersonnels()" [paginator]="true" [rows]="10"
                        [rowsPerPageOptions]="[10, 25, 50, 100]" [loading]="isLoadingPersonnel()"
                        styleClass="p-datatable-striped p-datatable-gridlines" [tableStyle]="{ 'min-width': '60rem' }"
                        [showCurrentPageReport]="true"
                        currentPageReportTemplate="Affichage {first} à {last} sur {totalRecords} personnels">
                        <ng-template pTemplate="header">
                            <tr>
                                <th pSortableColumn="matricule" style="width: 100px">
                                    Matricule <p-sortIcon field="matricule"></p-sortIcon>
                                </th>
                                <th pSortableColumn="nom">
                                    Nom <p-sortIcon field="nom"></p-sortIcon>
                                </th>
                                <th pSortableColumn="prenom">
                                    Prénom <p-sortIcon field="prenom"></p-sortIcon>
                                </th>

                                <th pSortableColumn="statut" style="width: 120px">
                                    Statut <p-sortIcon field="statut"></p-sortIcon>
                                </th>
                                <th style="width: 150px">Date création</th>
                                <th style="width: 120px">Actions</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-personnel>
                            <tr [class.inactive-row]="personnel.statut === 'INACTIVE'">
                                <td>
                                    <span class="matricule-badge">{{ personnel.matricule }}</span>
                                </td>
                                <td>
                                    <!-- ✅ NOUVEAU: Surligner le texte recherché -->
                                    <span [innerHTML]="highlightSearch(personnel.nom)"></span>
                                </td>
                                <td>
                                    <span [innerHTML]="highlightSearch(personnel.prenom)"></span>
                                </td>

                                <td>
                                    <p-tag [value]="getStatutLabel(personnel.statut)"
                                        [severity]="getStatutSeverity(personnel.statut)"></p-tag>
                                </td>
                                <td>{{ personnel.createdAt | javaDate:'dd/MM/yyyy HH:mm' }}</td>
                                <td>
                                    <div class="action-buttons">
                                        @if (personnel.statut === 'ACTIVE') {
                                        <p-button icon="pi pi-user-minus" severity="danger" [text]="true"
                                            [rounded]="true" size="small" (onClick)="desactiverPersonnel(personnel)"
                                            [loading]="isUpdatingStatut() === personnel.id"
                                            pTooltip="Désactiver (retraite, démission...)"
                                            tooltipPosition="left"></p-button>
                                        } @else {
                                        <p-button icon="pi pi-user-plus" severity="success" [text]="true"
                                            [rounded]="true" size="small" (onClick)="activerPersonnel(personnel)"
                                            [loading]="isUpdatingStatut() === personnel.id" pTooltip="Réactiver"
                                            tooltipPosition="left"></p-button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="7" class="empty-message">
                                    <i class="pi pi-inbox"></i>
                                    @if (searchTerm()) {
                                    <span>Aucun personnel trouvé pour "{{ searchTerm() }}"</span>
                                    } @else {
                                    <span>Aucun personnel trouvé</span>
                                    }
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </p-card>
            </div>
        </p-tabPanel>

        <!-- TAB 2: Import Fichier Salaire -->
        <p-tabPanel>
            <ng-template pTemplate="header">
                <i class="pi pi-wallet mr-2"></i>
                <span>Fichier Salaire</span>
                <p-badge [value]="countAvances().toString()" severity="success" class="ml-2"></p-badge>
            </ng-template>

            <div class="tab-content">
                <!-- Section Upload Salaire -->
                <p-card header="Importer le fichier des salaires" styleClass="mb-4">
                    <div class="upload-section">
                        <div class="upload-info">
                            <h4><i class="pi pi-info-circle"></i> Format attendu du fichier Excel</h4>
                            <table class="format-table">
                                <thead>
                                    <tr>
                                        <th>Matricule</th>
                                        <th>NET A PAYER</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>1</td>
                                        <td>7 259 220</td>
                                    </tr>
                                    <tr>
                                        <td>13</td>
                                        <td>5 931 300</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="info-note">
                                <i class="pi pi-info-circle"></i>
                                <span>La limite d'avance (50% du salaire net) est calculée automatiquement.</span>
                            </p>
                        </div>

                        <p-divider></p-divider>

                        <!-- ✅ MESSAGE D'AVERTISSEMENT SI DONNÉES EXISTENT -->
                        @if (hasSalaireData()) {
                        <div class="import-blocked-message">
                            <p-message severity="warn" [style]="{ width: '100%' }">
                                <ng-template pTemplate="content">
                                    <div class="blocked-content">
                                        <i class="pi pi-lock"></i>
                                        <div class="blocked-text">
                                            <strong>Import bloqué</strong>
                                            <p>{{ salaireImportMessage() }}</p>
                                        </div>
                                    </div>
                                </ng-template>
                            </p-message>

                            <div class="reset-action">
                                <p-button icon="pi pi-refresh" label="Réinitialiser maintenant" severity="danger"
                                    (onClick)="confirmResetAvancesSalaire()" [loading]="isResetting()"></p-button>
                            </div>
                        </div>
                        } @else {
                        <!-- ✅ ZONE D'UPLOAD VISIBLE SEULEMENT SI PAS DE DONNÉES -->
                        <div class="upload-zone">
                            <p-fileUpload mode="advanced" name="file" accept=".xlsx,.xls" [maxFileSize]="10000000"
                                [customUpload]="true" (uploadHandler)="onUploadSalaire($event)" [auto]="false"
                                chooseLabel="Choisir fichier" uploadLabel="Importer" cancelLabel="Annuler"
                                [showUploadButton]="true" [showCancelButton]="true" [disabled]="isUploadingSalaire()">
                                <ng-template pTemplate="content">
                                    <div class="upload-placeholder">
                                        <i class="pi pi-cloud-upload"></i>
                                        <p>Glissez-déposez votre fichier Excel ici</p>
                                        <span>ou cliquez pour sélectionner</span>
                                    </div>
                                </ng-template>
                            </p-fileUpload>

                            @if (isUploadingSalaire()) {
                            <div class="upload-progress">
                                <p-progressBar mode="indeterminate" [style]="{ height: '6px' }"></p-progressBar>
                                <span>Import en cours...</span>
                            </div>
                            }
                        </div>
                        }

                        <!-- Résultat d'import -->
                        @if (statsSalaire()) {
                        <div class="import-result" [class.success]="statsSalaire()!.success"
                            [class.partial]="!statsSalaire()!.success">
                            <div class="result-header">
                                <i
                                    [class]="statsSalaire()!.success ? 'pi pi-check-circle' : 'pi pi-exclamation-triangle'"></i>
                                <span>{{ statsSalaire()!.success ? 'Import réussi' : 'Import partiel' }}</span>
                            </div>
                            <div class="result-stats">
                                <div class="stat">
                                    <span class="label">Total lignes:</span>
                                    <span class="value">{{ statsSalaire()!.total }}</span>
                                </div>
                                <div class="stat">
                                    <span class="label">Importées:</span>
                                    <span class="value success">{{ statsSalaire()!.importees }}</span>
                                </div>
                                @if (statsSalaire()!.erreurs > 0) {
                                <div class="stat">
                                    <span class="label">Erreurs:</span>
                                    <span class="value error">{{ statsSalaire()!.erreurs }}</span>
                                    <p-button icon="pi pi-eye" severity="danger" [text]="true" size="small"
                                        (onClick)="showErrors('salaire')" pTooltip="Voir les erreurs"></p-button>
                                </div>
                                }
                            </div>
                        </div>
                        }
                    </div>
                </p-card>

                <!-- Actions pour avances salaire -->
                <div class="actions-bar mb-3">
                    <p-button icon="pi pi-refresh" label="Actualiser" [text]="true" (onClick)="loadAvancesSalaire()"
                        [loading]="isLoadingSalaire()"></p-button>

                    @if (hasSalaireData()) {
                    <p-button icon="pi pi-trash" label="Reset mensuel ({{ countAvances() }} enregistrements)"
                        severity="danger" [outlined]="true" (onClick)="confirmResetAvancesSalaire()"
                        [loading]="isResetting()"
                        pTooltip="Supprimer toutes les avances pour permettre un nouvel import"></p-button>
                    }
                </div>

                <!-- Table Avances Salaire -->
                <p-card header="Liste des avances salaire">
                    <p-table [value]="avancesSalaire()" [paginator]="true" [rows]="10"
                        [rowsPerPageOptions]="[10, 25, 50, 100]" [loading]="isLoadingSalaire()"
                        [globalFilterFields]="['matricule', 'nomPersonnel', 'prenomPersonnel']"
                        styleClass="p-datatable-striped p-datatable-gridlines" [tableStyle]="{ 'min-width': '60rem' }"
                        [showCurrentPageReport]="true"
                        currentPageReportTemplate="Affichage {first} à {last} sur {totalRecords} avances">
                        <ng-template pTemplate="header">
                            <tr>
                                <th pSortableColumn="matricule" style="width: 100px">
                                    Matricule <p-sortIcon field="matricule"></p-sortIcon>
                                </th>
                                <th pSortableColumn="nomPersonnel">
                                    Nom <p-sortIcon field="nomPersonnel"></p-sortIcon>
                                </th>
                                <th pSortableColumn="prenomPersonnel">
                                    Prénom <p-sortIcon field="prenomPersonnel"></p-sortIcon>
                                </th>
                                <th pSortableColumn="netAmount" style="width: 150px">
                                    Net à payer <p-sortIcon field="netAmount"></p-sortIcon>
                                </th>
                                <th pSortableColumn="netAmountLimit" style="width: 150px">
                                    Limite avance (50%) <p-sortIcon field="netAmountLimit"></p-sortIcon>
                                </th>
                                <th style="width: 150px">Date import</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-avance>
                            <tr>
                                <td>
                                    <span class="matricule-badge">{{ avance.matricule }}</span>
                                </td>
                                <td>{{ avance.nomPersonnel }}</td>
                                <td>{{ avance.prenomPersonnel }}</td>
                                <td class="text-right">
                                    <span class="montant">{{ formatMontant(avance.netAmount) }}</span>
                                </td>
                                <td class="text-right">
                                    <span class="montant limite">{{ formatMontant(avance.netAmountLimit) }}</span>
                                </td>
                                <td>{{ avance.createdAt | javaDate:'dd/MM/yyyy HH:mm' }}</td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="6" class="empty-message">
                                    <i class="pi pi-inbox"></i>
                                    <span>Aucune avance salaire trouvée. Importez un fichier pour commencer.</span>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </p-card>
            </div>
        </p-tabPanel>
    </p-tabView>
</div>

<!-- Dialog pour afficher les erreurs -->
<p-dialog [header]="errorDialogTitle()" [(visible)]="showErrorDialog" [modal]="true" [style]="{ width: '700px' }"
    [dismissableMask]="true" (onHide)="hideErrorDialog()">
    <div class="error-dialog-content">
        @if (currentErrors().length > 0) {
        <p-table [value]="currentErrors()" styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 80px">Ligne</th>
                    <th style="width: 120px">Champ</th>
                    <th>Valeur</th>
                    <th>Message d'erreur</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-error>
                <tr>
                    <td><span class="error-line">{{ error.ligne }}</span></td>
                    <td>{{ error.champ }}</td>
                    <td>
                        @if (error.valeur) {
                        <code>{{ error.valeur }}</code>
                        } @else {
                        <span class="no-data">(vide)</span>
                        }
                    </td>
                    <td class="error-message">{{ error.message }}</td>
                </tr>
            </ng-template>
        </p-table>
        } @else {
        <div class="no-errors">
            <i class="pi pi-check-circle"></i>
            <span>Aucune erreur à afficher</span>
        </div>
        }
    </div>

    <ng-template pTemplate="footer">
        <p-button label="Fermer" icon="pi pi-times" (onClick)="hideErrorDialog()"></p-button>
    </ng-template>
</p-dialog>