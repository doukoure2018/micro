<div class="card h-full">
    <p-toast></p-toast>

    <div class="p-4">
        <div class="flex items-center justify-between mb-6">
            <div class="flex gap-4 items-center">
                <div class="text-4xl">&#128188;</div>
                <div class="flex flex-col gap-1">
                    <span class="text-2xl font-semibold">
                        Bonjour, <span class="text-color">{{ user?.firstName }} {{ user?.lastName }}!</span>
                    </span>
                    <span class="text-surface-600">Tableau de bord - Delegue Regional</span>
                </div>
            </div>
            <div class="flex gap-3 flex-wrap">
                <p-chip *ngIf="state().demandesAValider.length > 0"
                    [label]="'A valider: ' + state().demandesAValider.length"
                    styleClass="bg-blue-100 text-blue-800"></p-chip>
                <p-chip *ngIf="state().demandesCorrectionDE.length > 0"
                    [label]="'Rejetees DE: ' + state().demandesCorrectionDE.length"
                    styleClass="bg-red-100 text-red-800"></p-chip>
            </div>
        </div>

        <div *ngIf="state().loading" class="flex justify-center items-center py-8">
            <p-progressSpinner strokeWidth="4" [style]="{width: '50px', height: '50px'}"></p-progressSpinner>
            <span class="ml-3">Chargement...</span>
        </div>

        <div *ngIf="!state().loading">
            <p-tabView>
                <!-- Onglet: A Valider -->
                <p-tabPanel>
                    <ng-template pTemplate="header">
                        <span>A Valider</span>
                        <p-badge *ngIf="state().demandesAValider.length > 0"
                            [value]="state().demandesAValider.length.toString()" severity="info" class="ml-2"></p-badge>
                    </ng-template>

                    <div class="card border-l-4 border-blue-500">
                        <p-table #dtValider [value]="state().demandesAValider" [paginator]="true" [rows]="10"
                            [showCurrentPageReport]="true" responsiveLayout="scroll"
                            currentPageReportTemplate="Affichage de {first} a {last} sur {totalRecords}"
                            [rowsPerPageOptions]="[10, 25, 50]"
                            [globalFilterFields]="['nom', 'prenom', 'numeroMembre', 'objectCredit', 'agenceLibele']"
                            styleClass="p-datatable-striped">

                            <ng-template pTemplate="caption">
                                <div class="flex flex-wrap gap-3 items-center justify-between">
                                    <p-icon-field class="w-full sm:w-80">
                                        <p-inputicon class="pi pi-search" />
                                        <input pInputText type="text" (input)="onGlobalFilter(dtValider, $event)"
                                            placeholder="Rechercher..." class="w-full" />
                                    </p-icon-field>
                                    <p-button icon="pi pi-refresh" (click)="refreshData()" severity="secondary"
                                        size="small"></p-button>
                                </div>
                            </ng-template>

                            <ng-template pTemplate="header">
                                <tr>
                                    <th pSortableColumn="createdAt" style="width:12%">Date <p-sortIcon field="createdAt"></p-sortIcon></th>
                                    <th pSortableColumn="nom" style="width:18%">Client <p-sortIcon field="nom"></p-sortIcon></th>
                                    <th style="width:12%">Agence</th>
                                    <th pSortableColumn="montantDemande" class="text-right" style="width:15%">Montant <p-sortIcon field="montantDemande"></p-sortIcon></th>
                                    <th style="width:15%">Objet</th>
                                    <th style="width:12%">Avis DA</th>
                                    <th class="text-center" style="width:16%">Actions</th>
                                </tr>
                            </ng-template>

                            <ng-template pTemplate="body" let-demande>
                                <tr class="hover:bg-surface-50">
                                    <td>{{ demande.createdAt | date:'dd/MM/yyyy' }}</td>
                                    <td>
                                        <div class="flex flex-col gap-1">
                                            <span class="font-semibold">{{ demande.prenom }} {{ demande.nom }}</span>
                                            <small class="text-500">{{ demande.numeroMembre }}</small>
                                        </div>
                                    </td>
                                    <td><p-chip [label]="demande.agenceLibele || 'N/A'" styleClass="text-xs"></p-chip></td>
                                    <td class="text-right font-bold text-blue-600">{{ formatMontantGNF(demande.montantDemande) }}</td>
                                    <td>{{ demande.objectCredit }}</td>
                                    <td>
                                        <small *ngIf="demande.avisDa" class="text-600">{{ demande.avisDa | slice:0:50 }}...</small>
                                        <small *ngIf="!demande.avisDa" class="text-400">-</small>
                                    </td>
                                    <td class="text-center">
                                        <div class="flex gap-2 justify-center">
                                            <p-button icon="pi pi-eye" (click)="viewDemandeDetail(demande.demandeIndividuelId)"
                                                size="small" severity="info" pTooltip="Voir detail"></p-button>
                                            <p-button icon="pi pi-check" (click)="ouvrirValidation(demande)"
                                                size="small" severity="success" pTooltip="Valider"></p-button>
                                            <p-button icon="pi pi-times" (click)="ouvrirRejet(demande)"
                                                size="small" severity="danger" pTooltip="Rejeter"></p-button>
                                        </div>
                                    </td>
                                </tr>
                            </ng-template>

                            <ng-template pTemplate="emptymessage">
                                <tr>
                                    <td colspan="7" class="text-center p-6">
                                        <i class="pi pi-check-circle text-4xl text-green-500 mb-3"></i>
                                        <p class="text-600">Aucune demande a valider</p>
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>
                </p-tabPanel>

                <!-- Onglet: Rejetees par DE -->
                <p-tabPanel>
                    <ng-template pTemplate="header">
                        <span>Rejetees par DE</span>
                        <p-badge *ngIf="state().demandesCorrectionDE.length > 0"
                            [value]="state().demandesCorrectionDE.length.toString()" severity="danger" class="ml-2"></p-badge>
                    </ng-template>

                    <div class="card border-l-4 border-red-500">
                        <p-table #dtCorrection [value]="state().demandesCorrectionDE" [paginator]="true" [rows]="10"
                            [showCurrentPageReport]="true" responsiveLayout="scroll"
                            currentPageReportTemplate="Affichage de {first} a {last} sur {totalRecords}"
                            [rowsPerPageOptions]="[10, 25, 50]"
                            [globalFilterFields]="['nom', 'prenom', 'numeroMembre', 'motifRejetDe']"
                            styleClass="p-datatable-striped">

                            <ng-template pTemplate="caption">
                                <div class="flex flex-wrap gap-3 items-center justify-between">
                                    <p-icon-field class="w-full sm:w-80">
                                        <p-inputicon class="pi pi-search" />
                                        <input pInputText type="text" (input)="onGlobalFilter(dtCorrection, $event)"
                                            placeholder="Rechercher..." class="w-full" />
                                    </p-icon-field>
                                </div>
                            </ng-template>

                            <ng-template pTemplate="header">
                                <tr>
                                    <th pSortableColumn="createdAt" style="width:12%">Date <p-sortIcon field="createdAt"></p-sortIcon></th>
                                    <th pSortableColumn="nom" style="width:20%">Client <p-sortIcon field="nom"></p-sortIcon></th>
                                    <th class="text-right" style="width:15%">Montant</th>
                                    <th style="width:25%">Motif de rejet DE</th>
                                    <th style="width:15%">Sections a revoir</th>
                                    <th class="text-center" style="width:13%">Actions</th>
                                </tr>
                            </ng-template>

                            <ng-template pTemplate="body" let-demande>
                                <tr class="hover:bg-surface-50">
                                    <td>{{ demande.createdAt | date:'dd/MM/yyyy' }}</td>
                                    <td>
                                        <div class="flex flex-col gap-1">
                                            <span class="font-semibold">{{ demande.prenom }} {{ demande.nom }}</span>
                                            <small class="text-500">{{ demande.numeroMembre }}</small>
                                        </div>
                                    </td>
                                    <td class="text-right font-bold text-red-600">{{ formatMontantGNF(demande.montantDemande) }}</td>
                                    <td>{{ demande.motifRejetDe }}</td>
                                    <td><small>{{ demande.sectionsARevoirDe }}</small></td>
                                    <td class="text-center">
                                        <p-button icon="pi pi-eye" label="Voir" (click)="viewDemandeDetail(demande.demandeIndividuelId)"
                                            size="small" severity="warn"></p-button>
                                    </td>
                                </tr>
                            </ng-template>

                            <ng-template pTemplate="emptymessage">
                                <tr>
                                    <td colspan="6" class="text-center p-6">
                                        <i class="pi pi-check-circle text-4xl text-green-500 mb-3"></i>
                                        <p class="text-600">Aucune demande rejetee par DE</p>
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>
                </p-tabPanel>
            </p-tabView>
        </div>
    </div>

    <!-- Dialog Validation -->
    <p-dialog header="Valider la demande" [(visible)]="showValidationDialog" [modal]="true" [style]="{width: '500px'}">
        <div *ngIf="selectedDemande" class="mb-4">
            <p class="font-semibold">{{ selectedDemande.prenom }} {{ selectedDemande.nom }} - {{ formatMontantGNF(selectedDemande.montantDemande) }}</p>
        </div>
        <form [formGroup]="validationForm">
            <div class="flex flex-col gap-2 mb-4">
                <label class="font-semibold">Avis du DR *</label>
                <textarea pTextarea formControlName="avis" rows="4" placeholder="Saisissez votre avis..." class="w-full"></textarea>
                <small *ngIf="validationForm.get('avis')?.touched && validationForm.get('avis')?.invalid" class="text-red-500">
                    L'avis est obligatoire (min 10 caracteres)
                </small>
            </div>
        </form>
        <ng-template pTemplate="footer">
            <p-button label="Annuler" icon="pi pi-times" (click)="showValidationDialog = false" severity="secondary"></p-button>
            <p-button label="Valider" icon="pi pi-check" (click)="confirmerValidation()" severity="success"
                [disabled]="validationForm.invalid"></p-button>
        </ng-template>
    </p-dialog>

    <!-- Dialog Rejet -->
    <p-dialog header="Rejeter la demande" [(visible)]="showRejetDialog" [modal]="true" [style]="{width: '600px'}">
        <div *ngIf="selectedDemande" class="mb-4">
            <p class="font-semibold">{{ selectedDemande.prenom }} {{ selectedDemande.nom }} - {{ formatMontantGNF(selectedDemande.montantDemande) }}</p>
        </div>
        <form [formGroup]="rejetForm">
            <div class="flex flex-col gap-2 mb-4">
                <label class="font-semibold">Motif de rejet *</label>
                <textarea pTextarea formControlName="motifRejet" rows="3" placeholder="Motif du rejet..." class="w-full"></textarea>
                <small *ngIf="rejetForm.get('motifRejet')?.touched && rejetForm.get('motifRejet')?.invalid" class="text-red-500">
                    Le motif est obligatoire (min 10 caracteres)
                </small>
            </div>
            <div class="flex flex-col gap-2 mb-4">
                <label class="font-semibold">Sections a revoir *</label>
                <div class="flex flex-wrap gap-3">
                    <div *ngFor="let option of sectionsOptions" class="flex items-center gap-2">
                        <input type="checkbox" [value]="option.value" (change)="toggleSection(option.value, $event)">
                        <label>{{ option.label }}</label>
                    </div>
                </div>
                <small *ngIf="rejetForm.get('sectionsARevoir')?.touched && rejetForm.get('sectionsARevoir')?.value?.length === 0" class="text-red-500">
                    Au moins une section doit etre selectionnee
                </small>
            </div>
            <div class="flex flex-col gap-2">
                <label class="font-semibold">Instructions pour le DA</label>
                <textarea pTextarea formControlName="instructions" rows="2" placeholder="Instructions..." class="w-full"></textarea>
            </div>
        </form>
        <ng-template pTemplate="footer">
            <p-button label="Annuler" icon="pi pi-times" (click)="showRejetDialog = false" severity="secondary"></p-button>
            <p-button label="Rejeter" icon="pi pi-times-circle" (click)="confirmerRejet()" severity="danger"
                [disabled]="rejetForm.invalid"></p-button>
        </ng-template>
    </p-dialog>
</div>
